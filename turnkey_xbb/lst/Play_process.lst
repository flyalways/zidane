C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 1   


C51 COMPILER V7.10, COMPILATION OF MODULE PLAY_PROCESS
OBJECT MODULE PLACED IN .\obj\Play_process.obj
COMPILER INVOKED BY: F:\Keil C 7.10\chengxu\C51\BIN\C51.EXE Play\Play_process.C LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS IN
                    -CDIR(..\libsource\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\Play_process.lst) OBJECT(.\obj\Play_proce
                    -ss.obj)

line level    source

   1          #include "SPDA2K.h"
   2          #include "dos\fs_struct.h"
   3          #include "Memalloc.h"
   4          #include "..\DSP\DSPPHYSIC.H"
   5          #include "..\DSP\dspuser.h"
   6          #include "..\header\music_play.h"
   7          #include "..\IR\remote.h"
   8          #include "..\header\host_init.h"
   9          #include "..\UI_Display\unicode_hzk.c"
  10          #include "..\header\variables.h"
  11          #include "..\LCM\TFT_display.h"         // TFT
  12          #include "..\LCM\TFT_config.h"          // TFT
  13          #include "..\LCM\LCM.h"
  14          #include "..\LCM\LCM_func.h"
  15          #include "..\LCM\UI_icon.h"
  16          
  17          #define D_LrcNum                3
  18          
  19          extern xdata U8 gc_NUMBER[4];
  20          
  21          extern  data    bit     gb_HostError;  //20090107 chiayen add
  22          extern  U8              gc_clock_mode;  //20090526 chiayen add
  23          extern  U8              Get_LogData_PageIndex(void);
  24          extern  U8              WMA_ASF_Parser();
  25          extern  U8              DOS_DIRtable(void);  //20090216 chiayen add
  26          extern  U8              USER_LogFile_ReadWrite(U8 tbt_ReadOrWrite);//use reserveblock for log
  27          extern  U16             MP3_Total_Time_Parser();
  28          extern  U16             MP3_Bitrate_Parser();
  29          extern  void    MediaChange(void);  //20090107 chiayen add
  30          extern  void    PickSong_Process(void);
  31          extern  void    FM_FREQ_CHG(U8 tc_UP_DOWN,U8 offset);
  32          extern  void    Lyric_NextGetLyrics(void);
  33          extern  U8              DOS_SearchFreeCluster(U8 tc_SearchMode);
  34          
  35          void InitDispVariable(void);
  36          void Play_SDFlash_DosInit();
  37          void Play_SourceDetect_Process();
  38          void IR_Service_Process();
  39          void Music_SetVolumeCmd(void); 
  40          void LCM_Display_Func1(void);
  41          void LCM_Display_Func2(void);
  42          extern  void IR_Service_Process_Menu();
  43          extern  void UI_fastFFFR_Play(U8 XFFFR);
  44          
  45          U8 LRC_DisplayString(U8 *tpc_DataBuf, U8 tw_nByte,U8 tc_RowAddr);
  46          
  47          xdata   System_Struct gs_System_State;
  48          struct  str_scroll_t    gs_str_scroll_state;
  49          //////////////sunzhk add 090612
  50          void ir_service_menu(void);
  51          void ir_commandservice_menu(void);
  52          void IR_Service_Process_Menu();
  53          
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 2   

  54          xdata U8 gc_loopcount=0;
  55          extern xdata    U32     gdw_HOSTStartSectorRead;
  56          extern void play_fffr_end();
  57          
  58          
  59          ////////////sunzhk add over
  60          ////////////////////////////////////////////////////////////////////////////////////////////////
  61          
  62          void TFT_disp_SongName(U8 tc_Width,U8 xdata *BMPdataBuf)  //yflin080820
  63          {
  64   1              xdata   U8      m;
  65   1              data    U8      tc_i;
  66   1              data    U8      j;
  67   1              data    U8      tc_char;
  68   1      
  69   1              if (tc_Width == 0)
  70   1              {
  71   2                      return;
  72   2              }
  73   1              //for 023Only
  74   1              LCD_Nand2DataMode();
  75   1      
  76   1              do
  77   1              {
  78   2                      if(tc_Width>16)
  79   2                      {
  80   3                              tc_Width -= 16;
  81   3                              tc_i = 32;
  82   3                      }
  83   2                      else
  84   2                      { 
  85   3                              tc_i = tc_Width*2;
  86   3                              if (tc_i == 0)
  87   3                              {
  88   4                                      break;
  89   4                              }
  90   3                              tc_Width = 0;
  91   3                      }
  92   2      
  93   2                      j = tc_i;
  94   2                      do { // loop 'tc_i' times
  95   3                              tc_char = *BMPdataBuf++;
  96   3                              m = 8;
  97   3                              do { // loop 8 times
  98   4                                      tc_char = tc_char>>1;   //@bit@bit shift
  99   4                                      if(CY)          //低位为1 将输入一个点的颜色
 100   4                                      {       
 101   5                                              if(gb_LrcFileName_Exist==1)
 102   5                                              {
 103   6                                                      if(gb_LRCDispLevel==0)
 104   6                                                      {
 105   7                                                              // LRC材@舱r
 106   7                                                              XBYTE[0xB420] = FullLRC_Word1Color/256; 
 107   7                                                              XBYTE[0xB420] = FullLRC_Word1Color;     
 108   7                                                      }
 109   6                                                      else
 110   6                                                      {
 111   7                                                              // LRC材G舱r
 112   7                                                              XBYTE[0xB420] = FullLRC_Word2Color/256; 
 113   7                                                              XBYTE[0xB420] = FullLRC_Word2Color;     
 114   7                                                      }
 115   6                                              }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 3   

 116   5                                              else
 117   5                                              {
 118   6      
 119   6                                                      if(gc_folder_disp==1)
 120   6                                                      {
 121   7                                                              XBYTE[0xB420] = WordColor_FolderName/256; 
 122   7                                                              XBYTE[0xB420] = WordColor_FolderName;
 123   7                                                      }else
 124   6                                                      {       // qWr
 125   7                                                      XBYTE[0xB420] = WordColor_FileName/256; 
 126   7                                                      XBYTE[0xB420] = WordColor_FileName;
 127   7                                              }
 128   6                                      }
 129   5                                      }
 130   4                                      else
 131   4                                      {
 132   5                                              if(gb_LrcFileName_Exist==1)
 133   5                                              {
 134   6                                                      if(gb_LRCDispLevel==0)
 135   6                                                      {
 136   7                                                              // LRC材@舱I春
 137   7                                                              XBYTE[0xB420] = FullLRC_Word1Color_BG/256; 
 138   7                                                              XBYTE[0xB420] = FullLRC_Word1Color_BG;
 139   7                                                      }
 140   6                                                      else
 141   6                                                      {
 142   7                                                              // LRC材G舱I春
 143   7                                                              XBYTE[0xB420] = FullLRC_Word2Color_BG/256; 
 144   7                                                              XBYTE[0xB420] = FullLRC_Word2Color_BG;                                          
 145   7                                                      }
 146   6                                              }
 147   5                                              else
 148   5                                              {
 149   6                                                      if(gc_folder_disp==1)
 150   6                                                      {
 151   7                                                              XBYTE[0xB420] = WordColorBG_FolderName/256; 
 152   7                                                              XBYTE[0xB420] = WordColorBG_FolderName;
 153   7                                                      }else
 154   6                                                      {
 155   7                                                      // qWI春
 156   7                                                      XBYTE[0xB420] = WordColorBG_FileName/256; 
 157   7                                                      XBYTE[0xB420] = WordColorBG_FileName;
 158   7                                              }
 159   6                                      }
 160   5                                      }
 161   4                              } while (--m);
 162   3                      } while (--tc_i);
 163   2              } while(tc_Width);
 164   1      
 165   1              LCD_Data2NandMode();
 166   1      }
 167          
 168          U8 TFT_GetStringHZK(struct string_view_t * p_disp_param,
 169                                                  struct string_disp_t xdata * p_string_disp_param,
 170                                                  U8 * tpc_DataBuf,
 171                                                  U8 tc_nByte,
 172                                                  U8 tc_ANSI,
 173                                                  U8 line_num,
 174                                                  U8 font_truncate_flag,
 175                                                  U8 tc_scroll_flag,
 176                                                  U8 xdata * p_bitmap)
 177          {
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 4   

 178   1              //mode: display mode  offset: reserved for file brwser  tc_nByte:string num tc_ANSI:string type(ANSI or u
             -nicode)
 179   1              struct string_view_t disp_param;
 180   1              data    U8      tc_Status = 0; 
 181   1              data    U8      i = 0;
 182   1              data    U8      tc_1st_char = 0;
 183   1              data    U8      tc_shift_start = 0;
 184   1              data    U8      tc_next_1st_char = 0;
 185   1              data    U8      tc_next_shift_start = 0;
 186   1              data    U8      tc_ColumnNum;
 187   1              data    U16     tw_Width = 0;
 188   1      
 189   1              disp_param = *p_disp_param;
 190   1              gw_BmpInx       = 0;
 191   1              gb_TFT_scroll=0;
 192   1      
 193   1              if (tc_scroll_flag)
 194   1              {
 195   2                      i = tc_1st_char
 196   2                        = tc_next_1st_char
 197   2                        = gs_str_scroll_state.c_str_1st_char;
 198   2                      tc_shift_start = tc_next_shift_start    = gs_str_scroll_state.c_shift_in_1st_char;
 199   2              }
 200   1      
 201   1              while (i<tc_nByte)
 202   1              {               
 203   2                      if(tc_ANSI)
 204   2                      {
 205   3                              tc_ColumnNum = UNICODE_HZK_GET_BMP(*(tpc_DataBuf+i),*(tpc_DataBuf+i+1),&(p_bitmap[gw_BmpInx]),1);
 206   3                      }
 207   2                      else //Unicode
 208   2                      { 
 209   3                              tc_ColumnNum = UNICODE_HZK_GET_BMP(*(tpc_DataBuf+i+1),*(tpc_DataBuf+i),&(p_bitmap[gw_BmpInx]),0);
 210   3                      }
 211   2                              
 212   2                      if (i == tc_1st_char)
 213   2                      {
 214   3                              tc_next_shift_start ++;
 215   3                              if (tc_next_shift_start >= (tc_ColumnNum&0x7f))
 216   3                              {
 217   4                                      tc_next_shift_start = 0;
 218   4                                      tc_next_1st_char++;
 219   4                                      if(tc_ColumnNum&0x80)tc_next_1st_char++;
 220   4                              }
 221   3                      }
 222   2                              
 223   2                      tw_Width += (tc_ColumnNum&0x7f);
 224   2                      if(tw_Width > tc_shift_start+disp_param.c_view_width)
 225   2                      {
 226   3                              tc_Status=1;
 227   3                              break;
 228   3                      }
 229   2      
 230   2                      if (tc_ColumnNum&0x80)
 231   2                      {
 232   3                              i+=2;
 233   3                      }
 234   2                      else
 235   2                      {
 236   3                              i+=1;
 237   3                      }
 238   2              }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 5   

 239   1      
 240   1              if(tw_Width>FileName_Width)
 241   1              {
 242   2                      gb_TFT_scroll=1;
 243   2              }
 244   1      
 245   1              tw_Width -= tc_shift_start;
 246   1              if (tw_Width > disp_param.c_view_width)
 247   1              {
 248   2                      if (font_truncate_flag)
 249   2                      {
 250   3                              tw_Width = disp_param.c_view_width;
 251   3                      }
 252   2                      else
 253   2                      {
 254   3                              tw_Width -= (tc_ColumnNum&0x7f);
 255   3                      }
 256   2              }
 257   1              else
 258   1              {
 259   2                      tc_next_shift_start     = 0;
 260   2                      tc_next_1st_char        = 0;
 261   2              }
 262   1      
 263   1              p_string_disp_param->c_x                        = disp_param.c_view_x;
 264   1              p_string_disp_param->c_y                        = disp_param.c_view_y + disp_param.c_row_spacing*line_num;
 265   1              p_string_disp_param->c_width            = tw_Width;
 266   1              p_string_disp_param->c_reverse_flag     = 0;
 267   1              p_string_disp_param->pc_font_bitmap     = p_bitmap +2*tc_shift_start; 
 268   1      
 269   1              if (tc_scroll_flag)
 270   1              {
 271   2                      gs_str_scroll_state.c_str_1st_char              = tc_next_1st_char;
 272   2                      gs_str_scroll_state.c_shift_in_1st_char = tc_next_shift_start;
 273   2              }
 274   1              else
 275   1              {
 276   2                      gs_str_scroll_state.c_str_1st_char              = 0;
 277   2                      gs_str_scroll_state.c_shift_in_1st_char = 0;
 278   2              }
 279   1      
 280   1              return tc_Status;
 281   1      }
 282          
 283          
 284          static void UI_StringTrigger(struct string_disp_t xdata *p_str)
 285          {
 286   1              LCM_set_view(TFT_HZKDispDir, p_str->c_x, p_str->c_y, p_str->c_width, 16); 
 287   1              TFT_disp_SongName(p_str->c_width, p_str->pc_font_bitmap);//total width,reverse,string start index
 288   1      }
 289          
 290          void TFT_ShowSongName(struct string_view_t *p_disp_param,struct string_disp_t xdata *p_string_disp_param)
 291          {
 292   1              data    U8      tc_ColumnNum;
 293   1              data    U16     i;
 294   1              data    U16 tw_Start;
 295   1              data    U16 tw_Width;
 296   1              struct string_view_t disp_param;
 297   1      
 298   1              disp_param = *p_disp_param;
 299   1              UI_StringTrigger(&(p_string_disp_param[0]));
 300   1              tw_Width        = p_string_disp_param[0].c_width;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 6   

 301   1              //clear resudue space
 302   1              if (tw_Width < disp_param.c_view_width)
 303   1              {
 304   2                      tw_Start         = p_string_disp_param[0].c_x+tw_Width;
 305   2                      tc_ColumnNum = p_string_disp_param[0].c_y;
 306   2                      tw_Width         = disp_param.c_view_width-tw_Width;
 307   2       
 308   2                      LCD_set_view(TFT_HZKDispDir, tw_Start, tc_ColumnNum,tw_Width,16); // horizontal view    
 309   2                      LCD_Nand2DataMode();
 310   2                      for(i=0;i<tw_Width*32;i++)
 311   2                      {
 312   3                              if(gc_folder_disp==1)
 313   3                              {
 314   4                                      XBYTE[0xB420]=WordColorBG_FolderName>>8;
 315   4                                      XBYTE[0xB420]=WordColorBG_FolderName;
 316   4      
 317   4                              }else
 318   3                              {
 319   4                              XBYTE[0xB420]=WordColorBG_FileName>>8;
 320   4                              XBYTE[0xB420]=WordColorBG_FileName;
 321   4                      }
 322   3                      }
 323   2                      LCD_Data2NandMode();
 324   2              }
 325   1      }
 326          
 327          
 328          static U8 LCD_Disp_FileName(U8 *tpc_DataBuf, U8 tc_ANSI, U8 tc_nByte, U8 tc_scroll_flag)
 329          {       //mode: display mode  offset: reserved for file brwser  tc_nByte:string num tc_ANSI:string type(ANSI or 
             -unicode)
 330   1              U8 tc_Status;
 331   1              struct string_view_t disp_param;// = { Start_X_FileName,        Start_Y_FileName,       FileName_Width, 22};
 332   1              struct string_disp_t filename_attrib;
 333   1              
 334   1              if(gc_folder_disp==1)    
 335   1              {//显示文件夹名称
 336   2                      disp_param.c_view_x=Start_X_FolderName;
 337   2                      disp_param.c_view_y=Start_Y_FolderName;
 338   2                      disp_param.c_view_width=FolderName_Width;
 339   2                      disp_param.c_row_spacing=20;  
 340   2                      
 341   2                      gs_str_scroll_state.c_str_1st_char=0;  //20090331
 342   2                      gs_str_scroll_state.c_shift_in_1st_char=0;
 343   2      
 344   2              }else
 345   1              {//显示文件的名称
 346   2                      disp_param.c_view_x=Start_X_FileName;
 347   2                      disp_param.c_view_y=Start_Y_FileName;
 348   2                      disp_param.c_view_width=FileName_Width;
 349   2                      disp_param.c_row_spacing=22;
 350   2              }
 351   1              tc_Status=TFT_GetStringHZK(&disp_param, //*
 352   1                                                                       &(filename_attrib),
 353   1                                                                       &(tpc_DataBuf[0]), //* string to display
 354   1                                                                       tc_nByte, //* string size in bytes
 355   1                                                                       tc_ANSI, //* unicode or ansi flag
 356   1                                                                       0, //* line number
 357   1                                                                       1,/*truncate on char or not*/ //* 1
 358   1                                                                       tc_scroll_flag, //rolling factor
 359   1                                                                       &(gc_BmpString[0]));
 360   1              TFT_ShowSongName(&disp_param, &filename_attrib);
 361   1              return tc_Status;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 7   

 362   1      }
 363          
 364          
 365          void Music_EQ_Cmd(U8 tc_Type)
 366          {
 367   1          DSP_EQ_Cmd(tc_Type);
 368   1          gs_DSP_GLOBAL_RAM.sc_EQ_Type = tc_Type;
 369   1          DSP_SpectrumOn();
 370   1      }
 371          
 372          
 373          void Music_WakeUp(U8 tc_Type)
 374          {   
 375   1          DSP_WakeUp(tc_Type);
 376   1      }
 377          
 378          
 379          U8 MP3_DataIn(void)
 380          {   
 381   1              data    U8 tc_status;
 382   1              xdata   U16     tw_SmpRateIdx;
 383   1          
 384   1          while (L2_DSP_Read_DMem16(DSP_EmptyBuffer) >= 512)           //Jimi 091126
 385   1          {
 386   2              tc_status=DOS_Read_File(C_MusicFHandle);
 387   2              if(tc_status == DOS_END_OF_FILE)
 388   2              {
 389   3                              L2_DSP_Write_DMem16(DSP_MP3_file_end_flag, 1);  //Jimi 091126
 390   3                  return DSP_DATAIN_COMMAND_ERROR;
 391   3              }
 392   2              else if(tc_status)
 393   2              {
 394   3                  return tc_status;   
 395   3              }
 396   2      
 397   2              L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x20, (U16)gc_PlayRecordDataBuf, DMA_24BIT_MODE
             -);
 398   2              L2_DSP_SendCommandSet(DCMD_DatIn);
 399   2      
 400   2              if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 24)
 401   2                      {
 402   3                  gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // DM Range: 0x2000 ~  0x2FFF
 403   3                      }
 404   2          }
 405   1      
 406   1          tw_SmpRateIdx = L2_DSP_Read_DMem16(0x3F8E); //0x3F8E is an index of mp3 sampling rate within DSP
 407   1                                                                                                                
             -      //0x0:44.1k;  0x1:48k;  0x2:32k;  0x3:22.1k;  0x4:24k;  0x5:16k;  0x6:11.025k;  0x7:12k;  0x8:8k
 408   1          if(tw_SmpRateIdx == 0 || tw_SmpRateIdx == 3 || tw_SmpRateIdx == 6)
 409   1              {
 410   2              GLOBAL_REG[0x46] |=0x04;
 411   2              }
 412   1          else
 413   1              {
 414   2              GLOBAL_REG[0x46] &=0xFB; 
 415   2              }
 416   1      
 417   1          return  DSP_SUCCESS;
 418   1      }
 419          
 420          
 421          U16 MP3_Bitrate(void)
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 8   

 422          {
 423   1          return(L2_DSP_Read_DMem16(DSP_MP3Bitrate));
 424   1      }
 425          
 426          
 427          U16 MP3_ReadTime(void)
 428          {
 429   1              code    U16     SampleRate[4][3]={{11025,12000,8000},{0,0,0},{22050,24000,16000},{44100,48000,32000} };
 430   1              data    U8      tc_SampleRate, tc_MPEG_Type, tc_Layer;
 431   1          data        U16 tw_DurTime;
 432   1              data    U16 tw_SamplePerFrame;
 433   1          xdata       U32 tdw_Mpeg_Status = L2_DSP_Read_DMem24(DSP_MPEGSt);
 434   1          xdata       U32 tdw_FrameCnt = L2_DSP_Read_DMem24(DSP_DecodeFrameCounter);
 435   1      
 436   1              tc_SampleRate = ((U8)(tdw_Mpeg_Status>>5)&0x03);
 437   1              tc_MPEG_Type = ((U8)(tdw_Mpeg_Status>>(14+8))&0x03);
 438   1              tc_Layer = ((U8)(tdw_Mpeg_Status>>(12+8))&0x03);
 439   1      
 440   1          if(tdw_FrameCnt>0x20)
 441   1          {
 442   2                      if(tc_Layer == 0x03) //layer-I, reference ISO/IEC 11172-3 header description
 443   2              {
 444   3                              tw_SamplePerFrame = 384;
 445   3              }
 446   2                      else if((tc_MPEG_Type != 0x03) && (tc_Layer == 0x01))
 447   2                      {       
 448   3                              tw_SamplePerFrame = 576;
 449   3                      } 
 450   2                      else
 451   2                      {
 452   3                              tw_SamplePerFrame = 1152;
 453   3              }
 454   2                      
 455   2                      if(tc_MPEG_Type != 0x01)
 456   2                      {
 457   3                              tw_DurTime = gw_CurrentSec +  tdw_FrameCnt * tw_SamplePerFrame/SampleRate[tc_MPEG_Type][tc_SampleRate];
 458   3              }
 459   2                  else
 460   2              {
 461   3                      tw_DurTime = 0;
 462   3                  }
 463   2          }
 464   1              else//(JC)min ~32 frames -> 1sec
 465   1          {
 466   2              tw_DurTime = gw_CurrentSec;
 467   2          }
 468   1      
 469   1          return tw_DurTime;
 470   1      }
 471          
 472          
 473          U8 MP3_EOF_Proc(void)
 474          {                       
 475   1              data    U16 tw_BufRem;
 476   1              data    U16 tw_RampDownBufSz;
 477   1              data    U16 tw_dec_bsbuf_rem;    //Jimi 091126
 478   1      
 479   1              L2_DSP_Write_DMem16(0x3F44, 8000);      //Jimi 100517, enlarge DSP MP3 decoder ramp down step
 480   1              L2_DSP_Write_DMem16(0x3F45, 8000);
 481   1      
 482   1          tw_BufRem = L2_DSP_Read_DMem16(DSP_RemainBuffer);
 483   1          tw_RampDownBufSz =(U16)(((U32)gs_System_State.w_BitRate * 1000 )/8/20);  // 0.05 sec for ramp down
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 9   

 484   1          tw_dec_bsbuf_rem = L2_DSP_Read_DMem16(DSP_MP3_dec_bsbuf_rem);   //Jimi 091126
 485   1          
 486   1          if(tw_RampDownBufSz < 512 )     //for 8k bitrate condition(M2L3 & M2.5L3)
 487   1              {
 488   2              tw_RampDownBufSz = 512;
 489   2              }
 490   1          
 491   1          if(tw_BufRem < tw_RampDownBufSz )
 492   1              {
 493   2                      if(L2_DSP_Read_DMem16(DSP_RampDownComplete) == 0)       //(Jimi 091126)RampDownOK == 0
 494   2                      {
 495   3                              if( tw_dec_bsbuf_rem < tw_RampDownBufSz)
 496   3                              {
 497   4                              return 1;
 498   4                              }
 499   3                      }
 500   2                      else
 501   2                      {       
 502   3                              return 1;
 503   3                      }
 504   2              }
 505   1      
 506   1          return 0;
 507   1      }
 508          
 509          
 510          //=================WMA=================
 511          U8 WMA_err_bs_proc(void)
 512          {
 513   1              data    U8      tc_iloop;
 514   1              data    U16     tw_tmp;
 515   1              data    U16 tw_DRMStatus;
 516   1              data    U16 tw_DecodeStatus;
 517   1              xdata   U32 tdw_testcluster;
 518   1              
 519   1              tw_DRMStatus = L2_DSP_Read_DMem16(DSP_WMAhasJanusDRM);
 520   1              tw_tmp = L2_DSP_Read_DMem16(DSP_DecodeStatus);
 521   1              tw_DecodeStatus = tw_tmp & 0x0020;
 522   1      
 523   1              if( (tw_DecodeStatus == 0x0020) || tw_DRMStatus  )      //wma format error or drm
 524   1              {
 525   2              DSP_ResetCmd();
 526   2                      return DSP_USER_FILE_TYPE_ERROR;
 527   2              }
 528   1              
 529   1              tw_DecodeStatus = tw_tmp & 0x00C0;
 530   1          if(tw_DecodeStatus!=0x0000)
 531   1              {
 532   2                      tdw_testcluster = (gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint >> 9)+5;
 533   2      
 534   2                      if( tdw_testcluster >= (gs_File_FCB[gs_System_State.c_FileHandle].dw_File_TotalSize >> 9) )
 535   2                      {
 536   3                              return DSP_RUNNING_STATUS1_ERROR;
 537   3                      }
 538   2      
 539   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster =gs_File_FCB[gs_System_State.c_FileHand
             -le].dw_File_StartCluster;
 540   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint = tdw_testcluster << 9;
 541   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster = DOS_Seek_File(gs_System_State.c_FileH
             -andle,gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint>>9);
 542   2      
 543   2                      L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3C00);    //reset BS buffer information   //Jimi081112 mdf size to 0x3C
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 10  

             -00
 544   2              L2_DSP_Write_DMem16(DSP_RemainBuffer,0x0000);   
 545   2      
 546   2              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;      
 547   2              L2_DSP_Write_DMem24(DSP_WMASectorOffset,(gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoi
             -nt>>9));      
 548   2              L2_DSP_Write_DMem16(DSP_DecodeStatus,0x0000);
 549   2              L2_DSP_Write_DMem16(DSP_WMARandomFlag,0x0001);   //set random flag
 550   2              tc_iloop = 0;
 551   2      
 552   2              do
 553   2              {
 554   3                  if (DOS_Read_File(C_MusicFHandle) == DOS_END_OF_FILE)
 555   3                  {
 556   4                      return DSP_DATAIN_COMMAND_ERROR;
 557   4                  }
 558   3      
 559   3                  L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x20, (U16)gc_PlayRecordDataBuf, DMA_24BIT_
             -MODE);
 560   3                  L2_DSP_SendCommandSet(DCMD_DatIn); 
 561   3      
 562   3                  tc_iloop ++;
 563   3              }while(tc_iloop!=5);
 564   2      
 565   2          }
 566   1          return DSP_SUCCESS; 
 567   1      }
 568          
 569          
 570          U8 WMA_DataIn(void)  //20090803 chiayen modify
 571          {
 572   1              xdata   U8  tc_errbs;
 573   1      
 574   1      /* Error Bitstream Process */
 575   1          tc_errbs = WMA_err_bs_proc();
 576   1      
 577   1          if(tc_errbs == DSP_USER_FILE_TYPE_ERROR || tc_errbs == DSP_RUNNING_STATUS1_ERROR)
 578   1          {
 579   2              return DSP_DATAIN_COMMAND_ERROR;
 580   2          }   
 581   1      
 582   1          while (L2_DSP_Read_DMem16(DSP_EmptyBuffer) > 512) //wei.tang modify 081024  //for test play WMA file 0
             -81024
 583   1          {
 584   2              if (DOS_Read_File(C_MusicFHandle) == DOS_END_OF_FILE)
 585   2              {
 586   3                  return DSP_DATAIN_COMMAND_ERROR;
 587   3              }
 588   2      
 589   2              L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x20, (U16)gc_PlayRecordDataBuf, DMA_24BIT_MODE
             -);
 590   2              L2_DSP_SendCommandSet(DCMD_DatIn);
 591   2      
 592   2              if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 30)  //20090420 chiayen modify 36->30
 593   2                      {
 594   3                  gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // DM Range: 0x2000 ~  0x37FF
 595   3              }
 596   2          }
 597   1          return  DSP_SUCCESS;
 598   1      }
 599          
 600          
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 11  

 601          U16 WMA_ReadTime(void)
 602          {
 603   1          U32 tw_cur_time_h;
 604   1              U32     tw_cur_time;
 605   1      
 606   1          tw_cur_time_h = L2_DSP_Read_DMem24(DSP_WMACurrenTimeHigh);
 607   1          tw_cur_time = L2_DSP_Read_DMem24(DSP_WMACurrenTimeLow) + (tw_cur_time_h<<24);
 608   1      
 609   1          return(tw_cur_time / 1000);    
 610   1      }
 611          
 612          
 613          U16 WMA_Bitrate(void)
 614          {
 615   1          return(L2_DSP_Read_DMem16(DSP_WMABitrate));
 616   1      }
 617          
 618          
 619          U8 WMA_EOF_Proc(void)
 620          {    
 621   1          data        U8  tc_wma_eof_cnt = 0;
 622   1              data    U16 tw_DSP_RemainBufPrev = 0;
 623   1          xdata       U16 tw_bs_buf_remain;
 624   1          xdata       U16 tw_DSP_dec_status;
 625   1          
 626   1          tw_bs_buf_remain = L2_DSP_Read_DMem16(DSP_RemainBuffer);
 627   1      
 628   1          if(tw_bs_buf_remain == tw_DSP_RemainBufPrev)
 629   1              {
 630   2              tc_wma_eof_cnt ++;
 631   2              }   
 632   1          else
 633   1          {
 634   2              tw_DSP_RemainBufPrev = tw_bs_buf_remain;
 635   2              tc_wma_eof_cnt = 0;
 636   2          }    
 637   1          tw_DSP_dec_status = L2_DSP_Read_DMem16(DSP_DecodeStatus) & 0xC0;
 638   1      
 639   1          if( tw_DSP_dec_status || (tc_wma_eof_cnt >=10) )
 640   1          {
 641   2              L2_DSP_Write_DMem16(DSP_DecodeStatus, tw_DSP_dec_status|0xC0 );//挨F磷Kぇ岐play_stop hang
 642   2              
 643   2              return 1;
 644   2          }
 645   1          
 646   1          return 0;   
 647   1      }
 648          
 649          
 650          U8 Music_PlayCmd(void)
 651          {
 652   1          // sent "PLAY" command to DSP
 653   1          if(L2_DSP_SendCommandSet(DCMD_Play) != DCMD_Play)
 654   1          {
 655   2              return DSP_PLAY_COMMAND_ERROR;
 656   2          }
 657   1      
 658   1          if(gc_Play_FileType!=1)                  //(Jimi 091028)wma do not need to reset bitstream address cuz
             - the asf parser is contiguous to wma decoder 
 659   1          {
 660   2              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // reset bitstream address of DM//(Jimi 091104 mdf)
 661   2              // MP3 file open        
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 12  

 662   2              if(DOS_Open_File_r(C_MusicFHandle, C_Open_FoundFile, C_NullFileName))
 663   2                  {
 664   3                  return DSP_PLAY_COMMAND_ERROR;
 665   3                  }
 666   2          }
 667   1      
 668   1          return DSP_SUCCESS;
 669   1      }
 670          
 671          
 672          void Music_VolumeUpCmd(void)
 673          {
 674   1          if (gs_DSP_GLOBAL_RAM.sw_Volume<50)
 675   1          {
 676   2              gs_DSP_GLOBAL_RAM.sw_Volume+=2;
 677   2          }
 678   1          L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sw_Volume);     // Vloume Range:0~63
 679   1      }
 680          
 681          
 682          void Music_SetVolumeCmd(void)
 683          {
 684   1          L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sw_Volume);
 685   1      }
 686          
 687          
 688          void Music_VolumeDownCmd(void)
 689          {
 690   1          if (gs_DSP_GLOBAL_RAM.sw_Volume>1)
 691   1          {
 692   2              gs_DSP_GLOBAL_RAM.sw_Volume-=2;
 693   2          }
 694   1          L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sw_Volume);     // Vloume Range:0~63
 695   1      }
 696          
 697          
 698          U8 Music_PauseCmd(void)  //20090803 chiayen modify
 699          {   
 700   1          data        U8  tc_Ret;
 701   1              data    U16     TimeOUT;
 702   1      
 703   1          Music_WakeUp(DSP_CLK_CTRL | SRAM2T_CTRL);
 704   1              tc_Ret=DSP_PauseCmd();
 705   1              TimeOUT=0xFFFF;
 706   1      
 707   1              if(gc_Play_FileType==0)
 708   1              {
 709   2                      do
 710   2                      {
 711   3                              TimeOUT--;
 712   3                              if (TimeOUT == 0)
 713   3                              {
 714   4                                      return DSP_RUNNING_STATUS1_ERROR;
 715   4                              }
 716   3                      } while (!(L2_DSP_Read_DMem16(DSP_RunningStatus)&0x0002));
 717   2              }
 718   1              else
 719   1              {
 720   2                      do
 721   2                      {
 722   3                              TimeOUT--;
 723   3                              if (TimeOUT == 0)
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 13  

 724   3                              {
 725   4                                      return DSP_RUNNING_STATUS1_ERROR;
 726   4                              }
 727   3                      } while (!L2_DSP_Read_DMem16(DSP_RampDownComplete)); //H1226 DSP_RampDownComplete = 0x3FB8, indicates Ra
             -mpDown OK or NOT
 728   2              }
 729   1      
 730   1              return tc_Ret;
 731   1      }
 732          
 733          
 734          U8 Music_ResumeCmd(void)
 735          {
 736   1          Music_WakeUp(DSP_CLK_CTRL | SRAM2T_CTRL);
 737   1      
 738   1          if(L2_DSP_SendCommandSet(DCMD_Play) != DCMD_Play)
 739   1          {
 740   2              return DSP_PLAY_COMMAND_ERROR;
 741   2          }
 742   1          return DSP_SUCCESS;
 743   1      }
 744          
 745          
 746          U8 Music_StopCmd(U8 tc_FileHandle)
 747          {
 748   1              data    U8  tc_Ret;
 749   1              data    U8      tc_value;
 750   1              data    U16 tw_temp;
 751   1              data    U16 dbgTmp;
 752   1      
 753   1          Music_WakeUp(DSP_CLK_CTRL | SRAM2T_CTRL);
 754   1          tc_Ret = DSP_StopCmd();
 755   1      
 756   1          // Reset decode status
 757   1              tw_temp=0xffff;
 758   1              do
 759   1              {
 760   2                      tw_temp --;
 761   2                      if(tw_temp==0)
 762   2                      {
 763   3                              tc_Ret = DSP_DECODE_STATUS_TIMEOUT_ERROR;
 764   3                              break;
 765   3                      }
 766   2              }while(!((L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)==0x00C0));  //wait file end
 767   1      
 768   1              tw_temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 769   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,tw_temp&0xFF3F);
 770   1      
 771   1          // Close current file
 772   1              DOS_Close_File_r(tc_FileHandle);
 773   1      
 774   1              // wait for ramp down ok and Turn off DSP clock, ycc 081113
 775   1              tw_temp=0xFFFF;
 776   1              while(1)
 777   1              {
 778   2                      dbgTmp=L2_DSP_Read_DMem16(DSP_RestartFlag);  //read DSP 0x3F0B.0 ready status
 779   2                      tw_temp--;     
 780   2                      if((tw_temp==0)||(dbgTmp==0))
 781   2                      {           
 782   3                              break; 
 783   3                      } 
 784   2              }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 14  

 785   1              tc_value=XBYTE[0xB010] & 0xFE;
 786   1              XBYTE[0xB010] = tc_value;   
 787   1      
 788   1              return tc_Ret;
 789   1      }
 790          
 791          //===============  UI flow  =================
 792          void Idle_Disp_Icon()
 793          {   
 794   1          gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType;
 795   1      
 796   1          if(gc_Play_FileType==0)
 797   1          {
 798   2              gs_System_State.w_BitRate=MP3_Bitrate_Parser();
 799   2              gw_TotalSec = MP3_Total_Time_Parser();//(JC)H0630 LCM test
 800   2          }
 801   1          else if(gc_Play_FileType==1)
 802   1          {
 803   2              WMA_ASF_Parser();
 804   2          }
 805   1      
 806   1          DOS_GetLongFileName(0, gc_FileLongName);
 807   1      }
 808          
 809          
 810          void play_idle()
 811          {
 812   1          
 813   1      }
 814          
 815          
 816          void UI_LRCTrigger(U8 tc_line,U8 width,U16 index,struct string_view_t code * p_str)
 817          {
 818   1              U8 tc_y;
 819   1      
 820   1              tc_y= p_str->c_view_y +  p_str->c_row_spacing*tc_line;
 821   1              LCM_set_view(TFT_HZKDispDir, p_str->c_view_x, tc_y, p_str->c_view_width, 16); 
 822   1              TFT_disp_SongName(width,&(gc_BmpString[index]));
 823   1      }
 824          
 825          
 826          void UI_FulllcdDis_Lrc()//if the filename beyond the lcd ,so rolling ,the same with lrc
 827          {
 828   1              code U8 Lrc_NoContent[11]={0x20,0x20,0x20,0x20,0x4E,0x6F,0x20,0x4C,0x52,0x43};
 829   1      
 830   1              TFT_LRCBackGround();
 831   1              if(gb_LrcFileName_Exist==1)
 832   1              {
 833   2                      LRC_DisplayString(&gc_LrcDisplayBuf[0],gc_LrcCurrentLen,0);     //ROW 0 
 834   2                      LRC_DisplayString(&gc_LrcDisplayBuf[60],gc_LrcCurrentLenNext,1); //ROW 1                
 835   2              }
 836   1              else
 837   1              {
 838   2                      LRC_DisplayString(&Lrc_NoContent,10,0); //ROW 0 
 839   2              }
 840   1      }
 841          
 842          
 843          U8 LRC_DisplayString(U8 *tpc_DataBuf, U8 tw_nByte,U8 tc_RowAddr) 
 844          {
 845   1              data    U8      i=0;
 846   1              data    U8      tc_line=0;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 15  

 847   1              data    U8      line_limit;
 848   1              data    U8      tc_ColumnNum;
 849   1              data    U16 tw_Width;
 850   1              data    U16 tw_WidthPre=0;
 851   1              data    U16 tw_BmpInxPre;
 852   1              data    U16 tw_BmpInx=0;        
 853   1              code struct string_view_t tp_lrc[2]={ 8, 4,144,20,              //for Low1 
 854   1                                                                                    8,68,144,20};             //foe Low2
 855   1      
 856   1              gb_LRCDispLevel=(bit)tc_RowAddr;
 857   1      
 858   1              gw_BmpInx               =0;
 859   1              tw_Width                =0;  
 860   1              line_limit= tp_lrc[tc_RowAddr].c_view_width;
 861   1      
 862   1              while (i<tw_nByte)
 863   1              {
 864   2                      tc_ColumnNum = UNICODE_HZK_GET_BMP(*(tpc_DataBuf+i),*(tpc_DataBuf+i+1),&(gc_BmpString[gw_BmpInx]),1);//f
             -or ANSI only
 865   2      
 866   2                      tw_Width += (tc_ColumnNum&0x7f);
 867   2      
 868   2      
 869   2                      if(tw_Width > line_limit )
 870   2                      {
 871   3                              UI_LRCTrigger(tc_line,tw_WidthPre,tw_BmpInx,&tp_lrc[tc_RowAddr]);
 872   3                              tc_line++;
 873   3                              if(tc_line>=D_LrcNum)
 874   3                              {
 875   4                                      return(tw_nByte-i);                             
 876   4                              }
 877   3                              tw_BmpInx=tw_BmpInxPre; //record new BMP Index
 878   3      
 879   3                              tw_Width=tc_ColumnNum&0x7f;
 880   3                      }
 881   2                      tw_WidthPre=tw_Width;
 882   2                      tw_BmpInxPre=gw_BmpInx;
 883   2      
 884   2                      if (tc_ColumnNum&0x80)
 885   2                      {
 886   3                              i+=2;
 887   3                      }
 888   2                      else
 889   2                      {
 890   3                              i+=1;
 891   3                      }
 892   2              }
 893   1      
 894   1              while(tc_line<D_LrcNum)
 895   1              {
 896   2                      UI_LRCTrigger(tc_line,tw_WidthPre,tw_BmpInx,&tp_lrc[tc_RowAddr]);
 897   2                      tw_WidthPre=0;
 898   2                      tc_line++;
 899   2              }
 900   1      }
 901          
 902          
 903          void play_proc()
 904          {
 905   1          bit tb_settime_status;
 906   1      
 907   1          gc_KeyDet_Mask=0;  //20090107 chiayen modify
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 16  

 908   1      
 909   1      //    if ( (gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_B) || (gs_File_FCB[gs_System_State.c_FileHan
             -dle].dw_File_DataPoint<=gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint) )
 910   1          {   // normal play
 911   2                      gw_Disp_CurrentSec=(*Music_ReadTime[gc_Play_FileType])();
 912   2                              
 913   2                      if(gw_Disp_CurrentSec!=gw_PrevTimeSec)
 914   2                      {
 915   3                              gw_PrevTimeSec=gw_Disp_CurrentSec;
 916   3                              tb_settime_status=0;
 917   3                      }
 918   2                      else
 919   2                      {
 920   3                              tb_settime_status=1;
 921   3                      }
 922   2           
 923   2              if(gb_LrcFileName_Exist==1)
 924   2              {
 925   3                  if(!tb_settime_status)
 926   3                  {
 927   4                      Lyric_GetTimeStamp();
 928   4                      if(gb_LrcGetTimeOrNot)
 929   4                      {
 930   5                          gb_LrcGetTimeOrNot=0;
 931   5                          Lyric_GetLyrics();
 932   5      
 933   5                                              if(gb_LrcGetTimeNextOrNot)
 934   5                                              {   
 935   6                                                      gb_LrcGetTimeNextOrNot=0;
 936   6                                                      Lyric_NextGetLyrics();
 937   6                                              }
 938   5      
 939   5                                              if((gw_IR_Timer==0) && (gc_ShowTimer==0))
 940   5                                              {
 941   6                                                      UI_FulllcdDis_Lrc();
 942   6                                              }
 943   5                                      }
 944   4                  }
 945   3              }
 946   2             
 947   2              if ((*Music_Data_In[gc_Play_FileType])()!=0)// 0727
 948   2              {
 949   3                  gc_PhaseInx = 2;    //End of File for play
 950   3                  return;//(JC)H0620
 951   3              }
 952   2              
 953   2              if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_B)
 954   2              {
 955   3                  if(gc_RepPlayMode==4)
 956   3                  {
 957   4                      if((*Music_ReadTime[gc_Play_FileType])()>10)
 958   4                      {
 959   5                          gc_PhaseInx = 2;
 960   5                          return;
 961   5                      }
 962   4                  }
 963   3              }
 964   2          }
 965   1      
 966   1              if(gc_EQChangeFlag==1) //20090106 chiayen add
 967   1              {
 968   2                      Music_EQ_Cmd(gs_DSP_GLOBAL_RAM.sc_EQ_Type);  
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 17  

 969   2                      gc_EQChangeFlag=0;
 970   2              } 
 971   1      }
 972          
 973          
 974          void play_playpause()
 975          { 
 976   1              U32 tdw_File_StartCluster;  //20090106 chiayen add
 977   1              U32 tdw_FDB_LogAdd;  //20090106 chiayen add
 978   1              U8 i;
 979   1              gc_PlayMenu_IR=0;
 980   1      
 981   1              #if BankingCode_Recover
 982   1          if(gbt_Code_NeedRecover)
 983   1              {
 984   2                      U8      tc_Reg_Status,tc_CE;
 985   2      //              dbprintf("code recover \n");
 986   2                      tc_Reg_Status =DEVICE_REG[0x00];
 987   2                      DEVICE_REG[0x00]= 0x01; 
 988   2                      tc_CE= FDBP.cFDev;
 989   2                      for(gc_Global_I =0; gc_Global_I<gc_CodeBlock_Num;gc_Global_I++)
 990   2                      {
 991   3                              gw_SourceBlock = Bank_Block_A[gc_Global_I];
 992   3                              gw_TargetBlock = Bank_Block_B[gc_Global_I];
 993   3                              FDBP.cFDev=0;
 994   3                              FDBP.cFPlane=0;
 995   3                              FDBP.wFBlock = gw_TargetBlock;
 996   3                              Flash_EraseOneBlock();                  
 997   3                              FLASH_Backup_Blcok(0,NAND_INFO.wPAGE_NUM,4,0);// 4-->bank  mark 
 998   3                      }
 999   2                      gbt_Code_NeedRecover=0;
1000   2                      DEVICE_REG[0x00]=tc_Reg_Status ;
1001   2                      FDBP.cFDev = tc_CE;
1002   2              }
1003   1              #endif
1004   1      
1005   1          if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_AB_NULL)
1006   1          {
1007   2              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB_NULL;
1008   2              gc_PhaseInx=1;
1009   2              return;
1010   2          }
1011   1          if(gs_System_State.c_Phase == TASK_PHASE_PLAYACT)
1012   1          {
1013   2              Music_PauseCmd();
1014   2              gs_System_State.c_Phase = TASK_PHASE_PAUSE;
1015   2          }
1016   1          else if(gs_System_State.c_Phase == TASK_PHASE_PAUSE)
1017   1          {
1018   2              Music_ResumeCmd();
1019   2              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1020   2          }
1021   1          else if ((gs_System_State.c_Phase == TASK_PHASE_FASTFWD)||(gs_System_State.c_Phase==TASK_PHASE_FASTREV
             -))
1022   1          {
1023   2              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // reset bitstream address of DM
1024   2              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1025   2          }
1026   1          else
1027   1          {
1028   2              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1029   2              DOS_GetLongFileName(0,gc_FileLongName);
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 18  

1030   2              gb_LrcFileName_Exist=Lyric_FileSearch();//(JC)Lyric file exist?
1031   2              for(i=0;i<100;i++) //sunzhk add
1032   2              { 
1033   3                 gc_LrcDisplayBuf[i]=0x20;            
1034   3              } 
1035   2      
1036   2      
1037   2                      if(gb_LrcFileName_Exist==1)
1038   2                      {
1039   3                              TFT_LRCBackGround();
1040   3                      }
1041   2              gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType;
1042   2              
1043   2              if(gc_Play_FileType==0)//(JC)MP3
1044   2              {
1045   3                              if(gb_LrcFileName_Exist==1)
1046   3                              {
1047   4                                      set_clock_mode(CLOCK_MODE_MP3L);
1048   4                              }
1049   3                              else
1050   3                              {
1051   4                      set_clock_mode(CLOCK_MODE_MP3);
1052   4                              }
1053   3              }
1054   2              else if((gc_Play_FileType==1))//(JC)WMA //Jimi: gc_Play_FileType==2 ==>WMV
1055   2              {
1056   3                  set_clock_mode(CLOCK_MODE_WMA);
1057   3              }
1058   2      
1059   2                      Music_WakeUp(DSP_CLK_CTRL | SRAM2T_CTRL);
1060   2      
1061   2                      if((*Music_Download[gc_Play_FileType])())    // 材@Ω磅娈森n更J IM, PM    //Jimi Yu 080509
1062   2              {
1063   3                  gc_PhaseInx=2;                          // when wma 
1064   3                  return; 
1065   3              }
1066   2              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // reset bitstream address of DM
1067   2                      gw_Disp_CurrentSec=0;
1068   2      
1069   2                      if(gc_VolumeMute==0)
1070   2                      {
1071   3                      Music_SetVolumeCmd();
1072   3                      }
1073   2                      else
1074   2                      {
1075   3                              L2_DSP_Write_DMem16(DSP_VolumeControl,0);//20090812 chiayen add VOL=0   
1076   3                      }
1077   2      
1078   2                      //Jimi 081208
1079   2                      L2_DSP_Write_DMem16(DSP_PostProcessSelect, L2_DSP_Read_DMem16(DSP_PostProcessSelect)|0x0020);
1080   2                      {
1081   3                              U8 tc_timeout = 0xFF;
1082   3                              while( (L2_DSP_Read_DMem16(DSP_PostProcessSelect)&0x0020))      //Handshake with DSP to make sure that DSP h
             -as ramp digital volume up.
1083   3                              {
1084   4                                      if (!(tc_timeout--))
1085   4                                              break;
1086   4                              }
1087   3                      }
1088   2      
1089   2              Music_EQ_Cmd(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
1090   2      
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 19  

1091   2                      if(gb_DirPlay_Flag==1)  //20090106 chiayen add
1092   2              {
1093   3                              tdw_File_StartCluster=gs_File_FCB[gs_System_State.c_FileHandle].dw_File_StartCluster;
1094   3                              tdw_FDB_LogAdd=gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_LogAdd;
1095   3                              DOS_Search_File(C_File_OneDir|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);
1096   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_StartCluster=tdw_File_StartCluster;
1097   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_LogAdd=tdw_FDB_LogAdd;
1098   3                      }
1099   2      
1100   2              if(gc_Play_FileType==0)
1101   2              {
1102   3                  gs_System_State.w_BitRate=MP3_Bitrate_Parser();
1103   3                  gw_TotalSec = MP3_Total_Time_Parser();//(JC)H0630 LCM test
1104   3              }
1105   2              else if(gc_Play_FileType==1)
1106   2              {
1107   3                  WMA_ASF_Parser();
1108   3              }
1109   2      
1110   2      
1111   2              if(Music_PlayCmd()==DSP_PLAY_COMMAND_ERROR)
1112   2              {
1113   3                  //(JC)H0521; pls check if error handle needed
1114   3                  gc_PhaseInx=5;  //20081219 chiayen modify for 0Byte mp3
1115   3                  return;
1116   3              }
1117   2              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode = REPEAT_AB_NULL; // CΩs冀@害饱亍A常nр RepeatAB 
             -m
1118   2          }
1119   1      
1120   1              gc_ShowTimer=0;
1121   1              gc_TuneVolFreqStatus=0;
1122   1          gc_PhaseInx=1;
1123   1      }
1124          
1125          
1126          
1127          void play_stop()
1128          {
1129   1          if(gs_System_State.c_Phase != TASK_PHASE_STOP)
1130   1          {           
1131   2              U8 tc_Ret = Music_StopCmd(gs_System_State.c_FileHandle);
1132   2              gs_System_State.c_Phase = TASK_PHASE_STOP;
1133   2              gc_PhaseInx=9;
1134   2          }
1135   1      }
1136          
1137          
1138          void RandomGetFileIndex(void)
1139          {
1140   1          xdata       U16 tw_Num;
1141   1      
1142   1          tw_Num=(gw_Random_Timer%gw_FileTotalNumber[gs_System_State.c_FileHandle])+1;
1143   1          
1144   1          if(gw_FileIndex[gs_System_State.c_FileHandle]==tw_Num)
1145   1          {
1146   2              gw_FileSkipNumber = 0;
1147   2          }
1148   1          else
1149   1          {
1150   2              if (gw_FileIndex[gs_System_State.c_FileHandle] > tw_Num)
1151   2              {
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 20  

1152   3                  gw_FileSkipNumber=gw_FileTotalNumber[gs_System_State.c_FileHandle] - (gw_FileIndex[gs_System_S
             -tate.c_FileHandle] - tw_Num);
1153   3              }
1154   2              else
1155   2              {
1156   3                  gw_FileSkipNumber=(tw_Num - gw_FileIndex[gs_System_State.c_FileHandle]);
1157   3              }
1158   2          }
1159   1      }
1160          
1161          
1162          void play_endfile()
1163          {
1164   1          U32 tdw_FDB_LogAddr;
1165   1          
1166   1          play_SetTime2DisplayBuf((*Music_ReadTime[gc_Play_FileType])());//Jimi 080804
1167   1      
1168   1          if( (*Music_EOF_Proc[gc_Play_FileType])() ) //Jimi 080522
1169   1          {
1170   2              play_stop();
1171   2              //============== test cyclic ==============
1172   2              if(gc_RepPlayMode==C_NoRepeat)//(JC)no repeat
1173   2              {
1174   3                  //gc_PhaseInx=9;
1175   3                  if(gw_FileIndex[gs_System_State.c_FileHandle]==gw_FileTotalNumber[gs_System_State.c_FileHandle
             -])
1176   3                  {
1177   4                      //gc_PhaseInx=9;
1178   4                                      gw_Disp_CurrentSecBak=0xFFFF;
1179   4                                      gw_Disp_CurrentSec=0;
1180   4                                  gc_PhaseInx=C_PlayNext;
1181   4                  }
1182   3                              else
1183   3                              {
1184   4                                      if(gb_DirPlay_Flag==1) //20090107 chiayen add
1185   4                                      {
1186   5                                              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1187   5                                      }
1188   4                                      else
1189   4                                      {
1190   5                              DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType,C_CmpExtName|C_Next);
1191   5                                      }
1192   4                          gc_PhaseInx=3;                              
1193   4                              }  
1194   3              }
1195   2              else if(gc_RepPlayMode==C_RepeatOne)//(JC)repeat one
1196   2              {
1197   3                  gc_PhaseInx=3;      
1198   3              }
1199   2              else if(gc_RepPlayMode==C_RepeatAll||gc_RepPlayMode==C_IntroPlay)//(JC)repeat all || introduction
1200   2              {
1201   3                              if(gb_DirPlay_Flag==1) //20090107 chiayen add
1202   3                              {
1203   4                                      DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1204   4                              }
1205   3                              else
1206   3                              {
1207   4                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType,C_CmpExtName|C_Next);
1208   4                              }
1209   3                  gc_PhaseInx=3;
1210   3              }
1211   2              else if(gc_RepPlayMode==C_RandomPlay)//(JC)random
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 21  

1212   2              {
1213   3                  RandomGetFileIndex();
1214   3                              if(gb_DirPlay_Flag==1) //20081226 chiayen add
1215   3                              {
1216   4                                      gb_TriggerFileSkip=1;
1217   4                                      DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1218   4                                      gb_TriggerFileSkip=0;
1219   4                              }
1220   3                              else
1221   3                              {
1222   4                                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1223   4                              }
1224   3                  gc_PhaseInx=3;
1225   3              }
1226   2              else if(gc_RepPlayMode==C_InDirRepeat)//(JC)repeat in a dir
1227   2              {
1228   3                  DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1229   3                  gc_PhaseInx=3;
1230   3              }
1231   2              else if(gc_RepPlayMode==C_InDirPlay)
1232   2              {
1233   3                  tdw_FDB_LogAddr=gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_LogAdd;
1234   3                  DOS_Search_File(C_File_OneDir|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);
1235   3                  gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_LogAdd=tdw_FDB_LogAddr;
1236   3                  if(gw_FileIndex[gs_System_State.c_FileHandle]==gw_FileTotalNumber[gs_System_State.c_FileHandle
             -])
1237   3                  {
1238   4                      gc_PhaseInx=1;  
1239   4                  }
1240   3                  else
1241   3                  {
1242   4                      DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1243   4                      gc_PhaseInx=3;
1244   4                  }   
1245   3              }
1246   2              //============== test cyclic ============== 
1247   2          }
1248   1      }
1249          
1250          
1251          void play_next()
1252          {
1253   1          data        U8 tc_playmode_status;
1254   1      
1255   1              gw_CurrentSec = 0;
1256   1          tc_playmode_status=gc_RepPlayMode;
1257   1          if(gb_PickSong==1 && gc_RepPlayMode==C_RandomPlay)
1258   1          {
1259   2              gc_RepPlayMode=2;
1260   2          }
1261   1      
1262   1          if(gs_System_State.c_Phase==TASK_PHASE_STOP)
1263   1          {
1264   2              if(gw_FileIndex[gs_System_State.c_FileHandle]==0)
1265   2                      {
1266   3                  return;//if no this line,error will happen
1267   3                      }
1268   2              gc_PhaseInx=9;        
1269   2          }
1270   1          else if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
1271   1          {
1272   2              gc_PhaseInx=3;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 22  

1273   2              gc_KeyDet_Mask=1;//(JC)H0508 avoid key-press to change phase index  //20090107 chiayen modify  
1274   2          }
1275   1          else if(gs_System_State.c_Phase==TASK_PHASE_PAUSE)
1276   1          {
1277   2              gc_PhaseInx=9;
1278   2          }
1279   1      
1280   1          if(gs_System_State.c_Phase!=TASK_PHASE_STOP)//(JC)H0505
1281   1          {
1282   2              U8 tc_Ret = Music_StopCmd(gs_System_State.c_FileHandle);
1283   2              gs_System_State.c_Phase=TASK_PHASE_STOP;
1284   2          }
1285   1      
1286   1          if((gc_RepPlayMode==C_InDirRepeat)||(gc_RepPlayMode==C_InDirPlay))
1287   1          {
1288   2              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);  
1289   2          }
1290   1          else if(gc_RepPlayMode==C_RandomPlay)//Ching 080805
1291   1          {
1292   2              RandomGetFileIndex();
1293   2                      if(gb_DirPlay_Flag==1) //20081226 chiayen add
1294   2                      {
1295   3                              gb_TriggerFileSkip=1;
1296   3                              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1297   3                              gb_TriggerFileSkip=0;
1298   3                      }
1299   2                      else
1300   2                      {
1301   3                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1302   3                  }
1303   2          }
1304   1          else
1305   1          {           
1306   2                      if(gb_DirPlay_Flag==1) //20090107 chiayen add
1307   2                      {
1308   3                              gb_TriggerFileSkip=1;
1309   3                              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1310   3                              gb_TriggerFileSkip=0;
1311   3                      }
1312   2                  else
1313   2                  {
1314   3                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1315   3                  }
1316   2          }
1317   1      
1318   1          gs_System_State.c_Phase=TASK_PHASE_STOP;
1319   1              gc_TuneVolFreqStatus=0;
1320   1          gc_RepPlayMode=tc_playmode_status;
1321   1          Idle_Disp_Icon();
1322   1      }
1323          
1324          
1325          void play_prev()
1326          {
1327   1              gw_CurrentSec = 0;
1328   1          if(gs_System_State.c_Phase==TASK_PHASE_STOP)
1329   1          {
1330   2              if(gw_FileIndex[gs_System_State.c_FileHandle]==0)
1331   2                      {
1332   3                  return;//if no this line,error will happen
1333   3                      }
1334   2              gc_PhaseInx=9;        
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 23  

1335   2          }
1336   1          else if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
1337   1          {
1338   2              gc_PhaseInx=3;
1339   2              gc_KeyDet_Mask=1;//(JC)H0508 avoid key-press to change phase index //20090107 chiayen modify     
1340   2          }
1341   1          else if(gs_System_State.c_Phase==TASK_PHASE_PAUSE)
1342   1          {
1343   2              gc_PhaseInx=9;        
1344   2          }
1345   1          
1346   1          if(gs_System_State.c_Phase!=TASK_PHASE_STOP)//(JC)H0505
1347   1          {
1348   2              U8 tc_Ret = Music_StopCmd(gs_System_State.c_FileHandle);
1349   2              gs_System_State.c_Phase=TASK_PHASE_STOP;
1350   2          }
1351   1      
1352   1          if((gc_RepPlayMode==C_InDirRepeat)||(gc_RepPlayMode==C_InDirPlay))
1353   1          {
1354   2              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Prev);
1355   2          }
1356   1          else if(gc_RepPlayMode==C_RandomPlay)//Ching 080805
1357   1          {
1358   2              RandomGetFileIndex();
1359   2                      if(gb_DirPlay_Flag==1) //20090107 chiayen add
1360   2                      {
1361   3                              gb_TriggerFileSkip=1;
1362   3                              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1363   3                              gb_TriggerFileSkip=0;
1364   3                      }
1365   2                      else
1366   2                      {
1367   3                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Next);
1368   3                  }
1369   2          }
1370   1          else
1371   1          {
1372   2                      if(gb_DirPlay_Flag==1) //20090107 chiayen add 
1373   2                      {
1374   3                              gb_TriggerFileSkip=1;
1375   3                              DOS_Search_File(C_File_OneDir|C_By_FDB, C_MusicFileType, C_CmpExtName|C_Prev);
1376   3                              gb_TriggerFileSkip=0;
1377   3                      }
1378   2                  else
1379   2                  {
1380   3                      DOS_Search_File(C_File_All|C_By_FDB, C_MusicFileType,C_CmpExtName|C_Prev);
1381   3                  }
1382   2          }
1383   1      
1384   1          gs_System_State.c_Phase=TASK_PHASE_STOP;
1385   1      
1386   1              gc_TuneVolFreqStatus=0;
1387   1          Idle_Disp_Icon();
1388   1      }
1389          
1390          void play_volup()
1391          {
1392   1          gw_LogData_Timer=60; 
1393   1          gc_ShowTimer=72;       
1394   1          gb_Frequency_Song=1;    // 0=Show Frequency    1=Show Song Number/EQ
1395   1          gc_SelectVol=1;         // 1=Show Vol
1396   1          gb_SelectEQ=0;          // 0=Show Song Number  1=Show EQ
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 24  

1397   1          gc_VolumeMute=0;
1398   1      
1399   1          if (gs_DSP_GLOBAL_RAM.sw_Volume<50)
1400   1          {
1401   2            gs_DSP_GLOBAL_RAM.sw_Volume+=2;
1402   2            L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sw_Volume);     // Vloume Range:0~63
1403   2          }
1404   1              gc_TuneVolFreqStatus=1;
1405   1          gc_PhaseInx=1;
1406   1      }
1407          
1408          
1409          void play_voldn()
1410          {
1411   1          gw_LogData_Timer=60;
1412   1          gc_ShowTimer=72;
1413   1          gb_Frequency_Song=1;    // 0=Show Frequency    1=Show Song Number/EQ
1414   1          gc_SelectVol=1;         // 1=Show Vol
1415   1          gb_SelectEQ=0;          // 0=Show Song Number  1=Show EQ
1416   1          gc_VolumeMute=0;
1417   1          if (gs_DSP_GLOBAL_RAM.sw_Volume>1)
1418   1          {
1419   2              gs_DSP_GLOBAL_RAM.sw_Volume-=2;
1420   2                      L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sw_Volume);     // Vloume Range:0~63
1421   2          }
1422   1              gc_TuneVolFreqStatus=1;
1423   1          gc_PhaseInx=1;  
1424   1      }
1425          
1426          
1427          void play_back2uplevel()
1428          {
1429   1          if((gs_System_State.c_Phase==TASK_PHASE_PLAYACT)||(gs_System_State.c_Phase==TASK_PHASE_PAUSE))
1430   1          {
1431   2              play_stop();    
1432   2          }
1433   1          gc_Task_Next=C_Task_Menu;
1434   1          gw_init_needed |= SET_BIT8;
1435   1          gc_PhaseInx=0;
1436   1      }
1437          
1438          
1439          UBYTE play_SetTime2DisplayBuf(U16 tw_TimeSec)
1440          {
1441   1          if(gw_PrevTimeSec != tw_TimeSec)
1442   1          {
1443   2              gw_PrevTimeSec=tw_TimeSec;
1444   2              return 0;
1445   2          }
1446   1          return 1;
1447   1      }
1448          
1449          
1450          void FM_FREQ_CHGUP(void) //chiayen0807
1451          {
1452   1          FM_FREQ_CHG(1,1);
1453   1          if(gs_System_State.c_Phase==TASK_PHASE_STOP)
1454   1          {
1455   2              gc_PhaseInx=0x09;   
1456   2          }
1457   1          else
1458   1          {
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 25  

1459   2              gc_PhaseInx=1;
1460   2          }
1461   1      }
1462          
1463          
1464          void FM_FREQ_CHGDOWN(void) //chiayen0807
1465          {
1466   1          FM_FREQ_CHG(0,1);
1467   1          if(gs_System_State.c_Phase==TASK_PHASE_STOP)
1468   1          {
1469   2              gc_PhaseInx=0x09;   
1470   2          }
1471   1          else
1472   1          {
1473   2              gc_PhaseInx=1;
1474   2          }
1475   1      }
1476          
1477          
1478          void IR_Service_Process()
1479          {
1480   1          if(gc_IRCmdStatus!=0)
1481   1          {
1482   2                      if(gc_IRCmdStatus==1)  //20090216 chiayen add
1483   2                      {
1484   3                              gc_Dirchange_Timer=0;
1485   3                      }
1486   2              ir_service();
1487   2          }
1488   1      
1489   1          if((gw_IR_Timer==0) && (gw_irkey_count!=0))
1490   1          {
1491   2              if(gw_FileIndex[0]<gw_irkey_count)
1492   2              {
1493   3                  gw_FileSkipNumber=(gw_irkey_count-gw_FileIndex[0]);
1494   3                  play_next();
1495   3              }
1496   2              else if(gw_FileIndex[0]>gw_irkey_count)
1497   2              {
1498   3                  gw_FileSkipNumber=(gw_FileTotalNumber[0]-gw_FileIndex[0])+gw_irkey_count;
1499   3                  play_next();
1500   3              }
1501   2      
1502   2              gw_irkey_count=0;
1503   2          }   
1504   1      }
1505          
1506          
1507          void Play_SDFlash_DosInit()
1508          {
1509   1              U8  tc_clock_mode_backup;  //20090526 chiayen add
1510   1              tc_clock_mode_backup=gc_clock_mode;
1511   1      
1512   1              if (DOS_Initialize())
1513   1              {
1514   2                      // Initial Fail
1515   2                      XBYTE[0xB400]= 0x01;
1516   2                      gc_PhaseInx=9;
1517   2                      gc_Dosinitfail=1;
1518   2                      gdw_HOSTStartSectorRead=0xFFFFFFF0; //20090803 chiayen add
1519   2              }
1520   1              else
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 26  

1521   1              {               
1522   2                      gb_FindFlag = 0;
1523   2                      gc_PhaseInx=0;
1524   2                      gw_init_needed=0xFFFF;
1525   2                      if((gc_DirReBuildFlag != D_Valid) && (gc_CurrentCard==0))
1526   2                      {
1527   3                              set_clock_mode(CLOCK_MODE_MJPEG);  //20090803 chiayen move here for HOST 
1528   3                              DOS_DIRtable();  //20090216 chiayen add
1529   3                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
1530   3                      }       
1531   2                      gs_File_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;           
1532   2                      DOS_Search_File(C_File_All|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);//(JC)count music file no
             -. in root
1533   2                      gb_TFT_refresh=1;
1534   2                      gc_DispWallpaper=0xFF;
1535   2                      gc_ShowTimer=0;
1536   2                      gc_TuneVolFreqStatus=0;
1537   2              }
1538   1      }
1539          
1540          
1541          void Play_SourceDetect_Process()
1542          {
1543   1              gb_SD_Exist_pre=gb_SD_Exist;
1544   1              if(!SD_Detect)  //SD exist
1545   1          {
1546   2              gb_SD_Exist=1;
1547   2          }
1548   1              else
1549   1              {
1550   2                      gb_SD_Exist=0;
1551   2                      gb_SDNoFileflag=0;
1552   2              }
1553   1      
1554   1              gb_Host_Exist_pre=gb_Host_Exist;
1555   1              if(!Host_DetectDevice())
1556   1              {
1557   2                      gb_Host_Exist=1;        //host_exist            
1558   2              }
1559   1              else
1560   1              {
1561   2                      gb_Host_Exist=0;
1562   2                      gc_HostNoFileflag=0;
1563   2              }
1564   1      
1565   1              if((gc_CurrentCard==0) && ((gb_Host_Exist_pre!=gb_Host_Exist)||(gb_SD_Exist_pre!=gb_SD_Exist)))
1566   1              {
1567   2                      if((gb_Host_Exist_pre!=gb_Host_Exist) && (gb_Host_Exist==1))
1568   2                      {
1569   3                              gc_CurrentCard=5;
1570   3                      }
1571   2                      else if((gb_SD_Exist_pre!=gb_SD_Exist) && (gb_SD_Exist==1))
1572   2                      {
1573   3                              gc_CurrentCard=2;       
1574   3                      }
1575   2                      else
1576   2                      {
1577   3                              gc_CurrentCard=0;       
1578   3                      }
1579   2              }
1580   1              else
1581   1              {
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 27  

1582   2                      if(gc_CurrentCard==2)
1583   2                      {
1584   3                              if(gc_Dosinitfail==0)  //20090803 chiayen add
1585   3                              {
1586   4                                      if((gb_Host_Exist_pre!=gb_Host_Exist) && (gb_Host_Exist==1))
1587   4                                      {
1588   5                                              gc_CurrentCard=5;
1589   5                                      }
1590   4                                      else if(((gb_SD_Exist==0) || (gb_SDNoFileflag==1)) && (gb_Host_Exist==1))
1591   4                                      {
1592   5                                              gc_CurrentCard=5;
1593   5                                              if(gc_HostNoFileflag==1)
1594   5                                              {
1595   6                                                      gc_CurrentCard=0;       
1596   6                                              }
1597   5                                      }
1598   4                                      else if((gb_SD_Exist==0) || (gb_SDNoFileflag==1))
1599   4                                      {
1600   5                                              gc_CurrentCard=0;       
1601   5                                      }
1602   4                              }
1603   3                              else //20090803 chiayen add for SD Dos initial fail
1604   3                              {
1605   4                                      if((gb_Host_Exist==1) && (gc_HostNoFileflag==0))
1606   4                                      {
1607   5                                              gc_CurrentCard=5;
1608   5                                      }
1609   4                                      else
1610   4                                      {
1611   5                                              gc_CurrentCard=0;
1612   5                                      }
1613   4                                      gc_Dosinitfail=0;                               
1614   4                              }
1615   3                      }
1616   2                      if(gc_CurrentCard==5)
1617   2                      {
1618   3                              if(gc_Dosinitfail==0)  //20090803 chiayen add
1619   3                              {
1620   4                                      if((gb_SD_Exist_pre!=gb_SD_Exist) && (gb_SD_Exist==1))
1621   4                                      {
1622   5                                              gc_CurrentCard=2;
1623   5                                      }
1624   4                                      else if(((gb_Host_Exist==0) || (gc_HostNoFileflag==1)) && (gb_SD_Exist==1))
1625   4                                      {
1626   5                                              gc_CurrentCard=2;
1627   5                                              if(gb_SDNoFileflag==1)
1628   5                                              {
1629   6                                                      gc_CurrentCard=0;       
1630   6                                              }
1631   5                                      }
1632   4                                      else if((gb_Host_Exist==0) || (gc_HostNoFileflag==1))
1633   4                                      {
1634   5                                              gc_CurrentCard=0;       
1635   5                                      }
1636   4                              }
1637   3                              else //host dos initial fail  //20090803 chiayen add
1638   3                              {
1639   4                                      if((gb_SD_Exist==1) && (gb_SDNoFileflag==0))
1640   4                                      {
1641   5                                              gc_CurrentCard=2;
1642   5                                      }
1643   4                                      else
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 28  

1644   4                                      {
1645   5                                              gc_CurrentCard=0;
1646   5                                      }
1647   4                                      gc_Dosinitfail=0;
1648   4                              }
1649   3                      }
1650   2              }
1651   1      
1652   1          if(gc_CurrentCard_backup!=gc_CurrentCard)  //auto  //20090803 chiayen modify
1653   1          {
1654   2                      U8 tc_CurrentCard;//20090803 chiayen add for media change
1655   2                      tc_CurrentCard=gc_CurrentCard; //20090803 chiayen add for media change  
1656   2                      gc_CurrentCard=gc_CurrentCard_backup;  //20090803 chiayen add for media change
1657   2                      play_stop();
1658   2                      gc_CurrentCard=tc_CurrentCard; //20090803 chiayen add for media change
1659   2                      set_clock_mode(CLOCK_MODE_MP3); //20090803 chiayen add for media change
1660   2      
1661   2                      if(gc_CurrentCard==2)
1662   2              {           
1663   3                  if(SD_Identification_Flow())
1664   3                  {
1665   4                      gc_CardExist |=0x02;
1666   4                  }
1667   3                  else if((gb_Host_Exist==1) && (gc_HostNoFileflag==0)) //20090730 chiayen modify
1668   3                  {
1669   4                                      XBYTE[0xB400]= 0x01;  //20090730 chiayen add
1670   4                                      if(!Host_Initial())
1671   4                                      {
1672   5                                              gc_CurrentCard = CURRENT_MEDIA_HOST;
1673   5                                              gb_FindFlag = 0;
1674   5                      }
1675   4                          else
1676   4                          {
1677   5                                              gc_CurrentCard=0;
1678   5                                              gc_CardExist &=0xFD;
1679   5                                              gb_FindFlag = 0;
1680   5                                              InitFlash();                                
1681   5                          }
1682   4                      }
1683   3                              else 
1684   3                      {
1685   4                                      XBYTE[0xB400]= 0x01;  //20090730 chiayen add
1686   4                                      gc_CurrentCard=0;
1687   4                                      gc_CardExist &=0xFD;
1688   4                                      gb_FindFlag = 0;
1689   4                                      InitFlash();
1690   4                              }
1691   3                              Play_SDFlash_DosInit();
1692   3              }
1693   2                      else if(gc_CurrentCard==CURRENT_MEDIA_HOST)
1694   2                      {
1695   3                              XBYTE[0xB400]= 0x01;  //20090803 chiayen add                    
1696   3                              if(!Host_Initial())
1697   3                              {
1698   4                                      gc_CurrentCard = CURRENT_MEDIA_HOST;
1699   4                                      gb_FindFlag = 0;
1700   4                              }
1701   3                              else if((gb_SD_Exist==1) && (gb_SDNoFileflag==0)) //20090730 chiayen add
1702   3                              {
1703   4                          if(SD_Identification_Flow())
1704   4                          { 
1705   5                              gc_CardExist |=0x02;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 29  

1706   5                                              gc_CurrentCard=2;      
1707   5                                      }
1708   4                                      else
1709   4                                      {
1710   5                                              gc_CurrentCard=0;
1711   5                                              gc_CardExist &=0xFD;
1712   5                                              gb_FindFlag = 0;
1713   5                                              InitFlash();
1714   5                                      }
1715   4                              }
1716   3                              else 
1717   3                      {
1718   4                                      gc_CurrentCard=0;
1719   4                                      gb_FindFlag = 0;
1720   4                                      InitFlash();
1721   4                              }
1722   3                              Play_SDFlash_DosInit();
1723   3                      }
1724   2                      else if(gc_CurrentCard==0)
1725   2              {
1726   3                              gc_CardExist &=0xFD;
1727   3                              InitFlash();
1728   3                              Play_SDFlash_DosInit();
1729   3                      }
1730   2          }
1731   1      }
1732          
1733          
1734          void MediaChange_Play(void)  //20090803 chiayen add
1735          {
1736   1              if(gc_Dosinitfail==0)  //20090818 chiayen add
1737   1              {
1738   2                      if((gb_SD_Exist==1) && (gb_SDNoFileflag==0))
1739   2                      {
1740   3                              gc_CurrentCard=2;       
1741   3                      }
1742   2                      else
1743   2                      {
1744   3                              gc_CurrentCard=0;
1745   3                      }
1746   2              }
1747   1      }
1748          
1749          
1750          void LCM_Display_Func1(void)
1751          {
1752   1              // For WMA file size=0
1753   1              if(((gc_Play_FileType==1)&&(gs_System_State.c_Phase == TASK_PHASE_PLAYACT))&&(((gb_PickSong==1)||(gb_Chan
             -nelSet==1)) || gc_CurrentCard!=5))
1754   1              {
1755   2                      if(gs_File_FCB[0].dw_File_TotalSize==0)
1756   2                      {
1757   3                              gc_PhaseInx=5;
1758   3                              return;
1759   3                      }
1760   2                      WMA_DataIn();
1761   2              }
1762   1      
1763   1              // maxliao-20090602
1764   1              if(gdw_FreeClusterNum[1] < (gdw_DOS_FatMaxCluster - 1)) 
1765   1              {
1766   2                      if(gc_loopcount==20)
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 30  

1767   2                      {         
1768   3      //                      DOS_SearchFreeCluster(1);
1769   3                              gc_loopcount=0;
1770   3                      }
1771   2                      gc_loopcount++; 
1772   2              } 
1773   1      
1774   1              if(gb_LrcFileName_Exist==1)
1775   1              {
1776   2                      return;
1777   2              }
1778   1      
1779   1              // 冀癀De
1780   1              if(gc_DispWallpaper!=1)
1781   1              {
1782   2                      gc_DispWallpaper=1;
1783   2                      gb_TFT_refresh=1;
1784   2                      TFT_Main();
1785   2              }
1786   1      
1787   1              // De崩Wv
1788   1              if((gw_DisplayFreq!=gw_FM_frequency)||(gb_TFT_refresh==1))
1789   1              {
1790   2                      gb_FlashNoFileflag=0;
1791   2                      gw_DisplayFreq=gw_FM_frequency;
1792   2                      TFT_ShowFMFrequency();            
1793   2              }       
1794   1      
1795   1              // 郎桩姒:MP3/WMA/APE
1796   1              if((gc_Media_type!=gc_Play_FileType)||(gb_TFT_refresh==1))
1797   1              {
1798   2                      gc_Media_type=gc_Play_FileType;
1799   2                      TFT_ShowMusicType();
1800   2              }
1801   1      
1802   1              // xs杆m:NAND/U-disk/SDC
1803   1              if((gc_CurrentCard_Bak!=gc_CurrentCard)||(gb_TFT_refresh==1))
1804   1              {
1805   2                      gc_CurrentCard_Bak=gc_CurrentCard;
1806   2                      TFT_ShowMediaIcon();
1807   2              }
1808   1      
1809   1              // Show Play Mode:Normal/Repeat 1/Repeat All
1810   1              if((gc_DisplayPlayMode!=gc_RepPlayMode)||(gb_TFT_refresh==1))
1811   1              {
1812   2                      gc_DisplayPlayMode=gc_RepPlayMode;
1813   2                      TFT_ShowPlayMode();
1814   2              }
1815   1      
1816   1              // 冀瘭奔                             
1817   1              if((gw_DispSongNum!=gw_FileIndex[0])||(gb_TFT_refresh==1))
1818   1              {
1819   2                      gw_DispSongNum=gw_FileIndex[0]; 
1820   2                      TFT_ShowSongIndex();
1821   2              }
1822   1      
1823   1              // `Ρ计
1824   1              if((gw_DispTotalSong!=gw_FileTotalNumber[0])||(gb_TFT_refresh==1))
1825   1              {
1826   2                      gw_DispTotalSong=gw_FileTotalNumber[0]; 
1827   2                      TFT_ShowTotalSong();
1828   2              }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 31  

1829   1      
1830   1              // Show EQ icon
1831   1              if((gc_DisplayEQIcon!=gs_DSP_GLOBAL_RAM.sc_EQ_Type)||(gb_TFT_refresh==1))
1832   1              {
1833   2                      gc_EQBak=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
1834   2                      gc_DisplayEQIcon=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
1835   2                      TFT_ShowEQIcon();
1836   2              }
1837   1      
1838   1              // 冀癃A:Play/Pause
1839   1              if((gc_DispPlayStatus!=gs_System_State.c_Phase)||(gb_TFT_refresh==1))
1840   1              {
1841   2                      gc_DispPlayStatus=gs_System_State.c_Phase;
1842   2                      TFT_ShowPlayPauseIcon();
1843   2              }
1844   1      
1845   1              // 讽e冀癞啥
1846   1              if((gw_Disp_CurrentSecBak!=gw_Disp_CurrentSec)||(gb_TFT_refresh==1))
1847   1              {       
1848   2                      gw_Disp_CurrentSecBak=gw_Disp_CurrentSec;
1849   2                      TFT_ShowPlayTime();
1850   2              }
1851   1      #ifndef TFT_18_V      //sunzhk add 090617
1852   1          // qΡ啥
1853   1              if((gw_DispTotalTime!=gw_TotalSec)||(gb_TFT_refresh==1))
1854   1              {
1855   2                      gw_DispTotalTime=gw_TotalSec;
1856   2                      TFT_ShowSongLength();
1857   2              }
1858   1      #endif
1859   1              // Show BitRate
1860   1              if(((gw_DisplayBitRate!=gs_System_State.w_BitRate)&&(gw_DisplayBitrateTime==0))||(gb_TFT_refresh==1))
1861   1              {
1862   2                      gw_DisplayBitRate=gs_System_State.w_BitRate;
1863   2                      gw_DisplayBitrateTime=30;
1864   2                      TFT_ShowBitRate();
1865   2              }
1866   1      
1867   1              // Display Song name
1868   1              if(gw_FileTotalNumber[0]==0)
1869   1              {                       
1870   2                      if((gc_CurrentCard==0)  && (gb_FlashNoFileflag==0))
1871   2                      {
1872   3                              gb_FlashNoFileflag=1;
1873   3                      }
1874   2              }
1875   1              else
1876   1              {
1877   2                      if((gw_DispSongNum1!=gw_FileIndex[0])||(gb_TFT_refresh==1))
1878   2                      {
1879   3                              U8      i;
1880   3      
1881   3                              if((gc_CurrentCard==2) && (SD_Detect!=0))  //if SD not exist return DOS_CLUSTER_LINK_ERR chiayen0813
1882   3                              {
1883   4                                      return;         
1884   4                              }
1885   3      
1886   3                              if((gc_CurrentCard==5) && (gb_HostConnect==0))  //if Host not exist return DOS_CLUSTER_LINK_ERR chiayen
             - 20081017
1887   3                              {
1888   4                                      return;         
1889   4                              }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 32  

1890   3      
1891   3                              for(i=0;i<48;i++)
1892   3                              {
1893   4                                      gc_FileLongName[i]=0;
1894   4                              }
1895   3                              gw_DispSongNum1=gw_FileIndex[0];
1896   3                              DOS_GetLongFileName(0,gc_FileLongName);
1897   3      
1898   3                              gw_LogData_Timer=2;  //20090107 chiayen modify 
1899   3                              gs_str_scroll_state.c_str_1st_char=0;  //20090331
1900   3                          gs_str_scroll_state.c_shift_in_1st_char=0;
1901   3                              LCD_Disp_FileName(&gc_FileLongName[5], gc_FileLongName[2], gc_FileLongName[4], 1);
1902   3                              gw_LCMScrollTimer=40;
1903   3                      }
1904   2      
1905   2                      if((gw_LCMScrollTimer==0)&&(gb_TFT_scroll==1))
1906   2                      {
1907   3                              if(gb_LrcFileName_Exist==0)
1908   3                              {
1909   4                                      LCD_Disp_FileName(&gc_FileLongName[5], gc_FileLongName[2], gc_FileLongName[4], 1);
1910   4                              }
1911   3                              gw_LCMScrollTimer=20;
1912   3                      }                                       
1913   2              }
1914   1      
1915   1              if(((gc_Play_FileType==1)&&(gs_System_State.c_Phase == TASK_PHASE_PLAYACT))&&(((gb_PickSong==1)||(gb_Chan
             -nelSet==1)) || gc_CurrentCard!=5))
1916   1              {
1917   2                      WMA_DataIn();
1918   2              }
1919   1      
1920   1              gb_TFT_refresh=0;
1921   1      }
1922          
1923          
1924          void RepeatMode_Process()
1925          {
1926   1              bit     tc_Confirm=0;
1927   1      
1928   1              if(gc_PhaseInx)
1929   1              {
1930   2              switch(gc_PhaseInx)
1931   2              {
1932   3                  case C_PlayMenu:
1933   3                                      gc_ShowTimer =150;
1934   3                                      gc_refresh_type=REFRESH_NOT;//该项确潞蟛恍枰刷新菜单  、、sunzhkadd 00703
1935   3                                      tc_Confirm=1;
1936   3                  break;
1937   3      
1938   3                  case C_PlayNext:
1939   3                                      gc_ShowTimer =150;
1940   3                                      gc_refresh_type=REFRESH_NEXT;
1941   3                                      if(gc_LCMDispIndex==2)
1942   3                                      {
1943   4                                              gc_LCMDispIndex=0;
1944   4                                      }
1945   3                                      else
1946   3                                      {
1947   4                                              gc_LCMDispIndex++;
1948   4                                      }
1949   3                  break;
1950   3      
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 33  

1951   3                  case C_PlayPrev:
1952   3                                      gc_ShowTimer =150;
1953   3                                      gc_refresh_type=REFRESH_PREV;
1954   3                                      if(gc_LCMDispIndex==0)
1955   3                                      {
1956   4                                              gc_LCMDispIndex=2;
1957   4                                      }
1958   3                                      else
1959   3                                      {
1960   4                                              gc_LCMDispIndex--;
1961   4                                      }
1962   3                  break;
1963   3              }
1964   2              
1965   2                      if(tc_Confirm==1) //enter child dir or confirm selected item
1966   2                      {
1967   3                              if(gc_LCMDispIndex==0)
1968   3                              {
1969   4                                      gc_RepPlayMode=0;
1970   4                              }
1971   3                              else if(gc_LCMDispIndex==1)
1972   3                              {
1973   4                                      gc_RepPlayMode=1;
1974   4                              }
1975   3                              else if(gc_LCMDispIndex==2)
1976   3                              {
1977   4                                      gc_RepPlayMode=2;
1978   4                              }
1979   3                              gc_ShowTimer=0;
1980   3                              gc_TuneVolFreqStatus=0;
1981   3                              if(gb_LrcFileName_Exist==1)
1982   3                              {
1983   4                                      UI_FulllcdDis_Lrc();
1984   4                                      gc_DispWallpaper=0;
1985   4                              }
1986   3                      }
1987   2              }
1988   1      }       
1989          
1990          
1991          void EQMenu_Process()
1992          {
1993   1              bit tb_Confirm=0;
1994   1      
1995   1              if(gc_PhaseInx!=1)
1996   1              {
1997   2              switch(gc_PhaseInx)
1998   2              {
1999   3                  case C_PlayMenu:
2000   3                                      gc_ShowTimer =150;
2001   3                                      gc_refresh_type=REFRESH_NOT;
2002   3                                      tb_Confirm = 1;
2003   3                  break;
2004   3      
2005   3                  case C_PlayNext:
2006   3                                      gc_ShowTimer =150;
2007   3                                      gc_refresh_type=REFRESH_NEXT;
2008   3                                      if(gc_LCMDispIndex==5)
2009   3                                      {
2010   4                                              gc_LCMDispIndex=0;
2011   4                                      }
2012   3                                      else
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 34  

2013   3                                      {
2014   4                                              gc_LCMDispIndex++;
2015   4                                      }
2016   3                  break;
2017   3      
2018   3                  case C_PlayPrev:
2019   3                                      gc_ShowTimer =150;
2020   3                                      gc_refresh_type=REFRESH_PREV;
2021   3                                      if(gc_LCMDispIndex==0)
2022   3                                      {
2023   4                                              gc_LCMDispIndex=5;
2024   4                                      }
2025   3                                      else
2026   3                                      {
2027   4                                              gc_LCMDispIndex--;
2028   4                                      }
2029   3                  break;
2030   3              }
2031   2              
2032   2                      if(gs_DSP_GLOBAL_RAM.sc_EQ_Type!=gc_LCMDispIndex)
2033   2                      {
2034   3                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=gc_LCMDispIndex;
2035   3                              gc_EQChangeFlag=1;
2036   3                      }
2037   2      
2038   2                      if(tb_Confirm==1) //enter child dir or confirm selected item
2039   2                      {
2040   3                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=gc_LCMDispIndex;
2041   3                              gc_ShowTimer=0;
2042   3                              gc_TuneVolFreqStatus=0;
2043   3                              if(gb_LrcFileName_Exist==1)
2044   3                              {
2045   4                                      UI_FulllcdDis_Lrc();
2046   4                                      gc_DispWallpaper=0;
2047   4                              }
2048   3                      }
2049   2              }
2050   1      }       
2051          
2052          
2053          void PlayMenu_Process()
2054          {
2055   1              bit tb_Confirm=0;
2056   1      
2057   1              gc_refresh_type=REFRESH_ALL;
2058   1              if(gc_PhaseInx!=1)
2059   1              {
2060   2              switch(gc_PhaseInx)
2061   2              {
2062   3                  case C_PlayMenu:
2063   3                                      gc_refresh_type=REFRESH_ALL;
2064   3                                      tb_Confirm=1;
2065   3                                      gc_ShowTimer =150;
2066   3                  break;
2067   3      
2068   3                  case C_PlayNext:
2069   3                                      gc_ShowTimer =150;
2070   3                                      gc_refresh_type=REFRESH_NEXT;
2071   3                                      if(gc_LCMDispIndex==4)
2072   3                                      {
2073   4                                              gc_LCMDispIndex=0;
2074   4                                      }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 35  

2075   3                                      else
2076   3                                      {
2077   4                                              gc_LCMDispIndex++;
2078   4                                      }
2079   3                  break;
2080   3      
2081   3                  case C_PlayPrev:
2082   3                                      gc_ShowTimer =150;
2083   3                                      gc_refresh_type=REFRESH_PREV;
2084   3                                      if(gc_LCMDispIndex==0)
2085   3                                      {
2086   4                                              gc_LCMDispIndex=4;
2087   4                                      }
2088   3                                      else
2089   3                                      {
2090   4                                              gc_LCMDispIndex--;
2091   4                                      }
2092   3                  break;      
2093   3              }
2094   2      
2095   2                      if(tb_Confirm==1) //confirm selected item
2096   2                      {
2097   3                              if(gc_LCMDispIndex==0)  //File Select
2098   3                              {
2099   4                              if(gw_FileTotalNumber[0])
2100   4                              {
2101   5                                              play_stop();                     //Terry20090527
2102   5                                              gc_TaskMode_BkUp=C_Task_Play;    //
2103   5                                              gc_Task_Next=C_Task_Dir;         //
2104   5                              }
2105   4                              }
2106   3                              else if(gc_LCMDispIndex==1)  //Play All
2107   3                              {
2108   4                                      play_stop();
2109   4                                      gb_DirPlay_Flag=0; //20081224 chiayen test
2110   4                                      gc_PlayModeChange_Flag=1;
2111   4                                      gw_init_needed=0xFFFF;             
2112   4                                      gb_FindFlag = 0;            
2113   4                                      gs_File_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;           
2114   4                                      DOS_Search_File(C_File_All|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);//(JC)count music file 
             -no. in root
2115   4                                      gc_ShowTimer=0;
2116   4                                      gc_TuneVolFreqStatus=0;
2117   4                                      gc_PhaseInx=0;
2118   4                              }
2119   3                              else if(gc_LCMDispIndex==2)  //Equalizer
2120   3                              {
2121   4                                      gc_DispPlayMenuAct=1;
2122   4                                      gc_TuneVolFreqStatus=4;
2123   4                              }
2124   3                              else if(gc_LCMDispIndex==3)  //Repeat
2125   3                              {
2126   4                                      gc_DispPlayMenuAct=2;
2127   4                                      gc_TuneVolFreqStatus=5;
2128   4                              }
2129   3                              else if(gc_LCMDispIndex==4)  //Exit
2130   3                              {
2131   4                                      gc_ShowTimer=0;
2132   4                                      gc_TuneVolFreqStatus=0;
2133   4                                      if(gb_LrcFileName_Exist==1)
2134   4                                      {
2135   5                                              UI_FulllcdDis_Lrc();
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 36  

2136   5                                              gc_DispWallpaper=0;
2137   5                                      }
2138   4                              }
2139   3                      }
2140   2              }       
2141   1      }
2142          
2143          
2144          data    U8      gc_ShowIRNumMain=0;
2145          extern U8 LCD_Disp_FileName(U8 *tpc_DataBuf, U8 tc_ANSI, U8 tc_nByte, U8 tc_scroll_flag);
2146          extern UBYTE DOS_GetDIRName(UBYTE tc_FileHandle, UBYTE tb_UicodeToISN, UBYTE * tpc_LongName);
2147          extern void Folder_Display();
2148          void LCM_Display_Func2(void)    // \嗫锒:MP3/MP4/JPG/Setup
2149          {
2150   1              // IR NUM
2151   1              if(gb_ShowIRNum==1)
2152   1              {
2153   2                      gb_ShowIRNum=0;
2154   2                      gc_TuneVolFreqStatus=0;
2155   2                      if(gc_ShowIRNumMain==0)
2156   2                      {
2157   3                              gc_ShowIRNumMain=1;
2158   3                              gb_TFT_refresh=1;
2159   3                              gc_DispWallpaper=0;
2160   3                              TFT_IRNumMain();
2161   3                      }
2162   2      
2163   2                      TFT_IRNum();
2164   2              }
2165   1      
2166   1              // EQ Frame(换北竟匡EQ)
2167   1              if(gb_Frequency_Song==1)
2168   1              {
2169   2                      if(gc_EQBak!=gs_DSP_GLOBAL_RAM.sc_EQ_Type)
2170   2                      {
2171   3                              gc_TuneVolFreqStatus=0;
2172   3                              gc_EQBak=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
2173   3                              TFT_EQFrame();
2174   3                              gb_TFT_refresh=1;
2175   3                              gc_DispWallpaper=0xFF;
2176   3                              return;
2177   3                      }
2178   2              }
2179   1      
2180   1              if(gc_TuneVolFreqStatus==1)     // VOLUME ADJ.
2181   1              {
2182   2                  gc_ShowIRNumMain=0;
2183   2                      if(gc_DispWallpaper!=2)
2184   2                      {
2185   3                              gb_TFT_VOL_FM=0;        // 0=VOL adj.  1=FM adj.
2186   3                              //TFT_Main_VOL_FM_ADJ();
2187   3                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,0);//显示音量调整的背景图
2188   3                              gc_DispWallpaper=2;
2189   3                              gc_DisplayVol=0xFF;
2190   3                      }
2191   2                      if(gc_DisplayVol!=gs_DSP_GLOBAL_RAM.sw_Volume)
2192   2                      {
2193   3                              gc_DisplayVol=gs_DSP_GLOBAL_RAM.sw_Volume;
2194   3                              TFT_ShowVOLAdj();
2195   3                      }
2196   2              }
2197   1              else if(gc_TuneVolFreqStatus==2)        // FM ADJ.
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 37  

2198   1              {
2199   2                      if(gc_DispWallpaper!=3)
2200   2                      {
2201   3                              gb_TFT_VOL_FM=1;        // 0=VOL adj.  1=FM adj.
2202   3                              //TFT_Main_VOL_FM_ADJ();
2203   3                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,0);//显示音量调整的背景图
2204   3                              gc_DispWallpaper=3;
2205   3                              gw_DisplayFreq=0;
2206   3                      }
2207   2      
2208   2                      if(gw_DisplayFreq!=gw_FM_frequency)
2209   2                      {
2210   3                              gb_FlashNoFileflag=0;
2211   3                              gw_DisplayFreq=gw_FM_frequency;
2212   3                              TFT_ShowFMFreqAdj();
2213   3                              gc_ShowIRNumMain=0;
2214   3                      }
2215   2              }
2216   1              else if(gc_TuneVolFreqStatus==3)        // Playing operation(play menu)
2217   1              {
2218   2                      //gc_ShowTimer=72;
2219   2                      IR_Service_Process_Menu();
2220   2                      if(gc_DispWallpaper!=4)
2221   2                      {
2222   3                              gc_DispWallpaper=4;
2223   3                              gc_LCMDispIndex=0;
2224   3                              gc_LCMDispIndexBak=0xFF;
2225   3                              gc_PhaseInx=1;
2226   3                      }
2227   2                      PlayMenu_Process();
2228   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
2229   2                      {
2230   3                              gc_LCMDispIndexBak=gc_LCMDispIndex;
2231   3      //                      TFT_PlayingOperation_new(gc_LCMDispIndex,gc_TuneVolFreqStatus);
2232   3                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
2233   3                              
2234   3                      }               
2235   2              }
2236   1              else if(gc_TuneVolFreqStatus==4)
2237   1              {
2238   2                      //gc_ShowTimer=72;
2239   2                      IR_Service_Process_Menu();
2240   2                      if(gc_DispWallpaper!=5)
2241   2                      {
2242   3                              gc_DispWallpaper=5;
2243   3                              gc_LCMDispIndex=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
2244   3                              gc_LCMDispIndexBak=0xFF;
2245   3                              gc_PhaseInx=1;
2246   3                      }
2247   2      
2248   2                      EQMenu_Process();               
2249   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
2250   2                      {
2251   3                              gc_EQBak=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
2252   3                              gc_LCMDispIndexBak=gc_LCMDispIndex;
2253   3                              //TFT_EQMenu();
2254   3                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
2255   3                      }               
2256   2              }
2257   1              else if(gc_TuneVolFreqStatus==5)
2258   1              {
2259   2                      //gc_ShowTimer=72;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 38  

2260   2                      IR_Service_Process_Menu();
2261   2                      if(gc_DispWallpaper!=6)
2262   2                      {
2263   3                              gc_DispWallpaper=6;
2264   3                              gc_LCMDispIndex=0;
2265   3                              gc_LCMDispIndexBak=0xFF;
2266   3                              gc_PhaseInx=1;
2267   3                      }
2268   2      
2269   2                      RepeatMode_Process();           
2270   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
2271   2                      {
2272   3                              gc_LCMDispIndexBak=gc_LCMDispIndex;
2273   3                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
2274   3                      //      TFT_RepeatMenu();
2275   3                      }               
2276   2              }
2277   1      //////////////sunzhk add disp folder name
2278   1              else if(gc_folder_disp==1)
2279   1              {
2280   2                      gc_ShowTimer=72;
2281   2                      IR_Service_Process_Menu();
2282   2                      if(gc_DispWallpaper!=6)
2283   2                      {
2284   3                              gc_DispWallpaper=6;
2285   3                              gc_LCMDispIndex=0;
2286   3                              gc_LCMDispIndexBak=0xFF;
2287   3                              gc_PhaseInx=1;
2288   3                      }
2289   2      
2290   2                      /*RepeatMode_Process();         
2291   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
2292   2                      {
2293   2                              gc_LCMDispIndexBak=gc_LCMDispIndex;
2294   2                              Menu_Disp_Item_Play(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
2295   2                      //      TFT_RepeatMenu();
2296   2                      }*/
2297   2                              Folder_Display();
2298   2                              DOS_GetDIRName(0, 0, gc_FileLongName);                                          
2299   2                              LCD_Disp_FileName(&gc_FileLongName[5], gc_FileLongName[2], gc_FileLongName[4], 1);
2300   2                              gc_folder_disp=0;               
2301   2              }
2302   1      /////////
2303   1              if(gc_PhaseInx!=0)
2304   1              {
2305   2                      if(gs_System_State.c_Phase==TASK_PHASE_STOP)
2306   2                  {
2307   3                      gc_PhaseInx=0x09;   
2308   3                  }
2309   2                  else
2310   2                  {
2311   3                      gc_PhaseInx=1;
2312   3                  }
2313   2              }
2314   1      }
2315          
2316          
2317          void Play_Task()
2318          {
2319   1              gb_TFT_refresh=1;       // ┮ΤICON/计r场陪ボ@Ω
2320   1              gc_DispWallpaper=0;
2321   1              LCD_BACKLIGHT_ON;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 39  

2322   1              while(1)
2323   1              {
2324   2              switch(gc_PhaseInx)
2325   2              {
2326   3                  case C_PlayInit:
2327   3                      play_init();
2328   3                  break;
2329   3      
2330   3                  case C_PlayProc:
2331   3                      play_proc();
2332   3                  break;
2333   3                  
2334   3                  case C_PlayEndfile:
2335   3                                      if(gb_LrcFileName_Exist==1)
2336   3                                      {
2337   4                                              gb_TFT_refresh=1;
2338   4                                              gc_DispWallpaper=0;
2339   4                                      }
2340   3                      play_endfile();
2341   3                  break;
2342   3      
2343   3                  case C_PlayPause:
2344   3                                      if(!gb_FlashNoFileflag)
2345   3                                      {
2346   4                              play_playpause();
2347   4                                      }
2348   3                                      else
2349   3                                      {
2350   4                                              gc_PhaseInx=9;  
2351   4                                      }
2352   3                  break;
2353   3      
2354   3                  case C_PlayStop:
2355   3                      play_stop();    
2356   3                  break;
2357   3      
2358   3                  case C_PlayNext:
2359   3                                      if(!gb_FlashNoFileflag)
2360   3                                      {
2361   4                                              if((gb_LrcFileName_Exist==1)&&(gc_ShowTimer==0))
2362   4                                              {
2363   5                                                      gb_TFT_refresh=1;
2364   5                                                      gc_DispWallpaper=0;
2365   5                                              }
2366   4      
2367   4                                              if(gc_TuneVolFreqStatus==0)
2368   4                                              {
2369   5                                      play_next();
2370   5                                              }
2371   4                                              else if(gc_TuneVolFreqStatus==1)
2372   4                                              {
2373   5                                                      play_volup();   
2374   5                                              }
2375   4                                              else if(gc_TuneVolFreqStatus==2)
2376   4                                              {
2377   5                                                      FM_FREQ_CHGUP();        
2378   5                                              }
2379   4                                      }
2380   3                  break;
2381   3      
2382   3                  case C_PlayPrev:
2383   3                                      if(!gb_FlashNoFileflag)
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 40  

2384   3                                      {
2385   4                                              if((gb_LrcFileName_Exist==1)&&(gc_ShowTimer==0))
2386   4                                              {
2387   5                                                      gb_TFT_refresh=1;
2388   5                                                      gc_DispWallpaper=0;
2389   5                                              }
2390   4      
2391   4                                              if(gc_TuneVolFreqStatus==0)
2392   4                                              {
2393   5                                                      play_prev();
2394   5                                              }
2395   4                                              else if(gc_TuneVolFreqStatus==1)
2396   4                                              {
2397   5                                                      play_voldn();   
2398   5                                              }
2399   4                                              else if(gc_TuneVolFreqStatus==2)
2400   4                                              {
2401   5                                                      FM_FREQ_CHGDOWN();      
2402   5                                              }                                       
2403   4                                      }
2404   3                  break;
2405   3      
2406   3                  case C_PlayIdle:
2407   3                      play_idle();
2408   3                  break;
2409   3      
2410   3                  case C_PlayVolUp:
2411   3                      play_volup();
2412   3                  break;
2413   3      
2414   3                  case C_PlayVolDn:
2415   3                      play_voldn();
2416   3                  break;
2417   3      
2418   3                  case C_PlayUpLevel:
2419   3                      play_back2uplevel();
2420   3                  break;
2421   3      
2422   3                  case C_PlayMenu:  //short key mode
2423   3                              gc_ShowTimer=72;
2424   3                              
2425   3                                      if(gc_DispPlayMenuAct==0&&gc_TuneVolFreqStatus!=3)
2426   3                                      {
2427   4                                              gc_DispWallpaper=0; 
2428   4                                              gc_TuneVolFreqStatus=3;
2429   4                                      }
2430   3                  break;
2431   3                              case C_PlayChgDn:
2432   3                                              FM_FREQ_CHG(0,1);
2433   3                              break;
2434   3      
2435   3                              case C_PlayChgUp:
2436   3                                              FM_FREQ_CHG(1,1);
2437   3                              break;
2438   3                  case C_TuneVolFreq:  //tune vol key
2439   3                                      if(gc_TuneVolFreqStatus<3)  //20090331
2440   3                                      {
2441   4                                              gc_ShowTimer=72;
2442   4                                              gc_TuneVolFreqStatus++;
2443   4                                              if(gc_TuneVolFreqStatus>2)
2444   4                                              {
2445   5                                                      gc_ShowTimer=0;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 41  

2446   5                                                      gc_TuneVolFreqStatus=0; 
2447   5                                              }                               
2448   4                                      }
2449   3      
2450   3                                      if(gs_System_State.c_Phase==TASK_PHASE_STOP)
2451   3                                  {
2452   4                                      gc_PhaseInx=0x09;   
2453   4                                  }
2454   3                                  else
2455   3                                  {
2456   4                                      gc_PhaseInx=1;
2457   4                                  }
2458   3                  break;
2459   3      
2460   3                  case C_PowerOff:
2461   3                                      gc_TaskMode_BkUp=C_Task_Play;
2462   3                                      if(gs_System_State.c_Phase!=TASK_PHASE_STOP)
2463   3                                      {
2464   4                                              play_stop();    
2465   4                                      }
2466   3                                      gc_Task_Next=C_Task_PowerOff;                                           
2467   3      
2468   3                  break;
2469   3      
2470   3                              case C_MainMenu: //Long key mode
2471   3                                      play_stop();
2472   3                                      gc_Task_Next=C_Task_Menu;
2473   3                              break;
2474   3      
2475   3                  case C_PlayFF:
2476   3                                      UI_fastFFFR_Play(0);
2477   3                              break;
2478   3      
2479   3                              case C_PlayFR:
2480   3                                      UI_fastFFFR_Play(1);
2481   3                  break;
2482   3      
2483   3                  case C_PlayFfFrEnd:
2484   3                                      play_fffr_end();
2485   3                              break;
2486   3              }
2487   2      
2488   2              if((gs_System_State.c_Phase == TASK_PHASE_PLAYACT)  && (gc_Play_FileType!=0x03))
2489   2              {
2490   3                  gs_System_State.w_BitRate = (*Music_Bitrate[gc_Play_FileType])();
2491   3              }
2492   2      
2493   2                      if((gc_Dirchange_Timer==0)&&(gc_ShowTimer==0)&&(gw_IR_Timer==0)&&(gc_folder_disp==0))
2494   2                      {       
2495   3                      LCM_Display_Func1();    // 冀癀De           
2496   3                              gc_DispPlayMenuAct=0;
2497   3                              gc_ShowIRNumMain=0;
2498   3                              if((gb_LrcFileName_Exist==1) && ((gc_DispWallpaper==2)||(gc_DispWallpaper==3))) //for LRC Volkey
2499   3                              {
2500   4                                      UI_FulllcdDis_Lrc();
2501   4                                      gc_DispWallpaper=0;
2502   4                              }
2503   3                      }
2504   2                      else
2505   2                      {
2506   3                              LCM_Display_Func2();
2507   3                      }
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 42  

2508   2      
2509   2                      gc_CurrentCard_backup=gc_CurrentCard;
2510   2                      IR_Service_Process();
2511   2      
2512   2                      if(gb_PickSongSet==1)
2513   2                              {               
2514   3                                      gb_PickSongSet=0;
2515   3                                      if(gb_ChannelSet==0)
2516   3                                      {
2517   4                                              PickSong_Process();
2518   4                                      }
2519   3                                      else
2520   3                                      {
2521   4                                              ChannelSet_Process();
2522   4                                              gb_ChannelSet=0;
2523   4                                              gc_ShowIRNumMain=0;
2524   4                                      }
2525   3                              }
2526   2                      
2527   2              Polling_TaskEvents();
2528   2              if(gc_LogDataFlag==1)
2529   2              {
2530   3                  USER_LogFile_ReadWrite(1);
2531   3                  gc_LogDataFlag=0;
2532   3              }
2533   2      
2534   2                      if(gb_HostError==1)  //20090107 chiayen add
2535   2                      {
2536   3                              gb_HostError=0;
2537   3                              MediaChange_Play();
2538   3                      }
2539   2                      Play_SourceDetect_Process();
2540   2      
2541   2                      if(gc_Task_Current!=gc_Task_Next)
2542   2              {
2543   3                  gc_Task_Current=gc_Task_Next;
2544   3                              gc_ShowTimer=0;  //20090331
2545   3                              gc_DispWallpaper=1;
2546   3                              gc_TuneVolFreqStatus=0;
2547   3                              gc_Dirchange_Timer =0;
2548   3                              gw_IR_Timer=0;
2549   3                              gc_folder_disp=0;
2550   3                              ClearIRBuffer();
2551   3                  if((gc_Task_Current==C_Task_USB) || (gc_Task_Current==C_Task_Dir) || (gc_Task_Current==C_Task_
             -PlayMenu) || (gc_Task_Current==C_Task_PlayMenu_IR)) //20090107 chiayen add
2552   3                  {
2553   4                      if((gs_System_State.c_Phase==TASK_PHASE_PLAYACT)||(gs_System_State.c_Phase==TASK_PHASE_PAU
             -SE))
2554   4                      {
2555   5                          play_stop();    
2556   5                      }
2557   4                  }
2558   3                  break;  
2559   3              }
2560   2          }
2561   1      }
2562          
2563          void ir_service_menu(void)
2564          {
2565   1              U16 tw_temp;
2566   1              
2567   1              if(gc_IRCmdStatus!=0)
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 43  

2568   1              {
2569   2                      tw_temp=(IR_REG[0x1b]<<8)+IR_REG[0x1a];
2570   2              
2571   2                      
2572   2                      if(tw_temp==IR_21_Key)
2573   2                      {
2574   3                              gc_irkey=5;     
2575   3                      }
2576   2                      else if(tw_temp==IR_21_1_Key)
2577   2                      {
2578   3                              gc_irkey=7;     
2579   3                      }
2580   2                      if(gc_irkey!=0)
2581   2                      {
2582   3                              if((IR_REG[0x1c]+IR_REG[0x1d])==0xFF)
2583   3                              {
2584   4                                      if(gc_IRCmdStatus==1)
2585   4                                      {
2586   5                                              ir_commandservice_menu();
2587   5                                              gc_IRCmdStatus=0;
2588   5                                      }
2589   4                                      if(gc_IRCmdStatus==2)
2590   4                                      {                                       
2591   5                                              ir_commandservice_menu();
2592   5                                              gc_IRCmdStatus=0;
2593   5                                      }
2594   4                              }                                       
2595   3                      }
2596   2                      else
2597   2                      {
2598   3                              gc_IRCmdStatus=0;
2599   3                      }
2600   2                      gc_IRCmdStatus=0;
2601   2              }
2602   1              gc_irkey=0;
2603   1      }
2604          
2605          
2606          void ir_commandservice_menu(void)
2607          {
2608   1      
2609   1              
2610   1              if(gc_irkey==5)
2611   1              {
2612   2                  switch(IR_REG[0x1c])
2613   2                  {
2614   3                              case 0x1e:                                                              //just for suo lang.
2615   3                              case 0x01:      //Mode  //Menu   
2616   3                                      if(gc_Task_Current == C_Task_Jpeg)
2617   3                                      gc_PhaseInx = C_JpegMenu;
2618   3                                      else if(gc_Task_Current == C_Task_Mjpeg)
2619   3                                      gc_PhaseInx = C_MjpegMenu;
2620   3                                      else
2621   3                                      gc_PhaseInx = C_PlayMenu;
2622   3      
2623   3                                      break;
2624   3                      
2625   3                              case 0x0d:      // PlayPrev --
2626   3                                      if(gc_Task_Current == C_Task_Jpeg)
2627   3                                      gc_PhaseInx = C_JpegPrev;
2628   3                                      else if(gc_Task_Current == C_Task_Mjpeg)
2629   3                                      gc_PhaseInx = C_MjpegPrev;
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 44  

2630   3                                      else
2631   3                                      gc_PhaseInx = C_PlayPrev;
2632   3      
2633   3                                      break;
2634   3                      case 0x0e:      // PlayNext ++
2635   3                                      if(gc_Task_Current == C_Task_Jpeg)
2636   3                                      gc_PhaseInx = C_JpegNext;
2637   3                                      else if(gc_Task_Current == C_Task_Mjpeg)
2638   3                                      gc_PhaseInx = C_MjpegNext;
2639   3                                      else
2640   3                                      gc_PhaseInx = C_PlayNext;
2641   3      
2642   3                                      break;
2643   3                              case 0x00:      //ON/OFF 
2644   3                   
2645   3                                              if(gs_System_State.c_Phase!=TASK_PHASE_STOP)
2646   3                                              {
2647   4                                                      if(gc_Task_Current == C_Task_Play)
2648   4                                                      {
2649   5                                                              play_stop();
2650   5                                                      }
2651   4                                                      else if(gc_Task_Current == C_Task_Jpeg)
2652   4                                                      {
2653   5                                                              jpeg_stop();
2654   5                                                      }
2655   4                                                      else if(gc_Task_Current == C_Task_Mjpeg)
2656   4                                                      {
2657   5                                                              mjpeg_stop();
2658   5                                                      }
2659   4                                              }
2660   3                              gc_Task_Next=C_Task_PowerOff;
2661   3                                              gc_PhaseInx=0xff; 
2662   3                                      
2663   3      
2664   3                                      break;
2665   3                              default:                
2666   3                              break;
2667   3                  }
2668   2              }
2669   1              else if(gc_irkey==7)    // 21-key
2670   1              {
2671   2                  switch(IR_REG[0x1c])
2672   2                  {
2673   3      #if 0
                              case 0x0d:      // Menu
                                              if(gc_Task_Current == C_Task_Jpeg)
                                              gc_PhaseInx = C_JpegMenu;
                                              else if(gc_Task_Current == C_Task_Mjpeg)
                                              gc_PhaseInx = C_MjpegMenu;
                                              else
                                              gc_PhaseInx = C_PlayMenu;
              
                                              break;
              #endif 
2684   3                      case 0x04:      // PlayPrev --
2685   3                                      if(gc_Task_Current == C_Task_Jpeg)
2686   3                                      gc_PhaseInx = C_JpegPrev;
2687   3                                      else if(gc_Task_Current == C_Task_Mjpeg)
2688   3                                      gc_PhaseInx = C_MjpegPrev;
2689   3                                      else
2690   3                                      gc_PhaseInx = C_PlayPrev;
2691   3      
C51 COMPILER V7.10   PLAY_PROCESS                                                          02/28/2011 10:30:25 PAGE 45  

2692   3                                      break;
2693   3                      case 0x06:      // PlayNext ++
2694   3                                      if(gc_Task_Current == C_Task_Jpeg)
2695   3                                      gc_PhaseInx = C_JpegNext;
2696   3                                      else if(gc_Task_Current == C_Task_Mjpeg)
2697   3                                      gc_PhaseInx = C_MjpegNext;
2698   3                                      else
2699   3                                      gc_PhaseInx = C_PlayNext;
2700   3      
2701   3                                      break;
2702   3                              default:                
2703   3                              break;
2704   3                  }           
2705   2              }
2706   1      }
2707          
2708          
2709          void IR_Service_Process_Menu()
2710          {
2711   1          if(gc_IRCmdStatus==1)
2712   1          {
2713   2              ir_service_menu();
2714   2          }
2715   1      }
2716          
2717          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   8236    ----
   CONSTANT SIZE    =    114    ----
   XDATA SIZE       =      8     113
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1      65
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
