C51 COMPILER V9.00   FF_FR                                                                 07/09/2012 21:16:53 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE FF_FR
OBJECT MODULE PLACED IN .\obj\FF_FR.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Play\FF_FR.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsource\head
                    -er) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\FF_FR.lst) OBJECT(.\obj\FF_FR.obj)

line level    source

   1          #include "..\header\SPDA2K.h"
   2          #include "..\header\variables.h"
   3          #include "..\DSP\dspuser.h"
   4          #include "..\DSP\DSPPHYSIC.H"
   5          
   6          void UI_fastFFFR_Play(U8 XFFFR)
   7          {
   8   1              gc_LongKeyCount=30;
   9   1              if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
  10   1              {  
  11   2                  if(XFFFR==0)
  12   2                  {// play_fastfwd
  13   3                          gs_System_State.c_Phase=TASK_PHASE_FASTFWD;
  14   3                  }
  15   2                  else
  16   2                  {// play_fastrev -- XFFFR == 1
  17   3                          gs_System_State.c_Phase=TASK_PHASE_FASTREV;
  18   3                  }
  19   2      
  20   2                      if(gc_Play_FileType==0)
  21   2                      {
  22   3                              gw_CurrentSec=MP3_ReadTime();
  23   3                              gs_System_State.w_SampleRate=L2_DSP_Read_DMem16(DSP_MP3Bitrate);
  24   3                              MP3_FF_FR_Cmd();
  25   3                      }
  26   2                      else
  27   2                      {
  28   3                              gw_CurrentSec=WMA_ReadTime();
  29   3                              gs_System_State.w_SampleRate=L2_DSP_Read_DMem16(DSP_WMABitrate);
  30   3                              WMA_FF_FR_Cmd();
  31   3                      }
  32   2              }
  33   1              else if(gs_System_State.c_Phase==TASK_PHASE_FASTFWD)
  34   1              {       
  35   2                      if(gw_CurrentSec<gw_TotalSec)
  36   2                      {
  37   3                              gw_CurrentSec+=1;
  38   3                              gw_Disp_CurrentSec=gw_CurrentSec;
  39   3                      }
  40   2              }
  41   1              else if(gs_System_State.c_Phase==TASK_PHASE_FASTREV)
  42   1              {       
  43   2                      if(gw_CurrentSec!=0)
  44   2                      {
  45   3                              gw_CurrentSec-=1;
  46   3                              gw_Disp_CurrentSec=gw_CurrentSec;
  47   3                      }
  48   2              }
  49   1      }
  50          
  51          U8 MP3_FF_FR_Cmd(void)
  52          {
  53   1              data    U8  tc_Ret;
  54   1              data    U16     TimeOUT=0xFFFF;
C51 COMPILER V9.00   FF_FR                                                                 07/09/2012 21:16:53 PAGE 2   

  55   1              xdata   U16     temp;
  56   1      
  57   1              tc_Ret=DSP_StopCmd();
  58   1      
  59   1              do{
  60   2                      TimeOUT --;
  61   2                      if(TimeOUT==0)
  62   2                      {
  63   3                              return DSP_DECODE_STATUS_TIMEOUT_ERROR;
  64   3                      }
  65   2              }while(!((L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)==0x00C0));
  66   1      
  67   1              temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
  68   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,temp&0xFF3F);
  69   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,0);
  70   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3000);
  71   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
  72   1              return tc_Ret;
  73   1      }
  74          
  75          
  76          U8 WMA_FF_FR_Cmd()
  77          {
  78   1              data    U8  tc_Ret;
  79   1              data    U16     TimeOUT=0xFFFF;
  80   1      
  81   1              DSP_WakeUp();
  82   1              tc_Ret=DSP_PauseCmd();
  83   1      
  84   1              do{
  85   2                      if(--TimeOUT==0)
  86   2                      {
  87   3                              return DSP_DECODE_STATUS_TIMEOUT_ERROR;
  88   3                      }
  89   2              } while (!L2_DSP_Read_DMem16(DSP_RampDownComplete)); //Jimi 090417, DSP_RampDownComplete = 0x3FB8, indica
             -tes RampDown OK or NOT
  90   1      
  91   1              return tc_Ret;
  92   1      }
  93          
  94          void play_fffr_end()
  95          {
  96   1              xdata   U32     tdw_datapoint;
  97   1      
  98   1              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster=gs_File_FCB[0].dw_File_StartCluster;
  99   1              tdw_datapoint=gw_CurrentSec*(gs_File_FCB[0].dw_File_TotalSize/gw_TotalSec);     
 100   1      
 101   1          if(tdw_datapoint==0)
 102   1              {
 103   2                      gs_File_FCB[0].dw_File_DataPoint=0;
 104   2                      gb_Mp3FileEnd=1;
 105   2                      return;
 106   2              }
 107   1              else
 108   1          {
 109   2                      gs_File_FCB[0].dw_File_CurrentCluster=DOS_Seek_File(0,tdw_datapoint>>9);
 110   2                      if(gc_Play_FileType==0)
 111   2                      {
 112   3                              MP3_seek_trig();
 113   3                      }
 114   2                      else
 115   2                      {
C51 COMPILER V9.00   FF_FR                                                                 07/09/2012 21:16:53 PAGE 3   

 116   3                              WMA_seek_trig();
 117   3                      }
 118   2          }
 119   1      }
 120          
 121          void MP3_seek_trig(void)
 122          {
 123   1              data    U8      tc_Cnt;
 124   1              data    U16 tw_FrmCnt;
 125   1      
 126   1              // restart DSP, Jimi 081125
 127   1              tw_FrmCnt=L2_DSP_Read_DMem16(DSP_DecodeFrameCounter);
 128   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
 129   1              {
 130   2                      if (DSP_PlayInit()==DSP_SUCCESS)
 131   2                      {
 132   3                              break;
 133   3                      }
 134   2      
 135   2                      if(tc_Cnt>4) 
 136   2                      {
 137   3                              XBYTE[0xB002]|=0x01;    // DSP reset
 138   3                      }
 139   2                      XBYTE[0xB002]&=~0x01;   // Enable DSP Run Normal Mode
 140   2              }
 141   1      
 142   1              L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);
 143   1              L2_DSP_Write_DMem16(DSP_PostProcessSelect, L2_DSP_Read_DMem16(DSP_PostProcessSelect)|0x0020);
 144   1              {
 145   2                      U8 tc_timeout = 0xFF;
 146   2                      while( (L2_DSP_Read_DMem16(DSP_PostProcessSelect)&0x0020))      //Handshake with DSP to make sure that DSP ha
             -s ramp digital volume up.
 147   2                      {
 148   3                              if (!(tc_timeout--))
 149   3                              {
 150   4                                      break;
 151   4                              }
 152   3                      }
 153   2              }
 154   1              Music_EQ_Cmd();
 155   1              L2_DSP_Write_DMem16(DSP_DecodeFrameCounter, tw_FrmCnt);
 156   1              L2_DSP_SendCommandSet(DCMD_Play);
 157   1      }
 158          
 159          
 160          void WMA_seek_trig(void)
 161          {
 162   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3C00);    //reset BS buffer information //Jimi081112 mdf size to 0x3C0
             -0
 163   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,0x0000);   
 164   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;                
 165   1              L2_DSP_Write_DMem24(DSP_WMASectorOffset,(gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint>>9))
             -;                
 166   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,0x0000);
 167   1              L2_DSP_Write_DMem16(DSP_WMARandomFlag,0x0001);   //set random flag
 168   1              L2_DSP_SendCommandSet(DCMD_Play);
 169   1      }
 170          
 171          
 172          


C51 COMPILER V9.00   FF_FR                                                                 07/09/2012 21:16:53 PAGE 4   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    638    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
