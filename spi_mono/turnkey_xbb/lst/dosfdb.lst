C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DOSFDB
OBJECT MODULE PLACED IN .\obj\dosfdb.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE DOS\dosfdb.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsource\head
                    -er) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\dosfdb.lst) OBJECT(.\obj\dosfdb.obj)

line level    source

   1          #include <string.h>
   2          #include "..\header\SPDA2K.h"
   3          #include "..\header\Rambase.h"
   4          #include "..\header\variables.h"
   5          
   6          
   7          U8 Find_Fdb(SearchFdb *p_mp)
   8          {
   9   1              data    bit     tc_RecFlag;
  10   1              data    bit     tb_flag=0;
  11   1              data    bit     tb_SortFlag=0;
  12   1              data    bit     tb_SameFlag=0;
  13   1              data    bit     tb_not_1stFDB=0;
  14   1              data    bit     tb_DiffFlag;
  15   1              data    U8      tc_sts;
  16   1              data    U8      tc_SectorOffset;
  17   1              data    U8      tc_Temp_SectorOffset;
  18   1              data    U8      tc_PlayMode;
  19   1              data    U8      tc_ExtNum;
  20   1              data    U16     tw_FdbOffset;
  21   1              data    U16     tw_Temp_FdbOffset;
  22   1              data    U16     tw_FileLongName;
  23   1              data    U16     tw_ByteOffset;
  24   1              data    U16     tw_PrevFDB_Offset;
  25   1              data    U16     tw_DirIndex=0;
  26   1              data    U16     tw_DirIndex1=0;
  27   1              xdata   U32 tdw_SectorAdd,tdw_StartCluster,tdw_S_ClusterNum,tdw_FDBClusterNum;
  28   1              xdata   U32 tdw_Find_ClusterSize,tdw_TheEndCluster,tdw_StartCluster1,tdw_StartCluster3,tdw_PrevFDB_Cluster,
             - tdw_PrevFDB_LogAdd;
  29   1              xdata   U32 tdw_FDB_LogAdd0,tdw_FDB_LogAdd1;
  30   1              xdata   U32 tdw_Temp_flag=0;
  31   1              xdata   U32 tdw_Tag0,tdw_Tag1;
  32   1              data    U16     tw_FileSkipNumber;
  33   1              code    U8      REC[]={'R','E','C','_'};
  34   1      
  35   1              tw_FileSkipNumber=gw_FileSkipNumber;
  36   1              tdw_Tag1=p_mp->Compare.dw_BubbleFlag;
  37   1              if(p_mp->c_Search_Direction) //find pre
  38   1              {
  39   2                      tdw_Tag0=0x0000;                
  40   2              }
  41   1              else
  42   1              {//find next
  43   2                      tdw_Tag0=0xffffffff;
  44   2              }
  45   1      
  46   1              if((p_mp->dw_FDB_StartCluster==0)&&(gdw_DOS_RootDirClus==2)) //FAT32, 20090216 chiayen add
  47   1              {
  48   2                      p_mp->dw_FDB_StartCluster=2;
  49   2              }
  50   1      
  51   1              tdw_FDBClusterNum=p_mp->dw_FDB_StartCluster;
  52   1              p_mp->dw_LongFDB_LogAdd1=0;
  53   1              p_mp->dw_LongFDB_LogAdd0=0;     
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 2   

  54   1              tw_Temp_FdbOffset=0x00;
  55   1              tc_Temp_SectorOffset=0x00;
  56   1              tdw_FDB_LogAdd0=0;
  57   1              tdw_FDB_LogAdd1=0;
  58   1              tdw_S_ClusterNum=p_mp->dw_FDB_StartCluster;     
  59   1              tc_sts=GO_ON;
  60   1      
  61   1              if(gc_DOS_FileSystemType==1)
  62   1              {
  63   2                      tdw_TheEndCluster=0xffff;
  64   2              }
  65   1              else
  66   1              {
  67   2                      tdw_TheEndCluster=0x0fffffff; 
  68   2              }
  69   1      
  70   1              while(tdw_S_ClusterNum<tdw_TheEndCluster)
  71   1              { //find in one dir
  72   2                      if((gc_CurrentCard==2)&&(gb_SD_pin==1))
  73   2                      {
  74   3                              return 1;
  75   3                      }
  76   2      
  77   2                      if((gc_CurrentCard==5)&&(gb_HostConnect==0))
  78   2                      {                       
  79   3                              return 1;               
  80   3                      }
  81   2      
  82   2                      if(!tdw_S_ClusterNum)                                                        //Is rootdir
  83   2                      {
  84   3                              tdw_Find_ClusterSize=(gdw_DOS_DataAddr-gdw_DOS_RootDirAddr);
  85   3                              tdw_SectorAdd=gdw_DOS_RootDirAddr;              
  86   3                      }
  87   2                      else
  88   2                      {
  89   3                              tdw_Find_ClusterSize=gc_DOS_SectorPerCluster;   
  90   3                              tdw_SectorAdd=DOS_ClusterLogicAddr(tdw_S_ClusterNum);           
  91   3                      }
  92   2      
  93   2                      if(tdw_S_ClusterNum!=p_mp->dw_FDB_Cluster)
  94   2                      {
  95   3                              tc_SectorOffset=0;      // when one cluster is(tw_FdbOffset)finished,fdboffset should be 0
  96   3                      }
  97   2      
  98   2                      for(tc_SectorOffset=tc_Temp_SectorOffset;tc_SectorOffset<tdw_Find_ClusterSize*gc_HostSectorUnit;tc_Secto
             -rOffset++)
  99   2                      {//find in one cluster  
 100   3                              gb_ReadWriteDataArea=1;
 101   3                              if(DOS_Read_LogicSector(tdw_SectorAdd+tc_SectorOffset)!=0)
 102   3                              {//read sector error(1 is fail)
 103   4                                      break;
 104   4                              }
 105   3      
 106   3                              if(tc_SectorOffset!=tc_Temp_SectorOffset)//when one Sector is(tw_FdbOffset)finished,fdboffset should be
             - 0
 107   3                              {
 108   4                                      tw_Temp_FdbOffset=0;
 109   4                              }
 110   3      
 111   3                              for(tw_FdbOffset=tw_Temp_FdbOffset;tw_FdbOffset<512;tw_FdbOffset+=32)
 112   3                              {//Find in one sector                   
 113   4                                      tc_PlayMode=0;                          
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 3   

 114   4                                      tc_RecFlag=1;
 115   4                                      tw_DirIndex++;
 116   4                                      if(gc_UserDataBuf[tw_FdbOffset]==0xE5)
 117   4                                      {
 118   5                                              if(p_mp->c_Search_Mode==K_FIND_FREE_FDB)
 119   5                                              {
 120   6                                                      tc_sts=SUCCESS;
 121   6                                              }                               
 122   5                                      }
 123   4                                      else if(gc_UserDataBuf[tw_FdbOffset]==0x00)
 124   4                                      {
 125   5                                              if((p_mp->c_Search_Mode==K_FIND_FREE_FDB)||(p_mp->c_Search_Mode==K_FIND_LAST_FDB))
 126   5                                              {
 127   6                                                      tc_sts=SUCCESS;
 128   6                                              }
 129   5                                              else
 130   5                                              {                                       
 131   6                                                      tc_sts=FAIL;                                            //The dir is end flag
 132   6                                              }                       
 133   5                                      }
 134   4                                      else if(gc_UserDataBuf[tw_FdbOffset+0x0b]==0x0f)//is longfdb
 135   4                                      {
 136   5                                              if(p_mp->c_Search_Mode==K_SPECIFIC_LONG_FILENAME)//find by long filename
 137   5                                              {
 138   6                                                      if(gc_UserDataBuf[tw_FdbOffset]&0x40)//IS it the last longfdb?
 139   6                                                      {                                               
 140   7                                                              if(gc_UserDataBuf[tw_FdbOffset]==p_mp->pc_LongFileName[0])
 141   7                                                              {                                       
 142   8                                                                      if (*(p_mp->pc_LongFileName+1) != 0)
 143   8                                                                      {
 144   9                                                                              if((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[*(p_mp->pc_LongFileName+1)-1]]==0x00) && (gc_UserD
             -ataBuf[tw_FdbOffset+Unicode_Offset[*(p_mp->pc_LongFileName+1)-2]]==0x00))
 145   9                                                                              {
 146  10                                                                                      goto MatchEXTName;
 147  10                                                                              }
 148   9                                                                      }
 149   8                                                                      else
 150   8                                                                      {//character NUM is equal
 151   9      MatchEXTName:
 152   9                                                                              ((U8 *)(&tw_FileLongName))[0] = *(p_mp->pc_LongFileName+3);
 153   9                                                                              ((U8 *)(&tw_FileLongName))[1] = *(p_mp->pc_LongFileName+4);
 154   9                                                                              tw_FileLongName+=5;
 155   9                                                              
 156   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<(26-(*(p_mp->pc_LongFileName+1)));tw_ByteOffset++)
 157   9                                                                              {//compare the last longfdb
 158  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]]!=p_mp
             -->pc_LongFileName[tw_FileLongName-tw_ByteOffset])  //last longfdb is not equal
 159  10                                                                                      {
 160  11                                                                                              if ((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]] >=
             - 'a') && (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]] <= 'z'))
 161  11                                                                                              {//if current char is lower letter,try to compare after converting to upper letter
 162  12                                                                                                      if (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]]!=(
             -p_mp->pc_LongFileName[tw_FileLongName-tw_ByteOffset] + 0x20))
 163  12                                                                                                      {
 164  13                                                                                                              break;
 165  13                                                                                                      }
 166  12                                                                                              }
 167  11                                                                                              else
 168  11                                                                                              {
 169  12                                                                                                      break;
 170  12                                                                                              }                                                                               
 171  11                                                                                      }
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 4   

 172  10                                                                              }
 173   9                                                                              if (tw_ByteOffset==26-*(p_mp->pc_LongFileName+1))//the last longfdb is equal
 174   9                                                                              {
 175  10                                                                                      if((gc_UserDataBuf[tw_FdbOffset]&0x3f)==1)//current longfdb is the first 
 176  10                                                                                      {
 177  11                                                                                              tc_sts=SUCCESS;
 178  11                                                                                      }
 179  10                                                                                      else
 180  10                                                                                      {
 181  11                                                                                              tw_FileLongName-=tw_ByteOffset;
 182  11                                                                                      }
 183  10                                                                              }
 184   9                                                                      }
 185   8                                                              }
 186   7                                                      }
 187   6                                                      else
 188   6                                                      {//not the      "last" longfdb
 189   7                                                              for(tw_ByteOffset=0;tw_ByteOffset<26;tw_ByteOffset++)
 190   7                                                              {//compare the longfdb which is not the last
 191   8                                                                      if(gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]]!=p_mp->pc_LongFileName[tw_FileLongNa
             -me-tw_ByteOffset])
 192   8                                                                      {
 193   9                                                                              if ((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]] >= 'a') && (gc_UserDataBuf[tw_Fdb
             -Offset+Unicode_Offset[tw_ByteOffset]] <= 'z'))
 194   9                                                                              {//if current char is lower letter,try to compare after converting to upper letter
 195  10                                                                                      if (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]]!=(p_mp->pc_LongFileName[tw_FileLo
             -ngName-tw_ByteOffset] + 0x20))
 196  10                                                                                      {
 197  11                                                                                              break;
 198  11                                                                                      }
 199  10                                                                              }
 200   9                                                                              else
 201   9                                                                              {
 202  10                                                                                      break;
 203  10                                                                              }               
 204   9                                                                      }
 205   8                                                              }
 206   7                                                              if(tw_ByteOffset==26)//equal                    
 207   7                                                              {
 208   8                                                                      tw_FileLongName-=tw_ByteOffset;//the length of gc_FileLongName[] minus 26
 209   8                                                                      if((gc_UserDataBuf[tw_FdbOffset]&0x3f)==1)
 210   8                                                                      {//current longfdb is the first                                                                 
 211   9                                                                              tc_sts=SUCCESS;
 212   9                                                                      }                                               
 213   8                                                              }
 214   7                                                      }
 215   6                                              }
 216   5                                      }
 217   4                                      else
 218   4                                      {//short_fdb
 219   5                                              tw_FileLongName=*(p_mp->pc_LongFileName+4);
 220   5                                              if(gc_UserDataBuf[tw_FdbOffset+0x0b]&0x10)//2005/05/17 modify
 221   5                                              {//is dir
 222   6                                                      if(p_mp->c_Search_Attribute)
 223   6                                                      {//find dir
 224   7                                                              if(gc_UserDataBuf[tw_FdbOffset]!=0x2e)
 225   7                                                              {
 226   8                                                                      if(((p_mp->c_Search_Mode==K_FIND_DIR_EXTNAME)||(p_mp->c_Search_Mode==K_SPECIFIC_SHORT_FILENAME)))
 227   8                                                                      {
 228   9                                                                              goto EXTNAMECOMPARE;
 229   9                                                                      }
 230   8                                                                      else
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 5   

 231   8                                                                      {
 232   9                                                                              tb_flag=1; //the flag which determine if implement the flowing program
 233   9                                                                      }
 234   8                                                              }                                               
 235   7                                                      }
 236   6                                                      else if(gb_CountDirFlag && (p_mp->c_Search_Mode != K_SPECIFIC_STARTCLUSTER))
 237   6                                                      {
 238   7                                                              if(gc_UserDataBuf[tw_FdbOffset]!=0x2e) //. & ..
 239   7                                                                      gw_DirTotalNumber++; 
 240   7                                                      }
 241   6                                              }
 242   5                                              else if(!(p_mp->c_Search_Attribute))
 243   5                                              {//not to find dir
 244   6                                                      if((gc_UserDataBuf[tw_FdbOffset+0x0b]&0x08)!=0x08)//2005/05/17 modify
 245   6                                                      {
 246   7      EXTNAMECOMPARE:
 247   7                                                              if(p_mp->c_EXTSelect==1)
 248   7                                                              {//need compare EXTName                                         
 249   8                                                                      for(tc_ExtNum=0;tc_ExtNum<EXT_Name[p_mp->c_type][0];tc_ExtNum++)
 250   8                                                                      {//compare the ext_name
 251   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<3;tw_ByteOffset++)
 252   9                                                                              {//the max length of ext_name is 3 now  
 253  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+0x08+tw_ByteOffset]!=EXT_Name[p_mp->c_type][tw_ByteOffset+tc_Play
             -Mode*3+1])
 254  10                                                                                      {
 255  11                                                                                              tc_PlayMode++;
 256  11                                                                                              break;
 257  11                                                                                      }
 258  10                                                                              }
 259   9                                                                              if(tw_ByteOffset>=3)
 260   9                                                                              {//Extension name is equal
 261  10                                                                                      tb_flag=1;
 262  10                                                                                      tw_FileLongName-=3;
 263  10                                                                                      if(p_mp->c_type==1)
 264  10                                                                                      {
 265  11                                                                                              tc_PlayMode+=EXT_Name[0][0];
 266  11                                                                                      }
 267  10                                                                                      break;
 268  10                                                                              }
 269   9                                                                      }
 270   8                                                              }
 271   7                                                              else if(p_mp->c_EXTSelect==0) 
 272   7                                                              {//no need compare EXTName
 273   8                                                                      tb_flag=1;                           //the flag determines if implement the flowing programe
 274   8                                                                      tw_FileLongName-=3;
 275   8                                                              }
 276   7                                                                                                                      
 277   7                                                              if((tb_flag==1)&&(p_mp->c_type==1))                                                     
 278   7                                                              {//voice file
 279   8                                                                      for(tw_ByteOffset=0;tw_ByteOffset<4;tw_ByteOffset++)
 280   8                                                                      {//the max length of ext_name is 3 now                                                                  
 281   9                                                                              if(gc_UserDataBuf[tw_FdbOffset+tw_ByteOffset]!=REC[tw_ByteOffset])
 282   9                                                                              {
 283  10                                                                                      tb_flag=0;
 284  10                                                                                      break;
 285  10                                                                              }
 286   9                                                                      }
 287   8                                                              }                               
 288   7                                                      }
 289   6                                              }//not and not find dir
 290   5      
 291   5                                              if(tb_flag)
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 6   

 292   5                                              {
 293   6                                                      tb_flag=0;      
 294   6                                                      if(p_mp->c_type==1)
 295   6                                                      {
 296   7                                                              for(tw_ByteOffset=0;tw_ByteOffset<0x04;tw_ByteOffset++)
 297   7                                                              {
 298   8                                                                      if((gc_UserDataBuf[tw_FdbOffset+0x04+tw_ByteOffset]<0x30)||(gc_UserDataBuf [tw_FdbOffset+0x04+tw_B
             -yteOffset]>0x39))
 299   8                                                                      {
 300   9                                                                              tc_RecFlag=0;
 301   9                                                                      }               
 302   8                                                                      tdw_Temp_flag=tdw_Temp_flag<<8;                 
 303   8                                                                      tdw_Temp_flag|=gc_UserDataBuf [tw_FdbOffset+0x04+tw_ByteOffset];  //sorts the name of current fdb
 304   8                                                              }
 305   7                                                      }
 306   6      
 307   6                                                      if(p_mp->c_Search_Mode==K_COUNTER_FILENUM)
 308   6                                                      {                                                                                                                                               
 309   7                                                              if(tc_RecFlag)
 310   7                                                              {                                       
 311   8                                                                      p_mp->w_FileTotalNum++;
 312   8                                                              }
 313   7                                                      }
 314   6                                                      else if((p_mp->c_Search_Mode==K_TIME_FINDFDB)||p_mp->c_Search_Mode==K_NAME_FINDFDB)               //find by cre
             -ate time
 315   6                                                      {                               
 316   7                                                              ((U8 *)(&tdw_StartCluster1))[0]=gc_UserDataBuf[tw_FdbOffset+0x15];
 317   7                                                              ((U8 *)(&tdw_StartCluster1))[1]=gc_UserDataBuf[tw_FdbOffset+0x14];
 318   7                                                              ((U8 *)(&tdw_StartCluster1))[2]=gc_UserDataBuf[tw_FdbOffset+0x1B];
 319   7                                                              ((U8 *)(&tdw_StartCluster1))[3]=gc_UserDataBuf[tw_FdbOffset+0x1A];
 320   7                                                      
 321   7                                                              if(tc_RecFlag)
 322   7                                                              {                       
 323   8                                                                      if(p_mp->c_Search_Direction)  
 324   8                                                                      {//find pre                                             
 325   9                                                                              if((tdw_Tag0<=tdw_Temp_flag)&&(tdw_Temp_flag<tdw_Tag1))
 326   9                                                                              {                                       
 327  10                                                                                      tdw_Tag0= tdw_Temp_flag;
 328  10                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 329  10                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 330  10                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 331  10                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 332  10                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 333  10                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 334  10                                                                                      tb_SortFlag=1;  
 335  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType=tc_PlayMode;                                                               
 336  10                                                                              }                                                       
 337   9                                                                              else if(tdw_Temp_flag==tdw_Tag1)
 338   9                                                                              {                                                               
 339  10                                                                                      if(tdw_StartCluster1!=p_mp->dw_File_StartCluster)
 340  10                                                                                      {//startcluster is not equal
 341  11                                                                                              if(!tb_SameFlag)
 342  11                                                                                              {//current fdb is  before pre fdb which we stored                                                                               
 343  12                                                                                                      tdw_Tag0= tdw_Temp_flag;
 344  12                                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 345  12                                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 346  12                                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 347  12                                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 348  12                                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 349  12                                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 350  12                                                                                                      tb_SortFlag=1;
 351  12                                                                                                      gs_File_FCB[p_mp->c_type].c_FileType=tc_PlayMode;                                                                                                                                                                       
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 7   

 352  12                                                                                              }                                                                       
 353  11                                                                                      }
 354  10                                                                                      else
 355  10                                                                                      {
 356  11                                                                                              tb_SameFlag=1;  
 357  11                                                                                      }                                                               
 358  10                                                                              }                                                                                                               
 359   9                                                                      }
 360   8                                                                      else
 361   8                                                                      {//find next
 362   9                                                                              if((tdw_Tag1<tdw_Temp_flag)&&(tdw_Temp_flag<tdw_Tag0))
 363   9                                                                              {                                                                                                                               
 364  10                                                                                      tdw_Tag0= tdw_Temp_flag;
 365  10                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 366  10                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 367  10                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 368  10                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 369  10                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 370  10                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;                                                                       
 371  10                                                                                      tb_SortFlag=1;  
 372  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType=tc_PlayMode;                                               
 373  10                                                                              }
 374   9                                                                              if(tdw_Temp_flag!=tdw_Tag0)
 375   9                                                                              {
 376  10                                                                                      if(tdw_Temp_flag==tdw_Tag1)     
 377  10                                                                                      {                                                       
 378  11                                                                                              if(tdw_StartCluster1!=p_mp->dw_File_StartCluster)
 379  11                                                                                              {//startcluster is not equal
 380  12                                                                                                      if(tb_SameFlag)
 381  12                                                                                                      {//current fdb is after pre fdb which we stored                                                                                 
 382  13                                                                                                              tdw_Tag0=tdw_Temp_flag;
 383  13                                                                                                              p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 384  13                                                                                                              p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 385  13                                                                                                              p_mp->w_FDB_Offset=tw_FdbOffset;
 386  13                                                                                                              tdw_StartCluster3=tdw_StartCluster1;
 387  13                                                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 388  13                                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;                                                                                               
 389  13                                                                                                              tb_SortFlag=1;
 390  13                                                                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                                                             
 391  13                                                                                                      }
 392  12                                                                                              }
 393  11                                                                                              else
 394  11                                                                                              {
 395  12                                                                                                      tb_SameFlag=1;  
 396  12                                                                                              }               
 397  11                                                                                      }
 398  10                                                                              }                                                               
 399   9                                                                      }
 400   8                                                              }
 401   7                                                      }                                                       
 402   6                                                      else if(p_mp->c_Search_Mode==K_ORDER_FINDFDB || p_mp->c_Search_Mode==K_FIND_DIR_EXTNAME) //find by      o
             -rder
 403   6                                                      {                                                       
 404   7                                                              if(p_mp->c_Search_Direction) 
 405   7                                                              {//previous
 406   8                                                                      if(tw_DirIndex<gw_DirIndex[p_mp->c_Search_Attribute])
 407   8                                                                      {
 408   9                                                                              tw_DirIndex1=tw_DirIndex;
 409   9                                                                              p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 410   9                                                                              p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 411   9                                                                              p_mp->w_FDB_Offset=tw_FdbOffset;                                                                        
 412   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 8   

 413   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 414   9                                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;     
 415   9                                                                              tb_SortFlag=1;
 416   9                                                                      }
 417   8                                                                      else//(JC)
 418   8                                                                      {
 419   9                                                                              tc_sts=FAIL;                                    
 420   9                                                                      }
 421   8                                                              }
 422   7                                                              else
 423   7                                                              { //next                                                                                                 
 424   8                                                                      if(tw_DirIndex>(gw_DirIndex[p_mp->c_Search_Attribute]))
 425   8                                                                      {
 426   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 427   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 428   9                                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex;
 429   9                                                                              tc_sts=SUCCESS;                                                                                                                                                                                                         
 430   9                                                                              gb_FindFile=1;//Ching 080805                                                                                                                                                                                            
 431   9                                                                      }                       
 432   8                                                              }
 433   7                                                      }
 434   6                                                      else if(p_mp->c_Search_Mode==K_SPECIFIC_STARTCLUSTER)   //find by StartCluster
 435   6                                                      {                                               
 436   7                                                              ((U8 *)(&tdw_StartCluster))[0]=gc_UserDataBuf[tw_FdbOffset+0x15];
 437   7                                                              ((U8 *)(&tdw_StartCluster))[1]=gc_UserDataBuf[tw_FdbOffset+0x14];
 438   7                                                              ((U8 *)(&tdw_StartCluster))[2]=gc_UserDataBuf[tw_FdbOffset+0x1b];
 439   7                                                              ((U8 *)(&tdw_StartCluster))[3]=gc_UserDataBuf[tw_FdbOffset+0x1a];
 440   7                                                              if(p_mp->c_Search_Direction)
 441   7                                                              {
 442   8                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 443   8                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 444   8                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 445   8                                                                      
 446   8                                                                      if(tdw_StartCluster==p_mp->Compare.dw_StartCluster)
 447   8                                                                      {
 448   9                                                                              if(tb_not_1stFDB)
 449   9                                                                              {
 450  10                                                                                      p_mp->dw_FDB_Cluster=tdw_PrevFDB_Cluster;
 451  10                                                                                      p_mp->dw_FDB_LogAdd=tdw_PrevFDB_LogAdd;
 452  10                                                                                      p_mp->w_FDB_Offset=tw_PrevFDB_Offset;
 453  10                                                                                      tb_not_1stFDB=0;                
 454  10                                                                              }
 455   9                                                                              return 0;
 456   9                                                                      }
 457   8                                                                      else
 458   8                                                                      {
 459   9                                                                              tb_not_1stFDB=1;
 460   9                                                                              if(p_mp->c_Search_Direction && p_mp->c_Search_Attribute) 
 461   9                                                                              {
 462  10                                                                                      tdw_PrevFDB_Cluster=tdw_S_ClusterNum;
 463  10                                                                                      tdw_PrevFDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 464  10                                                                                      tw_PrevFDB_Offset=tw_FdbOffset;                                                                         
 465  10                                                                              }       
 466   9                                                                      }
 467   8                                                              }
 468   7                                                              else
 469   7                                                              {
 470   8                                                                      if(tdw_StartCluster==p_mp->Compare.dw_StartCluster)
 471   8                                                                      {
 472   9                                                                              tc_sts=0;
 473   9                                                                      }
 474   8                                                              }                                                       
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 9   

 475   7                                                      }
 476   6                                                      else if(p_mp->c_Search_Mode==K_SPECIFIC_SHORT_FILENAME)
 477   6                                                      {//find by short file name
 478   7                                                              tw_FileLongName=5;      // Only for Search Folder-VOICE
 479   7                                                              for(tw_ByteOffset=0;tw_ByteOffset<tw_FileLongName;tw_ByteOffset++)
 480   7                                                              {//Compare shortfdb
 481   8                                                                      if(gc_UserDataBuf[tw_FdbOffset+tw_ByteOffset]!=p_mp->pc_LongFileName[5+tw_ByteOffset])
 482   8                                                                      {
 483   9                                                                              break;
 484   9                                                                      }
 485   8                                                              }//compare shortfdb
 486   7                                                              if(tw_ByteOffset==tw_FileLongName)
 487   7                                                              {//short file name is equal                                             
 488   8                                                                      //debug: ex. search 01.txt, but find 012.txt (012's FDB in front of 01's FDB), Ching 100224
 489   8                                                                      tb_DiffFlag=0;
 490   8                                                                      if(tw_FileLongName<8)
 491   8                                                                      {
 492   9                                                                              if(gc_UserDataBuf[tw_FdbOffset+tw_FileLongName]!=0x20)
 493   9                                                                              {
 494  10                                                                                      tb_DiffFlag=1;
 495  10                                                                              }
 496   9                                                                      }
 497   8      
 498   8                                                                      if(tb_DiffFlag==0)
 499   8                                                                      {
 500   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;//add for DRM
 501   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;//add for DRM
 502   9                                                                              if(p_mp->c_EXTSelect==1)//hao.yang 090314
 503   9                                                                              {
 504  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;
 505  10                                                                              }
 506   9                                                                              tc_sts=SUCCESS;
 507   9                                                                      }
 508   8                                                              }                                               
 509   7                                                      }                                       
 510   6                                              }
 511   5                                      }//short_fdb            
 512   4                                      if(!tc_sts) //Get what we want to get
 513   4                                      {
 514   5                                              if((gb_TriggerFileSkip==0) || (tw_FileSkipNumber==0))   //Ching 080805
 515   5                                              {
 516   6      NextFIND:   //Ching 080805
 517   6                                                      if(p_mp->c_Search_Attribute)
 518   6                                                      {
 519   7                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex;
 520   7                                                      }
 521   6              
 522   6                                                      if (p_mp->c_Search_Mode < K_SPECIFIC_LONG_FILENAME)
 523   6                                                      {
 524   7                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                     
 525   7                                                      }
 526   6                                                      else if (p_mp->c_Search_Mode == K_SPECIFIC_LONG_FILENAME)
 527   6                                                      {
 528   7                                                              tw_FdbOffset+=32;
 529   7                                                              if (tw_FdbOffset == 0x200)
 530   7                                                              {
 531   8                                                                      tw_FdbOffset = 0;
 532   8                                                                      p_mp->dw_LongFDB_LogAdd1 = tdw_FDB_LogAdd0;//add for DRM        
 533   8                                                                      p_mp->dw_LongFDB_LogAdd0 = tc_SectorOffset+tdw_SectorAdd;//add for DRM  
 534   8                                                                      tc_SectorOffset ++;
 535   8                                                                      if (tc_SectorOffset == gc_DOS_SectorPerCluster)
 536   8                                                                      {
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 10  

 537   9                                                                              tdw_S_ClusterNum = DOS_GetNextCluster(tdw_S_ClusterNum,1);
 538   9                                                                              tdw_SectorAdd=DOS_ClusterLogicAddr(tdw_S_ClusterNum);
 539   9                                                                              tc_SectorOffset = 0;
 540   9                                                                      }
 541   8                                                                      DOS_Read_LogicSector(tdw_SectorAdd+tc_SectorOffset);//tangwei add 090314 for RTC
 542   8                                                              }
 543   7                                                              else
 544   7                                                              {
 545   8                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;//add for DRM
 546   8                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;//add for DRM
 547   8                                                              }
 548   7                                                              //================================tangwei add for RTC 090314 start=================
 549   7                                                              if(p_mp->c_EXTSelect==1)
 550   7                                                              {//need compare EXTName                                         
 551   8                                                                      for(tc_ExtNum=0;tc_ExtNum<EXT_Name[p_mp->c_type][0];tc_ExtNum++)
 552   8                                                                      {//compare the ext_name
 553   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<3;tw_ByteOffset++)
 554   9                                                                              {//the max length of ext_name is 3 now                                                                  
 555  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+0x08+tw_ByteOffset]!=EXT_Name[p_mp->c_type][tw_ByteOffset+tc_Play
             -Mode*3+1])
 556  10                                                                                      {
 557  11                                                                                              tc_PlayMode++;
 558  11                                                                                              break;
 559  11                                                                                      }
 560  10                                                                              }
 561   9                                                                              if(tw_ByteOffset>=3)
 562   9                                                                              {//Extension name is equal
 563  10                                                                                      if(p_mp->c_type==1)
 564  10                                                                                      {
 565  11                                                                                              tc_PlayMode+=EXT_Name[0][0];
 566  11                                                                                      }
 567  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;
 568  10                                                                                      break;
 569  10                                                                              }
 570   9                                                                      }
 571   8                                                              }
 572   7                                                              //==================================tangwei add for RTC 090314 end===================
 573   7                                                      }
 574   6              
 575   6                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 576   6                                                      p_mp->dw_FDB_LogAdd=tdw_SectorAdd+tc_SectorOffset;
 577   6                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 578   6                                                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;
 579   6                                                      return(SUCCESS);
 580   6                                              }
 581   5                                              else    //Ching 080805
 582   5                                              {
 583   6                                                      if(gb_FindFile==1)
 584   6                                                      {
 585   7                                                              gb_FindFile=0;
 586   7                                                              gw_FileSkipNumber--;
 587   7                                                              if(gw_FileSkipNumber==0)
 588   7                                                              {
 589   8                                                                      goto NextFIND;
 590   8                                                              }
 591   7                                                      }
 592   6                                              }// end of else Ching 080805
 593   5                                      }
 594   4                                      else
 595   4                                      {//not get what we want directly
 596   5                                              if(tc_sts==FAIL)
 597   5                                              {//the  fdb is end or the mode oversteps  
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 11  

 598   6                                                      if(tb_SortFlag)
 599   6                                                      {//sort success 
 600   7                                                              tb_SortFlag=0;  
 601   7                                                              tb_SameFlag=0;
 602   7                                                              p_mp->dw_File_StartCluster=tdw_StartCluster3;//save startcluster of current fdb
 603   7                                                              p_mp->Compare.dw_BubbleFlag=tdw_Tag0;
 604   7                                                              p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;
 605   7                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex1;
 606   7                                                              return(SUCCESS);
 607   7                                                      }
 608   6                                                      else
 609   6                                                      {
 610   7                                                              p_mp->dw_FDB_Cluster = tdw_S_ClusterNum;
 611   7                                                              p_mp->dw_FDB_LogAdd = tdw_SectorAdd+tc_SectorOffset;
 612   7                                                              p_mp->w_FDB_Offset = tw_FdbOffset;
 613   7                                                              p_mp->dw_FDB_StartCluster = tdw_FDBClusterNum;
 614   7                                                              return(FAIL);                   
 615   7                                                      }
 616   6                                              }                                       
 617   5                                      }
 618   4                              }
 619   3                              tdw_FDB_LogAdd1=tdw_FDB_LogAdd0;
 620   3                              tdw_FDB_LogAdd0=tdw_SectorAdd+tc_SectorOffset;                                          
 621   3                      }//for(tc_SectorOffset=tc_Temp_SectorOffset;tc_SectorOffset<tdw_Find_ClusterSize;tc_SectorOffset++)--->f
             -ind in one cluster
 622   2                      tdw_S_ClusterNum=DOS_GetNextCluster(tdw_S_ClusterNum,1);                
 623   2              }//while(tdw_S_ClusterNum<0xffff)------>find in one dir
 624   1              if(tb_SortFlag)
 625   1              {//sort success                                                                                         
 626   2                      tb_SortFlag=0;  
 627   2                      tb_SameFlag=0;
 628   2                      p_mp->dw_File_StartCluster=tdw_StartCluster3;          //save startcluster of current fdb
 629   2                      p_mp->Compare.dw_BubbleFlag=tdw_Tag0;                                           
 630   2                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;                                            
 631   2                      gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex1;                                   
 632   2                      return 0;
 633   2              }
 634   1              else
 635   1              {               
 636   2                      p_mp->dw_FDB_Cluster = tdw_S_ClusterNum;
 637   2                      p_mp->dw_FDB_LogAdd = tdw_SectorAdd+tc_SectorOffset;
 638   2                      p_mp->w_FDB_Offset = tw_FdbOffset;
 639   2                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;    
 640   2                      return 1;                       
 641   2              }
 642   1      }
 643          
 644          void DOS_FillFdb(U8 *tpc_Fdb,U8 *tpc_Name,U32 tdw_StartCluster,U32 tdw_FileSize)
 645          {
 646   1              // update new name
 647   1              memcpy(tpc_Fdb,tpc_Name,0x0C);                                                                  
 648   1              gw_DOS_CreateDate=(U16)(gc_Year+30)*0x0200+(U16)gc_Month*0x0020+gc_Day;
 649   1              gw_DOS_CreateTime=(U16)gc_Hour*0x0800+(U16)gc_Min*0x0020+gc_Sec;
 650   1      
 651   1              tpc_Fdb[0x0C]=0;        // reserved 
 652   1              tpc_Fdb[0x0D]=0;        // creation time in millisecond 
 653   1                      
 654   1              //creation time
 655   1              tpc_Fdb[0x0E]=gw_DOS_CreateTime;
 656   1              tpc_Fdb[0x0F]=gw_DOS_CreateTime>>8;
 657   1              
 658   1              //creation date
C51 COMPILER V9.00   DOSFDB                                                                07/09/2012 21:16:45 PAGE 12  

 659   1              tpc_Fdb[0x10]=gw_DOS_CreateDate;                
 660   1              tpc_Fdb[0x11]=gw_DOS_CreateDate>>8;     
 661   1              
 662   1              //last access date
 663   1              tpc_Fdb[0x12]=gw_DOS_CreateDate;
 664   1              tpc_Fdb[0x13]=gw_DOS_CreateDate>>8;     
 665   1              
 666   1              //high word of start cluster number
 667   1              tpc_Fdb[0x14]=tdw_StartCluster>>16;             
 668   1              tpc_Fdb[0x15]=tdw_StartCluster>>24;
 669   1      
 670   1              //last modify time
 671   1              tpc_Fdb[0x16]=gw_DOS_CreateTime;
 672   1              tpc_Fdb[0x17]=gw_DOS_CreateTime>>8;
 673   1              
 674   1              //last modify date
 675   1              tpc_Fdb[0x18]=gw_DOS_CreateDate;                
 676   1              tpc_Fdb[0x19]=gw_DOS_CreateDate>>8;
 677   1      
 678   1              tpc_Fdb[0x1A]=tdw_StartCluster;
 679   1              tpc_Fdb[0x1B]=tdw_StartCluster>>8;
 680   1      
 681   1              tpc_Fdb[0x1C]=tdw_FileSize;
 682   1              tpc_Fdb[0x1D]=tdw_FileSize>>8;
 683   1              tpc_Fdb[0x1E]=tdw_FileSize>>16;
 684   1              tpc_Fdb[0x1F]=tdw_FileSize>>24;
 685   1      }
 686          
 687          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3184    ----
   CONSTANT SIZE    =      4    ----
   XDATA SIZE       =   ----      77
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       6
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
