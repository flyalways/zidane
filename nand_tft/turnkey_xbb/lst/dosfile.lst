C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DOSFILE
OBJECT MODULE PLACED IN .\obj\dosfile.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\LIBSOURCE\DOS\dosfile.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\
                    -libsource\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\dosfile.lst) OBJECT(.\obj\dosfile.obj)

line level    source

   1          #include <string.h>
   2          #include "SPDA2K.h"
   3          #include "dos\fs_struct.h"
   4          #include "dos\dosfdb.h"
   5          #include "dos\dosfile.h"
   6          #include "Memalloc.h"
   7          
   8          extern U8       gc_clock_mode;
   9          //-------------------------------------------------------------------------------
  10          U32 DOS_Seek_File(U8 tc_FileHandle, U32 tdw_SectorNumber)
  11          {
  12   1              U32 tdw_ClusterNum;
  13   1              U32 tdw_NextClusterNum;
  14   1      
  15   1              if (gs_File_FCB[tc_FileHandle].dw_File_StartCluster==0xffffffff)
  16   1              {
  17   2                      return 1;       
  18   2              }
  19   1              tdw_ClusterNum = tdw_SectorNumber/gc_DOS_SectorPerCluster;
  20   1      
  21   1              gs_File_FCB[tc_FileHandle].dw_File_DataPoint = tdw_SectorNumber<<9;
  22   1              if ((tdw_SectorNumber%gc_DOS_SectorPerCluster)==0)
  23   1              {
  24   2                      if(tdw_ClusterNum)
  25   2                              tdw_ClusterNum = tdw_ClusterNum-1;
  26   2              }
  27   1              tdw_NextClusterNum = DOS_GetNextCluster(gs_File_FCB[tc_FileHandle].dw_File_CurrentCluster,tdw_ClusterNum)
             -;
  28   1              return (tdw_NextClusterNum);
  29   1      }
  30          
  31          
  32          U8      DOS_Search_File(U8 tc_Mode, U8 tc_Type, U8 tc_PrevOrNext)
  33          {
  34   1              U16     tw_FileSkipNumber;
  35   1              U8  tc_sts;
  36   1              U8      tb_IniFlag;      
  37   1              U8  tc_FindDir,tc_FindFile;                                                     //whether search file or search dir flag
  38   1              U8  tc_SearchTime;
  39   1              U8  tc_clock_mode_backup;
  40   1              U32 tdw_SectorAdd,tdw_CurrentDirCluster,tdw_PrevDirCluster,tdw_NextDirCluster;
  41   1              SearchFdb ptr;
  42   1              
  43   1              tc_clock_mode_backup=gc_clock_mode;
  44   1              set_clock_mode(CLOCK_MODE_MJPEG);
  45   1              
  46   1              tw_FileSkipNumber=gw_FileSkipNumber;
  47   1              gs_File_FCB[tc_Type].dw_File_StartCluster = 0xffffffff;
  48   1              gs_File_FCB[tc_Type].dw_FDB_LogAdd = 0;
  49   1      
  50   1              tc_sts=1;       
  51   1              tb_IniFlag=0;
  52   1              ptr.w_FileTotalNum=0;
  53   1              gb_ReadWriteDataArea=1;
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 2   

  54   1              if((tc_Mode&0x0f)==1)
  55   1              {//if search file by time, please search by order
  56   2                      tc_Mode|=0x03;  
  57   2              }       
  58   1              ptr.pc_LongFileName = gc_FileLongName; 
  59   1              ptr.c_Search_Mode=(tc_Mode&0x0f);
  60   1              ptr.c_EXTSelect = ((tc_PrevOrNext & 0xf0) >> 4);                //need to compare ExtName
  61   1              tc_PrevOrNext = tc_PrevOrNext & 0x0f;
  62   1              if((tc_Mode&0x0f)==0||(tc_Mode&0x0f)==4||(tc_Mode&0x0f)==5)
  63   1              {//count filenum, find by long short filename -> find next
  64   2                      tc_PrevOrNext=0;
  65   2              }
  66   1      
  67   1              ptr.c_Search_Direction=tc_PrevOrNext;
  68   1              ptr.Compare.dw_BubbleFlag = gdw_CurrFlag;
  69   1              ptr.dw_File_StartCluster = gdw_StartCluster2;
  70   1              ptr.c_type=tc_Type;     
  71   1              if(gb_CountDirFlag) tc_SearchTime=1; //Ching 100514
  72   1              else                            tc_SearchTime=2; 
  73   1              while(tc_SearchTime)
  74   1              {
  75   2                      if((tc_Mode&0x0f0)==0x20)
  76   2                      {//find dir (JC)find dir overall
  77   3                              tc_FindFile=0;
  78   3                              tc_FindDir=1;
  79   3                              ptr.dw_FDB_StartCluster=gs_DIR_FCB[tc_Type].dw_FDB_StartCluster;//(JC)start cluster of the dir that cur
             -rent file fdb is in
  80   3                      }
  81   2                      else
  82   2                      {//find file (JC)find file in one dir or overall, find dir in one dir not included?
  83   3                              tc_FindFile=1;
  84   3                              tc_FindDir=0;   
  85   3                              ptr.dw_FDB_StartCluster=gs_File_FCB[tc_Type].dw_FDB_StartCluster;//(JC)start cluster of the dir that cu
             -rrent file fdb is in  
  86   3                      }
  87   2                      if(gb_FindFlag==0)//(JC)Normally for 1st time search fail
  88   2                      {//have not searched                   
  89   3                              ptr.dw_File_StartCluster = gdw_DOS_RootDirClus;
  90   3                              gs_DIR_FCB[tc_Type].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
  91   3                              gs_DIR_FCB[tc_Type].dw_File_StartCluster = gdw_DOS_RootDirClus;
  92   3                              if(ptr.c_Search_Direction)//(JC)search previous
  93   3                              {
  94   4                                      if(((tc_Mode&0x0f)==K_TIME_FINDFDB)||((tc_Mode&0x0f)==K_NAME_FINDFDB))//(JC)Find by time or find by na
             -me
  95   4                                      {
  96   5                                              ptr.Compare.dw_BubbleFlag=0xffffffff;
  97   5                                      }
  98   4                                      tc_FindDir=1;
  99   4                                      
 100   4                                      gw_DirIndex[0]=0xffff;          //gw_DirIndex1 used to save the index of the fdb which find just now      
             -         lizhn 040927 add
 101   4                                      gw_DirIndex[1]=0xffff;     //gw_DirIndex0 used to save the index of the last fdb                                        
 102   4                              }
 103   3                              else
 104   3                              {
 105   4                                      if(((tc_Mode&0x0f)==K_TIME_FINDFDB)||((tc_Mode&0x0f)==K_NAME_FINDFDB))
 106   4                                      {
 107   5                                              ptr.Compare.dw_BubbleFlag=0x00;
 108   5                                      }
 109   4                                      gw_DirIndex[0] = 0;
 110   4                                      gw_DirIndex[1] = 0;
 111   4                              }       
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 3   

 112   3                      }
 113   2                      if((tc_Mode&0x0f0)==0x10)
 114   2                      {//find file in one dir
 115   3                              ptr.c_Search_Attribute=0;                                               //(JC)look 4 file
 116   3                              gb_TriggerFileSkip=1;                                                   //Ching 081016          
 117   3                              tc_sts=Find_Fdb(&ptr);  
 118   3                              gb_TriggerFileSkip=0;                                                   //Ching 081016
 119   3                      }
 120   2                      else
 121   2                      {//find in all dir ,(JC)find file or dir in all dir w/ the same path            
 122   3                              if(tc_PrevOrNext)
 123   3                              {//find pre
 124   4                                      //dbprintf("search previous!\n");
 125   4                                      while(1)
 126   4                                      {                                                                       
 127   5                                              if(tc_FindDir)
 128   5                                              {//not found dir in the dir in the last time but found file
 129   6                                                      ptr.c_Search_Mode=K_ORDER_FINDFDB;
 130   6                                                      ptr.c_Search_Attribute=1;                       //(JC)look for dir
 131   6                                                      tc_sts=Find_Fdb(&ptr);
 132   6                                              }                               
 133   5                                              if(tc_sts)
 134   5                                              {//haven't found dir
 135   6                                                      if(tb_IniFlag)
 136   6                                                      {
 137   7                                                              tb_IniFlag=0;                                   
 138   7                                                              ptr.Compare.dw_BubbleFlag=0xffffffff;
 139   7                                                      }
 140   6                                                      if((tc_Mode&0x0f)==2)
 141   6                                                      {//if find the file by name,please find dir by time
 142   7                                                              ptr.c_Search_Mode=2;
 143   7                                                      }
 144   6                                                      if(tc_FindFile)
 145   6                                                      {
 146   7                                                              ptr.c_Search_Attribute=0;
 147   7                                                              tc_sts=Find_Fdb(&ptr);                                  
 148   7                                                      }
 149   6                                                      if(tc_sts)
 150   6                                                      {//not find file
 151   7                                                              tc_FindDir=1;
 152   7                                                              if(ptr.dw_FDB_StartCluster!=gdw_DOS_RootDirClus)
 153   7                                                              {//current dir is not rootdir                                                   
 154   8                                                                      tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 155   8                                                                      gb_ReadWriteDataArea=1;
 156   8                                                                      //dbprintf("reading out the start cluster of '..'\n");
 157   8                                                                      if(DOS_Read_LogicSector(tdw_SectorAdd,1))//(JC)for reading out the start cluster of ".."
 158   8                                                                      {
 159   9                                                                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 160   9                                                                              return 0xff;
 161   9                                                                      }
 162   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 163   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 164   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 165   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15]; //computer the startcluster of predir//(
             -JC)".."upper dir 
 166   8      
 167   8                                                                      if(!(tdw_PrevDirCluster))
 168   8                                                                      {//predir is rootdir
 169   9                                                                              tdw_PrevDirCluster=gdw_DOS_RootDirClus;
 170   9                                                                      }
 171   8                                                                      ptr.dw_File_StartCluster=ptr.dw_FDB_StartCluster;//(JC)start cluster of this dir layer
 172   8                                                                      ptr.dw_FDB_StartCluster=tdw_PrevDirCluster;
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 4   

 173   8                                                                      //return to predir
 174   8                                                                      tb_IniFlag=1;
 175   8                                                                      if((tc_Mode&0x0f)==0x03)
 176   8                                                                      {//find dir by order
 177   9                                                                              //modified for Fake Flash Size, Ching 090420 === S
 178   9                                                                              U32 tdw_Cluster, tdw_LogicAdd;
 179   9                                                                              bit tbt_IsFakeFDB=0, tbt_BreakFlag=0;
 180   9      
 181   9                                                                              do
 182   9                                                                              {
 183  10                                                                                      tbt_IsFakeFDB=0;
 184  10                                                                                      gw_DirIndex[0]=0xffff;
 185  10                                                                                      ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;//(JC)search start cluster=ptr.dw_File_StartCluster 
             -from ptr.dw_FDB_StartCluster找目前所在目錄FDB是否在上層目錄
 186  10                                                                                      ptr.Compare.dw_StartCluster =ptr.dw_File_StartCluster;
 187  10                                                                                      ptr.c_Search_Attribute = 1;
 188  10                                                                                      if(Find_Fdb(&ptr))
 189  10                                                                                      {
 190  11                                                                                              tbt_BreakFlag=1; //Ching 090420
 191  11                                                                                              break;
 192  11                                                                                      }
 193  10      
 194  10                                                                                      if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd,1))   return 0xff;
 195  10      
 196  10                                                                                      ((U8 *)(&tdw_Cluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
 197  10                                                                                      ((U8 *)(&tdw_Cluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 198  10                                                                                      ((U8 *)(&tdw_Cluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 199  10                                                                                      ((U8 *)(&tdw_Cluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];
 200  10                                                                                      tdw_LogicAdd=DOS_ClusterLogicAddr(tdw_Cluster);
 201  10                                                                                      if(DOS_Read_LogicSector(tdw_LogicAdd,1))        
 202  10                                                                                      {
 203  11                                                                                              return 0xff;
 204  11                                                                                      }
 205  10      
 206  10                                                                                      if((gc_UserDataBuf[0x00]!=0x2E) || (gc_UserDataBuf[0x0B]!=0x10) || (gc_UserDataBuf[0x20]!=0x2E) 
             -|| (gc_UserDataBuf[0x21]!=0x2E) || (gc_UserDataBuf[0x2B]!=0x10))
 207  10                                                                                      {
 208  11                                                                                              tbt_IsFakeFDB=1;
 209  11                                                                                              ptr.dw_File_StartCluster=tdw_Cluster;
 210  11                                                                                      }
 211  10      
 212  10                                                                                      if(!tbt_IsFakeFDB)
 213  10                                                                                      {
 214  11                                                                                              if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd,1)) //(JC)FDB sector addr, w_FDB_Offset(x32B) is the 
             -FDb found
 215  11                                                                                              {
 216  12                                                                                                      set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 217  12                                                                                                      return 0xff;
 218  12                                                                                              }
 219  11              
 220  11                                                                                              if((((U8 *)(&ptr.Compare.dw_StartCluster))[3]!= gc_UserDataBuf[ptr.w_FDB_Offset+0x1a])||(((U8 *
             -)(&ptr.Compare.dw_StartCluster))[2]!= gc_UserDataBuf[ptr.w_FDB_Offset+0x1b])||
 221  11                                                                                                      (((U8 *)(&ptr.Compare.dw_StartCluster))[1]!= gc_UserDataBuf[ptr.w_FDB_Offset+0x14])||(((U8 *)(
             -&ptr.Compare.dw_StartCluster))[0]!= gc_UserDataBuf[ptr.w_FDB_Offset+0x15]))
 222  11                                                                                              {//(JC)previous dir exist
 223  12                                                                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];//(JC)start cluste
             -r no. in FDB found
 224  12                                                                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 225  12                                                                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 226  12                                                                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];
 227  12                                                                                                      ptr.Compare.dw_BubbleFlag=0xffffffff;   
 228  12                                                                                                      gw_DirIndex[1]=0xffff;
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 5   

 229  12                                                                                                      if((tc_Mode&0xf0)==0x20)
 230  12                                                                                                      {//find dir by order
 231  13                                                                                                              gw_DirIndex[ptr.c_Search_Mode] = 0xffff;                                                                                        
 232  13                                                                                                              tc_FindFile=0;
 233  13                                                                                                      }
 234  12                                                                                                      tc_FindDir=1;
 235  12                                                                                                      if(((tc_Mode&0xf0)==0x20))
 236  12                                                                                                      {                                                                       
 237  13                                                                                                              if(gs_DIR_FCB[tc_Type].dw_File_StartCluster!=ptr.dw_File_StartCluster)
 238  13                                                                                                              {
 239  14                                                                                                                      tc_sts=0;
 240  14                                                                                                                      tbt_BreakFlag=1; //Ching 090420
 241  14                                                                                                                      break;
 242  14                                                                                                              }
 243  13                                                                                                              else
 244  13                                                                                                              {
 245  14                                                                                                                      gw_DirIndex[1]=0xffff;
 246  14                                                                                                              }                                                                       
 247  13                                                                                                      }
 248  12                                                                                              }
 249  11                                                                                              else
 250  11                                                                                              {
 251  12                                                                                                      tc_FindDir=0;
 252  12                                                                                                      tc_FindFile=1;
 253  12                                                                                                      tc_sts=2;
 254  12                                                                                                      gw_DirIndex[0]=0xffff;
 255  12                                                                                                      ptr.c_Search_Mode=K_ORDER_FINDFDB;
 256  12                                                                                                      ptr.dw_FDB_StartCluster=tdw_PrevDirCluster;     
 257  12                                                                                                      ptr.dw_FDB_Cluster=ptr.dw_FDB_StartCluster;             
 258  12                                                                                              }
 259  11                                                                                      }
 260  10                                                                              }while(tbt_IsFakeFDB);
 261   9      
 262   9                                                                              if(tbt_BreakFlag)       break; //Ching 090420
 263   9                                                                              //modified for Fake Flash Size, Ching 090420 === E
 264   9                                                                      }
 265   8                                                              }
 266   7                                                              else
 267   7                                                              {//current dir is rootdir //(JC)no upper dir                    
 268   8                                                                      break;                                          
 269   8                                                              }
 270   7                                                      }
 271   6                                                      else
 272   6                                                      {                                               
 273   7                                                              break;                                  
 274   7                                                      }
 275   6                                              }                       
 276   5                                              else
 277   5                                              {//have found dir in dir                                        
 278   6                                                      gb_ReadWriteDataArea=1;         
 279   6                                                      if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd,1))//(JC)FDB sector addr, w_FDB_Offset(x32B) is the FDb fo
             -und
 280   6                                                      {
 281   7                                                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 282   7                                                              return 0xff;
 283   7                                                      }
 284   6                                                      tdw_CurrentDirCluster=ptr.dw_FDB_StartCluster;                                                          //save current dir(X)
 285   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];//(JC)start cluster no. 
             -in FDB found
 286   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 287   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 288   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];//next dir cluster 
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 6   

 289   6                                                                                      
 290   6                                                      tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 291   6                                                      if(DOS_Read_LogicSector((tdw_SectorAdd),1))
 292   6                                                      {
 293   7                                                              // For dummy size
 294   7                                                              if(gw_FileIndex[0]==1)
 295   7                                                              {
 296   8                                                                      gw_FileIndex[0]=0;
 297   8                                                              }
 298   7                                                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 299   7                                                              return 0xff;                                            
 300   7                                                      }
 301   6                                                      
 302   6                                                      ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 303   6                                                      ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 304   6                                                      ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 305   6                                                      ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];
 306   6              
 307   6                                                      ((U8 *)(&tdw_NextDirCluster))[3]=gc_UserDataBuf[0x1a];
 308   6                                                      ((U8 *)(&tdw_NextDirCluster))[2]=gc_UserDataBuf[0x1b];
 309   6                                                      ((U8 *)(&tdw_NextDirCluster))[1]=gc_UserDataBuf[0x14];
 310   6                                                      ((U8 *)(&tdw_NextDirCluster))[0]=gc_UserDataBuf[0x15];          
 311   6                                                                                                              
 312   6                                                      if((tdw_PrevDirCluster!=tdw_CurrentDirCluster)&&(tdw_CurrentDirCluster!=gdw_DOS_RootDirClus)||(tdw_N
             -extDirCluster!=ptr.dw_FDB_StartCluster))
 313   6                                                      {//dos error                                    
 314   7                                                               ptr.dw_FDB_StartCluster=tdw_CurrentDirCluster;                 
 315   7                                                      }                               
 316   6                                                      else
 317   6                                                      {
 318   7                                                              ptr.Compare.dw_BubbleFlag=0xffffffff;   
 319   7                                                              gw_DirIndex[1]=0xffff;
 320   7                                                              if((tc_Mode&0xf0)==0x20)
 321   7                                                              {//find dir by order
 322   8                                                                      gw_DirIndex[ptr.c_Search_Mode] = 0xffff;                                                                                        
 323   8                                                                      tc_FindFile=0;
 324   8                                                              } 
 325   7                                                      }
 326   6                                                      tc_FindDir=1;           
 327   6                                              
 328   6                                              }//have found dir in dir                        
 329   5                                      }
 330   4                              }
 331   3                              else
 332   3                              {//find next                            
 333   4                                      while(1)
 334   4                                      {
 335   5                                              ptr.c_Search_Mode = (tc_Mode&0x0f);                                             
 336   5                                              if(tc_FindFile)
 337   5                                              {                                                               
 338   6                                                      ptr.c_Search_Attribute=0;                       //look for file                 
 339   6      
 340   6                                                      gb_TriggerFileSkip=1;                           //Ching 080805
 341   6                                                      tc_sts=Find_Fdb(&ptr);
 342   6                                                      gb_TriggerFileSkip=0;                           //Ching 080805
 343   6                                                      
 344   6                                                      if(!(tc_Mode&0x0f))//(JC)count file number                                                                                              
 345   6                                                      {               
 346   7                                                              gw_FileTotalNumber[tc_Type] = ptr.w_FileTotalNum;               
 347   7                                                      }
 348   6                                              }                               
 349   5                                              if(tc_sts)
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 7   

 350   5                                              {//have not found the specific file in one dir
 351   6                                                      if(tc_FindFile)
 352   6                                                      {                                                                                               
 353   7                                                              ptr.Compare.dw_BubbleFlag=0x0000;
 354   7                                                              gw_DirIndex[1] = 0;
 355   7                                                      }                                               
 356   6                                                      ptr.c_Search_Mode=0x03;                         //if count filenum now,please search dir by order
 357   6                                              
 358   6                                                      if((tc_Mode&0xf0)==0x20)
 359   6                                                      {
 360   7                                                              ptr.c_Search_Mode=(tc_Mode&0x0f);
 361   7                                                      }
 362   6                                                      
 363   6                                                      ptr.c_Search_Attribute=1;                                               
 364   6                                                      tc_sts=Find_Fdb(&ptr);                          //look for dir in the dir
 365   6                                                      if(tc_sts)
 366   6                                                      {//not find dir
 367   7                                                              if(ptr.dw_FDB_StartCluster!=gdw_DOS_RootDirClus)//not rootdir
 368   7                                                              {                               
 369   8                                                                      tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 370   8                                                                      gb_ReadWriteDataArea=1;
 371   8                                                                      if(DOS_Read_LogicSector(tdw_SectorAdd,1))
 372   8                                                                      {
 373   9                                                                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add   
 374   9                                                                                return 0xff;
 375   9                                                                      }
 376   8      
 377   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 378   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 379   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 380   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];                                                               
 381   8                                                                      if(!(tdw_PrevDirCluster))
 382   8                                                                      {//predir is rootdir                                                                                                                   
 383   9                                                                              tdw_PrevDirCluster=gdw_DOS_RootDirClus;                                                 
 384   9                                                                      }
 385   8                                                              
 386   8                                                                      ptr.dw_File_StartCluster=ptr.dw_FDB_StartCluster;
 387   8                                                                      ptr.dw_FDB_StartCluster=tdw_PrevDirCluster;//return to predir
 388   8                                                                      tc_FindFile=0; 
 389   8                                                                      if(ptr.c_Search_Mode==0x03)
 390   8                                                                      {//find by order
 391   9                                                                              gw_DirIndex[1] = 0;
 392   9                                                                              ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;
 393   9                                                                              ptr.Compare.dw_StartCluster =ptr.dw_File_StartCluster;
 394   9                                                                              ptr.c_Search_Attribute=1;  
 395   9                                                                              if(Find_Fdb(&ptr))
 396   9                                                                              {
 397  10                                                                                      break;
 398  10                                                                              }                                                                                                       
 399   9                                                                      }
 400   8                                                              }
 401   7                                                              else
 402   7                                                              {//not find dir in rootdir      
 403   8                                                                      gs_DIR_FCB[tc_Type].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;                                                
 404   8                                                                      break;                                                  
 405   8                                                              }
 406   7                                                      }
 407   6                                                      else
 408   6                                                      {//have found dir                                               
 409   7                                                              gb_ReadWriteDataArea=1;
 410   7                                                              if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd,1))
 411   7                                                              {
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 8   

 412   8                                                                      set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 413   8                                                                      return 0xff;                                            
 414   8                                                              }
 415   7                                                              tdw_CurrentDirCluster=ptr.dw_FDB_StartCluster;                                   //save current dir
 416   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
 417   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 418   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 419   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];    //next dir cluster              
 420   7                                                              tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 421   7                                                              if(DOS_Read_LogicSector((tdw_SectorAdd),1))
 422   7                                                              {
 423   8                                                                      // For dummy size
 424   8                                                                      if(gw_FileIndex[0]==gw_FileTotalNumber[0])
 425   8                                                                      {
 426   9                                                                              gw_FileIndex[0]=0;
 427   9                                                                              DOS_Read_LogicSector((gdw_DOS_RootDirClus),1);
 428   9                                                                      }
 429   8                                                                      else
 430   8                                                                      {
 431   9                                                                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 432   9                                                                              return 0xff;                                                    
 433   9                                                                      }
 434   8                                                              }
 435   7                                                              ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 436   7                                                              ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 437   7                                                              ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 438   7                                                              ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];                          //current dir
 439   7              
 440   7                                                              ((U8 *)(&tdw_NextDirCluster))[3]=gc_UserDataBuf[0x1a];
 441   7                                                              ((U8 *)(&tdw_NextDirCluster))[2]=gc_UserDataBuf[0x1b];
 442   7                                                              ((U8 *)(&tdw_NextDirCluster))[1]=gc_UserDataBuf[0x14];
 443   7                                                              ((U8 *)(&tdw_NextDirCluster))[0]=gc_UserDataBuf[0x15];                                      //next dir  
 444   7                                                              
 445   7                                                              if((tdw_PrevDirCluster!=tdw_CurrentDirCluster)&&(tdw_CurrentDirCluster!=gdw_DOS_RootDirClus)||(tdw_
             -NextDirCluster!=ptr.dw_FDB_StartCluster))
 446   7                                                              {//dos error                                    
 447   8                                                                      ptr.dw_FDB_StartCluster=tdw_CurrentDirCluster;       
 448   8                                                                      tc_FindFile=0;                                                  
 449   8                                                              }
 450   7                                                              else
 451   7                                                              {
 452   8                                                                      gw_DirIndex[0] = 0;
 453   8                                                                      if((tc_Mode&0x0f0)==0x20)
 454   8                                                                      {//put the line in here is to make dw_FDB_StartCluster equal dw_File_StartCluster                                                               
 455   9                                                                          gw_DirIndex[1] = 0;  
 456   9                                                                              ptr.dw_File_StartCluster = ptr.dw_FDB_StartCluster;
 457   9                                                                              tc_sts=0;
 458   9                                                                              break;
 459   9                                                                      }                       
 460   8                                                                      ptr.Compare.dw_BubbleFlag=0x0000;
 461   8                                                                      tc_FindFile=1;  
 462   8                                                              }
 463   7                                                              tc_sts=1;                                               
 464   7                                                      }//have find dir
 465   6                                              }
 466   5                                              else
 467   5                                              {//have found the file 
 468   6                                                      break;
 469   6                                              }
 470   5                                      }               
 471   4                              }               
 472   3                      }
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 9   

 473   2                      if(!tc_sts)
 474   2                      {//find the file/dir 
 475   3                              gb_FindFlag=1;  
 476   3                              if((tc_Mode&0x0f0)==0x20)
 477   3                              {//dir
 478   4                                      gs_DIR_FCB[tc_Type].dw_File_StartCluster=ptr.dw_File_StartCluster;                          
 479   4                                      gs_DIR_FCB[tc_Type].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 480   4                                      gs_DIR_FCB[tc_Type].dw_LongFDB_LogAdd1=ptr.dw_LongFDB_LogAdd1;
 481   4                                      gs_DIR_FCB[tc_Type].dw_LongFDB_LogAdd0=ptr.dw_LongFDB_LogAdd0;
 482   4                                      gs_DIR_FCB[tc_Type].dw_FDB_Cluster=ptr.dw_FDB_Cluster;
 483   4                                      gs_DIR_FCB[tc_Type].dw_FDB_LogAdd=ptr.dw_FDB_LogAdd;
 484   4                                      gs_DIR_FCB[tc_Type].w_FDB_Offset=ptr.w_FDB_Offset;
 485   4                              
 486   4                              }
 487   3                              else
 488   3                              {                                                       
 489   4                                      gs_File_FCB[tc_Type].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 490   4                                      gs_File_FCB[tc_Type].dw_LongFDB_LogAdd1=ptr.dw_LongFDB_LogAdd1;
 491   4                                      gs_File_FCB[tc_Type].dw_LongFDB_LogAdd0=ptr.dw_LongFDB_LogAdd0;
 492   4                                      gs_File_FCB[tc_Type].dw_FDB_Cluster=ptr.dw_FDB_Cluster;
 493   4                                      gs_File_FCB[tc_Type].dw_FDB_LogAdd=ptr.dw_FDB_LogAdd;
 494   4                                      gs_File_FCB[tc_Type].w_FDB_Offset=ptr.w_FDB_Offset;
 495   4                                      gdw_CurrFlag = ptr.Compare.dw_BubbleFlag;
 496   4                                      gdw_StartCluster2 =     ptr.dw_File_StartCluster;
 497   4                                      if(tc_PrevOrNext)
 498   4                                      {
 499   5                                              if(tw_FileSkipNumber==0)
 500   5                                              {
 501   6                                                      tw_FileSkipNumber=1;
 502   6                                              }       
 503   5                                              if(tw_FileSkipNumber>=gw_FileIndex[tc_Type])
 504   5                                              {
 505   6                                                      gw_FileIndex[tc_Type]=gw_FileIndex[tc_Type]+gw_FileTotalNumber[tc_Type]-tw_FileSkipNumber;
 506   6                                              }
 507   5                                              else
 508   5                                              {
 509   6                                                      gw_FileIndex[tc_Type]-=tw_FileSkipNumber;
 510   6                                              }               
 511   5                                      }
 512   4                                      else
 513   4                                      {
 514   5                                              if(tw_FileSkipNumber==0)
 515   5                                              {
 516   6                                                      tw_FileSkipNumber=1;
 517   6                                              }
 518   5                                              gw_FileIndex[tc_Type]+=tw_FileSkipNumber;
 519   5                                              if(gw_FileIndex[tc_Type]>gw_FileTotalNumber[tc_Type])
 520   5                                              {
 521   6                                                      gw_FileIndex[tc_Type]-=gw_FileTotalNumber[tc_Type];
 522   6                                              }
 523   5                                      }
 524   4                              }       
 525   3                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add                                    
 526   3                              return(tc_sts);         
 527   3                      }
 528   2                      else if(!(tc_Mode&0x0f))//(JC)Count file total number                                                                                           
 529   2                      {                       
 530   3                              gw_FileTotalNumber[tc_Type] = ptr.w_FileTotalNum;                       
 531   3                              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add                   
 532   3                              return(1);                                                              
 533   3                      }
 534   2                      else 
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 10  

 535   2                      {//(JC)search fail, search again if this were the 1st search 
 536   3                              gs_File_FCB[tc_Type].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 537   3                              gs_DIR_FCB[tc_Type].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 538   3                              tc_SearchTime--;
 539   3                              if(((tc_Mode&0x0f)==1)||((tc_Mode&0x0f)==2)||((tc_Mode&0x0f)==3))
 540   3                              {
 541   4                                      gb_FindFlag=0;          
 542   4                              }
 543   3                      } 
 544   2              }
 545   1              set_clock_mode(tc_clock_mode_backup);  //20090526 chiayen add
 546   1              return(1);      
 547   1      }
 548          
 549          
 550          UBYTE DOS_Open_File_r(UBYTE tc_FileHandle, UBYTE tc_OpenMode, UBYTE * tpc_FileName)
 551          {
 552   1              WORD tw_Fdb_offset;
 553   1              LWORD   tdw_temp;
 554   1              SearchFdb *p_mp;
 555   1              SearchFdb temp;
 556   1              p_mp=&temp;
 557   1      
 558   1                      if(!gs_File_FCB[tc_FileHandle].dw_FDB_LogAdd)
 559   1                      {
 560   2                              return 1;       
 561   2                      }
 562   1      
 563   1                      if(tc_OpenMode==0)//open SPECIFIC name file
 564   1                      {
 565   2                              if(tpc_FileName[2]==K_LongFileName)
 566   2                              {
 567   3                                      p_mp->c_Search_Mode=K_SPECIFIC_LONG_FILENAME;
 568   3                              }
 569   2                              else if(tpc_FileName[2]==K_ShortFileName) 
 570   2                              {
 571   3                                      p_mp->c_Search_Mode=K_SPECIFIC_SHORT_FILENAME;
 572   3                              }
 573   2                              p_mp->pc_LongFileName=tpc_FileName;
 574   2                              p_mp->dw_FDB_StartCluster=gs_File_FCB[tc_FileHandle].dw_FDB_StartCluster;//(JC)start cluster of DIR tha
             -t the file is in      
 575   2                              Find_Fdb(p_mp);
 576   2                      } 
 577   1                      else 
 578   1                      {//open found file
 579   2                                      p_mp->w_FDB_Offset =gs_File_FCB[tc_FileHandle].w_FDB_Offset;
 580   2                                      p_mp->dw_FDB_LogAdd =gs_File_FCB[tc_FileHandle].dw_FDB_LogAdd;
 581   2                      }
 582   1      
 583   1                      tw_Fdb_offset=p_mp->w_FDB_Offset;
 584   1                      gb_ReadWriteDataArea=1;
 585   1      
 586   1                      DOS_Read_LogicSector(p_mp->dw_FDB_LogAdd,1);
 587   1                      
 588   1                      ((U8 *)(&tdw_temp))[0]=gc_UserDataBuf[tw_Fdb_offset+31];//(JC)store file size(in FDB) into tdw_temp then
             - dw_File_TotalSize
 589   1                      ((U8 *)(&tdw_temp))[1]=gc_UserDataBuf[tw_Fdb_offset+30];
 590   1                      ((U8 *)(&tdw_temp))[2]=gc_UserDataBuf[tw_Fdb_offset+29];
 591   1                      ((U8 *)(&tdw_temp))[3]=gc_UserDataBuf[tw_Fdb_offset+28];
 592   1                      gs_File_FCB[tc_FileHandle].dw_File_TotalSize= tdw_temp;
 593   1      
 594   1                      if (tc_OpenMode != 2)//(JC)specific name file
C51 COMPILER V9.00   DOSFILE                                                               07/10/2012 15:51:51 PAGE 11  

 595   1                      {//in mode 2 these value is got in searchfile() at first 
 596   2                              gs_File_FCB[tc_FileHandle].dw_LongFDB_LogAdd1=p_mp->dw_LongFDB_LogAdd1;
 597   2                              gs_File_FCB[tc_FileHandle].dw_LongFDB_LogAdd0=p_mp->dw_LongFDB_LogAdd0;
 598   2                              gs_File_FCB[tc_FileHandle].dw_FDB_Cluster=p_mp->dw_FDB_Cluster;
 599   2                              gs_File_FCB[tc_FileHandle].dw_FDB_LogAdd=p_mp->dw_FDB_LogAdd;
 600   2                              gs_File_FCB[tc_FileHandle].w_FDB_Offset=p_mp->w_FDB_Offset;
 601   2                      }
 602   1      
 603   1                      //get the File_StartCluster
 604   1                      ((U8 *)(&tdw_temp))[0]=gc_UserDataBuf[tw_Fdb_offset+21];
 605   1                      ((U8 *)(&tdw_temp))[1]=gc_UserDataBuf[tw_Fdb_offset+20];
 606   1                      ((U8 *)(&tdw_temp))[2]=gc_UserDataBuf[tw_Fdb_offset+27];
 607   1                      ((U8 *)(&tdw_temp))[3]=gc_UserDataBuf[tw_Fdb_offset+26];
 608   1                      gs_File_FCB[tc_FileHandle].dw_File_StartCluster=tdw_temp;
 609   1                      gs_File_FCB[tc_FileHandle].dw_File_CurrentCluster=tdw_temp;             
 610   1                      gs_File_FCB[tc_FileHandle].dw_File_DataPoint = 0;        
 611   1                      if(gs_File_FCB[tc_FileHandle].dw_File_StartCluster>=2&&gs_File_FCB[tc_FileHandle].dw_File_StartCluster!=
             -0xffffffff)
 612   1                      {//(JC)data cluster is from cluster 2
 613   2                              return 0;
 614   2                      }
 615   1                      else
 616   1                      {
 617   2                              return 1;
 618   2                      }
 619   1      
 620   1              return 0;       
 621   1      }
 622          
 623          
 624          void DOS_Close_File_r(UBYTE tc_FileHandle)
 625          {
 626   1                      gs_File_FCB[tc_FileHandle].dw_File_StartCluster = 0xffffffff;
 627   1      }
 628          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3187    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----     142
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
