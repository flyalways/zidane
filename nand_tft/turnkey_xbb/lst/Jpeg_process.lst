C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE JPEG_PROCESS
OBJECT MODULE PLACED IN .\obj\Jpeg_process.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Jpeg\Jpeg_process.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsour
                    -ce\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\Jpeg_process.lst) OBJECT(.\obj\Jpeg_process.obj)

line level    source

   1          #include <string.h>
   2          #include "SPDA2K.h"
   3          #include "dos\fs_struct.h"
   4          #include "dos\dosfile.h"
   5          #include "memalloc.h"
   6          #include "..\LCM\model_define.h"
   7          #include "..\DSP\DSPPHYSIC.H"
   8          #include "..\DSP\dspuser.h"
   9          #include "..\LCM\LCM.h"
  10          #include "..\LCM\UI_icon.h"
  11          #include "..\LCM\TFT_display.h"
  12          #include "..\LCM\TFT_config.h"
  13          #include "..\header\variables.h"
  14          #include "..\header\host_init.h"
  15          
  16          extern data U8 gc_PhaseInx;
  17          extern  data U8 gc_KeyDet_Mask;  //20090107 chiayen modify
  18          extern xdata System_Struct gs_System_State;
  19          extern U8  xdata EXT_NameC[];
  20          extern xdata U8  gc_Play_FileType;
  21          extern  xdata   U8      gc_LCMDispIndexBak;
  22          extern  xdata   U16     gc_DispFilePageBak;
  23          extern  xdata   U8 media_changetimes;
  24          
  25          extern void     MediaChange(void); 
  26          extern  void    LCM_set_view(U8 view_type, U16 x_start, U16 y_start, U16 x_size, U16 y_size);
  27          extern  void    IR_Service_Process_Menu_2();
  28          extern  void    IR_Service_Process();
  29          extern  void    ir_service_menu(void);
  30          
  31          U8 jpeg_marker_parser(U32 *tpdw_File_Ptr, U8 tw_marker_Hbyte, U8 tw_marker_Lbyte);     //Jimi 090305
  32          
  33          xdata   U8      gc_JPGSetting;
  34          xdata   U8      gc_JpegVelocityBak;
  35          extern  xdata   U8      gc_MenuItemCount;
  36          extern  data    bit     gb_TFT_refresh;
  37          
  38          /* =============== Image function =============== */
  39          void Image_WakeUp(U8 tc_Type)
  40          {       
  41   1              DSP_WakeUp(tc_Type);
  42   1      }
  43          
  44          U8 Image_Download(void)
  45          {
  46   1              U8 tc_Cnt = 0;
  47   1      
  48   1              if (DSP_Download(0x08, 0x10) != DSP_SUCCESS)
  49   1                      return DSP_PLAY_COMMAND_ERROR;
  50   1      
  51   1              for (tc_Cnt=0; tc_Cnt<10; ++tc_Cnt) {
  52   2                      if (DSP_PlayInit() == DSP_SUCCESS)
  53   2                              break;
  54   2      //              dbprintf("Retry to start DSP\n");
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 2   

  55   2                      if (tc_Cnt < 5) 
  56   2                      {
  57   3                              //GLOBAL_REG[0x02] |= 0x01;             // DSP reset, ycc mark
  58   3                              GLOBAL_REG[0x02] &= 0xFE;               // Enable DSP Run Normal Mode
  59   3                      }
  60   2                      else
  61   2                      {
  62   3      //                      dbprintf("Hardware Reset DSP!!!!!\n");
  63   3                              GLOBAL_REG[0x02] |= 0x01;               // DSP reset
  64   3                              GLOBAL_REG[0x02] &= 0xFE;               // Enable DSP Run Normal Mode
  65   3                      }
  66   2              }
  67   1              if (tc_Cnt == 10)
  68   1                      return DSP_PLAY_COMMAND_ERROR;
  69   1      
  70   1              return DSP_SUCCESS;
  71   1      }
  72          
  73          U8 Image_PlayCmd(void)
  74          {
  75   1              // sent "PLAY" command to DSP
  76   1              if (L2_DSP_SendCommandSet(DCMD_Play) != DCMD_Play)
  77   1              {
  78   2                      return DSP_PLAY_COMMAND_ERROR;
  79   2              }
  80   1      //      dbprintf("Play Cmd Ok~\n");
  81   1      
  82   1              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;              // reset bitstream buffer index
  83   1              gs_DSP_GLOBAL_RAM.sc_Pixel_Index = 0;   // reset output pixel buffer index
  84   1              gs_DSP_GLOBAL_RAM.sc_End_Of_File = 0;   // reset file end flag
  85   1      
  86   1              // JPEG file open
  87   1              if (DOS_Open_File_r(C_OtherFHandle, C_Open_FoundFile, C_NullFileName))
  88   1                      return DSP_PLAY_COMMAND_ERROR;
  89   1      
  90   1              return DSP_SUCCESS;
  91   1      }
  92          
  93          
  94          U8 Image_DataIn(void)
  95          {
  96   1              if (!gs_DSP_GLOBAL_RAM.sc_End_Of_File)
  97   1              {
  98   2               // Jimi 090305 
  99   2                      if(gc_Play_FileType != 1)
 100   2                      {
 101   3                              while(L2_DSP_Read_DMem16(DSP_EmptyBuffer) > ONE_SECTOR)
 102   3                              {
 103   4                                      if (DOS_Read_File(C_OtherFHandle) != DOS_END_OF_FILE)
 104   4                                      {
 105   5                          L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x2E, (U16)gc_PlayRecordDataBuf, DM
             -A_24BIT_MODE);
 106   5      
 107   5                                              if (L2_DSP_SendCommandSet(DCMD_DatIn) != DCMD_DatIn)
 108   5                                              {
 109   6      //                                              dbprintf("DSP_DATAIN_COMMAND_ERROR\n");
 110   6                                                      return DSP_DATAIN_COMMAND_ERROR;
 111   6                                              }
 112   5                      
 113   5                                              if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 3) // JPEG bitstream buffer 0x3400~0x3600, sz = 1536 bytes
 114   5                                                      gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;
 115   5                                      }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 3   

 116   4                                      else
 117   4                                      {
 118   5      //                                      dbprintf("file-end\n");
 119   5                                              L2_DSP_Write_DMem16(0x3F44, 0x00FF);    // JPEG file end flag
 120   5                                              gs_DSP_GLOBAL_RAM.sc_End_Of_File = 1;
 121   5                                              break;
 122   5                                      }
 123   4                              }
 124   3                      }
 125   2                      
 126   2                      else
 127   2                      {
 128   3                              U8 i;
 129   3                              for(i=0; i<5; i++)
 130   3                              {
 131   4                                      if(L2_DSP_Read_DMem16(DSP_EmptyBuffer) > ONE_SECTOR)
 132   4                                      {
 133   5                                              if (DOS_Read_File(C_OtherFHandle) != DOS_END_OF_FILE)
 134   5                                              {
 135   6                              L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x2E, (U16)gc_PlayRecordDataBuf
             -, DMA_24BIT_MODE);
 136   6                                                      if (L2_DSP_SendCommandSet(DCMD_DatIn) != DCMD_DatIn)
 137   6                                                      {
 138   7      //                                                      dbprintf("DSP_DATAIN_COMMAND_ERROR\n");
 139   7                                                              return DSP_DATAIN_COMMAND_ERROR;
 140   7                                                      }
 141   6                              
 142   6                                                      if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 3) // JPEG bitstream buffer 0x3400~0x3600, sz = 1536 bytes
 143   6                                                              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;
 144   6                                              }
 145   5                                              else
 146   5                                              {
 147   6      //                                              dbprintf("file-end\n");
 148   6                                                      L2_DSP_Write_DMem16(0x3F44, 0x00FF);    // JPEG file end flag
 149   6                                                      gs_DSP_GLOBAL_RAM.sc_End_Of_File = 1;
 150   6                                                      return  DSP_DECODE_END; // 20100412 - BMP error
 151   6                                              }
 152   5                                      }
 153   4                              }
 154   3                      }
 155   2              }
 156   1              return  DSP_SUCCESS;
 157   1      }
 158          
 159          
 160          void Image_MCU_LCM_DMA(U16 movesize, U16 tw_Src)
 161          {
 162   1              XBYTE[0xB304] = 0x09; //reset DMA machine
 163   1              XBYTE[0xB304] = 0x08; 
 164   1      
 165   1              XBYTE[0xB423] = 3;              // set NAND /CS(bit 0), /WP(bit 1), ALE(bit 2), CLE(bit 3)
 166   1      
 167   1              FLASH_REG[0x00] = 0x00;
 168   1              DMA_REG[0x01] = 0x20;           //Sram to Flash
 169   1      
 170   1              // source
 171   1              CPU_REG[0x12] = (U8)(tw_Src);
 172   1              CPU_REG[0x13] = (U8)(tw_Src >> 8);
 173   1      
 174   1              // size
 175   1              DMA_REG[0x02] = (U8)(movesize-1);
 176   1              DMA_REG[0x03] = (U8)((movesize-1) >> 8);
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 4   

 177   1      
 178   1              DMA_REG[0xC0] = 0x00;           //clear DMA completed flag
 179   1              LCM_A0_HI;
 180   1              LCM_CS_LO;
 181   1              DMA_REG[0xB0] = 0x01;           //trigger DMA
 182   1              while(DMA_REG[0xC0] == 0);
 183   1              DMA_REG[0xC0] = 0;
 184   1              LCM_CS_HI;
 185   1              LCM_A0_LO;
 186   1      
 187   1              FLASH_REG[0x00] = 0x01;
 188   1      }
 189          
 190          
 191          U8 Image_DataOut(void)
 192          {
 193   1              U16 RemData = L2_DSP_Read_DMem16(DSP_SOutBufRemData);
 194   1      
 195   1              if (RemData >= ONE_SECTOR)
 196   1              {
 197   2                      do
 198   2                      {
 199   3                              L2_DSP_DM_MCU_DMA(gs_DSP_GLOBAL_RAM.sc_Pixel_Index++, 9, (U16)gc_PlayRecordDataBuf, DMA_16BIT_MODE);
 200   3                              if (L2_DSP_SendCommandSet(DCMD_DatOut) != DCMD_DatOut)
 201   3                              {
 202   4      //                              dbprintf("DSP_DATAOUT_COMMAND_ERROR\n");
 203   4                                      return DSP_DATAOUT_COMMAND_ERROR;
 204   4                              }
 205   3      
 206   3                  if (gs_DSP_GLOBAL_RAM.sc_Pixel_Index >= 10) // JPEG output pixel buffer 0x3000~0x3A00, sz = 25
             -60*2 bytes
 207   3                                      gs_DSP_GLOBAL_RAM.sc_Pixel_Index = 0;
 208   3                      
 209   3                              /* ==== Display on LCM: DMA Sram to LCM ==== */
 210   3                              Image_MCU_LCM_DMA(ONE_SECTOR, (U16)gc_PlayRecordDataBuf);
 211   3                      } while (L2_DSP_Read_DMem16(DSP_SOutBufRemData) >= ONE_SECTOR);
 212   2              }
 213   1              else if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)
 214   1              {
 215   2                      if (RemData > 0)
 216   2                      {
 217   3                              L2_DSP_DM_MCU_DMA(gs_DSP_GLOBAL_RAM.sc_Pixel_Index, 9, (U16)gc_PlayRecordDataBuf, DMA_16BIT_MODE);
 218   3                              if (L2_DSP_SendCommandSet(DCMD_DatOut) != DCMD_DatOut)
 219   3                              {
 220   4      //                              dbprintf("DSP_DATAOUT_COMMAND_ERROR\n");
 221   4                                      return DSP_DATAOUT_COMMAND_ERROR;
 222   4                              }
 223   3      
 224   3                              /* ==== Display on LCM: DMA Sram to LCM ==== */
 225   3                              Image_MCU_LCM_DMA(RemData, (U16)gc_PlayRecordDataBuf);
 226   3                      }
 227   2      //              dbprintf("JPEG DSP decode end!!\n");
 228   2                      return DSP_DECODE_END;
 229   2              }
 230   1              else if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x0020)
 231   1              {
 232   2      //              dbprintf("JPEG error format!!\n");
 233   2                      return DSP_USER_FILE_TYPE_ERROR;
 234   2              }
 235   1      
 236   1              return DSP_SUCCESS;
 237   1      }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 5   

 238          
 239          U8 Image_StopCmd(U8 tc_FileHandle)
 240          {
 241   1              U8 tc_Ret, tc_state;
 242   1              U16 TimeOUT;
 243   1              
 244   1              tc_Ret = DSP_StopCmd();
 245   1              TimeOUT = 0xffff;
 246   1              while (1)
 247   1              {
 248   2                      TimeOUT--;
 249   2                      if (TimeOUT == 0)
 250   2                      {
 251   3      //                      dbprintf("JPEG stop command time out\n");
 252   3                              tc_Ret = DSP_DECODE_STATUS_TIMEOUT_ERROR;
 253   3                              break;
 254   3                      }
 255   2      
 256   2                      tc_state = Image_DataIn();
 257   2                      if (tc_state == DSP_DATAIN_COMMAND_ERROR)
 258   2                      {
 259   3                              tc_Ret = tc_state;
 260   3                              break;
 261   3                      }
 262   2      
 263   2                      tc_state = Image_DataOut();
 264   2      
 265   2                      if (tc_state == DSP_DATAOUT_COMMAND_ERROR)
 266   2                      {
 267   3                              tc_Ret = tc_state;
 268   3                              break;
 269   3                      }
 270   2                      else if (tc_state == DSP_USER_FILE_TYPE_ERROR)
 271   2                      {
 272   3                              tc_Ret = tc_state;
 273   3                              L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFFDF));
 274   3                              break;
 275   3                      }
 276   2                      else if (tc_state == DSP_DECODE_END)
 277   2                      {
 278   3                              L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFF3F)); 
 279   3                              break;
 280   3                      }
 281   2              }
 282   1      
 283   1              // Close current file
 284   1      //      dbprintf("JPEG DOS close file\n");
 285   1              gw_AutoJpeg_Timer=(U16)(gc_JpegVelocity+1)*36;
 286   1              DOS_Close_File_r(tc_FileHandle);
 287   1      
 288   1              return tc_Ret;
 289   1      }
 290          
 291          /* =============== GIF function =============== */
 292          U8 GIF_DataIn(void)
 293          {
 294   1              if (L2_DSP_Read_DMem16(DSP_EmptyBuffer) >= ONE_SECTOR)
 295   1              {
 296   2                      if (DOS_Read_File(C_OtherFHandle) != DOS_END_OF_FILE)
 297   2                      {
 298   3                  L2_DSP_MCU_DM_DMA(gs_DSP_GLOBAL_RAM.sc_DM_Index++, 0x2E, (U16)gc_PlayRecordDataBuf, DMA_24BIT_
             -MODE);
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 6   

 299   3                              if (L2_DSP_SendCommandSet(DCMD_DatIn) != DCMD_DatIn)
 300   3                              {
 301   4      //                              dbprintf("DSP_DATAIN_COMMAND_ERROR\n");
 302   4                                      return DSP_DATAIN_COMMAND_ERROR;
 303   4                              }
 304   3              
 305   3                              if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 3) // JPEG bitstream buffer 0x3400~0x3600, sz = 1536 bytes
 306   3                                      gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;
 307   3                      }
 308   2                      else
 309   2                      {
 310   3      //                      dbprintf("Re-start GIF file\n");
 311   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster = gs_File_FCB[gs_System_State.c_FileHa
             -ndle].dw_File_StartCluster;
 312   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster = DOS_Seek_File(gs_System_State.c_File
             -Handle, 0);
 313   3                      }
 314   2      
 315   2              }
 316   1              return  DSP_SUCCESS;
 317   1      }
 318          
 319          
 320          void GIF_DM_MCU_DMA(U16 BufferIndex,U8 tc_PowerOf2, U16 tw_Src)
 321          {
 322   1              U8  tc_DSPAddr_High;
 323   1              U16 tw_MoveSize;
 324   1      
 325   1              // ----- DMA Reset -----
 326   1              DMA_REG[0x04] = 0x09;
 327   1              DMA_REG[0x04] = 0x08;
 328   1              DMA_REG[0xC0] = 0x00;           // clear DMA complete
 329   1              DMA_REG[0x30] = 0x01;           // clear checksum               
 330   1                      
 331   1              // ----- DMA initial settings for DM transfer -----             
 332   1              DSP_REG[0x16] = 0x00;           // Remain DSP mode.  When you do MCU -> DM, MCU will stop DSP automaticlly
 333   1              DMA_REG[0x01] = 0x05;           // DM -> SRAM
 334   1      
 335   1              // Define data size in DMA              
 336   1              tw_MoveSize = (1 << tc_PowerOf2) - 1;
 337   1              DMA_REG[0x02] = ((U8 *)(&tw_MoveSize))[1];
 338   1              DMA_REG[0x03] = ((U8 *)(&tw_MoveSize))[0];
 339   1      
 340   1              // Source
 341   1              DMA_REG[0x40] = 0x01;           // 16-bit DMA
 342   1              DSP_REG[0x1D] = 0x01;
 343   1              tc_DSPAddr_High = (U8)(((BufferIndex << tc_PowerOf2) >> 1) >> 8);
 344   1          DSP_REG[0x18] = tc_DSPAddr_High + 0x2D;     // GIF output pixel start address : 0x3700
 345   1              DSP_REG[0x17] = (U8)((BufferIndex << tc_PowerOf2) >> 1);
 346   1      
 347   1              // Destination
 348   1              CPU_REG[0x14] = (U8)(tw_Src);
 349   1              CPU_REG[0x15] = (U8)(tw_Src >> 8);
 350   1      
 351   1              // ------------------------------------------------
 352   1              DMA_REG[0xB0] = 0x01;           // DMA1 start
 353   1              // wait until DMA cycle is completed (0xB3C0)           
 354   1              while (!(DMA_REG[0xC0]&0x01));
 355   1              DMA_REG[0xC0] = 0x00;
 356   1      }
 357          
 358          
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 7   

 359          U8 GIF_DataOut(void)
 360          {
 361   1              U16 RemData = L2_DSP_Read_DMem16(DSP_SOutBufRemData);
 362   1              if (RemData >= 256)
 363   1              {
 364   2                      GIF_DM_MCU_DMA(gs_DSP_GLOBAL_RAM.sc_Pixel_Index++, 8, (U16)gc_PlayRecordDataBuf);
 365   2                      if (L2_DSP_SendCommandSet(DCMD_DatOut) != DCMD_DatOut)
 366   2                      {
 367   3      //                      dbprintf("DSP_DATAOUT_COMMAND_ERROR\n");
 368   3                              return DSP_DATAOUT_COMMAND_ERROR;
 369   3                      }
 370   2      
 371   2                      if (gs_DSP_GLOBAL_RAM.sc_Pixel_Index >= 2) // GIF output pixel buffer 0x3700~0x37FF, sz = 256*2 bytes
 372   2                              gs_DSP_GLOBAL_RAM.sc_Pixel_Index = 0;
 373   2      
 374   2                      /* ==== Display on LCM: DMA Sram to LCM ==== */
 375   2                      Image_MCU_LCM_DMA(256, (U16)gc_PlayRecordDataBuf);
 376   2              }
 377   1              else if (L2_DSP_Read_DMem16(0x3F8A) == 49)
 378   1              {
 379   2                      if (RemData > 0)
 380   2                      {
 381   3                              GIF_DM_MCU_DMA(gs_DSP_GLOBAL_RAM.sc_Pixel_Index++, 8, (U16)gc_PlayRecordDataBuf);
 382   3                              if (L2_DSP_SendCommandSet(DCMD_DatOut) != DCMD_DatOut)
 383   3                              {
 384   4      //                              dbprintf("DSP_DATAOUT_COMMAND_ERROR\n");
 385   4                                      return DSP_DATAOUT_COMMAND_ERROR;
 386   4                              }
 387   3                              /* ==== Display on LCM: DMA Sram to LCM ==== */
 388   3                              Image_MCU_LCM_DMA(RemData, (U16)gc_PlayRecordDataBuf);
 389   3                      }
 390   2                      gs_DSP_GLOBAL_RAM.sc_Pixel_Index = 0;
 391   2                      L2_DSP_Write_DMem16(0x3F8A, 0);
 392   2              }
 393   1              else if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x0020)
 394   1              {
 395   2      //              dbprintf("GIF error format!!\n");
 396   2                      //L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFFDF));
 397   2                      return DSP_USER_FILE_TYPE_ERROR;
 398   2              }
 399   1      
 400   1              return DSP_SUCCESS;
 401   1      }
 402          
 403          
 404          U8 GIF_StopCmd(U8 tc_FileHandle)
 405          {
 406   1              U8 tc_Ret, tc_state;
 407   1              U16 TimeOUT;
 408   1              
 409   1              tc_Ret = DSP_StopCmd();
 410   1      
 411   1              if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x0020)        // reset DSP_DecodeStatus
 412   1                      L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFFDF));
 413   1      
 414   1              TimeOUT = 0xffff;
 415   1              while (1)
 416   1              {
 417   2                      TimeOUT--;
 418   2                      if (TimeOUT == 0)
 419   2                      {
 420   3      //                      dbprintf("GIF stop command time out\n");
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 8   

 421   3                              tc_Ret = DSP_DECODE_STATUS_TIMEOUT_ERROR;
 422   3                              break;
 423   3                      }
 424   2      
 425   2                      tc_state = GIF_DataIn();
 426   2                      if (tc_state == DSP_DATAIN_COMMAND_ERROR)
 427   2                      {
 428   3                              tc_Ret = tc_state;
 429   3                              break;
 430   3                      }
 431   2      
 432   2                      tc_state = GIF_DataOut();
 433   2                      if (tc_state == DSP_DATAOUT_COMMAND_ERROR)
 434   2                      {
 435   3                              tc_Ret = tc_state;
 436   3                              break;
 437   3                      }
 438   2                      else if (tc_state == DSP_USER_FILE_TYPE_ERROR)
 439   2                      {
 440   3                              tc_Ret = tc_state;
 441   3                              L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFFDF));
 442   3                              break;
 443   3                      }
 444   2      
 445   2                      if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)        //wait file end
 446   2                      {
 447   3      //                      dbprintf("GIF DSP decode end!!\n");
 448   3                              L2_DSP_Write_DMem16(DSP_DecodeStatus, (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFF3F)); 
 449   3                              break;
 450   3                      }
 451   2              }               
 452   1      
 453   1              // Close current file
 454   1      //      dbprintf("GIF DOS close file\n");
 455   1              gw_AutoJpeg_Timer=(U16)(gc_JpegVelocity+1)*36;
 456   1              DOS_Close_File_r(tc_FileHandle);
 457   1      
 458   1              return tc_Ret;
 459   1      }
 460          
 461          //=================(JC)Jpeg ctrl flow====================
 462          void jpeg_idle()
 463          {
 464   1      
 465   1      }
 466          
 467          void jpeg_init()
 468          {       
 469   1              
 470   1               U8    tc_media_changetimes=1; 
 471   1              if(gw_init_needed & SET_BIT4)
 472   1              {
 473   2      //              dbprintf("=jpeg init=\n");
 474   2      
 475   2              
 476   2              if((gb_SD_Exist==1) && (gb_Host_Exist==1)) 
 477   2              { 
 478   3                 tc_media_changetimes=3; 
 479   3              } 
 480   2              else if((gb_SD_Exist==1) || (gb_Host_Exist==1)) 
 481   2              { 
 482   3                      tc_media_changetimes=2; 
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 9   

 483   3              } 
 484   2              else   
 485   2              {                 
 486   3                       tc_media_changetimes=1; 
 487   3              }  
 488   2                      
 489   2                      gc_DispFilePageBak=0xFFFF;
 490   2                      gw_init_needed&=CLR_BIT4;
 491   2                      
 492   2                      gs_System_State.c_Phase = TASK_PHASE_STOP;
 493   2                      gs_DSP_GLOBAL_RAM.sw_Volume = 50;//(JC)init value
 494   2      
 495   2      
 496   2                      gs_System_State.c_FileHandle = 2;
 497   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 498   2      
 499   2                      EXT_NameC[0] = 3;
 500   2                      EXT_NameC[1] = 'J';
 501   2                      EXT_NameC[2] = 'P';
 502   2                      EXT_NameC[3] = 'G';
 503   2                      EXT_NameC[4] = 'B';
 504   2                      EXT_NameC[5] = 'M';
 505   2                      EXT_NameC[6] = 'P';
 506   2                      EXT_NameC[7] = 'G';
 507   2                      EXT_NameC[8] = 'I';
 508   2                      EXT_NameC[9] = 'F';
 509   2                      DOS_Search_File(C_File_All|C_Cnt_FileNo,C_OtherFileType,C_CmpExtName|C_Next);
 510   2      
 511   2                      if(DOS_Search_File(C_File_All|C_By_FDB, C_OtherFHandle, C_CmpExtName|C_Next))
 512   2                      //if(gw_FileTotalNumber[2]==0)
 513   2                      {
 514   3                              if(media_changetimes==tc_media_changetimes)
 515   3                              {
 516   4                                      
 517   4                      USER_DelayDTms(100); 
 518   4      //                      dbprintf("!No picture files!\n");
 519   4                              gw_init_needed |= SET_BIT8;
 520   4                              gc_Task_Next=C_Task_Menu;
 521   4                              gc_PhaseInx = 0;
 522   4                              return;
 523   4                      }
 524   3                              else
 525   3                              { 
 526   4                              MediaChange();
 527   4                              media_changetimes++;
 528   4                                                      gc_PhaseInx=C_JpegPause; 
 529   4                  } 
 530   3                      }
 531   2                      gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType;
 532   2              }
 533   1              gc_PhaseInx = C_JpegPause; //Ching 090316
 534   1      }
 535          
 536          void jpeg_proc()
 537          {
 538   1              gc_KeyDet_Mask = 0;
 539   1      
 540   1              if (gc_Play_FileType == 2)      // test
 541   1              {
 542   2                      if (GIF_DataIn() == DSP_DATAIN_COMMAND_ERROR)
 543   2                      {
 544   3      //                      dbprintf("GIF data in end\n");
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 10  

 545   3                              gc_PhaseInx = 4;
 546   3                      }
 547   2                      
 548   2                      if (GIF_DataOut() != DSP_SUCCESS )
 549   2                      {       // "error format" -> set stop command
 550   3      //                      dbprintf("GIF data out end\n");
 551   3                              gc_PhaseInx = 4;
 552   3                      }
 553   2              }
 554   1              else
 555   1              {
 556   2              if (Image_DataIn() != DSP_SUCCESS)      // 20100412 - BMP error
 557   2                      {
 558   3      //                      dbprintf("JPEG data in end\n");
 559   3                              gc_PhaseInx = 4;
 560   3                      }
 561   2                      
 562   2                      if (Image_DataOut() != DSP_SUCCESS )
 563   2                      {       // "file end" or "error format" -> set stop command
 564   3      //                      dbprintf("JPEG data out end\n");
 565   3                              gc_PhaseInx = 4;
 566   3                      }
 567   2              }
 568   1      }
 569          
 570          void jpeg_playpause()
 571          {
 572   1              U16     i;      
 573   1      
 574   1              if (gs_System_State.c_Phase == TASK_PHASE_PLAYACT)
 575   1              {
 576   2      //              dbprintf("Keep decoding...\n");
 577   2              }
 578   1              else
 579   1              {
 580   2      //              dbprintf("=play jpeg=\n");
 581   2                      
 582   2                      //jpeg init
 583   2                      //clock setting
 584   2      
 585   2                      //Draw a black frame
 586   2                      for (i=0; i<512; i++)
 587   2                      {
 588   3                              ((U32 *)gc_MotionJpegOutBuf)[i] = 0;
 589   3                      }
 590   2      
 591   2                      LCM_set_view(TFT_BMPDispDir, 0, 0, TFT_H_Size, TFT_V_Size); // vertical view, Jimi 090305
 592   2      
 593   2                      for (i=0; i<20; i++)            //Jimi 090305 for 128x160 LCM
 594   2                      {
 595   3                              Image_MCU_LCM_DMA(2048, (U16)gc_MotionJpegOutBuf);
 596   3                      }
 597   2      
 598   2                      Image_WakeUp(DSP_CLK_CTRL | SRAM2T_CTRL);
 599   2      
 600   2                      if (Image_Download())   // Load IM, PM
 601   2                      {
 602   3      //                      dbprintf("load IMPM err!\n");
 603   3                      }
 604   2      
 605   2      //              dbprintf("gc_Play_FileType = %bx\n",gc_Play_FileType);     //Jimi 090305
 606   2                      //Set file type, 0: SCV, 1: JPEG, 2: BMP, 3: GIF, 4: AMV
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 11  

 607   2                      if (gc_Play_FileType == 0)
 608   2                      {
 609   3                              L2_DSP_Write_DMem16(0x3F2F, 0x0001);    // JPEG file
 610   3                              /* Jimi 090305 , JPEG parser to get image height & length */
 611   3                              {
 612   4                                      U32 tdw_File_Ptr;
 613   4                                      U16 tw_Buf_idx;
 614   4                                      U16 tw_img_height=0;
 615   4                                      U16 tw_img_width=0;
 616   4                                      U16 tw_rem_data;
 617   4                                      U8 tc_ret;
 618   4                                      U8 tc_SOF_Buf[7];
 619   4                                      //Open File
 620   4                                      if(DOS_Open_File_r(C_OtherFHandle, C_Open_FoundFile, C_NullFileName) || (gs_File_FCB[0].dw_File_TotalS
             -ize==0)) 
 621   4                                      {
 622   5                                              //gs_System_State.w_BitRate=0;
 623   5      //                                      dbprintf("open file err\n");    
 624   5                                      }
 625   4                              //Read File
 626   4                                      gb_ReadWriteDataArea = 0;               //select gc_PlayRecordDataBuf[]
 627   4                                      DOS_Read_File(C_OtherFHandle);
 628   4      
 629   4                                      tdw_File_Ptr = 0;
 630   4                                      //find SOI marker
 631   4                                      tc_ret = jpeg_marker_parser(&tdw_File_Ptr, 0xFF, 0xD8);
 632   4                                      if(!tc_ret)
 633   4                                      {
 634   5      //                                      dbprintf("SOI File Pointer = %lx\n", tdw_File_Ptr);
 635   5      
 636   5                                              //find SOF marker
 637   5                                              tc_ret = jpeg_marker_parser(&tdw_File_Ptr, 0xFF, 0xC0);                 
 638   5                                              if(!tc_ret)
 639   5                                              {
 640   6      //                                              dbprintf("SOF File Pointer = %lx\n", tdw_File_Ptr);
 641   6                                              
 642   6                                                      tw_Buf_idx = tdw_File_Ptr & 0x1FF;
 643   6                                                      if(tw_Buf_idx ==0)
 644   6                                                      {
 645   7                                                              DOS_Read_File(C_OtherFHandle);
 646   7                                                      }
 647   6      
 648   6                                                      tw_rem_data = 512 - tw_Buf_idx;
 649   6                                                      if(tw_rem_data >= 7)
 650   6                                                      {
 651   7                                                              memcpy(tc_SOF_Buf, &gc_PlayRecordDataBuf[tw_Buf_idx], 7);
 652   7                                                      }
 653   6                                                      else
 654   6                                                      {
 655   7                                                              memcpy(tc_SOF_Buf, &gc_PlayRecordDataBuf[tw_Buf_idx], tw_rem_data);
 656   7                                                              tw_Buf_idx = 0;
 657   7                                                              DOS_Read_File(C_OtherFHandle);
 658   7                                                              memcpy(&tc_SOF_Buf[tw_rem_data], &gc_PlayRecordDataBuf[0], (7-tw_rem_data));
 659   7                                                      }       
 660   6      
 661   6                                                      ((U8 *)(&tw_img_height))[0] = tc_SOF_Buf[3];
 662   6                                                      ((U8 *)(&tw_img_height))[1] = tc_SOF_Buf[4];
 663   6      //                                              dbprintf("tw_img_height = %x\n", tw_img_height);
 664   6                                                      ((U8 *)(&tw_img_width))[0] = tc_SOF_Buf[5];
 665   6                                                      ((U8 *)(&tw_img_width))[1] = tc_SOF_Buf[6];
 666   6      //                                              dbprintf("tw_img_width = %x\n", tw_img_width);
 667   6                                              }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 12  

 668   5      
 669   5                                              {
 670   6                                                      // horizontal view
 671   6                                                      LCM_set_view(/*TFT_JPGDispDir*/1, 0, 0, TFT_H_Size, TFT_V_Size); // horizontal view
 672   6                                                      L2_DSP_Write_DMem16(0x3F40, TFT_H_Size);                  // Set width
 673   6                                                      L2_DSP_Write_DMem16(0x3F41, TFT_V_Size);                          // Set height
 674   6                                              }
 675   5      
 676   5                                              L2_DSP_Write_DMem16(0x3F48, 0x0000);                            // Set background color
 677   5                                      }
 678   4                              }
 679   3                      }
 680   2                      else if (gc_Play_FileType == 1)
 681   2                      {
 682   3                              L2_DSP_Write_DMem16(0x3F2F, 0x0002);    // BMP file
 683   3                              LCM_set_view(TFT_BMPDispDir, 0, 0, TFT_H_Size, TFT_V_Size); // horizontal view in BMP order
 684   3                      }
 685   2                      else
 686   2                      {
 687   3                              L2_DSP_Write_DMem16(0x3F2F, 0x0003);    // GIF file
 688   3                      }
 689   2      
 690   2              //DSP_Write_MMR16(0x3FD4, DSP_Read_MMR16(0x3FD4)|0x18);  //20090324 jimi add (set DSP Jpeg hardwar
             -e clock) 
 691   2                      if (Image_PlayCmd() == DSP_PLAY_COMMAND_ERROR)
 692   2                      {
 693   3      //                      dbprintf("SYS play init fail\n");
 694   3                      }
 695   2                      
 696   2                      if (gc_Play_FileType == 2)
 697   2                      {       // Set GIF display range
 698   3                              U16 tw_width, tw_height, tw_x_start, tw_y_start;
 699   3      
 700   3                              if (GIF_DataIn() == DSP_DATAIN_COMMAND_ERROR)
 701   3                              {
 702   4      //                              dbprintf("Data in command error\n");
 703   4                                      gs_System_State.c_Phase = TASK_PHASE_PLAYACT;
 704   4                                      gc_PhaseInx = 4;
 705   4                                      gc_KeyDet_Mask = 0;
 706   4                                      return;
 707   4                              }
 708   3      
 709   3                              while (L2_DSP_Read_DMem16(0x3F5E) == 0)
 710   3                              {
 711   4                                      if (L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x0020)        // GIF error format
 712   4                                      {
 713   5      //                                      dbprintf("GIF error format!!\n");
 714   5                                              gs_System_State.c_Phase = TASK_PHASE_PLAYACT;
 715   5                                              gc_PhaseInx = 4;
 716   5                                              gc_KeyDet_Mask = 0;
 717   5                                              return;
 718   5                                      }
 719   4                              }
 720   3                              tw_width = L2_DSP_Read_DMem16(0x3F5D);
 721   3                              tw_height = L2_DSP_Read_DMem16(0x3F5E);
 722   3      //                      dbprintf("width = %x, height = %x\n", tw_width, tw_height);
 723   3                              //Jimi 090305
 724   3                              tw_x_start = (TFT_H_Size - tw_width) >> 1;
 725   3                              tw_y_start = (TFT_V_Size - tw_height) >> 1;
 726   3                              LCM_set_view(TFT_IconDispDir, tw_x_start, tw_y_start, tw_width, tw_height); // horizontal view in norma
             -l order
 727   3                      }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 13  

 728   2                      //Jimi 090305
 729   2                      else if(gc_Play_FileType == 1)
 730   2                      {
 731   3                              /* ===== Setup DSP parameter ===== */
 732   3                              L2_DSP_Write_DMem16(0x3F40, TFT_H_Size);                // Set width  // horizontal view in normal order
 733   3                              L2_DSP_Write_DMem16(0x3F41, TFT_V_Size);                // Set height
 734   3                              L2_DSP_Write_DMem16(0x3F48, 0x0000);                            // Set background color
 735   3                      }
 736   2      
 737   2                      gs_System_State.c_Phase = TASK_PHASE_PLAYACT;
 738   2              }
 739   1              gc_PhaseInx = 2;
 740   1      }
 741          
 742          void jpeg_stop()
 743          {
 744   1              U8 tc_Ret;
 745   1      
 746   1      //      dbprintf("jpeg_stop!\n");
 747   1              if (gs_System_State.c_Phase != TASK_PHASE_STOP)
 748   1              {                       
 749   2                      //jpeg stop
 750   2                      if (gc_Play_FileType == 2)
 751   2                      {
 752   3                              tc_Ret = GIF_StopCmd(gs_System_State.c_FileHandle);
 753   3                      }
 754   2                      else
 755   2                      {
 756   3                              tc_Ret = Image_StopCmd(gs_System_State.c_FileHandle);
 757   3                      }
 758   2      
 759   2                      if (tc_Ret != DSP_SUCCESS)
 760   2                      {
 761   3      //                      dbprintf("JPEG stop error !!\n");
 762   3                      }
 763   2      
 764   2                      gs_System_State.c_Phase = TASK_PHASE_STOP;
 765   2              }
 766   1              gc_PhaseInx = 0;        //Jimi 090305
 767   1      
 768   1      }
 769          
 770          
 771          void jpeg_endfile()
 772          {
 773   1              //stop DSP 'n close file
 774   1              jpeg_stop();
 775   1      }
 776          
 777          
 778          void jpeg_next()
 779          {
 780   1      
 781   1      //      dbprintf("jpeg next!\n");
 782   1      
 783   1              if (gs_System_State.c_Phase == TASK_PHASE_STOP)
 784   1              {
 785   2                      if (gw_FileIndex[gs_System_State.c_FileHandle] == 0)
 786   2                      {
 787   3                              return;//if no this line,error will happen
 788   3                      }
 789   2      
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 14  

 790   2                      gc_PhaseInx = 3;
 791   2              }
 792   1              else if (gs_System_State.c_Phase == TASK_PHASE_PLAYACT)
 793   1              {
 794   2                      gc_PhaseInx = 3;
 795   2                      gc_KeyDet_Mask = 1;//(JC)H0508 avoid key-press to change phase index    
 796   2              }
 797   1              /*else if (gs_System_State.c_Phase == TASK_PHASE_PAUSE)
 798   1              {
 799   1                      gc_PhaseInx = 0;
 800   1              }*/
 801   1      
 802   1              if (gs_System_State.c_Phase != TASK_PHASE_STOP)
 803   1              {
 804   2                      U8 tc_Ret;
 805   2                      if (gc_Play_FileType == 2)
 806   2                      {
 807   3                              tc_Ret = GIF_StopCmd(gs_System_State.c_FileHandle);
 808   3                      }
 809   2                      else
 810   2                      {
 811   3                              tc_Ret = Image_StopCmd(gs_System_State.c_FileHandle);
 812   3                      }
 813   2                      if (tc_Ret != DSP_SUCCESS)
 814   2                      {
 815   3      //                      dbprintf("JPEG stop error !!\n");
 816   3                      }
 817   2                      
 818   2                      gs_System_State.c_Phase = TASK_PHASE_STOP;
 819   2              }
 820   1      
 821   1              DOS_Search_File(C_File_All|C_By_FDB, C_OtherFileType, C_CmpExtName|C_Next);
 822   1              gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType;           //Jimi 090305
 823   1      
 824   1              if((gc_AutoJpeg_Flag==1) && (gc_Play_FileType==2) && (gc_JpegVelocity==0))  //20090331
 825   1              {
 826   2                      gw_AutoJpeg_Timer=(U16)(gc_JpegVelocity+1)*36;  
 827   2              }       
 828   1      }
 829          
 830          void jpeg_prev()
 831          {
 832   1      //      dbprintf("jpeg prev!\n");
 833   1      
 834   1              if (gs_System_State.c_Phase == TASK_PHASE_STOP)
 835   1              {
 836   2                      if (gw_FileIndex[gs_System_State.c_FileHandle] == 0)
 837   2                              return;//if no this line,error will happen
 838   2                      gc_PhaseInx = 3;
 839   2              }
 840   1              else if (gs_System_State.c_Phase == TASK_PHASE_PLAYACT)
 841   1              {
 842   2                      gc_PhaseInx = 3;
 843   2                      gc_KeyDet_Mask = 1;//(JC)H0508 avoid key-press to change phase index            
 844   2              }
 845   1              /*else if (gs_System_State.c_Phase == TASK_PHASE_PAUSE)
 846   1              {
 847   1                      gc_PhaseInx = 0;
 848   1              }*/
 849   1              
 850   1              if (gs_System_State.c_Phase != TASK_PHASE_STOP)//(JC)H0505
 851   1              {
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 15  

 852   2                      U8 tc_Ret;
 853   2                      if (gc_Play_FileType == 2)
 854   2                      {
 855   3                              tc_Ret = GIF_StopCmd(gs_System_State.c_FileHandle);
 856   3                      }
 857   2                      else
 858   2                      {
 859   3                              tc_Ret = Image_StopCmd(gs_System_State.c_FileHandle);
 860   3                      }
 861   2                      if (tc_Ret != DSP_SUCCESS)
 862   2                      {
 863   3      //                      dbprintf("JPEG stop error !!\n");
 864   3                      }
 865   2      
 866   2                      gs_System_State.c_Phase = TASK_PHASE_STOP;
 867   2              }
 868   1      
 869   1              DOS_Search_File(C_File_All|C_By_FDB, C_OtherFileType, C_CmpExtName|C_Prev);
 870   1              gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType;          //Jimi 090305
 871   1      }
 872          
 873          
 874          void jpeg_back2uplevel()
 875          {
 876   1              if((gs_System_State.c_Phase == TASK_PHASE_PLAYACT) || (gs_System_State.c_Phase == TASK_PHASE_PAUSE))
 877   1              {
 878   2                      jpeg_stop();    
 879   2              }
 880   1              
 881   1      //      dbprintf("back 2 menu level\n");
 882   1              gc_Task_Next=C_Task_Menu;
 883   1              gw_init_needed |= SET_BIT8;
 884   1              gc_PhaseInx=0;
 885   1      }
 886          
 887          
 888          U8 jpeg_marker_parser(U32 *tpdw_File_Ptr, U8 tc_marker_Hbyte, U8 tc_marker_Lbyte)
 889          {
 890   1              bit tb_soi_found = 0;
 891   1              U8 tc_sector_cnt = 0;
 892   1              U16 tw_Buf_idx;
 893   1      
 894   1              do{
 895   2                      tw_Buf_idx = *tpdw_File_Ptr & 0x1FF;
 896   2                      if ((!tw_Buf_idx) && (*tpdw_File_Ptr>0))
 897   2                      {
 898   3                              DOS_Read_File(C_OtherFHandle);
 899   3                              tc_sector_cnt ++;
 900   3                      }
 901   2                      
 902   2                      if(gc_PlayRecordDataBuf[tw_Buf_idx++] == tc_marker_Hbyte)
 903   2                      {
 904   3                              bit tb_next_sector = 0;
 905   3                              //marker identifier found
 906   3      
 907   3                              if(tw_Buf_idx == 512)
 908   3                              {
 909   4                                      tw_Buf_idx = 0;
 910   4                                      DOS_Read_File(C_OtherFHandle);
 911   4                                      tb_next_sector = 1;
 912   4                                      tc_sector_cnt ++;
 913   4                              }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 16  

 914   3      
 915   3                              if(gc_PlayRecordDataBuf[tw_Buf_idx] == tc_marker_Lbyte)
 916   3                                      tb_soi_found = 1;
 917   3      
 918   3                              if(!tb_next_sector)
 919   3                              {               
 920   4                                      tw_Buf_idx++;
 921   4                                      (*tpdw_File_Ptr)++;
 922   4                              }                       
 923   3                      }
 924   2                      (*tpdw_File_Ptr)++;
 925   2      
 926   2                      if(tc_sector_cnt >=8)
 927   2                              return FAIL;
 928   2      
 929   2              }while(!tb_soi_found);          
 930   1      
 931   1              return SUCCESS;
 932   1      
 933   1      }
 934          
 935          
 936          void JpegMenu_Process()
 937          {
 938   1              bit     tc_Confirm=0;
 939   1              gc_refresh_type = REFRESH_ALL;
 940   1              if(gc_PhaseInx!=2)
 941   1              {
 942   2              switch(gc_PhaseInx)
 943   2              {
 944   3                  case C_JpegMenu:
 945   3                                      gc_refresh_type = REFRESH_ALL;  
 946   3                                      tc_Confirm=1;
 947   3                  break;
 948   3      
 949   3                  case C_JpegNext:
 950   3                                      gc_refresh_type = REFRESH_NEXT;
 951   3                                      if(gc_LCMDispIndex==2)
 952   3                                      {
 953   4                                              gc_LCMDispIndex=0;
 954   4                                      }
 955   3                                      else
 956   3                                      {
 957   4                                              gc_LCMDispIndex++;
 958   4                                      }
 959   3                  break;
 960   3      
 961   3                  case C_JpegPrev:
 962   3                                      gc_refresh_type = REFRESH_PREV;
 963   3                                      if(gc_LCMDispIndex==0)
 964   3                                      {
 965   4                                              gc_LCMDispIndex=2;
 966   4                                      }
 967   3                                      else
 968   3                                      {
 969   4                                              gc_LCMDispIndex--;
 970   4                                      }
 971   3                  break;      
 972   3              }
 973   2      
 974   2                      if(tc_Confirm==1) //confirm selected item
 975   2                      {
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 17  

 976   3                              if(gc_LCMDispIndex==0)  //jpeg Dir
 977   3                              {
 978   4                                      play_stop();
 979   4                                      gc_TaskMode_BkUp=C_Task_Jpeg;
 980   4                                      gc_Task_Next=C_Task_Dir;
 981   4                                      return;
 982   4                              }
 983   3                              else if(gc_LCMDispIndex==1)  //Select Jpeg Mode
 984   3                              {
 985   4                                      gc_DispPlayMenuAct=1;
 986   4                                      gc_TuneVolFreqStatus=32;
 987   4                                      return;
 988   4                              }
 989   3                              else if(gc_LCMDispIndex==2)  //Select Display velocity
 990   3                              {
 991   4                                      gc_DispPlayMenuAct=2;
 992   4                                      gc_TuneVolFreqStatus=33;
 993   4                                      return;
 994   4                              }
 995   3                      }
 996   2              }       
 997   1      }
 998          
 999          
1000          void JpegDispMode_Process()
1001          {
1002   1              bit     tc_Confirm=0;
1003   1      
1004   1              if(gc_PhaseInx!=2)
1005   1              {
1006   2              switch(gc_PhaseInx)
1007   2              {
1008   3                  case C_JpegMenu:
1009   3                                      tc_Confirm=1;
1010   3                  break;
1011   3      
1012   3                  case C_JpegNext:
1013   3                  case C_JpegPrev:
1014   3                                      gc_refresh_type=REFRESH_NEXT;
1015   3                                      gc_LCMDispIndex=(gc_LCMDispIndex+1)&0x01;
1016   3                  break;      
1017   3              }
1018   2      
1019   2                      if(tc_Confirm==1) //confirm selected item
1020   2                      {
1021   3                              if(gc_LCMDispIndex==0)  //User
1022   3                              {
1023   4                                      gc_AutoJpeg_Flag=0;
1024   4                                      gc_TuneVolFreqStatus=0;
1025   4                                      gc_DispPlayMenuAct=0;
1026   4                              }
1027   3                              else if(gc_LCMDispIndex==1)  //Auto
1028   3                              {
1029   4                                      gc_AutoJpeg_Flag=1;
1030   4                                      gc_TuneVolFreqStatus=0;
1031   4                                      gc_DispPlayMenuAct=0;
1032   4                              }
1033   3                      }
1034   2              }               
1035   1      }
1036          
1037          
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 18  

1038          void JpegDispVelocity_Process()
1039          {
1040   1              if(gc_PhaseInx!=2)
1041   1              {
1042   2              switch(gc_PhaseInx)
1043   2              {
1044   3                  case C_JpegMenu:
1045   3                                      gc_TuneVolFreqStatus=0;
1046   3                                      gc_DispPlayMenuAct=0;
1047   3                  break;
1048   3      
1049   3                  case C_JpegNext:
1050   3                                      if(gc_JpegVelocity<10)
1051   3                                      {
1052   4                                              gc_JpegVelocity++;
1053   4                                      }
1054   3                  break;
1055   3      
1056   3                  case C_JpegPrev:
1057   3                                      if(gc_JpegVelocity>0)
1058   3                                      {
1059   4                                              gc_JpegVelocity--;
1060   4                                      }
1061   3                  break;      
1062   3              }
1063   2              }       
1064   1      }
1065          
1066          
1067          void JpegMenu_Disp()
1068          {
1069   1              if(gc_TuneVolFreqStatus==31)
1070   1              {
1071   2                      gc_JPGSetting=0;
1072   2                      IR_Service_Process_Menu_2();
1073   2      
1074   2                      if(gc_DispWallpaper!=32)
1075   2                      {
1076   3                              //TFT_PhotoMenu();//--sunzhk modif 100703
1077   3                              Menu_Disp_Item_Other(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
1078   3                              gc_DispWallpaper=32;
1079   3                              gc_LCMDispIndex=0;
1080   3                              gc_LCMDispIndexBak=0x00;                        //home
1081   3                              gc_PhaseInx=0;
1082   3                              gc_DispPlayMenuAct =0x03;                               
1083   3                      }
1084   2      
1085   2                      JpegMenu_Process();
1086   2      
1087   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
1088   2                      {
1089   3                              gc_LCMDispIndexBak=gc_LCMDispIndex;
1090   3                              //TFT_PhotoMenu();//--sunzhk modif 100703
1091   3                              Menu_Disp_Item_Other(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
1092   3                      }
1093   2              }
1094   1              else if(gc_TuneVolFreqStatus==32)
1095   1              {
1096   2                      IR_Service_Process_Menu_2();
1097   2                      if(gc_DispWallpaper!=33)
1098   2                      {
1099   3                              gc_DispWallpaper=33;
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 19  

1100   3                              gc_LCMDispIndex=0;
1101   3                              gc_LCMDispIndexBak=0xFF;
1102   3                              gc_PhaseInx=0;
1103   3                      }
1104   2      
1105   2                      gc_JPGSetting=1;
1106   2                      JpegDispMode_Process();
1107   2      
1108   2                      if(gc_LCMDispIndexBak!=gc_LCMDispIndex)
1109   2                      {
1110   3                              gc_LCMDispIndexBak=gc_LCMDispIndex;
1111   3                              //TFT_PhotoMenu();//--sunzhk modif 100703
1112   3                              Menu_Disp_Item_Other(gc_TuneVolFreqStatus,gc_LCMDispIndex,gc_refresh_type);
1113   3                      }
1114   2              }
1115   1              else if(gc_TuneVolFreqStatus==33)
1116   1              {
1117   2                      IR_Service_Process_Menu_2();
1118   2                      if(gc_DispWallpaper!=34)
1119   2                      {
1120   3                              gc_JpegVelocityBak=0xFF;
1121   3                              gc_DispWallpaper=34;
1122   3                              gc_LCMDispIndex=0;
1123   3                              gc_PhaseInx=0;
1124   3                      }
1125   2      
1126   2                      JpegDispVelocity_Process();
1127   2      
1128   2                      if(gc_JpegVelocityBak!=gc_JpegVelocity)
1129   2                      {
1130   3                              TFT_Velocity();
1131   3                              gc_JpegVelocityBak=gc_JpegVelocity;
1132   3                      }
1133   2              }
1134   1      
1135   1              if(gc_TuneVolFreqStatus==0)  //Tw play jpeg
1136   1              {
1137   2                      if(gc_AutoJpeg_Flag==1)
1138   2                      {
1139   3                              gw_AutoJpeg_Timer=(U16)gc_JpegVelocity*36;
1140   3                      }
1141   2                      gc_PhaseInx=C_JpegPause;        
1142   2              }
1143   1              else
1144   1              {
1145   2                      gc_PhaseInx=C_JpegIdle;
1146   2              }
1147   1      }
1148          
1149          
1150          void Play_SDFlash_DosInit_Jpeg()
1151          {
1152   1              gb_FindFlag = 0;
1153   1              gc_PhaseInx=0;
1154   1              gw_init_needed=0xFFFF;
1155   1              if (DOS_Initialize())
1156   1              {
1157   2              }
1158   1              else
1159   1              {
1160   2                      gc_ShowTimer=0;  //20090331
1161   2                      gc_DispWallpaper=1;
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 20  

1162   2                      gc_TuneVolFreqStatus=0;
1163   2                      gb_FindFlag = 0;
1164   2                      gc_PhaseInx=0;
1165   2                      gw_init_needed=0xFFFF;
1166   2      
1167   2                      gs_System_State.c_Phase = TASK_PHASE_STOP; 
1168   2                      gs_System_State.c_FileHandle = 2; 
1169   2              
1170   2                  gs_File_FCB[gs_System_State.c_FileHandle].dw_FDB_StartCluster = gdw_DOS_RootDirClus; 
1171   2              
1172   2                  EXT_NameC[0] = 3; 
1173   2                  EXT_NameC[1] = 'J'; 
1174   2                  EXT_NameC[2] = 'P'; 
1175   2                  EXT_NameC[3] = 'G'; 
1176   2                  EXT_NameC[4] = 'B'; 
1177   2                  EXT_NameC[5] = 'M'; 
1178   2                  EXT_NameC[6] = 'P'; 
1179   2                  EXT_NameC[7] = 'G'; 
1180   2                  EXT_NameC[8] = 'I'; 
1181   2                  EXT_NameC[9] = 'F'; 
1182   2                      DOS_Search_File(C_File_All|C_Cnt_FileNo,C_OtherFileType,C_CmpExtName|C_Next); 
1183   2              
1184   2                  if(DOS_Search_File(C_File_All|C_By_FDB, C_OtherFHandle, C_CmpExtName|C_Next)) 
1185   2                      { 
1186   3                      //if(media_changetimes==tc_media_changetimes) 
1187   3                       
1188   3                          //media_changetimes=1; 
1189   3                          dbprintf("jpeg no file01\n"); 
1190   3              
1191   3                          gc_TuneVolFreqStatus=0; 
1192   3                          gb_FindFlag = 0; 
1193   3                          gw_init_needed=0xFFFF; 
1194   3                          
1195   3                          //gc_TaskMode_BkUp=C_Task_Play;//(JC)I0304 for back to rite TASK from Dir-list 
1196   3                          gc_TaskMode_BkUp=C_Task_Play; 
1197   3                      gc_Task_Next=C_Task_Play;
1198   3                      gc_MenuItemCount=0;
1199   3                      gs_System_State.c_FileHandle=0;
1200   3      //              DOS_DIRtable();  //20090216 chiayen add       
1201   3                      gs_File_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;           
1202   3                      DOS_Search_File(C_File_All|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);//(JC)count music file no
             -. in root
1203   3                      gc_PhaseInx=0;
1204   3                      gb_TFT_refresh=1;
1205   3                      gc_DispWallpaper=0xFF;
1206   3                              return; 
1207   3                   } 
1208   2                      gc_Play_FileType=gs_File_FCB[gs_System_State.c_FileHandle].c_FileType; 
1209   2                      gc_PhaseInx=C_JpegPause; 
1210   2      
1211   2              }
1212   1      }
1213          
1214          
1215          /*void Play_SDFlash_DosInit_Jpeg()
1216          {
1217                  gb_FindFlag = 0;
1218                  gc_PhaseInx=0;
1219                  gw_init_needed=0xFFFF;
1220                  if (DOS_Initialize())
1221                  {
1222                  }
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 21  

1223                  else
1224                  {
1225                          gc_ShowTimer=0;  //20090331
1226                          gc_DispWallpaper=1;
1227                          gc_TuneVolFreqStatus=0;
1228                          gb_FindFlag = 0;
1229                          gc_PhaseInx=0;
1230                          gw_init_needed=0xFFFF;
1231          
1232                          //gc_TaskMode_BkUp=C_Task_Play;//(JC)I0304 for back to rite TASK from Dir-list
1233                          gc_TaskMode_BkUp=C_Task_Play;
1234                          gc_Task_Next=C_Task_Play;
1235                          gc_MenuItemCount=0;
1236                          gs_System_State.c_FileHandle=0;
1237          //              DOS_DIRtable();  //20090216 chiayen add       
1238                          gs_File_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;           
1239                          DOS_Search_File(C_File_All|C_Cnt_FileNo, C_MusicFileType, C_CmpExtName|C_Next);//(JC)count music file no
             -. in root
1240                          gc_PhaseInx=0;
1241                          gb_TFT_refresh=1;
1242                          gc_DispWallpaper=0xFF;
1243                  }
1244          }
1245          
1246          */
1247          void Play_SourceDetect_Process_Jpeg()
1248          {
1249   1              gb_SD_Exist_pre=gb_SD_Exist;
1250   1              if(!SD_Detect)  //SD exist
1251   1          {
1252   2              gb_SD_Exist=1;
1253   2          }
1254   1              else
1255   1              {
1256   2                      gb_SD_Exist=0;
1257   2                      gb_SDNoFileflag=0;
1258   2              }
1259   1      #if 1//(USB_HOST==1)
1260   1              gb_Host_Exist_pre=gb_Host_Exist;
1261   1              if(!Host_DetectDevice())
1262   1              {
1263   2                      gb_Host_Exist=1;        //host_exist            
1264   2              }
1265   1              else
1266   1              {
1267   2                      gb_Host_Exist=0;
1268   2                      gc_HostNoFileflag=0;
1269   2              }
1270   1      #endif
1271   1      
1272   1              if((gc_CurrentCard==0) && ((gb_Host_Exist_pre!=gb_Host_Exist)||(gb_SD_Exist_pre!=gb_SD_Exist)))
1273   1              {
1274   2                      if((gb_Host_Exist_pre!=gb_Host_Exist) && (gb_Host_Exist==1))
1275   2                      {
1276   3                              gc_CurrentCard=5;
1277   3                      }
1278   2                      else if((gb_SD_Exist_pre!=gb_SD_Exist) && (gb_SD_Exist==1))
1279   2                      {
1280   3                              gc_CurrentCard=2;       
1281   3                      }
1282   2                      else
1283   2                      {
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 22  

1284   3                              gc_CurrentCard=0;       
1285   3                      }
1286   2              }
1287   1              else
1288   1              {
1289   2                      if(gc_CurrentCard==2)
1290   2                      {
1291   3                              if(gc_Dosinitfail==0)  //20090803 chiayen add
1292   3                              {
1293   4                                      if((gb_Host_Exist_pre!=gb_Host_Exist) && (gb_Host_Exist==1))
1294   4                                      {
1295   5                                              gc_CurrentCard=5;
1296   5                                      }
1297   4                                      else if(((gb_SD_Exist==0) || (gb_SDNoFileflag==1)) && (gb_Host_Exist==1))
1298   4                                      {
1299   5                                              gc_CurrentCard=5;
1300   5                                              if(gc_HostNoFileflag==1)
1301   5                                              {
1302   6                                                      gc_CurrentCard=0;       
1303   6                                              }
1304   5                                      }
1305   4                                      else if((gb_SD_Exist==0) || (gb_SDNoFileflag==1))
1306   4                                      {
1307   5                                              gc_CurrentCard=0;       
1308   5                                      }
1309   4                              }
1310   3                              else //20090803 chiayen add for SD Dos initial fail
1311   3                              {
1312   4                                      if((gb_Host_Exist==1) && (gc_HostNoFileflag==0))
1313   4                                      {
1314   5                                              gc_CurrentCard=5;
1315   5                                      }
1316   4                                      else
1317   4                                      {
1318   5                                              gc_CurrentCard=0;
1319   5                                      }
1320   4                                      gc_Dosinitfail=0;                               
1321   4                              }
1322   3                      }
1323   2                      if(gc_CurrentCard==5)
1324   2                      {
1325   3                              if(gc_Dosinitfail==0)  //20090803 chiayen add
1326   3                              {
1327   4                                      if((gb_SD_Exist_pre!=gb_SD_Exist) && (gb_SD_Exist==1))
1328   4                                      {
1329   5                                              gc_CurrentCard=2;
1330   5                                      }
1331   4                                      else if(((gb_Host_Exist==0) || (gc_HostNoFileflag==1)) && (gb_SD_Exist==1))
1332   4                                      {
1333   5                                              gc_CurrentCard=2;
1334   5                                              if(gb_SDNoFileflag==1)
1335   5                                              {
1336   6                                                      gc_CurrentCard=0;       
1337   6                                              }
1338   5                                      }
1339   4                                      else if((gb_Host_Exist==0) || (gc_HostNoFileflag==1))
1340   4                                      {
1341   5                                              gc_CurrentCard=0;       
1342   5                                      }
1343   4                              }
1344   3                              else //host dos initial fail  //20090803 chiayen add
1345   3                              {
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 23  

1346   4                                      if((gb_SD_Exist==1) && (gb_SDNoFileflag==0))
1347   4                                      {
1348   5                                              gc_CurrentCard=2;
1349   5                                      }
1350   4                                      else
1351   4                                      {
1352   5                                              gc_CurrentCard=0;
1353   5                                      }
1354   4                                      gc_Dosinitfail=0;
1355   4                              }
1356   3                      }
1357   2              }
1358   1      
1359   1          if(gc_CurrentCard_backup!=gc_CurrentCard)
1360   1          {
1361   2                      U8 tc_CurrentCard;
1362   2                      tc_CurrentCard=gc_CurrentCard;
1363   2                      gc_CurrentCard=gc_CurrentCard_backup;
1364   2                      jpeg_stop();
1365   2                      gc_MenuItemCount=0;
1366   2                      gc_CurrentCard=tc_CurrentCard;
1367   2                      gc_CurrentCard_backup=gc_CurrentCard;
1368   2      
1369   2                      set_clock_mode(CLOCK_MODE_MP3); //20090803 chiayen add for media change
1370   2      
1371   2                      if(gc_CurrentCard==2)
1372   2              {           
1373   3                  if(SD_Identification_Flow())
1374   3                  {
1375   4                      gc_CardExist |=0x02;
1376   4                  }
1377   3                  else if((gb_Host_Exist==1) && (gc_HostNoFileflag==0)) //20090730 chiayen modify
1378   3                  {
1379   4                                      DEVICE_REG[0x00]= 0x01;  //20090730 chiayen add
1380   4                                      if(!Host_Initial())
1381   4                                      {
1382   5                                              gc_CurrentCard = CURRENT_MEDIA_HOST;
1383   5                                              gb_FindFlag = 0;
1384   5                      }
1385   4                          else
1386   4                          {
1387   5                                              gc_CurrentCard=0;
1388   5                                              gc_CardExist &=0xFD;
1389   5                                              gb_FindFlag = 0;
1390   5                                              InitFlash();                                
1391   5                          }
1392   4                      }
1393   3                              else 
1394   3                      {
1395   4                                      DEVICE_REG[0x00]= 0x01;  //20090730 chiayen add
1396   4                                      gc_CurrentCard=0;
1397   4                                      gc_CardExist &=0xFD;
1398   4                                      gb_FindFlag = 0;
1399   4                                      InitFlash();
1400   4                              }
1401   3                              Play_SDFlash_DosInit_Jpeg();
1402   3              }
1403   2                      #if 1//(USB_HOST==1)
1404   2                      else if(gc_CurrentCard==CURRENT_MEDIA_HOST)
1405   2                      {
1406   3                              DEVICE_REG[0x00]= 0x01;  //20090803 chiayen add                 
1407   3                              if(!Host_Initial())
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 24  

1408   3                              {
1409   4                                      gc_CurrentCard = CURRENT_MEDIA_HOST;
1410   4                                      gb_FindFlag = 0;
1411   4                              }
1412   3                              else if((gb_SD_Exist==1) && (gb_SDNoFileflag==0)) //20090730 chiayen add
1413   3                              {
1414   4                          if(SD_Identification_Flow())
1415   4                          { 
1416   5                              gc_CardExist |=0x02;
1417   5                                              gc_CurrentCard=2;      
1418   5                                      }
1419   4                                      else
1420   4                                      {
1421   5                                              DEVICE_REG[0x00]= 0x01;
1422   5                                              gc_CurrentCard=0;
1423   5                                              gc_CardExist &=0xFD;
1424   5                                              gb_FindFlag = 0;
1425   5                                              InitFlash();
1426   5                                      }
1427   4                              }
1428   3                              else 
1429   3                      {
1430   4                                      DEVICE_REG[0x00]= 0x01;
1431   4                                      gc_CurrentCard=0;
1432   4                                      gb_FindFlag = 0;
1433   4                                      InitFlash();
1434   4                              }
1435   3                              Play_SDFlash_DosInit_Jpeg();
1436   3                      }
1437   2                      else if(gc_CurrentCard==0)
1438   2              {
1439   3                              DEVICE_REG[0x00]= 0x01;
1440   3                              gc_CardExist &=0xFD;
1441   3                              InitFlash();
1442   3                              Play_SDFlash_DosInit_Jpeg();
1443   3                      }
1444   2                      #endif
1445   2      
1446   2                      #if 0
                              if(gc_CurrentCard==2)
                      {           
                          if(SD_Identification_Flow())
                          {
                              gc_CardExist |=0x02;
                                              Play_SDFlash_DosInit_Jpeg();      
                          }
                          else
                          {
                                              XBYTE[0xB400]= 0x01;
                                              gc_CurrentCard=0;
                                              gc_CardExist &=0xFD;
                                              gb_FindFlag = 0;
                                              InitFlash();
                                              Play_SDFlash_DosInit_Jpeg();                                        
                          }
                      }
                      else if(gc_CurrentCard==0)
                      {
                                      XBYTE[0xB400]= 0x01;
                                      gc_CardExist &=0xFD;
                                      InitFlash();
                                      Play_SDFlash_DosInit_Jpeg();
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 25  

                      }
                              else if(gc_CurrentCard==CURRENT_MEDIA_HOST)
                              {
                                      set_clock_mode(CLOCK_MODE_MP3);
                                      if(!Host_Initial())
                                      {
                                              gc_CurrentCard = CURRENT_MEDIA_HOST;
                                              gb_FindFlag = 0;
                                      }
                                      else
                                      {
                                              XBYTE[0xB400]= 0x01;
                                              gc_CurrentCard=0;
                                              gb_FindFlag = 0;
                                              InitFlash();
                                              gc_CurrentCard=0;
                                      }
                                      Play_SDFlash_DosInit_Jpeg();
                              }
                              #endif
1490   2          }
1491   1      }
1492          
1493          
1494          void Jpeg_Task()
1495          {
1496   1              gc_TuneVolFreqStatus=0;  //20090331
1497   1              gc_DispPlayMenuAct=0;
1498   1              gw_AutoJpeg_Timer=(U16)gc_JpegVelocity*36+18;
1499   1               
1500   1              while (1)
1501   1              {
1502   2                      switch(gc_PhaseInx)
1503   2                      {
1504   3                              case C_JpegIdle:
1505   3                                      set_clock_mode(CLOCK_MODE_MP3);         // added by maxliao
1506   3                                      jpeg_idle();
1507   3                              break;
1508   3      
1509   3                              case C_JpegInit:
1510   3                                      set_clock_mode(CLOCK_MODE_MJPEG);       // added by maxliao
1511   3                                      jpeg_init();
1512   3                              break;                  
1513   3      
1514   3                              case C_JpegProc:
1515   3                                      jpeg_proc();
1516   3                              break;
1517   3                              
1518   3                              case C_JpegPause:
1519   3                                      if(gc_TuneVolFreqStatus<30)
1520   3                                      {
1521   4                                              jpeg_playpause();
1522   4                                      }
1523   3                              break;
1524   3      
1525   3                              case C_JpegStop:
1526   3                                      jpeg_stop();
1527   3                              break;
1528   3      
1529   3                              case C_JpegEndfile:
1530   3                                      jpeg_endfile(); 
1531   3                              break;
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 26  

1532   3      
1533   3                              case C_JpegNext:
1534   3                                      if(gc_TuneVolFreqStatus<30)
1535   3                                      {
1536   4                                              jpeg_next();
1537   4                                      }                               
1538   3                              break;
1539   3      
1540   3                              case C_JpegPrev:
1541   3                                      if(gc_TuneVolFreqStatus<30)
1542   3                                      {
1543   4                                              jpeg_prev();
1544   4                                      }
1545   3                              break;
1546   3                              
1547   3                              case C_JpegUpLevel:
1548   3                                      jpeg_back2uplevel();
1549   3                              break;
1550   3      
1551   3                              case C_JpegMenu:  //20090331
1552   3                                      gc_ShowTimer =150;
1553   3                                      if(gc_DispPlayMenuAct==0)
1554   3                                      {
1555   4                                              gc_TuneVolFreqStatus=31;
1556   4                                      }                                                                                       
1557   3                              break;
1558   3                                      
1559   3                  case C_PowerOff:
1560   3                                      if(gs_System_State.c_Phase!=TASK_PHASE_STOP)
1561   3                                      {
1562   4                                              jpeg_stop();    
1563   4                                      }
1564   3                                      gc_Task_Next=C_Task_PowerOff;                                           
1565   3                  break;
1566   3                                      
1567   3                              case C_MainMenu:
1568   3                                      jpeg_stop();
1569   3                                      gc_Task_Next=C_Task_Menu;
1570   3                              break;
1571   3                      }       
1572   2                      
1573   2                      if(gc_TuneVolFreqStatus>30)
1574   2                      {
1575   3                              if((gc_PhaseInx==C_JpegProc)&&(gc_Play_FileType<2))                     //sunzhk add 090612 
1576   3                              {
1577   4                                      U8 tc_Ret;
1578   4                                      if (gs_System_State.c_Phase != TASK_PHASE_STOP)
1579   4                                      {                       
1580   5                                              //jpeg stop
1581   5                                              if (gc_Play_FileType == 2)
1582   5                                              {
1583   6                                                      tc_Ret = GIF_StopCmd(gs_System_State.c_FileHandle);
1584   6                                              }
1585   5                                              else
1586   5                                              {
1587   6                                                      tc_Ret = Image_StopCmd(gs_System_State.c_FileHandle);
1588   6                                              }
1589   5                              
1590   5                                              if (tc_Ret != DSP_SUCCESS)
1591   5                                              {
1592   6      //                                              dbprintf("JPEG stop error !!\n");
1593   6                                                      XBYTE[0xB001]|=0x02;
C51 COMPILER V9.00   JPEG_PROCESS                                                          07/10/2012 15:51:59 PAGE 27  

1594   6                                                      XBYTE[0xB001]&=~0x02;
1595   6                                              }
1596   5                                              gs_System_State.c_Phase = TASK_PHASE_STOP;
1597   5                                      }
1598   4                              }
1599   3                              JpegMenu_Disp();
1600   3                      }
1601   2                      else
1602   2                      {
1603   3                              if((gc_PhaseInx==C_JpegIdle)&&(gc_Play_FileType<2))
1604   3                              {
1605   4                                      if(gc_AutoJpeg_Flag==1 && gw_AutoJpeg_Timer==0)
1606   4                                  {
1607   5                                              gw_AutoJpeg_Timer=(U16)gc_JpegVelocity*36;
1608   5                                              gc_PhaseInx=C_JpegNext; 
1609   5                                      }
1610   4                              }
1611   3      
1612   3                              if((gc_Play_FileType==2))
1613   3                              {
1614   4                                      if(gc_AutoJpeg_Flag==1 && gw_AutoJpeg_Timer==0)
1615   4                                  {
1616   5                                              gw_AutoJpeg_Timer=(U16)gc_JpegVelocity*36;
1617   5                                              gc_PhaseInx=C_JpegNext; 
1618   5                                      }                               
1619   4                              }
1620   3                      }       
1621   2                              
1622   2                      Polling_TaskEvents();
1623   2              IR_Service_Process();
1624   2                      Play_SourceDetect_Process_Jpeg();
1625   2                      if (gc_Task_Current != gc_Task_Next)
1626   2                      {
1627   3                              gc_Task_Current = gc_Task_Next;
1628   3                              break;  
1629   3                      }
1630   2              }
1631   1      }
1632          
1633          
1634          void IR_Service_Process_Menu_2(void)
1635          {
1636   1          if(gc_IRCmdStatus==1)
1637   1          {
1638   2              ir_service_menu();
1639   2          }
1640   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4391    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =      2      55
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
