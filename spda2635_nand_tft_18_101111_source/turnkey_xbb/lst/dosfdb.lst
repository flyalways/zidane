C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DOSFDB
OBJECT MODULE PLACED IN .\obj\dosfdb.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\LIBSOURCE\DOS\dosfdb.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\l
                    -ibsource\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\dosfdb.lst) OBJECT(.\obj\dosfdb.obj)

line level    source

   1          #include <string.h>
   2          #include "SPDA2K.h"
   3          #include "dos\fs_struct.h"
   4          #include "dos\dosfat.h"
   5          #include "dos\dosfdb.h"
   6          #include "Memalloc.h"
   7          #include "dos\dosfile.h"
   8          #include "dos\dosrw.h"
   9          #include "PROTOTYP.h"
  10          #include "Rambase.h"
  11          
  12          U8 Find_Fdb(SearchFdb *p_mp);
  13          
  14          U8  code EXT_NameA[]={2,'M','P','3','W','M','A'};
  15          U8  code EXT_NameB[]={1,'W','A','V'};
  16          U8  xdata EXT_NameC[10];
  17          U8  *code EXT_Name[] = {EXT_NameA,EXT_NameB,EXT_NameC,EXT_NameC,EXT_NameC,EXT_NameC,};
  18          
  19          extern  data    bit     gb_HostConnect;
  20          extern  xdata   U8      gc_HostSectorUnit;
  21          extern  xdata   U16     gw_DirTotalNumber;
  22          
  23          U8 Find_Fdb(SearchFdb *p_mp)
  24          {
  25   1              data    bit     tc_RecFlag;
  26   1              data    bit     tb_flag=0;
  27   1              data    bit     tb_SortFlag=0;
  28   1              data    bit     tb_SameFlag=0;
  29   1              data    bit     tb_not_1stFDB=0;
  30   1              U8      code REC[]={'R','E','C','_'};
  31   1              U8      tc_sts,tc_Read_fail,tc_SectorOffset,tc_Temp_SectorOffset;
  32   1              U8      tc_PlayMode;
  33   1              U8      tc_ExtNum;
  34   1              U16 tw_FdbOffset,tw_Temp_FdbOffset,tw_FileLongName,tw_ByteOffset ,tw_PrevFDB_Offset;
  35   1              U16     tw_DirIndex=0,tw_DirIndex1=0;
  36   1              U32 tdw_SectorAdd,tdw_StartCluster,tdw_S_ClusterNum,tdw_FDBClusterNum;
  37   1              U32 tdw_Find_ClusterSize,tdw_TheEndCluster,tdw_StartCluster1,tdw_StartCluster3, tdw_PrevFDB_Cluster, tdw_
             -PrevFDB_LogAdd;
  38   1              U32 tdw_FDB_LogAdd0,tdw_FDB_LogAdd1;
  39   1              U32 tdw_Temp_flag=0;
  40   1              U32 tdw_Tag0,tdw_Tag1;
  41   1              U16     tw_FileSkipNumber;
  42   1      
  43   1              tw_FileSkipNumber=gw_FileSkipNumber;
  44   1              
  45   1              tdw_Tag1= p_mp->Compare.dw_BubbleFlag;
  46   1              if(p_mp->c_Search_Direction) //find pre
  47   1              {
  48   2                      tdw_Tag0=0x0000;                
  49   2              }
  50   1              else
  51   1              {//find next
  52   2                      tdw_Tag0=0xffffffff;
  53   2              }
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 2   

  54   1      
  55   1              if(p_mp->dw_FDB_StartCluster==0 && gdw_DOS_RootDirClus==2) //FAT32, 20090216 chiayen add
  56   1              {
  57   2                      p_mp->dw_FDB_StartCluster=2;
  58   2              }
  59   1      
  60   1              tdw_FDBClusterNum=p_mp->dw_FDB_StartCluster;
  61   1              p_mp->dw_LongFDB_LogAdd1=0;
  62   1              p_mp->dw_LongFDB_LogAdd0=0;     
  63   1              tw_Temp_FdbOffset=0x00;
  64   1              tc_Temp_SectorOffset=0x00;
  65   1              tdw_FDB_LogAdd0=0;
  66   1              tdw_FDB_LogAdd1=0;
  67   1              tdw_S_ClusterNum=p_mp->dw_FDB_StartCluster;     
  68   1              tc_sts=GO_ON;
  69   1      
  70   1              if(gc_DOS_FileSystemType==1)
  71   1              {
  72   2                      tdw_TheEndCluster=0xffff;
  73   2              }
  74   1              else
  75   1              {
  76   2                      tdw_TheEndCluster=0x0fffffff; 
  77   2              }
  78   1              while(tdw_S_ClusterNum<tdw_TheEndCluster)
  79   1              { //find in one dir
  80   2                      if((gc_CurrentCard==2) && (SD_Detect==1))  //chiayen0919 add
  81   2                      {
  82   3                              return 1;
  83   3                      }
  84   2      
  85   2                      if((gc_CurrentCard==5)&&(gb_HostConnect==0))
  86   2                      {                       
  87   3                              return 1;               
  88   3                      }
  89   2      
  90   2                      if (!tdw_S_ClusterNum)                //Is rootdir
  91   2                      {
  92   3                              tdw_Find_ClusterSize=(gdw_DOS_DataAddr - gdw_DOS_RootDirAddr);
  93   3                              tdw_SectorAdd=gdw_DOS_RootDirAddr;              
  94   3                      }
  95   2                      else
  96   2                      {
  97   3                              tdw_Find_ClusterSize=gc_DOS_SectorPerCluster;
  98   3                              tdw_SectorAdd=DOS_ClusterLogicAddr(tdw_S_ClusterNum);
  99   3                      }
 100   2                      if(tdw_S_ClusterNum!=p_mp->dw_FDB_Cluster)
 101   2                      {
 102   3                              tc_SectorOffset=0;                       // when one cluster is(tw_FdbOffset)finished,fdboffset should 
             -be 0
 103   3                      }
 104   2      
 105   2                      for(tc_SectorOffset=tc_Temp_SectorOffset;tc_SectorOffset<tdw_Find_ClusterSize*gc_HostSectorUnit;tc_Secto
             -rOffset++)
 106   2                      {//find in one cluster  
 107   3                              gb_ReadWriteDataArea=1;
 108   3                              tc_Read_fail = DOS_Read_LogicSector((tdw_SectorAdd+tc_SectorOffset),1);                                                                                                 
 109   3                              
 110   3                              if(tc_Read_fail)//lzp modify
 111   3                              {//read sector error(1 is fail)
 112   4                                      break;
 113   4                              }
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 3   

 114   3                              if(tc_SectorOffset!=tc_Temp_SectorOffset)//when one Sector is(tw_FdbOffset)finished,fdboffset should be
             - 0
 115   3                              {
 116   4                                      tw_Temp_FdbOffset=0;
 117   4                              }
 118   3                              for(tw_FdbOffset=tw_Temp_FdbOffset;tw_FdbOffset<K_DOS_SectorSize;tw_FdbOffset+=32)
 119   3                              {//Find in one sector                   
 120   4                                      tc_PlayMode=0;                          
 121   4                                      tc_RecFlag=1;
 122   4                                      tw_DirIndex++;
 123   4                                      if(gc_UserDataBuf[tw_FdbOffset]==0xE5)
 124   4                                      {
 125   5                                              if(p_mp->c_Search_Mode==K_FIND_FREE_FDB)
 126   5                                              {
 127   6                                                      tc_sts=SUCCESS;
 128   6                                              }                               
 129   5                                      }
 130   4                                      else if(gc_UserDataBuf[tw_FdbOffset]==0x00)
 131   4                                      {                               
 132   5                                              if((p_mp->c_Search_Mode==K_FIND_FREE_FDB) || (p_mp->c_Search_Mode==K_FIND_LAST_FDB))//lzp add for cre
             -ate long name 05/02/19  
 133   5                                              {
 134   6                                                      tc_sts=SUCCESS;
 135   6                                              }
 136   5                                              else
 137   5                                              {                                       
 138   6                                                      tc_sts=FAIL;        //The dir is end flag
 139   6                                              }                       
 140   5                                      }
 141   4                                      else if(gc_UserDataBuf[tw_FdbOffset+0x0b]==0x0f)         //is longfdb
 142   4                                      {
 143   5                                              if(p_mp->c_Search_Mode==K_SPECIFIC_LONG_FILENAME)            //find by long filename
 144   5                                              {
 145   6                                                      if(gc_UserDataBuf[tw_FdbOffset]&0x40)                          //IS it the last longfdb?
 146   6                                                      {                                               
 147   7                                                              if(gc_UserDataBuf[tw_FdbOffset]==p_mp->pc_LongFileName[0])
 148   7                                                              {                                       
 149   8                                                                      if (*(p_mp->pc_LongFileName+1) != 0)
 150   8                                                                      {
 151   9                                                                              if((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[*(p_mp->pc_LongFileName+1)-1]]==0x00) && (gc_UserD
             -ataBuf[tw_FdbOffset+Unicode_Offset[*(p_mp->pc_LongFileName+1)-2]]==0x00))
 152   9                                                                              {
 153  10                                                                                      goto MatchEXTName;
 154  10                                                                              }
 155   9                                                                      }
 156   8                                                                      else
 157   8                                                                      {//character NUM is equal
 158   9      MatchEXTName:
 159   9                                                                              ((U8 *)(&tw_FileLongName))[0] = *(p_mp->pc_LongFileName+3);
 160   9                                                                              ((U8 *)(&tw_FileLongName))[1] = *(p_mp->pc_LongFileName+4);
 161   9                                                                              tw_FileLongName+=5;
 162   9                                                                      
 163   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<(26-(*(p_mp->pc_LongFileName+1)));tw_ByteOffset++)
 164   9                                                                              {//compare the last longfdb
 165  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]]!=p_mp
             -->pc_LongFileName[tw_FileLongName-tw_ByteOffset-1])  //last longfdb is not equal
 166  10                                                                                      {
 167  11                                                                                              if ((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]] >=
             - 'a') && (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]] <= 'z'))
 168  11                                                                                              {//if current char is lower letter,try to compare after converting to upper letter
 169  12                                                                                                      if (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[(*(p_mp->pc_LongFileName+1))+tw_ByteOffset]]!=(
             -p_mp->pc_LongFileName[tw_FileLongName-tw_ByteOffset-1] + 0x20))
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 4   

 170  12                                                                                                      {
 171  13                                                                                                              break;
 172  13                                                                                                      }
 173  12                                                                                              }
 174  11                                                                                              else
 175  11                                                                                              {
 176  12                                                                                                      break;
 177  12                                                                                              }                                                                               
 178  11                                                                                      }
 179  10                                                                              }
 180   9                                                                              if (tw_ByteOffset==26-*(p_mp->pc_LongFileName+1))    //the last longfdb is equal
 181   9                                                                              {
 182  10                                                                                      if((gc_UserDataBuf[tw_FdbOffset]&0x3f)==1)        //current longfdb is the first 
 183  10                                                                                      {
 184  11                                                                                              tc_sts=SUCCESS;
 185  11                                                                                      }
 186  10                                                                                      else
 187  10                                                                                      {
 188  11                                                                                              tw_FileLongName-=tw_ByteOffset;
 189  11                                                                                      }
 190  10                                                                              }
 191   9                                                                      }
 192   8                                                              }
 193   7                                                      }
 194   6                                                      else
 195   6                                                      {//not the      "last" longfdb
 196   7                                                              for(tw_ByteOffset=0;tw_ByteOffset<26;tw_ByteOffset++)
 197   7                                                              {//compare the longfdb which is not the last
 198   8                                                                      if(gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]]!=p_mp->pc_LongFileName[tw_FileLongNa
             -me-tw_ByteOffset-1])
 199   8                                                                      {
 200   9                                                                              if ((gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]] >= 'a') && (gc_UserDataBuf[tw_Fdb
             -Offset+Unicode_Offset[tw_ByteOffset]] <= 'z'))
 201   9                                                                              {//if current char is lower letter,try to compare after converting to upper letter
 202  10                                                                                      if (gc_UserDataBuf[tw_FdbOffset+Unicode_Offset[tw_ByteOffset]]!=(p_mp->pc_LongFileName[tw_FileLo
             -ngName-tw_ByteOffset-1] + 0x20))
 203  10                                                                                      {
 204  11                                                                                              break;
 205  11                                                                                      }
 206  10                                                                              }
 207   9                                                                              else
 208   9                                                                              {
 209  10                                                                                      break;
 210  10                                                                              }               
 211   9                                                                      }
 212   8                                                              }
 213   7                                                              if(tw_ByteOffset==26) //equal                   
 214   7                                                              {
 215   8                                                                      tw_FileLongName-=tw_ByteOffset;                    //the length of gc_FileLongName[] minus 26
 216   8                                                                      if((gc_UserDataBuf[tw_FdbOffset]&0x3f)==1)
 217   8                                                                      {//current longfdb is the first                                                                 
 218   9                                                                              tc_sts=SUCCESS;
 219   9                                                                      }                                               
 220   8                                                              }
 221   7                                                      }
 222   6                                              }
 223   5                                      }
 224   4                                      else
 225   4                                      {//short_fdb
 226   5                                              tw_FileLongName = *(p_mp->pc_LongFileName+4);                                                           
 227   5                                              if(gc_UserDataBuf[tw_FdbOffset+0x0b] & 0x10) //2005/05/17 modify
 228   5                                              {//is dir
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 5   

 229   6                                                      if(p_mp->c_Search_Attribute)
 230   6                                                      {//find dir
 231   7                                                              if(gc_UserDataBuf[tw_FdbOffset]!=0x2e)
 232   7                                                              {
 233   8                                                                      if (((p_mp->c_Search_Mode == K_FIND_DIR_EXTNAME) || (p_mp->c_Search_Mode == K_SPECIFIC_SHORT_FILEN
             -AME)))
 234   8                                                                      {
 235   9                                                                              goto EXTNAMECOMPARE;
 236   9                                                                      }
 237   8                                                                      else
 238   8                                                                      {
 239   9                                                                              tb_flag=1;                        //the flag which determine if implement the flowing program
 240   9                                                                      }
 241   8                                                              }                                               
 242   7                                                      }                                       
 243   6                                                      else if(gb_CountDirFlag && (p_mp->c_Search_Mode != K_SPECIFIC_STARTCLUSTER)) //Ching 100514
 244   6                                                      {
 245   7                                                              if(gc_UserDataBuf[tw_FdbOffset]!=0x2e) //. & ..
 246   7                                                                      gw_DirTotalNumber++; 
 247   7                                                      }
 248   6                                              }
 249   5                                              else if(!(p_mp->c_Search_Attribute))
 250   5                                              {//not to find dir
 251   6                                                      if((gc_UserDataBuf[tw_FdbOffset+0x0b]&0x08)!=0x08)//2005/05/17 modify
 252   6                                                      {
 253   7      EXTNAMECOMPARE:
 254   7                                                              if(p_mp->c_EXTSelect==1)
 255   7                                                              {//need compare EXTName                                         
 256   8                                                                      for(tc_ExtNum=0;tc_ExtNum<EXT_Name[p_mp->c_type][0];tc_ExtNum++)
 257   8                                                                      {//compare the ext_name
 258   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<3;tw_ByteOffset++)
 259   9                                                                              {//the max length of ext_name is 3 now                                                                  
 260  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+0x08+tw_ByteOffset]!=EXT_Name[p_mp->c_type][tw_ByteOffset+tc_Play
             -Mode*3+1])
 261  10                                                                                      {
 262  11                                                                                              tc_PlayMode++;
 263  11                                                                                              break;
 264  11                                                                                      }
 265  10                                                                              }
 266   9                                                                              if(tw_ByteOffset>=3)
 267   9                                                                              {//Extension name is equal
 268  10                                                                                      tb_flag=1;
 269  10                                                                                      tw_FileLongName-=3;
 270  10                                                                                      if(p_mp->c_type==1)
 271  10                                                                                      {
 272  11                                                                                              tc_PlayMode+=EXT_Name[0][0];
 273  11                                                                                      }
 274  10                                                                                      break;
 275  10                                                                              }
 276   9                                                                      }
 277   8                                                              }
 278   7                                                              else if(p_mp->c_EXTSelect==0) 
 279   7                                                              {//no need compare EXTName
 280   8                                                                      tb_flag=1;                           //the flag determines if implement the flowing programe
 281   8                                                                      tw_FileLongName-=3;
 282   8                                                              }                               
 283   7                                                                                                                      
 284   7                                                              if((tb_flag==1)&&(p_mp->c_type==1))                                                     
 285   7                                                              {//voice file
 286   8                                                                      for(tw_ByteOffset=0;tw_ByteOffset<4;tw_ByteOffset++)
 287   8                                                                      {//the max length of ext_name is 3 now                                                                  
 288   9                                                                              if(gc_UserDataBuf[tw_FdbOffset+tw_ByteOffset]!=REC[tw_ByteOffset])
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 6   

 289   9                                                                              {
 290  10                                                                                      tb_flag=0;
 291  10                                                                                      break;
 292  10                                                                              }
 293   9                                                                      }
 294   8                                                              }
 295   7                                                      }
 296   6                                              }//not and not find dir
 297   5                                              if(tb_flag)
 298   5                                              {
 299   6                                                      tb_flag=0;      
 300   6                                                      if(p_mp->c_type==1)
 301   6                                                      {
 302   7                                                              for(tw_ByteOffset=0;tw_ByteOffset<0x04;tw_ByteOffset++)
 303   7                                                              {
 304   8                                                                      if((gc_UserDataBuf [tw_FdbOffset+0x04+tw_ByteOffset]<0x30)||(gc_UserDataBuf [tw_FdbOffset+0x04+tw_
             -ByteOffset]>0x39))
 305   8                                                                      {
 306   9                                                                              tc_RecFlag = 0;
 307   9                                                                      }               
 308   8                                                                      tdw_Temp_flag =tdw_Temp_flag<<8;                        
 309   8                                                                      tdw_Temp_flag |= gc_UserDataBuf [tw_FdbOffset+0x04+tw_ByteOffset];  //sorts the name of current fd
             -b
 310   8                                                              }
 311   7                                                      }               
 312   6                      
 313   6                                                      if(p_mp->c_Search_Mode==K_COUNTER_FILENUM)
 314   6                                                      {                                                                                                                                               
 315   7                                                              if(tc_RecFlag)                                                                                          
 316   7                                                              p_mp->w_FileTotalNum++;
 317   7                                                      }
 318   6                                                      else if((p_mp->c_Search_Mode==K_TIME_FINDFDB)||p_mp->c_Search_Mode==K_NAME_FINDFDB)               //find by cre
             -ate time
 319   6                                                      {                               
 320   7                                                              ((U8 *)(&tdw_StartCluster1))[0]=gc_UserDataBuf[tw_FdbOffset+0x15];
 321   7                                                              ((U8 *)(&tdw_StartCluster1))[1]=gc_UserDataBuf[tw_FdbOffset+0x14];
 322   7                                                              ((U8 *)(&tdw_StartCluster1))[2]=gc_UserDataBuf[tw_FdbOffset+0x1b];
 323   7                                                              ((U8 *)(&tdw_StartCluster1))[3]=gc_UserDataBuf[tw_FdbOffset+0x1a];
 324   7                                                      
 325   7                                                              if(tc_RecFlag)
 326   7                                                              {                       
 327   8                                                                      if(p_mp->c_Search_Direction)  
 328   8                                                                      {//find pre                                             
 329   9                                                                              if((tdw_Tag0<=tdw_Temp_flag)&&(tdw_Temp_flag<tdw_Tag1))
 330   9                                                                              {                                       
 331  10                                                                                      tdw_Tag0= tdw_Temp_flag;
 332  10                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 333  10                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 334  10                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 335  10                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 336  10                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 337  10                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 338  10                                                                                      tb_SortFlag=1;  
 339  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                             
 340  10                                                                              }                                                       
 341   9                                                                              else if(tdw_Temp_flag==tdw_Tag1)
 342   9                                                                              {                                                               
 343  10                                                                                      if(tdw_StartCluster1!=p_mp->dw_File_StartCluster)
 344  10                                                                                      {//startcluster is not equal
 345  11                                                                                              if(!tb_SameFlag)
 346  11                                                                                              {//current fdb is  before pre fdb which we stored                                                                               
 347  12                                                                                                      tdw_Tag0= tdw_Temp_flag;
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 7   

 348  12                                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 349  12                                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 350  12                                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 351  12                                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 352  12                                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 353  12                                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 354  12                                                                                                      tb_SortFlag=1;
 355  12                                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                                                                                                                                     
 356  12                                                                                              }                                                                       
 357  11                                                                                      }
 358  10                                                                                      else
 359  10                                                                                      {
 360  11                                                                                              tb_SameFlag=1;  
 361  11                                                                                      }                                                               
 362  10                                                                              }                                                                                                               
 363   9                                                                      }
 364   8                                                                      else
 365   8                                                                      {//find next
 366   9                                                                              if((tdw_Tag1<tdw_Temp_flag)&&(tdw_Temp_flag<tdw_Tag0))
 367   9                                                                              {                                                                                                                               
 368  10                                                                                      tdw_Tag0= tdw_Temp_flag;
 369  10                                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 370  10                                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 371  10                                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 372  10                                                                                      tdw_StartCluster3=tdw_StartCluster1;
 373  10                                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 374  10                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;                                                                       
 375  10                                                                                      tb_SortFlag=1;  
 376  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                             
 377  10                                                                              }
 378   9                                                                              if(tdw_Temp_flag!=tdw_Tag0)
 379   9                                                                              {
 380  10                                                                                      if(tdw_Temp_flag==tdw_Tag1)     
 381  10                                                                                      {                                                       
 382  11                                                                                              if(tdw_StartCluster1!=p_mp->dw_File_StartCluster)
 383  11                                                                                              {//startcluster is not equal
 384  12                                                                                                      if(tb_SameFlag)
 385  12                                                                                                      {//current fdb is after pre fdb which we stored                                                                                 
 386  13                                                                                                              tdw_Tag0= tdw_Temp_flag;
 387  13                                                                                                              p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 388  13                                                                                                              p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 389  13                                                                                                              p_mp->w_FDB_Offset=tw_FdbOffset;
 390  13                                                                                                              tdw_StartCluster3=tdw_StartCluster1;
 391  13                                                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 392  13                                                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;                                                                                               
 393  13                                                                                                              tb_SortFlag=1;
 394  13                                                                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                                                             
 395  13                                                                                                      }
 396  12                                                                                              }
 397  11                                                                                              else
 398  11                                                                                              {
 399  12                                                                                                      tb_SameFlag=1;  
 400  12                                                                                              }               
 401  11                                                                                      }
 402  10                                                                              }                                                               
 403   9                                                                      }
 404   8                                                              }
 405   7                                                      }                                                       
 406   6                                                      else if(p_mp->c_Search_Mode==K_ORDER_FINDFDB || p_mp->c_Search_Mode == K_FIND_DIR_EXTNAME) //find by
             -        order
 407   6                                                      {                                                       
 408   7                                                              if(p_mp->c_Search_Direction) 
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 8   

 409   7                                                              {//previous
 410   8                                                                      if(tw_DirIndex<gw_DirIndex[p_mp->c_Search_Attribute])
 411   8                                                                      {
 412   9                                                                              tw_DirIndex1=tw_DirIndex;
 413   9                                                                              p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 414   9                                                                              p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 415   9                                                                              p_mp->w_FDB_Offset=tw_FdbOffset;                                                                        
 416   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 417   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 418   9                                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;     
 419   9                                                                              tb_SortFlag=1;
 420   9                                                                      }
 421   8                                                                      else//(JC)
 422   8                                                                      {
 423   9                                                                              tc_sts=FAIL;                                    
 424   9                                                                      }
 425   8                                                              }
 426   7                                                              else
 427   7                                                              { //next                                                                                                 
 428   8                                                                      if(tw_DirIndex>(gw_DirIndex[p_mp->c_Search_Attribute]))
 429   8                                                                      {
 430   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;
 431   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;
 432   9                                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex;
 433   9                                                                              tc_sts=SUCCESS;                                                                                                                                                                                                         
 434   9                                                                              gb_FindFile=1;  //Ching 080805                                                                                                                                                                                          
 435   9                                                                      }                       
 436   8                                                              }
 437   7                                                      }
 438   6                                                      else if(p_mp->c_Search_Mode==K_SPECIFIC_STARTCLUSTER)   //find by StartCluster
 439   6                                                      {                                               
 440   7                                                              ((U8 *)(&tdw_StartCluster))[0]=gc_UserDataBuf[tw_FdbOffset+0x15];
 441   7                                                              ((U8 *)(&tdw_StartCluster))[1]=gc_UserDataBuf[tw_FdbOffset+0x14];
 442   7                                                              ((U8 *)(&tdw_StartCluster))[2]=gc_UserDataBuf[tw_FdbOffset+0x1b];
 443   7                                                              ((U8 *)(&tdw_StartCluster))[3]=gc_UserDataBuf[tw_FdbOffset+0x1a];
 444   7                                                              if(p_mp->c_Search_Direction)
 445   7                                                              {
 446   8                                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 447   8                                                                      p_mp->dw_FDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 448   8                                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 449   8                                                                      
 450   8                                                                      if(tdw_StartCluster==p_mp->Compare.dw_StartCluster)
 451   8                                                                      {
 452   9                                                                              if(tb_not_1stFDB)
 453   9                                                                              {
 454  10                                                                                      p_mp->dw_FDB_Cluster=tdw_PrevFDB_Cluster;
 455  10                                                                                      p_mp->dw_FDB_LogAdd=tdw_PrevFDB_LogAdd;
 456  10                                                                                      p_mp->w_FDB_Offset=tw_PrevFDB_Offset;
 457  10                                                                                      tb_not_1stFDB=0;                
 458  10                                                                              }
 459   9                                                                              return (SUCCESS);
 460   9                                                                      }
 461   8                                                                      else
 462   8                                                                      {
 463   9                                                                              tb_not_1stFDB=1;
 464   9                                                                              if(p_mp->c_Search_Direction && p_mp->c_Search_Attribute) 
 465   9                                                                              {
 466  10                                                                                      tdw_PrevFDB_Cluster=tdw_S_ClusterNum;
 467  10                                                                                      tdw_PrevFDB_LogAdd=tc_SectorOffset+tdw_SectorAdd;
 468  10                                                                                      tw_PrevFDB_Offset=tw_FdbOffset;                                                                         
 469  10                                                                              }       
 470   9                                                                      }
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 9   

 471   8                                                              }
 472   7                                                              else
 473   7                                                              {
 474   8                                                                      if(tdw_StartCluster==p_mp->Compare.dw_StartCluster)
 475   8                                                                      {
 476   9                                                                              tc_sts=SUCCESS;
 477   9                                                                      }
 478   8                                                              }                                                       
 479   7                                                      }
 480   6                                                      else if(p_mp->c_Search_Mode==K_SPECIFIC_SHORT_FILENAME)
 481   6                                                      {//find by short file name
 482   7                                                              tw_FileLongName--;      
 483   7                                                              for(tw_ByteOffset=0; tw_ByteOffset<tw_FileLongName;tw_ByteOffset++)
 484   7                                                              {//Compare shortfdb                                                                                             
 485   8                                                                      if(gc_UserDataBuf[tw_FdbOffset+tw_ByteOffset]!=p_mp->pc_LongFileName[5+tw_ByteOffset])
 486   8                                                                      {
 487   9                                                                              break;
 488   9                                                                      }
 489   8                                                              }//compare shortfdb                                                             
 490   7                                                              if(tw_ByteOffset==tw_FileLongName)
 491   7                                                              {//short file name is equal                                             
 492   8                                                                      //debug: ex. search 01.txt, but find 012.txt (012's FDB in front of 01's FDB), Ching 100224
 493   8                                                                      U8 tc_DiffFlag=0;
 494   8                                                                      if(tw_FileLongName<8)
 495   8                                                                      {
 496   9                                                                              if(gc_UserDataBuf[tw_FdbOffset+tw_FileLongName] != 0x20)
 497   9                                                                                      tc_DiffFlag = 1;
 498   9                                                                      }
 499   8      
 500   8                                                                      if(!tc_DiffFlag)
 501   8                                                                      {
 502   9                                                                              p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;//add for DRM
 503   9                                                                              p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;//add for DRM
 504   9                                                                              if(p_mp->c_EXTSelect==1)//hao.yang 090314
 505   9                                                                              {
 506  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;
 507  10                                                                              }
 508   9                                                                              tc_sts=SUCCESS;
 509   9                                                                      }
 510   8                                                              }                                               
 511   7                                                      }                                       
 512   6                                              }
 513   5                                      }//short_fdb            
 514   4                                      if(!tc_sts) //Get what we want to get
 515   4                                      {
 516   5                                              if((gb_TriggerFileSkip==0) || (tw_FileSkipNumber==0))   //Ching 080805
 517   5                                              {
 518   6      NextFIND:   //Ching 080805
 519   6                                                      if(p_mp->c_Search_Attribute)
 520   6                                                      {
 521   7                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex;
 522   7                                                      }
 523   6              
 524   6                                                      if (p_mp->c_Search_Mode < K_SPECIFIC_LONG_FILENAME)
 525   6                                                      {
 526   7                                                              gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;                                                     
 527   7                                                      }
 528   6                                                      else if (p_mp->c_Search_Mode == K_SPECIFIC_LONG_FILENAME)
 529   6                                                      {
 530   7                                                              tw_FdbOffset+=32;
 531   7                                                              if (tw_FdbOffset == 0x200)
 532   7                                                              {
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 10  

 533   8                                                                      tw_FdbOffset = 0;
 534   8                                                                      p_mp->dw_LongFDB_LogAdd1 = tdw_FDB_LogAdd0;//add for DRM        
 535   8                                                                      p_mp->dw_LongFDB_LogAdd0 = tc_SectorOffset+tdw_SectorAdd;//add for DRM  
 536   8                                                                      tc_SectorOffset ++;
 537   8                                                                      if (tc_SectorOffset == gc_DOS_SectorPerCluster)
 538   8                                                                      {
 539   9                                                                              tdw_S_ClusterNum = DOS_GetNextCluster(tdw_S_ClusterNum,1);
 540   9                                                                              tdw_SectorAdd=DOS_ClusterLogicAddr(tdw_S_ClusterNum);
 541   9                                                                              tc_SectorOffset = 0;
 542   9                                                                      }
 543   8                                                                      DOS_Read_LogicSector((tdw_SectorAdd+tc_SectorOffset),1);//tangwei add 090314 for RTC
 544   8                                                              }
 545   7                                                              else
 546   7                                                              {
 547   8                                                                      p_mp->dw_LongFDB_LogAdd1=tdw_FDB_LogAdd1;//add for DRM
 548   8                                                                      p_mp->dw_LongFDB_LogAdd0=tdw_FDB_LogAdd0;//add for DRM
 549   8                                                              }
 550   7                                                              //================================tangwei add for RTC 090314 start=================
 551   7                                                              if(p_mp->c_EXTSelect==1)
 552   7                                                              {//need compare EXTName                                         
 553   8                                                                      for(tc_ExtNum=0;tc_ExtNum<EXT_Name[p_mp->c_type][0];tc_ExtNum++)
 554   8                                                                      {//compare the ext_name
 555   9                                                                              for(tw_ByteOffset=0;tw_ByteOffset<3;tw_ByteOffset++)
 556   9                                                                              {//the max length of ext_name is 3 now                                                                  
 557  10                                                                                      if(gc_UserDataBuf[tw_FdbOffset+0x08+tw_ByteOffset]!=EXT_Name[p_mp->c_type][tw_ByteOffset+tc_Play
             -Mode*3+1])
 558  10                                                                                      {
 559  11                                                                                              tc_PlayMode++;
 560  11                                                                                              break;
 561  11                                                                                      }
 562  10                                                                              }
 563   9                                                                              if(tw_ByteOffset>=3)
 564   9                                                                              {//Extension name is equal
 565  10                                                                                      if(p_mp->c_type==1)
 566  10                                                                                      {
 567  11                                                                                              tc_PlayMode+=EXT_Name[0][0];
 568  11                                                                                      }
 569  10                                                                                      gs_File_FCB[p_mp->c_type].c_FileType = tc_PlayMode;
 570  10                                                                                      break;
 571  10                                                                              }
 572   9                                                                      }
 573   8                                                              }
 574   7                                                              //==================================tangwei add for RTC 090314 end===================
 575   7                                                      }
 576   6              
 577   6                                                      p_mp->dw_FDB_Cluster=tdw_S_ClusterNum;
 578   6                                                      p_mp->dw_FDB_LogAdd=tdw_SectorAdd+tc_SectorOffset;
 579   6                                                      p_mp->w_FDB_Offset=tw_FdbOffset;
 580   6                                                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;
 581   6                                                      return(SUCCESS);
 582   6                                              }
 583   5                                              else    //Ching 080805
 584   5                                              {
 585   6                                                      if(gb_FindFile==1)
 586   6                                                      {
 587   7                                                              gb_FindFile=0;
 588   7                                                              gw_FileSkipNumber--;
 589   7                                                              if(gw_FileSkipNumber==0)
 590   7                                                              {
 591   8                                                                      goto NextFIND;
 592   8                                                              }
 593   7                                                      }
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 11  

 594   6                                              }               // end of else Ching 080805
 595   5                                      }
 596   4                                      else
 597   4                                      {//not get what we want directly
 598   5                                              if(tc_sts==FAIL)
 599   5                                              {//the  fdb is end or the mode oversteps  
 600   6                                                      if(tb_SortFlag)
 601   6                                                      {//sort success 
 602   7                                                              tb_SortFlag=0;  
 603   7                                                              tb_SameFlag=0;
 604   7                                                              p_mp->dw_File_StartCluster=tdw_StartCluster3;          //save startcluster of current fdb
 605   7                                                              p_mp->Compare.dw_BubbleFlag=tdw_Tag0;
 606   7                                                              p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;
 607   7                                                              gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex1;
 608   7                                                              return(SUCCESS);
 609   7                                                      }
 610   6                                                      else
 611   6                                                      {
 612   7                                                              p_mp->dw_FDB_Cluster = tdw_S_ClusterNum;
 613   7                                                              p_mp->dw_FDB_LogAdd = tdw_SectorAdd+tc_SectorOffset;
 614   7                                                              p_mp->w_FDB_Offset = tw_FdbOffset;
 615   7                                                              p_mp->dw_FDB_StartCluster = tdw_FDBClusterNum;
 616   7                                                              return(FAIL);                   
 617   7                                                      }
 618   6                                              }                                       
 619   5                                      }//not  get what we want directly                       
 620   4                              
 621   4                              }//for(tw_FdbOffset=tw_Temp_FdbOffset;tw_FdbOffset<K_DOS_SectorSize;tw_FdbOffset+=32)---->find in one s
             -ector
 622   3                              tdw_FDB_LogAdd1=tdw_FDB_LogAdd0;
 623   3                              tdw_FDB_LogAdd0=tdw_SectorAdd+tc_SectorOffset;                                          
 624   3                      }//for(tc_SectorOffset=tc_Temp_SectorOffset;tc_SectorOffset<tdw_Find_ClusterSize;tc_SectorOffset++)--->f
             -ind in one cluster
 625   2                      tdw_S_ClusterNum=DOS_GetNextCluster(tdw_S_ClusterNum,1);                
 626   2              }//while(tdw_S_ClusterNum<0xffff)------>find in one dir
 627   1              if(tb_SortFlag)
 628   1              {//sort success                                                                                         
 629   2                      tb_SortFlag=0;  
 630   2                      tb_SameFlag=0;
 631   2                      p_mp->dw_File_StartCluster=tdw_StartCluster3;          //save startcluster of current fdb
 632   2                      p_mp->Compare.dw_BubbleFlag=tdw_Tag0;                                           
 633   2                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;                                            
 634   2                      gw_DirIndex[p_mp->c_Search_Attribute] = tw_DirIndex1;                                   
 635   2                      return(SUCCESS); 
 636   2              }
 637   1              else
 638   1              {               
 639   2                      p_mp->dw_FDB_Cluster = tdw_S_ClusterNum;
 640   2                      p_mp->dw_FDB_LogAdd = tdw_SectorAdd+tc_SectorOffset;
 641   2                      p_mp->w_FDB_Offset = tw_FdbOffset;
 642   2                      p_mp->dw_FDB_StartCluster=tdw_FDBClusterNum;    
 643   2                      return(FAIL);                   
 644   2              }
 645   1      }
 646          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3240    ----
   CONSTANT SIZE    =     33    ----
   XDATA SIZE       =     10      85
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.00   DOSFDB                                                                07/10/2012 15:51:51 PAGE 12  

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       5
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
