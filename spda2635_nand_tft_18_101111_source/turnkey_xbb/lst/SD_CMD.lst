C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SD_CMD
OBJECT MODULE PLACED IN .\obj\SD_CMD.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\libsource\SD\SD_CMD.C LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\li
                    -bsource\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\SD_CMD.lst) OBJECT(.\obj\SD_CMD.obj)

line level    source

   1          #include "SPDA2K.h"
   2          extern xdata U8  gc_RespBuff[17];
   3           
   4          
   5          void SD_Read_LBA_Dos(U32 Read_LBA ,U8 Buf_Index)
   6          {
   7   1              U16 tw_SD_CountDown;
   8   1              
   9   1              LBA.LW = Read_LBA;      
  10   1              XBYTE[0xB400]=0x06;
  11   1              
  12   1              XBYTE[0xB45B]=0x51;     // CMD17
  13   1              if(gbt_SDHC_Type==1)
  14   1              {                                                                                 
  15   2                      XBYTE[0xB45C]=LBA.BY[0];                                                        
  16   2                      XBYTE[0xB45D]=LBA.BY[1];        // relative address 1                             
  17   2                      XBYTE[0xB45E]=LBA.BY[2];        // 512Bytes/Block                          
  18   2                      XBYTE[0xB45F]=LBA.BY[3];        // Sectors Address                
  19   2              }                                                                                                   
  20   1              else
  21   1              {                                                                                               
  22   2                      XBYTE[0xB45C]=(LBA.BY[1]<<1)+(LBA.BY[2]>>7);
  23   2                      XBYTE[0xB45D]=(U8)(LBA.WD[1]>>7);       // relative address 1                
  24   2                      XBYTE[0xB45E]=(LBA.BY[3]<<1);           // 512Bytes/Block                     
  25   2                      XBYTE[0xB45F]=0x00;                                     // Sectors Address                    
  26   2              }                                                                                                   
  27   1      
  28   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;
  29   1              while(1)
  30   1              {
  31   2              SD_Send_DummyCLK(8);
  32   2                      if((XBYTE[0xB453]&0x20)==0x20)
  33   2                      {
  34   3                              break;
  35   3                      }
  36   2      
  37   2              if((--tw_SD_CountDown==0)||(SD_Detect)) 
  38   2                      {
  39   3                              goto RET;
  40   3                      }
  41   2              }
  42   1      
  43   1          SD_TrigCMD_Receive_Respond();  
  44   1              XBYTE[0xB455]=0x00;
  45   1              XBYTE[0xB456]|=0x02;
  46   1              Device_Xfer_DataLength.WD=0x01FF;                                                                 
  47   1              Device_Read_SRAM_Index.BY[0]=Buf_Index;                              
  48   1              Device_Read_SRAM_Index.BY[1]=0x00; 
  49   1              SET_DEVICE_READ();                                                    
  50   1              Trigger_Data_Transfer();                                                        
  51   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;    
  52   1              while((!(XBYTE[0xB3C0]&0x01))||(XBYTE[0xB454]&0x0F))
  53   1              {
  54   2                      //Wait Data transfer done
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 2   

  55   2                      if((--tw_SD_CountDown==0)||(SD_Detect))
  56   2                      {
  57   3                              goto RET;
  58   3                      }
  59   2              }
  60   1                                                                                                                          
  61   1              XBYTE[0xB3C0]=0x00;
  62   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;
  63   1              while(1)        // Wait Ready
  64   1              {
  65   2                      SD_Send_DummyCLK(8);
  66   2                      if((XBYTE[0xB453]&0x20)==0x20)
  67   2                      {
  68   3                              break;
  69   3                      }
  70   2      
  71   2                      if((--tw_SD_CountDown==0)||(SD_Detect))
  72   2                      {
  73   3                              goto RET;
  74   3                      }
  75   2              }
  76   1              XBYTE[0xB400] = 0x01;
  77   1              return;
  78   1      RET:
  79   1              XBYTE[0xB400] = 0x01;
  80   1              USER_DelayDTms(150);
  81   1      }
  82          
  83          
  84          void SD_Write_LBA_Dos(U32 Write_LBA,U8 Buf_Index,U8 Write_Stage)
  85          {
  86   1              xdata   U16     tw_SD_CountDown;                                                                              
  87   1              data    bit tbt_No_SD_Stop_CMD=0;    
  88   1              data    bit     tbt_SD_Start_Stage=0;   
  89   1              data    bit     tbt_SD_Data_Stage=0;
  90   1              data    bit tbt_SD_Stop_Stage=0;                                                     
  91   1      
  92   1              LBA.LW =Write_LBA;
  93   1              switch(Write_Stage)
  94   1              {
  95   2                      case 0: // CMD+Data
  96   2                              tbt_SD_Start_Stage      = 1;
  97   2                              tbt_SD_Data_Stage       = 1;
  98   2      //                      tbt_SD_Stop_Stage       = 0;
  99   2                      break;
 100   2                      
 101   2                      case 1: // only data
 102   2      //                      tbt_SD_Start_Stage      = 0;
 103   2                              tbt_SD_Data_Stage       = 1;
 104   2      //                      tbt_SD_Stop_Stage       = 0;    
 105   2                      break;
 106   2      
 107   2                      case 2: //data + Stop CMD
 108   2      //                      tbt_SD_Start_Stage      = 0;
 109   2                              tbt_SD_Data_Stage       = 1;
 110   2                              tbt_SD_Stop_Stage       = 1;    
 111   2                      break;
 112   2      
 113   2                      case 3:// only 1 sector
 114   2                              tbt_SD_Start_Stage      = 1;
 115   2                              tbt_SD_Data_Stage       = 1;
 116   2      //                      tbt_SD_Stop_Stage       = 0;
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 3   

 117   2                              tbt_No_SD_Stop_CMD      = 1;
 118   2                      break;
 119   2      
 120   2                      default:  //only  Stop cmd
 121   2      //                      tbt_SD_Start_Stage      = 0;
 122   2      //                      tbt_SD_Data_Stage       = 0;
 123   2                              tbt_SD_Stop_Stage       = 1;
 124   2                      break;
 125   2              }       
 126   1      
 127   1              XBYTE[0xB400]=0x06;
 128   1              if(tbt_SD_Start_Stage==1)
 129   1              {
 130   2                      if(tbt_No_SD_Stop_CMD==1)
 131   2                      {
 132   3                              XBYTE[0xB45B]=0x58;     // CMD24
 133   3                      }
 134   2                      else
 135   2                      {
 136   3                              XBYTE[0xB45B]=0x59;     // CMD25
 137   3                      }
 138   2      
 139   2                      if(gbt_SDHC_Type==1)
 140   2                      {                                                                                 
 141   3                              XBYTE[0xB45C]=LBA.BY[0];                                                        
 142   3                              XBYTE[0xB45D]=LBA.BY[1];        // relative address 1                             
 143   3                              XBYTE[0xB45E]=LBA.BY[2];        // 512Bytes/Block                          
 144   3                              XBYTE[0xB45F]=LBA.BY[3];        // Sectors Address                
 145   3                      }                                                                                                   
 146   2                      else
 147   2                      {                                                                                               
 148   3                              XBYTE[0xB45C]=(LBA.BY[1]<<1)+(LBA.BY[2]>>7);
 149   3                              XBYTE[0xB45D]=(U8)(LBA.WD[1]>>7);       // relative address 1                
 150   3                              XBYTE[0xB45E]=(LBA.BY[3]<<1);           // 512Bytes/Block                     
 151   3                              XBYTE[0xB45F]=0x00;                                     // Sectors Address                    
 152   3                      }                                                                                              
 153   2                      tw_SD_CountDown=65536;                                                        
 154   2                      while(!(XBYTE[0xB453]&0x20))
 155   2                      {
 156   3                              SD_Send_DummyCLK(8);
 157   3                              if((XBYTE[0xB453]&0x20)==0x20)
 158   3                              {
 159   4                                      break;
 160   4                              }
 161   3      
 162   3                              if((--tw_SD_CountDown==0)||(SD_Detect))
 163   3                              {
 164   4                                      break;
 165   4                              }
 166   3                      }
 167   2                      SD_TrigCMD_Receive_Respond();
 168   2              }
 169   1      
 170   1              if(tbt_SD_Data_Stage==1)
 171   1              {
 172   2                      XBYTE[0xB455]=0x00;
 173   2                      XBYTE[0xB456]|=0x02;
 174   2                      Device_Xfer_DataLength.WD=0x01FF;
 175   2                      Device_Write_SRAM_Index.BY[0]=Buf_Index;
 176   2                      Device_Write_SRAM_Index.BY[1]=0x00;
 177   2                      SET_DEVICE_WRITE();                                                                                 
 178   2                      Trigger_Data_Transfer();
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 4   

 179   2                      tw_SD_CountDown=SDMMCTimeOutLoop_10000;
 180   2                      while((!(XBYTE[0xB3C0]&0x01))||(XBYTE[0xB454]&0x0F))
 181   2                      {
 182   3                              if((--tw_SD_CountDown==0)||(SD_Detect))
 183   3                              {
 184   4                                      break;
 185   4                              }
 186   3                      }
 187   2                      XBYTE[0xB3C0] = 0x00;                                                                                       
 188   2                      XBYTE[0xB452] = 0x40;   
 189   2                      while(XBYTE[0xB454]&0x0F);
 190   2              }
 191   1      
 192   1              if(tbt_SD_Stop_Stage==1)
 193   1              {
 194   2              SD_Cmd12_Stop();                                                                            
 195   2                      XBYTE[0xB452]=0x40;     
 196   2                      while(XBYTE[0xB454]&0x0F);                            
 197   2                      SD_Send_DummyCLK(8);                                                                                
 198   2              }                                                                                               
 199   1              XBYTE[0xB400]=0x01;
 200   1      }
 201          
 202          
 203          void SD_ReadSectors_USB(void)
 204          {
 205   1              bit     tbt_No_SD_Stop_CMD;
 206   1              U16     tw_SD_CountDown;
 207   1                                                                                   
 208   1              gbt_OddTemp=0;
 209   1              XBYTE[0xB400]=0x06;
 210   1              XBYTE[0xB450]=0x03;
 211   1      
 212   1              if(TotalXferPageNum.WD==1)
 213   1              {
 214   2                      XBYTE[0xB45B]=0x51;     // CMD17
 215   2                      tbt_No_SD_Stop_CMD=1;
 216   2              }
 217   1              else
 218   1              {
 219   2                      XBYTE[0xB45B]=0x52;     // CMD18
 220   2                      tbt_No_SD_Stop_CMD=0;
 221   2              }
 222   1      
 223   1              if(gbt_SDHC_Type==1)
 224   1              {                                                                                 
 225   2                      XBYTE[0xB45C]=LBA.BY[0];
 226   2                      XBYTE[0xB45D]=LBA.BY[1];        // relative address 1
 227   2                      XBYTE[0xB45E]=LBA.BY[2];        // 512Bytes/Block
 228   2                      XBYTE[0xB45F]=LBA.BY[3];        // Sectors Address
 229   2              }                                                                                                   
 230   1              else
 231   1              {                                                                                               
 232   2                      XBYTE[0xB45C]=(LBA.BY[1]<<1)+(LBA.BY[2]>>7);
 233   2                      XBYTE[0xB45D]=(U8)(LBA.WD[1]>>7);       // relative address 1
 234   2                      XBYTE[0xB45E]=(LBA.BY[3]<<1);           // 512Bytes/Block
 235   2                      XBYTE[0xB45F]=0x00;                                     // Sectors Address
 236   2              } 
 237   1      
 238   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;
 239   1              while(1)
 240   1              {
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 5   

 241   2              SD_Send_DummyCLK(8);
 242   2                      if((XBYTE[0xB453]&0x20)==0x20)
 243   2                      {
 244   3                              break;
 245   3                      }
 246   2      
 247   2              if((--tw_SD_CountDown==0)||(SD_Detect)) 
 248   2                      {
 249   3                              break;
 250   3                      }
 251   2              }
 252   1                           
 253   1          SD_TrigCMD_Receive_Respond();
 254   1              XBYTE[0xB455]=0x00;
 255   1              XBYTE[0xB456]|=0x02;
 256   1              Device_Xfer_DataLength.WD=0x01FF;
 257   1              Device_Read_SRAM_Index.BY[0]=USB_BUF_Bank0_HIGH;
 258   1              Device_Read_SRAM_Index.BY[1]=0x00;
 259   1              Reset_DMA();
 260   1              SET_DEVICE_READ();                                                                                  
 261   1              TotalXferPageNum.WD--;                                                                          
 262   1              Trigger_Data_Transfer();                                                                            
 263   1              while(TotalXferPageNum.WD) 
 264   1              {
 265   2                      tw_SD_CountDown=SDMMCTimeOutLoop_10000;                                                          
 266   2                      while((!(XBYTE[0xB3C0]&0x01))||(XBYTE[0xB454]&0x0F))
 267   2                      {
 268   3                              if((--tw_SD_CountDown==0)||(SD_Detect))
 269   3                              {
 270   4                                      break;
 271   4                              }
 272   3                      }
 273   2                      XBYTE[0xB3C0]=0x00;
 274   2                      if(!gbt_OddTemp)
 275   2                      {       // transfer data to usb                                                     
 276   3                              while(XBYTE[0xB5A2]&0x01);                                                                 
 277   3                              XBYTE[0xB5C2]&=0xEF;    //Bulk-In Tx done                       
 278   3                              XBYTE[0xB5E9] = 0x01;   //Clear Bulk-In(EP1) Buffer
 279   3                              XBYTE[0xB516] = 0x02;   //512Byte
 280   3                              XBYTE[0xB515] = 0x00;
 281   3                              XBYTE[0xB5A1] = 0x01;   //Allow Bulk-In Tx.
 282   3                              XBYTE[0xB115] = USB_BUF_Bank1_HIGH;
 283   3                              if(gbt_USBHostIsHighSpeed)
 284   3                              {       //USB 2.0                                                     
 285   4      //                              XBYTE[0xB5E9] = 0x01;   //Clear Bulk-In(EP1) Buffer
 286   4      //                              XBYTE[0xB516] = 0x02;   //512Byte
 287   4      //                              XBYTE[0xB515] = 0x00;
 288   4      //                              XBYTE[0xB5A1] = 0x01;   //Allow Bulk-In Tx.
 289   4      //                              XBYTE[0xB115] = USB_BUF_Bank1_HIGH;
 290   4                              }                                                                                           
 291   3                              else 
 292   3                              {       //USB 1.1                                                                            
 293   4                                      XBYTE[0xB510] = 0x01;                                                   //BulkInEn auto turn-on(dma over)       
 294   4      //                              XBYTE[0xB5E9] = 0x01;                                                   //Clear Bulk-In(EP1) Buffer.            
 295   4      //                              XBYTE[0xB516] = 0x02;                                                   //512Byte                               
 296   4      //                              XBYTE[0xB515] = 0x00;                                                                   
 297   4      //                              XBYTE[0xB5A1] = 0x01;                                                   //Allow Bulk-In Tx.                     
 298   4      //                              XBYTE[0xB115] = USB_BUF_Bank1_HIGH;                             // 080104 joyce add                     
 299   4                                      while (XBYTE[0xB5A1]);                                                  //Bulk-In Tx done                       
 300   4                                      XBYTE[0xB510] = 0x00;                                                   //BulkInEn nonauto turn-on              
 301   4                              }                                                                                           
 302   3                      }                                                                                               
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 6   

 303   2                      else 
 304   2                      {                                                                                          
 305   3                              while (XBYTE[0xB5A1]&0x01);                                                     //Bulk-In Tx done                       
 306   3                              XBYTE[0xB5C2]   &= 0xFE;                                                                        
 307   3                              XBYTE[0xB5E9] = 0x10;                                                   //Clear Bulk-In(EP1) Buffer.            
 308   3                              XBYTE[0xB518] = 0x02;                                                   //512Byte                               
 309   3                              XBYTE[0xB517] = 0x00;                                                                   
 310   3                              XBYTE[0xB5A2] = 0x01;                                                   //Allow Bulk-In Tx.                                     
 311   3                              XBYTE[0xB115] = USB_BUF_Bank0_HIGH;                             // 080104 joyce add                     
 312   3                              if (gbt_USBHostIsHighSpeed) 
 313   3                              { //USB 2.0                                                     
 314   4      //                              XBYTE[0xB5E9] = 0x10;                                                   //Clear Bulk-In(EP1) Buffer.            
 315   4      //                              XBYTE[0xB518] = 0x02;                                                   //512Byte                               
 316   4      //                              XBYTE[0xB517] = 0x00;                                                                   
 317   4      //                              XBYTE[0xB5A2] = 0x01;                                                   //Allow Bulk-In Tx.                                     
 318   4      //                              XBYTE[0xB115] = USB_BUF_Bank0_HIGH;                             // 080104 joyce add                     
 319   4                              }                                                                                           
 320   3                              else 
 321   3                              { //USB 1.1                                                                            
 322   4                                      XBYTE[0xB510] = 0x01;                                                   //BulkInEn auto turn-on(dma over)       
 323   4      //                              XBYTE[0xB5E9] = 0x10;                                                   //Clear Bulk-In(EP1) Buffer.            
 324   4      //                              XBYTE[0xB518] = 0x02;                                                   //512Byte                               
 325   4      //                              XBYTE[0xB517] = 0x00;                                                                   
 326   4      //                              XBYTE[0xB5A2] = 0x01;                                                   //Allow Bulk-In Tx.                                     
 327   4      //                              XBYTE[0xB115] = USB_BUF_Bank0_HIGH;
 328   4                                      while (XBYTE[0xB5A2]);                                                  //Bulk-In Tx done                       
 329   4                                      XBYTE[0xB510] = 0x00;                                                   //BulkInEn nonauto turn-on              
 330   4                              }                                                                                           
 331   3                      }                                                                                               
 332   2                      gbt_OddTemp = !(gbt_OddTemp);                                                                   
 333   2                      (TotalXferPageNum.WD)--;                                                                            
 334   2                      Trigger_Data_Transfer();                                                                        
 335   2              }                                                                                                   
 336   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;                                                              
 337   1              while((!(XBYTE[0xB3C0] & 0x01))||(XBYTE[0xB454] & 0x0F))
 338   1              {                                                               //Wait Data xfer done                   
 339   2                      if((--tw_SD_CountDown==0)||(SD_Detect))
 340   2                      {
 341   3                              break;
 342   3                      }
 343   2              }                                                                                                           
 344   1              XBYTE[0xB3C0] = 0x00;                                                                               
 345   1              if(!gbt_OddTemp) 
 346   1              {
 347   2                      while(XBYTE[0xB5A2]&0x01);              //Bulk-In Tx done                       
 348   2                      XBYTE[0xB510] = 0x01;                   //BulkInEn auto turn-on(dma over)       
 349   2                      XBYTE[0xB5E9] = 0x01;                   //Clear Bulk-In(EP1) Buffer.            
 350   2                      XBYTE[0xB516] = 0x02;                   //512Byte                               
 351   2                      XBYTE[0xB515] = 0x00;                                                                           
 352   2                      XBYTE[0xB5A1] = 0x01;                   //Allow Bulk-In Tx.                     
 353   2                      while (XBYTE[0xB5A1]);                  //Bulk-In Tx done                       
 354   2                      XBYTE[0xB510] = 0x00;                   //BulkInEn nonauto turn-on              
 355   2              }                                                                                                   
 356   1              else
 357   1              {
 358   2                      while (XBYTE[0xB5A1]&0x01);             //Bulk-In Tx done                       
 359   2                      XBYTE[0xB510] = 0x01;                   //BulkInEn auto turn-on(dma over)       
 360   2                      XBYTE[0xB5E9] = 0x10;                   //Clear Bulk-In(EP1) Buffer.            
 361   2                      XBYTE[0xB518] = 0x02;                   //512Byte                               
 362   2                      XBYTE[0xB517] = 0x00;
 363   2                      XBYTE[0xB5A2] = 0x01;                   //Allow Bulk-In Tx.                     
 364   2                      while (XBYTE[0xB5A2]);                  //Bulk-In Tx done                       
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 7   

 365   2                      XBYTE[0xB510] = 0x00;                   //BulkInEn nonauto turn-on              
 366   2              }                                                                                                       
 367   1              
 368   1              if(!tbt_No_SD_Stop_CMD)
 369   1              {                                                                            
 370   2                      SD_Cmd12_Stop();                                                                                
 371   2              }                                                                                                   
 372   1      
 373   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;                                                              
 374   1              while(1)
 375   1              {
 376   2              SD_Send_DummyCLK(8);
 377   2                      if((XBYTE[0xB453]&0x20)==0x20)
 378   2                      {
 379   3                              break;
 380   3                      }
 381   2      
 382   2              if((--tw_SD_CountDown==0)||(SD_Detect)) 
 383   2                      {
 384   3                              break;
 385   3                      }
 386   2              }
 387   1              XBYTE[0xB400] = 0x01;
 388   1      }                                                                                                       
 389                                                                                                                
 390          
 391          void SD_WriteSectors_USB(void)
 392          {                                                                         
 393   1              U16 tw_SD_CountDown;
 394   1              bit tbt_No_SD_Stop_CMD=0;
 395   1              gbt_OddTemp =0;
 396   1              
 397   1              XBYTE[0xB400] = 0x06;                                                               
 398   1              XBYTE[0xB450] = 0x03;                                                               
 399   1      
 400   1              // USB-->SRAM Bank 0    // 需要先收一筆data否則會一直被Timeout                                      
 401   1              if (gbt_USBHostIsHighSpeed) 
 402   1              {
 403   2                      XBYTE[0xB512]=0x01;
 404   2              }
 405   1              else
 406   1              {
 407   2                      XBYTE[0xB512]=0x00;
 408   2              }
 409   1              XBYTE[0xB5D2] &= 0xFD;          //Disable Bulk-Out中斷                  
 410   1              XBYTE[0xB5E9] = 0x02;           // USB-->SRAM                           
 411   1              XBYTE[0xB516] = 0x02;           //512Byte                               
 412   1              XBYTE[0xB515] = 0x00;
 413   1              XBYTE[0xB5A1] = 0x02;           //Allow Bulk-Out Tx.                    
 414   1      
 415   1              if(TotalXferPageNum.WD==1)
 416   1              {
 417   2                      XBYTE[0xB45B]=0x58;     // CMD24
 418   2                      tbt_No_SD_Stop_CMD=1;
 419   2              }
 420   1              else
 421   1              {
 422   2                      XBYTE[0xB45B]=0x59;     // CMD25
 423   2                      tbt_No_SD_Stop_CMD=0;
 424   2              }
 425   1      
 426   1              if(gbt_SDHC_Type)
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 8   

 427   1              {                                                                                 
 428   2                      XBYTE[0xB45C] = LBA.BY[0];
 429   2                      XBYTE[0xB45D] = LBA.BY[1];
 430   2                      XBYTE[0xB45E] = LBA.BY[2];
 431   2                      XBYTE[0xB45F] = LBA.BY[3];
 432   2              }                                                                                                   
 433   1              else
 434   1              {
 435   2                      XBYTE[0xB45C] = (LBA.BY[1]<<1)+(LBA.BY[2]>>7);
 436   2                      XBYTE[0xB45D] = (U8)(LBA.WD[1]>>7);
 437   2                      XBYTE[0xB45E] = (LBA.BY[3]<<1);
 438   2                      XBYTE[0xB45F] =  0x00;
 439   2              }                                                                                                   
 440   1          tw_SD_CountDown=SDMMCTimeOutLoop_10000;
 441   1              while(1)
 442   1              {
 443   2              SD_Send_DummyCLK(8);
 444   2                      if((XBYTE[0xB453]&0x20)==0x20)
 445   2                      {
 446   3                              break;
 447   3                      }
 448   2      
 449   2              if((--tw_SD_CountDown==0)||(SD_Detect)) 
 450   2                      {
 451   3                              break;
 452   3                      }
 453   2              }
 454   1                   
 455   1              SD_TrigCMD_Receive_Respond();        
 456   1      
 457   1              XBYTE[0xB455] = 0x00;
 458   1              XBYTE[0xB456]|= 0x02;
 459   1              Device_Xfer_DataLength.WD = 0x01FF;                                                                 
 460   1              Device_Write_SRAM_Index.BY[0] = USB_BUF_Bank0_HIGH;                     // 080104 joyce add                     
 461   1              Device_Write_SRAM_Index.BY[1] = 0x00;                                                               
 462   1              SET_DEVICE_WRITE();                                                                                 
 463   1              (TotalXferPageNum.WD)--;  
 464   1              while(TotalXferPageNum.WD)
 465   1              {
 466   2                      XBYTE[0xB452] = 0x40;         
 467   2                      while(XBYTE[0xB454] & 0x0F);   
 468   2                      if(gbt_OddTemp) 
 469   2                      { //Bank 1-> Flash, USB -> Bank 0                                              
 470   3                              while(XBYTE[0xB5A2]&0x02);                                                                  
 471   3                              XBYTE[0xB5C2]   &= 0xDF;                                                                    
 472   3                              XBYTE[0xB113]    = USB_BUF_Bank1_HIGH;                  // 080104 joyce add                         
 473   3                              XBYTE[0xB112]    = 0x00;                                                                    
 474   3                              XBYTE[0xB3B0]    = 0x01;                                                        //Trigger Data Xfer                     
 475   3                              XBYTE[0xB5E9]    = 0x02;                                                        //Clear Bulk-Out(EP2) Buffer            
 476   3                              XBYTE[0xB516]    = 0x02;                                                        //512Byte                               
 477   3                              XBYTE[0xB515]    = 0x00;                                                                    
 478   3                              XBYTE[0xB5A1]    = 0x02;
 479   3                      }                                                                                               
 480   2                      else 
 481   2                      { //Bank 0 -> Flash, USB -> Bank 1                                                         
 482   3                              while (XBYTE[0xB5A1] & 0x02);                                                               
 483   3                              XBYTE[0xB5C2]   &= 0xFD;                                                                                
 484   3                              XBYTE[0xB113]    = USB_BUF_Bank0_HIGH;                  // 080104 joyce mark                        
 485   3                              XBYTE[0xB112]    = 0x00;                                                                    
 486   3                              XBYTE[0xB3B0]    = 0x01;                                                        //Trigger Data Xfer                     
 487   3                              XBYTE[0xB5E9]    = 0x20;                                                        //Clear Bulk-Out(EP2) Buffer            
 488   3                              XBYTE[0xB518]    = 0x02;                                                        //512Byte                               
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 9   

 489   3                              XBYTE[0xB517]    = 0x00;                                                                    
 490   3                              XBYTE[0xB5A2]    = 0x02;
 491   3                      }                                                                                                       
 492   2                      gbt_OddTemp = !(gbt_OddTemp);                                                                   
 493   2                      (TotalXferPageNum.WD)--;                               
 494   2                      tw_SD_CountDown=SDMMCTimeOutLoop_10000; 
 495   2                      while((!(XBYTE[0xB3C0] & 0x01))||(XBYTE[0xB454] & 0x0F))
 496   2                      {
 497   3                      if((--tw_SD_CountDown==0)||(SD_Detect))
 498   3                          {
 499   4                                      break;
 500   4                      }
 501   3                      } 
 502   2                      XBYTE[0xB3C0] = 0x00;                                                                               
 503   2              }// end while                                                                                       
 504   1              XBYTE[0xB452] = 0x40;         
 505   1              while(XBYTE[0xB454] & 0x0F);   
 506   1              
 507   1              if (gbt_OddTemp) 
 508   1              { //Bank 1-> Flash, USB -> Bank 0
 509   2                      while(XBYTE[0xB5A2]&0x02);                                                                      
 510   2                      XBYTE[0xB5C2]   &= 0xDF;                                                                        
 511   2                      XBYTE[0xB113]    = USB_BUF_Bank1_HIGH;
 512   2                      XBYTE[0xB112]    = 0x00;                                                                        
 513   2                      XBYTE[0xB3B0]    = 0x01;        //Trigger Data Xfer                         
 514   2              }
 515   1              else 
 516   1              { //Bank 0 -> Flash, USB -> Bank 1                                                             
 517   2                      while (XBYTE[0xB5A1] & 0x02);                                                                   
 518   2                      XBYTE[0xB5C2]   &= 0xFD;                                                                                    
 519   2                      XBYTE[0xB113]    = USB_BUF_Bank0_HIGH;
 520   2                      XBYTE[0xB112]    = 0x00;                                                                        
 521   2                      XBYTE[0xB3B0]    = 0x01;        //Trigger Data Xfer                                             
 522   2              }                                                                                                               
 523   1      
 524   1              tw_SD_CountDown=SDMMCTimeOutLoop_10000;                                                              
 525   1              while((!(XBYTE[0xB3C0] & 0x01))||(XBYTE[0xB454] & 0x0F))
 526   1              {
 527   2              if((--tw_SD_CountDown==0)||(SD_Detect))
 528   2                  {
 529   3                              break;
 530   3              }
 531   2              }                                                                                               
 532   1              XBYTE[0xB3C0] = 0x00;
 533   1              XBYTE[0xB452] = 0x40;
 534   1              while(XBYTE[0xB454] & 0x0F)
 535   1              {
 536   2                      if(SD_Detect)
 537   2                      {                                                               
 538   3                              break;
 539   3                      }     
 540   2              }
 541   1              
 542   1              if(!tbt_No_SD_Stop_CMD)
 543   1              {
 544   2                      SD_Cmd12_Stop();
 545   2              }
 546   1              XBYTE[0xB452] = 0x40;
 547   1              while(XBYTE[0xB454]&0x0F);
 548   1              SD_Send_DummyCLK(8);                                                                                
 549   1              XBYTE[0xB400] = 0x01;
 550   1      }                                                                                                       
C51 COMPILER V9.00   SD_CMD                                                                07/10/2012 15:51:45 PAGE 10  



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1372    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      19
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       6
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
