C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE WAVE_FUNC
OBJECT MODULE PLACED IN .\obj\Wave_Func.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE WAV\Wave_Func.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsource\h
                    -eader) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\Wave_Func.lst) OBJECT(.\obj\Wave_Func.obj)

line level    source

   1          #include "..\header\SPDA2K.h"
   2          #include "..\DSP\DSPPHYSIC.H"
   3          #include "..\DSP\dspuser.h"
   4          #include "..\header\variables.h"
   5          
   6          void MediaSelect(void)
   7          {
   8   1              gb_ChangeMedia=0;
   9   1              if(gc_CurrentCard==2)
  10   1              {
  11   2                      if(gb_SD_Exist==1)
  12   2                      {
  13   3                              gb_ChangeMedia=1;
  14   3                      }
  15   2                      else
  16   2                      {
  17   3                              if(gb_Host_Exist==1)
  18   3                              {
  19   4                                      gc_CurrentCard=5;
  20   4                                      gb_ChangeMedia=1;
  21   4                              }
  22   3                              else
  23   3                              {
  24   4                                      gc_CurrentCard=9;
  25   4                              }
  26   3                      }
  27   2              }
  28   1              else if(gc_CurrentCard==5)
  29   1              {
  30   2                      if(gb_Host_Exist==1)
  31   2                      {
  32   3                              gb_ChangeMedia=1;
  33   3                      }
  34   2                      else
  35   2                      {
  36   3                              if(gb_SD_Exist==1)
  37   3                              {
  38   4                                      gc_CurrentCard=2;
  39   4                                      gb_ChangeMedia=1;
  40   4                              }
  41   3                              else
  42   3                              {
  43   4                                      gc_CurrentCard=9;
  44   4                              }
  45   3                      }
  46   2              }
  47   1      }
  48          
  49          bit MediaInitial(void)
  50          {
  51   1              switch(gc_CurrentCard)
  52   1              {
  53   2                      case 2: // SD
  54   2                              if(SD_Identification_Flow()==1)
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 2   

  55   2                              {
  56   3                                      if(DOS_Initialize()==0)
  57   3                                      {
  58   4                                              return 0;       // Play SD
  59   4                                      }
  60   3      
  61   3                                      if(gb_Host_Exist)
  62   3                                      {
  63   4                                              if(Host_Initial()==0)
  64   4                                              {
  65   5                                                      gc_CurrentCard=5;
  66   5                                                      if(DOS_Initialize()==0)
  67   5                                                      {
  68   6                                                              return 0;
  69   6                                                      }
  70   5                                              }
  71   4                                      }
  72   3                                      gc_CurrentCard=9;
  73   3                                      return 1;
  74   3                              }
  75   2                      break;
  76   2      
  77   2                      case 5: // Host
  78   2                              if(Host_Initial()==0)
  79   2                              {
  80   3                                      if(DOS_Initialize()==0)
  81   3                                      {
  82   4                                              return 0;
  83   4                                      }
  84   3                              }
  85   2      
  86   2                              if(gb_SD_Exist)
  87   2                              {
  88   3                                      if(SD_Identification_Flow()==0)
  89   3                                      {
  90   4                                              gc_CurrentCard=2;
  91   4                                              if(DOS_Initialize()==0)
  92   4                                              {
  93   5                                                      return 0;
  94   5                                              }
  95   4                                      }
  96   3                              }
  97   2                              gc_CurrentCard=9;
  98   2                              return 1;
  99   2                      break;
 100   2              }
 101   1                      return 1;
 102   1      }
 103          
 104          bit SearchFolder_VOICE(void)
 105          {
 106   1              xdata   U8      tc_Status;
 107   1              xdata   U8      tc_FileName[10]={0x00,0x00,0x01,0x00,0x0B,'V','O','I','C','E'};
 108   1              idata   SearchFdb ts_FDBEntry;
 109   1      
 110   1              ts_FDBEntry.c_Search_Mode=K_SPECIFIC_SHORT_FILENAME;//search free fdb entry mode 
 111   1              ts_FDBEntry.dw_FDB_StartCluster=gdw_DOS_RootDirClus;//set directory startcluster
 112   1              ts_FDBEntry.c_EXTSelect=1;
 113   1              ts_FDBEntry.c_Search_Attribute=1;
 114   1              ts_FDBEntry.pc_LongFileName=tc_FileName;
 115   1              ts_FDBEntry.c_type=0x02;
 116   1              EXT_NameC[0]=1;
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 3   

 117   1              EXT_NameC[1]=0x20;
 118   1              EXT_NameC[2]=0x20;
 119   1          EXT_NameC[3]=0x20;
 120   1              tc_Status=Find_Fdb(&ts_FDBEntry);
 121   1      
 122   1              if(tc_Status)
 123   1              {       
 124   2                      return 1;
 125   2              }
 126   1              else
 127   1              {
 128   2                      gs_File_FCB[2].w_FDB_Offset=ts_FDBEntry.w_FDB_Offset;
 129   2                      gs_File_FCB[2].dw_FDB_LogAdd=ts_FDBEntry.dw_FDB_LogAdd;
 130   2                      DOS_Open_File_r(2,2,0); // Get FDB's start cluster
 131   2                      gs_System_State.c_FileHandle=1;
 132   2                      gs_File_FCB[1].dw_FDB_StartCluster=gs_File_FCB[2].dw_File_StartCluster;
 133   2                      DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_RecordFileType,C_CmpExtName|C_Next);
 134   2                      return 0;
 135   2              }
 136   1      }
 137          
 138          void WAV_Play_Init(void)
 139          {
 140   1              data    U8      tc_SampleRate;
 141   1      
 142   1              WAV_Play_Download();    // Download DSP code
 143   1              L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);     // Set Volume
 144   1              gw_CurrentSec=0;
 145   1              gb_ZeroFileSize_Or_FormatError=0;
 146   1              tc_SampleRate=(U8)IMA_ADPCM_SampleRate_Parser();
 147   1              gs_System_State.w_SampleRate=tc_SampleRate;
 148   1              DOS_GetLongFileName(1,gc_FileLongName);
 149   1              #ifdef SPI_1M             
 150   1              X_Unicode2ISN(gc_FileLongName);
 151   1              #endif
 152   1              LCM_Disp_FileName(&gc_FileLongName[5],gc_FileLongName[2],gc_FileLongName[4],1);
 153   1      
 154   1              gw_FileIndex[0]=gw_FileIndex[1];
 155   1              gw_FileTotalNumber[0]=gw_FileTotalNumber[1];
 156   1              RefreshAllDisplay();
 157   1              LCM_Disp_FileName(&gc_FileLongName[5],gc_FileLongName[2],gc_FileLongName[4],1);
 158   1      
 159   1              if(IMA_ADPCM_Play_PlayCmd(tc_SampleRate))
 160   1              {
 161   2                      gb_ZeroFileSize_Or_FormatError=1;
 162   2              }
 163   1      }
 164          
 165          void L2_DSP_MCU_DM_DMA_16bit(U16 BufferIndex,U8 tc_Dest_Addr_High,U16 tw_Src)
 166          {
 167   1              data    U16 tw_DSP_Word_Align;
 168   1              data    U16 tw_DSPAddr;
 169   1              xdata   U8  tc_DSPAddr_High;
 170   1      
 171   1              // ----- DMA Reset -----
 172   1              XBYTE[0xB304] = 0x09;
 173   1              XBYTE[0xB304] = 0x08;
 174   1              XBYTE[0xB3C0] = 0x00;           // clear DMA complete
 175   1              XBYTE[0xB330] = 0x01;           // clear checksum
 176   1      
 177   1              // ----- DMA initial settings for DM transfer -----
 178   1              XBYTE[0xB216] = 0x00;   // Remain DSP mode.  When you do MCU -> DM, MCU will stop DSP automaticlly
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 4   

 179   1              XBYTE[0xB301] = 0x50;   // DMA : SRAM --> DM
 180   1              XBYTE[0xB302] = 0xFF;   // Define data size in DMA (assume 512 bytes)
 181   1              XBYTE[0xB303] = 0x01;
 182   1      
 183   1              // Destination
 184   1              XBYTE[0xB340]=0x01;     // 16-bit DMA
 185   1              *((U8 *)&tw_DSPAddr)=((*((U8 *)&BufferIndex+1))<<1);
 186   1              *((U8 *)&tw_DSPAddr+1)=0;
 187   1              tw_DSP_Word_Align=tw_DSPAddr>>1;
 188   1              XBYTE[0xB21D]=0x01;     // offset
 189   1              tc_DSPAddr_High=*((U8 *)&tw_DSP_Word_Align);
 190   1              tc_DSPAddr_High+=tc_Dest_Addr_High;
 191   1              XBYTE[0xB217]=*((U8 *)&tw_DSP_Word_Align+1);
 192   1              XBYTE[0xB218]=tc_DSPAddr_High;
 193   1              // Source
 194   1              XBYTE[0xB112]=(tw_Src<<8)>>8;
 195   1              XBYTE[0xB113]=(tw_Src>>8);
 196   1              Trigger_Data_Transfer_Done();
 197   1      }
 198          
 199          U8 IMA_ADPCM_Play_DataIn(void)
 200          {
 201   1              if((L2_DSP_Read_DMem16(DSP_EmptyBuffer)*2/3)>=512)
 202   1              {
 203   2                      if(DOS_Read_File(1)==DOS_END_OF_FILE)
 204   2                      {
 205   3                              return DSP_DATAIN_COMMAND_ERROR;
 206   3                      }
 207   2      
 208   2                      L2_DSP_MCU_DM_DMA_16bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
 209   2                      L2_DSP_SendCommandSet(DCMD_DatIn);
 210   2                      if(gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
 211   2                      {
 212   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
 213   3                      }
 214   2              }
 215   1              return  0;
 216   1      }
 217          
 218          U8 IMA_ADPCM_Play_PlayCmd(U8 tc_SampleRate)
 219          {
 220   1              data    U16     tw_CtrlMode;
 221   1      
 222   1              if(tc_SampleRate==16)
 223   1              {
 224   2                      tw_CtrlMode=0x7010;
 225   2              }
 226   1              else if(tc_SampleRate==8)
 227   1              {
 228   2                      tw_CtrlMode=0x7000;
 229   2              }
 230   1              else if(tc_SampleRate==32)      
 231   1              {
 232   2                      tw_CtrlMode=0x7020;
 233   2              }
 234   1              else
 235   1              {
 236   2                      return DSP_PLAY_COMMAND_ERROR;
 237   2              }
 238   1      
 239   1              L2_DSP_Write_DMem16(DSP_ADPCMModeControl,tw_CtrlMode);
 240   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 5   

 241   1              {
 242   2                      return DSP_PLAY_COMMAND_ERROR;
 243   2              }
 244   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;        // reset bitstream address of DM
 245   1              if(DOS_Open_File_r(C_RecordFHandle,C_Open_FoundFile,C_NullFileName))
 246   1              {
 247   2                      return DSP_PLAY_COMMAND_ERROR;
 248   2              }
 249   1              return 0;
 250   1      }
 251          
 252          U8 IMA_ADPCM_Play_PauseCmd(void)
 253          {
 254   1              data    U16     TimeOUT=0xFFFF;
 255   1      
 256   1              if(L2_DSP_SendCommandSet(DCMD_Pause)!=DCMD_Pause)
 257   1              {
 258   2                      return DSP_PAUSE_COMMAND_ERROR;
 259   2              }
 260   1      
 261   1              do
 262   1              {
 263   2                      TimeOUT--;
 264   2                      if (TimeOUT == 0)
 265   2                      {
 266   3                              return DSP_RUNNING_STATUS1_ERROR;
 267   3                      }
 268   2              } while(!(L2_DSP_Read_DMem16(DSP_RunningStatus)&0x0002));
 269   1      
 270   1              return 0;
 271   1      }
 272          
 273          U8 IMA_ADPCM_Play_ResumeCmd(void)
 274          {
 275   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
 276   1              {
 277   2                      return DSP_PLAY_COMMAND_ERROR;
 278   2              }
 279   1              return 0;
 280   1      }
 281          
 282          U8 IMA_ADPCM_Play_StopCmd(void)
 283          {
 284   1              data    U8  tc_Ret;
 285   1              data    U16 TimeOUT=0xFFFF;
 286   1              xdata   U16     tc_temp;
 287   1      
 288   1              tc_Ret=DSP_StopCmd();
 289   1      
 290   1              do{
 291   2                      TimeOUT --;
 292   2                      if(TimeOUT==0)
 293   2                      {
 294   3                              tc_Ret=DSP_DECODE_STATUS_TIMEOUT_ERROR;
 295   3                              break;
 296   3                      }
 297   2              }while(!((L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)==0x00C0));  //wait file end
 298   1      
 299   1              tc_temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 300   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,tc_temp&0xFF3F);
 301   1              gs_File_FCB[1].dw_File_StartCluster=0xFFFFFFFF;
 302   1              gb_PlayOtherWAV=1;
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 6   

 303   1              return tc_Ret;
 304   1      }
 305          
 306          U16 IMA_ADPCM_Play_ReadTime(void)
 307          {
 308   1              data    U8      tc_status;
 309   1              xdata   U16 tw_DurTime;
 310   1              xdata   U32 tdw_FrameNum;
 311   1      
 312   1              tc_status=L2_DSP_Read_DMem16(DSP_ADPCMModeControl);
 313   1              tdw_FrameNum=L2_DSP_Read_DMem24(DSP_DecodeFrameCounter);
 314   1              tw_DurTime=(tdw_FrameNum*505)/1000;
 315   1      
 316   1              if(tc_status&0x20) // 32K sample rate 
 317   1              {
 318   2                      tw_DurTime=tw_DurTime/32;
 319   2              }
 320   1              else if(tc_status&0x10) // 16K sample rate 
 321   1              {
 322   2                      tw_DurTime=tw_DurTime/16;
 323   2              }
 324   1              else  // 8K samplpe rate
 325   1              {
 326   2                      tw_DurTime=tw_DurTime/8;
 327   2              }
 328   1      
 329   1              return tw_DurTime+gw_CurrentSec;
 330   1      }
 331          
 332          U16 IMA_ADPCM_SampleRate_Parser(void)//(JC)H0723 Parsing the ADPCM file header to get sample rate
 333          {
 334   1              data    U8      tc_temp;
 335   1              data    U16 tw_SampleRate;      
 336   1              
 337   1              if(DOS_Open_File_r(C_RecordFHandle,C_Open_FoundFile,C_NullFileName)||(gs_File_FCB[1].dw_File_TotalSize==0
             -))
 338   1              {
 339   2                      return 1;//(JC)file open fail 
 340   2              }
 341   1              DOS_Read_File(C_RecordFHandle);
 342   1              if(gc_PlayRecordDataBuf[0x00]!=0x52||gc_PlayRecordDataBuf[0x01]!=0x49           //check "RIFF" tag
 343   1              || gc_PlayRecordDataBuf[0x02]!=0x46||gc_PlayRecordDataBuf[0x03]!=0x46)
 344   1              {
 345   2                      return 2;//Jimi 100408, Format Error
 346   2              }
 347   1      
 348   1              if(gc_PlayRecordDataBuf[0x08]!=0x57||gc_PlayRecordDataBuf[0x09]!=0x41           //check "WAVE" tag
 349   1              || gc_PlayRecordDataBuf[0x0A]!=0x56||gc_PlayRecordDataBuf[0x0B]!=0x45)
 350   1              {
 351   2                      return 3;//Jimi 100408, Format Error
 352   2              }
 353   1      
 354   1              if(gc_PlayRecordDataBuf[0x10]!=0x14||gc_PlayRecordDataBuf[0x11]!=0x00           //check format chunk size
 355   1              || gc_PlayRecordDataBuf[0x12]!=0x00||gc_PlayRecordDataBuf[0x13]!=0x00)
 356   1              {
 357   2                      return 4;//Jimi 100408, Format Error
 358   2              }
 359   1      
 360   1              if(gc_PlayRecordDataBuf[0x14]!=0x11||gc_PlayRecordDataBuf[0x15]!=0x00)          //check iFormatTag
 361   1              {
 362   2                      return 5;//Jimi 100408, Format Error
 363   2              }
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 7   

 364   1      
 365   1              gc_WaveChannelNumber=gc_PlayRecordDataBuf[0x16];
 366   1              tw_SampleRate=gc_PlayRecordDataBuf[0x19];
 367   1              tw_SampleRate=(tw_SampleRate<<8)+gc_PlayRecordDataBuf[0x18];
 368   1              tw_SampleRate/=1000;
 369   1      
 370   1              gs_File_FCB[1].dw_File_StartCluster=0xFFFFFFFF;
 371   1              gs_File_FCB[1].dw_File_CurrentCluster=gs_File_FCB[1].dw_File_StartCluster;
 372   1              gs_File_FCB[1].dw_File_DataPoint=0;
 373   1      
 374   1              tc_temp=tw_SampleRate;
 375   1              gw_TotalSec=((gs_File_FCB[1].dw_File_TotalSize/512*505)/4000/gc_WaveChannelNumber);
 376   1              gw_TotalSec=gw_TotalSec/(tc_temp/8);
 377   1      
 378   1              return tw_SampleRate;
 379   1      }
 380          
 381          void AccessKeyEvent_WAV(void)
 382          {
 383   1              data    U8      tc_Step;
 384   1              xdata   U32     tdw_DataPoint;
 385   1      
 386   1              switch(gs_System_State.c_Phase)
 387   1              {
 388   2                      case TASK_PHASE_PLAYACT:
 389   2                              switch(gc_KeyEvent)
 390   2                              {
 391   3                                      case 0x02:      // Play
 392   3                                              if(gc_WAVMenuItem==0)
 393   3                                              {
 394   4                                                      IMA_ADPCM_Play_PauseCmd();
 395   4                                                      gs_System_State.c_Phase=TASK_PHASE_PAUSE;
 396   4                                                      LCM_ShowPlayPauseIcon();
 397   4                                                      ClearIRNumberVariable();
 398   4                                              }
 399   3                                              else
 400   3                                              {
 401   4                                              }
 402   3                                      break;
 403   3      
 404   3                                      case 0x03:      // Next
 405   3                                              if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_A)
 406   3                                              {
 407   4                                                      // 記憶A point
 408   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_B;
 409   4                                                      //gs_DSP_GLOBAL_RAM.sdw_File_ACluster=gs_File_FCB[1].dw_File_CurrentCluster;
 410   4                                                      gs_DSP_GLOBAL_RAM.sdw_File_ACluster = 0xFFFFFFFF;
 411   4                                                      tdw_DataPoint=L2_DSP_Read_DMem16(DSP_RemainBuffer)*2/3;         //jimiyu 081117
 412   4                                                      tdw_DataPoint&=0xFFFFFE00;
 413   4                                                      gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint=(gs_File_FCB[1].dw_File_DataPoint)-(tdw_DataPoint);
 414   4                                                      gw_AFrameCnt=L2_DSP_Read_DMem16(DSP_DecodeFrameCounter);                //Jimi 080530, to get A point frame count
 415   4                                              }
 416   3                                              else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_B)
 417   3                                              {
 418   4                                                      // 記憶B point & 開始Repeat
 419   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB;
 420   4                                                      gs_DSP_GLOBAL_RAM.sdw_File_BCluster=gs_File_FCB[1].dw_File_CurrentCluster;
 421   4                                                      gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint=gs_File_FCB[1].dw_File_DataPoint;
 422   4                                              }
 423   3                                              else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_AB)
 424   3                                              {
 425   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 8   

 426   4                                              }
 427   3                                              else if(gc_WAVMenuItem==0)
 428   3                                              {
 429   4                                                      ClearIRNumberVariable();
 430   4                                                      if(gb_SetVol)
 431   4                                                      {
 432   5                                                              gb_ADJ=0;
 433   5                                                              VOL_Adj();
 434   5                                                      }
 435   4                                                      else
 436   4                                                      {
 437   5                                                              IMA_ADPCM_Play_StopCmd();
 438   5                                                              gb_PlayNewWave=1;
 439   5                                                              DOS_Search_File(C_File_OneDir|C_By_Name,C_RecordFileType,C_CmpExtName|C_Next);
 440   5                                                      }
 441   4                                              }
 442   3                                              else if(gc_WAVMenuItem==1)      // WAV play Menu(EQ/A-B/Exit)
 443   3                                              {
 444   4                                                      tc_Step=gc_WAVPlayMenuNum;
 445   4                                                      gc_WAVPlayMenuNum=(gc_WAVPlayMenuNum+1)%3;
 446   4                                                      LCM_ShowWAVPlayMenu(tc_Step);
 447   4                                                      LCM_ShowWAVPlayMenu(gc_WAVPlayMenuNum);
 448   4                                              }
 449   3                                              else if(gc_WAVMenuItem==2)      // EQ Menu
 450   3                                              {
 451   4                                                      if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==3)
 452   4                                                      {
 453   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=4;
 454   5                                                              LCM_ShowEQMenu(4);
 455   5                                                              LCM_ShowEQMenu(5);
 456   5                                                              LCM_erase_one_page(4);
 457   5                                                              LCM_erase_one_page(5);
 458   5                                                              LCM_erase_one_page(6);
 459   5                                                              LCM_erase_one_page(7);
 460   5                                                      }
 461   4                                                      else if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==5)
 462   4                                                      {
 463   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=0;
 464   5                                                              LCM_ShowEQMenu(0);
 465   5                                                              LCM_ShowEQMenu(1);
 466   5                                                              LCM_ShowEQMenu(2);
 467   5                                                              LCM_ShowEQMenu(3);
 468   5                                                      }
 469   4                                                      else
 470   4                                                      {
 471   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type++;
 472   5                                                              LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type-1);
 473   5                                                              LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
 474   5                                                      }
 475   4                                                      Music_EQ_Cmd();
 476   4                                              }
 477   3                                      break;
 478   3      
 479   3                                      case 0x04:      // Prev
 480   3                                              if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_A)
 481   3                                              {
 482   4                                              }
 483   3                                              else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_B)
 484   3                                              {
 485   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
 486   4                                              }
 487   3                                              else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_AB)
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 9   

 488   3                                              {
 489   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
 490   4                                              }
 491   3                                              else if(gc_WAVMenuItem==0)
 492   3                                              {
 493   4                                                      ClearIRNumberVariable();
 494   4                                                      if(gb_SetVol)
 495   4                                                      {
 496   5                                                              gb_ADJ=1;
 497   5                                                              VOL_Adj();
 498   5                                                      }
 499   4                                                      else
 500   4                                                      {
 501   5                                                              IMA_ADPCM_Play_StopCmd();
 502   5                                                              gb_PlayNewWave=1;
 503   5                                                              DOS_Search_File(C_File_OneDir|C_By_Name,C_RecordFileType,C_CmpExtName|C_Prev);
 504   5                                                      }
 505   4                                              }
 506   3                                              else if(gc_WAVMenuItem==1)      // WAV play Menu(EQ/A-B/Exit)
 507   3                                              {
 508   4                                                      tc_Step=gc_WAVPlayMenuNum;
 509   4                                                      gc_WAVPlayMenuNum=(gc_WAVPlayMenuNum+2)%3;
 510   4                                                      LCM_ShowWAVPlayMenu(tc_Step);
 511   4                                                      LCM_ShowWAVPlayMenu(gc_WAVPlayMenuNum);                                                 
 512   4                                              }
 513   3                                              else if(gc_WAVMenuItem==2)
 514   3                                              {
 515   4                                                      if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==0)
 516   4                                                      {
 517   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=5;
 518   5                                                              LCM_ShowEQMenu(4);
 519   5                                                              LCM_ShowEQMenu(5);
 520   5                                                              LCM_erase_one_page(4);
 521   5                                                              LCM_erase_one_page(5);
 522   5                                                              LCM_erase_one_page(6);
 523   5                                                              LCM_erase_one_page(7);
 524   5                                                      }
 525   4                                                      else if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==4)
 526   4                                                      {
 527   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=3;
 528   5                                                              LCM_ShowEQMenu(0);
 529   5                                                              LCM_ShowEQMenu(1);
 530   5                                                              LCM_ShowEQMenu(2);
 531   5                                                              LCM_ShowEQMenu(3);
 532   5                                                      }
 533   4                                                      else
 534   4                                                      {
 535   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type--;
 536   5                                                              LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type+1);
 537   5                                                              LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
 538   5                                                      }
 539   4                                                      Music_EQ_Cmd();
 540   4                                              }
 541   3                                      break;
 542   3      
 543   3                                      case 0x05:      // V
 544   3                                              if(gc_WAVMenuItem==0&&gb_SetVol==0)
 545   3                                              {
 546   4                                                      gb_SetVol=1;
 547   4                                                      gc_MenuTimer=6;
 548   4                                                      LCM_Clear_L2_L5();
 549   4                                                      LCM_ShowVOL();
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 10  

 550   4                                                      ClearIRNumberVariable();
 551   4                                              }
 552   3                                              else
 553   3                                              {
 554   4                                                      gc_MenuTimer=0;
 555   4                                              }
 556   3                                      break;
 557   3      
 558   3                                      case 0x06:      // M
 559   3                                              if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_AB_NULL)
 560   3                                              {
 561   4                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB_NULL;
 562   4                                                      LCM_ShowRepeatIcon();   // Clear Repeat Icon
 563   4                                                      LCM_ShowSongNum();
 564   4                                                      LCM_ShowSongTotalNum();
 565   4                                              }
 566   3                                              else if(gc_WAVMenuItem==0)
 567   3                                              {
 568   4                                                      // Enter WAV Play Menu
 569   4                                                      gc_WAVMenuItem=1;
 570   4                                                      gc_MenuTimer=6;
 571   4                                                      ClearIRNumberVariable();
 572   4                                                      LCM_ShowWAVPlayMenu(0);
 573   4                                                      LCM_ShowWAVPlayMenu(1);
 574   4                                                      LCM_ShowWAVPlayMenu(2);
 575   4                                                      LCM_erase_one_page(6);
 576   4                                                      LCM_erase_one_page(7);
 577   4                                              }
 578   3                                              else if(gc_WAVMenuItem==1)      // ** Enter WAV Play Sub-Menu **
 579   3                                              {
 580   4                                                      if(gc_WAVPlayMenuNum==0)        // EQ menu
 581   4                                                      {
 582   5                                                              gc_WAVMenuItem=2;
 583   5                                                              if(gs_DSP_GLOBAL_RAM.sc_EQ_Type<4)
 584   5                                                              {
 585   6                                                                      LCM_ShowEQMenu(0);
 586   6                                                                      LCM_ShowEQMenu(1);
 587   6                                                                      LCM_ShowEQMenu(2);
 588   6                                                                      LCM_ShowEQMenu(3);
 589   6                                                              }
 590   5                                                              else
 591   5                                                              {
 592   6                                                                      LCM_ShowEQMenu(4);
 593   6                                                                      LCM_ShowEQMenu(5);
 594   6                                                                      LCM_erase_one_page(4);
 595   6                                                                      LCM_erase_one_page(5);
 596   6                                                                      LCM_erase_one_page(6);
 597   6                                                                      LCM_erase_one_page(7);
 598   6                                                              }
 599   5                                                      }
 600   4                                                      else if(gc_WAVPlayMenuNum==1)   // A-B
 601   4                                                      {
 602   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
 603   5                                                              gc_MenuTimer=0;
 604   5                                                      }
 605   4                                                      else    // Exit
 606   4                                                      {
 607   5                                                              gc_MenuTimer=0;
 608   5                                                      }
 609   4                                              }
 610   3                                              else if(gc_WAVMenuItem==2)      // Confirm EQ
 611   3                                              {
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 11  

 612   4                                                      gc_MenuTimer=0;
 613   4                                                      LCM_ShowEQIcon();
 614   4                                              }
 615   3                                              else    // Exit
 616   3                                              {
 617   4                                                      gc_MenuTimer=0;
 618   4                                              }
 619   3                                      break;
 620   3      
 621   3                                      case 0x12:      // L-Play
 622   3                                              gc_Task_Current=C_Task_Suspend;
 623   3                                      break;
 624   3      
 625   3                                      case 0x13:      // L-Next
 626   3                                              gb_ADJ=0;
 627   3                                              WAVE_FF_FR();
 628   3                                      break;
 629   3      
 630   3                                      case 0x14:      // L-Prev
 631   3                                              gb_ADJ=1;
 632   3                                              WAVE_FF_FR();
 633   3                                      break;
 634   3      
 635   3                                      case 0x16:      // L-M
 636   3                                              gc_Task_Current=C_Task_Idle;
 637   3                                              gc_LastCard=gc_CurrentCard;
 638   3                                      break;
 639   3                              }               
 640   2                      break;
 641   2      
 642   2                      case TASK_PHASE_FASTFWD:
 643   2                      case TASK_PHASE_FASTREV:
 644   2                              switch(gc_KeyEvent)
 645   2                              {
 646   3                                      case 0x13:      // L-Next
 647   3                                      case 0x14:      // L-Prev
 648   3                                              WAVE_FF_FR();
 649   3                                      break;
 650   3      
 651   3                                      case 0x23:      // R-Next
 652   3                                      case 0x24:      // R-Prev
 653   3                                              IMA_ADPCM_seek_trig();
 654   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
 655   3                                      break;
 656   3                              }
 657   2                      break;
 658   2      
 659   2                      case TASK_PHASE_PAUSE:
 660   2                      case TASK_PHASE_STOP:
 661   2                              switch(gc_KeyEvent)
 662   2                              {
 663   3                                      case 0x02://C_PlayPause:
 664   3                                              IMA_ADPCM_Play_ResumeCmd();
 665   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
 666   3                                              LCM_ShowPlayPauseIcon();
 667   3                                              gc_ShowTimer=0;
 668   3                                      break;
 669   3      
 670   3                                      case 0x03:      // Next
 671   3                                              if(gc_WAVMenuItem==0)   // 1=WAV-Menu  2=EQ-Mode
 672   3                                              {
 673   4                                                      ClearIRNumberVariable();
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 12  

 674   4                                                      if(gb_SetVol)
 675   4                                                      {
 676   5                                                              gb_ADJ=0;
 677   5                                                              VOL_Adj();
 678   5                                                      }
 679   4                                                      else
 680   4                                                      {
 681   5                                                              if(gs_System_State.c_Phase==TASK_PHASE_PAUSE)
 682   5                                                              {
 683   6                                                                      IMA_ADPCM_Play_StopCmd();
 684   6                                                                      gs_System_State.c_Phase=TASK_PHASE_STOP;
 685   6                                                              }
 686   5                                                              gb_PlayNewWave=1;
 687   5                                                              DOS_Search_File(C_File_OneDir|C_By_Name,C_RecordFileType,C_CmpExtName|C_Next);
 688   5                                                      }
 689   4                                              }
 690   3                                      break;
 691   3      
 692   3                                      case 0x04:      // Prev
 693   3                                              if(gc_WAVMenuItem==0)   // 1=WAV-Menu  2=EQ-Mode
 694   3                                              {
 695   4                                                      ClearIRNumberVariable();
 696   4                                                      if(gb_SetVol)
 697   4                                                      {
 698   5                                                              gb_ADJ=1;
 699   5                                                              VOL_Adj();
 700   5                                                      }
 701   4                                                      else
 702   4                                                      {               
 703   5                                                              if(gs_System_State.c_Phase==TASK_PHASE_PAUSE)
 704   5                                                              {
 705   6                                                                      IMA_ADPCM_Play_StopCmd();
 706   6                                                                      gs_System_State.c_Phase=TASK_PHASE_STOP;
 707   6                                                              }
 708   5                                                              gb_PlayNewWave=1;
 709   5                                                              DOS_Search_File(C_File_OneDir|C_By_Name,C_RecordFileType,C_CmpExtName|C_Prev);
 710   5                                                      }
 711   4                                              }
 712   3                                      break;
 713   3      
 714   3                                      case 0x05:      // V
 715   3                                              if(gc_WAVMenuItem==0)
 716   3                                              {
 717   4                                                      gb_SetVol=1;
 718   4                                                      gc_MenuTimer=6;
 719   4                                                      LCM_Clear_L2_L5();
 720   4                                                      LCM_ShowVOL();
 721   4                                                      ClearIRNumberVariable();
 722   4                                              }
 723   3                                              else
 724   3                                              {
 725   4                                                      gc_MenuTimer=0;
 726   4                                              }
 727   3                                      break;
 728   3      
 729   3                                      case 0x12:      // L-Play
 730   3                                              gc_Task_Current=C_Task_Suspend;
 731   3                                      break;
 732   3      
 733   3                                      case 0x16:      // L-M
 734   3                                              gc_Task_Current=C_Task_Idle;
 735   3                                              gc_LastCard=gc_CurrentCard;
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 13  

 736   3                                      break;
 737   3                              }
 738   2                      break;
 739   2              }
 740   1      }
 741          
 742          void WAV_SourceDetect_Process(void)
 743          {
 744   1              switch(gc_CurrentCard)
 745   1              {
 746   2                      case 2: // SD
 747   2                              if(gb_SD_pin==0)        // SD Present
 748   2                              {
 749   3                                      if(gb_Host_Exist==0)
 750   3                                      {
 751   4                                              if(Host_DetectDevice()==0)      // Host Insert, Change to Host
 752   4                                              {
 753   5                                                      IMA_ADPCM_Play_StopCmd();
 754   5                                                      gb_Host_Exist=1;
 755   5                                                      gc_CurrentCard=5;
 756   5                                                      gb_ChangeMedia=1;
 757   5                                              }
 758   4                                      }
 759   3                                      else
 760   3                                      {
 761   4                                              if(Host_DetectDevice()==1)
 762   4                                              {
 763   5                                                      gb_Host_Exist=0;
 764   5                                                      gb_SDNoFileflag=0;
 765   5                                              }
 766   4                                      }
 767   3                              }
 768   2                              else                            // SD Remove
 769   2                              {
 770   3                                      IMA_ADPCM_Play_StopCmd();
 771   3                                      gb_SD_Exist=0;
 772   3                                      gb_SDNoFileflag=0;
 773   3                                      if(gb_Host_Exist==1)
 774   3                                      {
 775   4                                              gc_CurrentCard=5;
 776   4                                              gb_ChangeMedia=1;
 777   4                                      }
 778   3                                      else
 779   3                                      {
 780   4                                              gc_CurrentCard=9;
 781   4                                      }
 782   3                              }
 783   2                      break;
 784   2      
 785   2                      case 5: // Host
 786   2                              if(Host_DetectDevice()==0)      // Host Present
 787   2                              {
 788   3                                      if(gb_SD_Exist==0)
 789   3                                      {
 790   4                                              if(gb_SD_pin==0)        // SD Insert, Change to SD
 791   4                                              {       
 792   5                                                      IMA_ADPCM_Play_StopCmd();
 793   5                                                      gb_SD_Exist=1;
 794   5                                                      gc_CurrentCard=2;
 795   5                                                      gb_ChangeMedia=1;       
 796   5                                              }
 797   4                                      }
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 14  

 798   3                                      else
 799   3                                      {
 800   4                                              if(gb_SD_pin==1)
 801   4                                              {
 802   5                                                      gb_SD_Exist=0;
 803   5                                                      gb_SDNoFileflag=0;
 804   5                                              }
 805   4                                      }
 806   3                              }
 807   2                              else                            // Host Remove
 808   2                              {
 809   3                                      IMA_ADPCM_Play_StopCmd();
 810   3                                      gb_Host_Exist=0;
 811   3                                      gb_HostNoFileflag=0;
 812   3                                      if(gb_SD_Exist==1)
 813   3                                      {
 814   4                                              gc_CurrentCard=2;
 815   4                                              gb_ChangeMedia=1;
 816   4                                      }
 817   3                                      else
 818   3                                      {
 819   4                                              gc_CurrentCard=9;
 820   4                                      }
 821   3                              }
 822   2                      break;
 823   2              }
 824   1      }
 825          
 826          void WAVE_FF_FR(void)
 827          {
 828   1              gc_LongKeyCount=30;
 829   1              if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
 830   1              {  
 831   2                  if(gb_ADJ==0)
 832   2                  {// play_fastfwd
 833   3                          gs_System_State.c_Phase=TASK_PHASE_FASTFWD;
 834   3                  }
 835   2                  else
 836   2                  {// play_fastrev
 837   3                          gs_System_State.c_Phase=TASK_PHASE_FASTREV;
 838   3                  }
 839   2      
 840   2                      gw_CurrentSec=IMA_ADPCM_Play_ReadTime();
 841   2                      IMA_ADPCM_Play_FF_FR_Cmd();
 842   2              }
 843   1              else if(gs_System_State.c_Phase==TASK_PHASE_FASTFWD)
 844   1              {       
 845   2                      if(gw_CurrentSec<gw_TotalSec)
 846   2                      {
 847   3                              gw_CurrentSec+=1;
 848   3                      }
 849   2              }
 850   1              else if(gs_System_State.c_Phase==TASK_PHASE_FASTREV)
 851   1              {       
 852   2                      if(gw_CurrentSec!=0)
 853   2                      {
 854   3                              gw_CurrentSec-=1;
 855   3                      }
 856   2              }
 857   1              LCM_ShowPlayTime(gw_CurrentSec);
 858   1      }
 859          
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 15  

 860          U8 IMA_ADPCM_Play_FF_FR_Cmd(void)
 861          {
 862   1              data    U8      tc_Ret;
 863   1              data    U16     TimeOUT;
 864   1              xdata   U16 temp;
 865   1      
 866   1              tc_Ret=DSP_PauseCmd();
 867   1              TimeOUT=0xFFFF;
 868   1              do
 869   1              {
 870   2                      TimeOUT --;
 871   2                      if(TimeOUT==0)
 872   2                      {
 873   3                              return DSP_RUNNING_STATUS1_ERROR;
 874   3                      }
 875   2              } while(!(L2_DSP_Read_DMem16(DSP_RunningStatus)&0x0002));
 876   1      
 877   1              temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 878   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,temp&0xFF3F);
 879   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,0);                                //Jimi 081127, ycc081204
 880   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3000);                    //Jimi 081127, ycc081204
 881   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;                                                //Jimi 081127, ycc081204
 882   1      
 883   1              return tc_Ret;
 884   1      }
 885          
 886          U8 IMA_ADPCM_seek_trig(void)
 887          {
 888   1              xdata   U32     tdw_datapoint;
 889   1      
 890   1              DOS_Open_File_r(C_RecordFHandle,C_Open_FoundFile,C_NullFileName);
 891   1              gs_File_FCB[1].dw_File_CurrentCluster=gs_File_FCB[1].dw_File_StartCluster;
 892   1              tdw_datapoint=gw_CurrentSec*((gs_File_FCB[1].dw_File_TotalSize-60)/gw_TotalSec)+60;
 893   1              gs_File_FCB[1].dw_File_CurrentCluster=DOS_Seek_File(1,tdw_datapoint>>9);
 894   1      
 895   1              //Jimi 110111
 896   1              L2_DSP_Write_DMem16(DSP_DecodeFrameCounter,0);
 897   1      
 898   1              while((L2_DSP_Read_DMem16(DSP_EmptyBuffer)*2/3)>=ONE_SECTOR)                    // jimiyu 081117
 899   1              {
 900   2                      if(DOS_Read_File(1)==DOS_END_OF_FILE)
 901   2                      {
 902   3                              return DSP_DATAIN_COMMAND_ERROR;
 903   3                      }
 904   2      
 905   2                      L2_DSP_MCU_DM_DMA_16bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
 906   2                      L2_DSP_SendCommandSet(DCMD_DatIn);
 907   2                      if(gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
 908   2                      {
 909   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
 910   3                      }
 911   2              }
 912   1      
 913   1              L2_DSP_Write_DMem16(0x3F55,L2_DSP_Read_DMem16(0x3F55)&~0x0508); //clear bit[10],bit[8],bit[3]
 914   1              L2_DSP_Write_DMem16(0x3F57,0);
 915   1              L2_DSP_Write_DMem16(0x3F50,0x201E);
 916   1              L2_DSP_Write_DMem16(0x3F21,L2_DSP_Read_DMem16(0x3F21)-90);
 917   1              L2_DSP_Write_DMem16(0x3F22,L2_DSP_Read_DMem16(0x3F22)+90);
 918   1      
 919   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
 920   1              {
 921   2                      return DSP_PLAY_COMMAND_ERROR;
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 16  

 922   2              }
 923   1              return 0;
 924   1      }
 925          
 926          U8 IMA_ADPCM_EOF_Proc(void)
 927          {                                               
 928   1              data    U16 tw_BufRem;
 929   1              xdata   U16 tw_RampDownBufSz;
 930   1      
 931   1              tw_BufRem=L2_DSP_Read_DMem16(DSP_RemainBuffer)*2/3;                     // jimiyu 081117
 932   1              tw_RampDownBufSz=(U16)(((U32)gs_System_State.w_SampleRate*1000)/8/2);   // 0.5 sec for ramp down
 933   1      
 934   1              if(tw_RampDownBufSz<512 )               //for 8k bitrate condition(M2L3 & M2.5L3)
 935   1              {
 936   2                      tw_RampDownBufSz=512;
 937   2              }
 938   1              
 939   1              if((tw_BufRem<tw_RampDownBufSz)||(gs_File_FCB[1].dw_File_TotalSize==0)) //Ching 090116
 940   1              {
 941   2                      return 1;
 942   2              }
 943   1              
 944   1              return 0;
 945   1      }
 946          
 947          U8 IMA_ADPCM_Repeat_DataIn(void)
 948          {
 949   1              xdata   U16     temp;
 950   1              data    U16     TimeOUT=0xFFFF;
 951   1      
 952   1              while((L2_DSP_Read_DMem16(DSP_EmptyBuffer)*2/3)>=ONE_SECTOR)
 953   1              {
 954   2                      if(DOS_Read_File(1)==DOS_END_OF_FILE)
 955   2                      {
 956   3                              return DSP_DATAIN_COMMAND_ERROR;
 957   3                      }
 958   2      
 959   2                      L2_DSP_MCU_DM_DMA_16bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
 960   2                      L2_DSP_SendCommandSet(DCMD_DatIn);
 961   2                      if(gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
 962   2                      {
 963   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
 964   3                      }
 965   2              }
 966   1      
 967   1      
 968   1              if(L2_DSP_SendCommandSet(DCMD_Pause)!=DCMD_Pause)
 969   1              {
 970   2                      return DSP_PAUSE_COMMAND_ERROR;
 971   2              }
 972   1      
 973   1              do
 974   1              {
 975   2                      TimeOUT--;
 976   2                      if (TimeOUT == 0)
 977   2                      {
 978   3                              return DSP_RUNNING_STATUS1_ERROR;
 979   3                      }
 980   2              } while(!(L2_DSP_Read_DMem16(DSP_RunningStatus)&0x0002));
 981   1      
 982   1              temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 983   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,temp&0xFF3F);
C51 COMPILER V9.00   WAVE_FUNC                                                             07/09/2012 21:16:55 PAGE 17  

 984   1      
 985   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,0);
 986   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3000);
 987   1              L2_DSP_Write_DMem16(DSP_DecodeFrameCounter,gw_AFrameCnt);
 988   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
 989   1      
 990   1              if(gs_DSP_GLOBAL_RAM.sdw_File_ACluster==0xFFFFFFFF)
 991   1              {       // recalculate cluster location
 992   2                      gs_File_FCB[1].dw_File_DataPoint=0;
 993   2                      gs_File_FCB[1].dw_File_CurrentCluster=gs_File_FCB[1].dw_File_StartCluster;
 994   2                      gs_DSP_GLOBAL_RAM.sdw_File_ACluster=DOS_Seek_File(1,gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint>>9);
 995   2              }
 996   1              gs_File_FCB[1].dw_File_CurrentCluster=gs_DSP_GLOBAL_RAM.sdw_File_ACluster;
 997   1              gs_File_FCB[1].dw_File_DataPoint=gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint;
 998   1      
 999   1              while((L2_DSP_Read_DMem16(DSP_EmptyBuffer)*2/3)>=ONE_SECTOR)
1000   1              {
1001   2                      if(DOS_Read_File(1)==DOS_END_OF_FILE)
1002   2                      {
1003   3                              return DSP_DATAIN_COMMAND_ERROR;
1004   3                      }
1005   2      
1006   2                      L2_DSP_MCU_DM_DMA_16bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
1007   2                      L2_DSP_SendCommandSet(DCMD_DatIn);
1008   2                      if(gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
1009   2                      {
1010   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
1011   3                      }
1012   2              }
1013   1      
1014   1              L2_DSP_Write_DMem16(0x3F55,L2_DSP_Read_DMem16(0x3F55)&~0x0508); //clear bit[10],bit[8],bit[3]
1015   1              L2_DSP_Write_DMem16(0x3F57,0);
1016   1              L2_DSP_Write_DMem16(0x3F50,0x201E);
1017   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,L2_DSP_Read_DMem16(DSP_RemainBuffer)-90);
1018   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,L2_DSP_Read_DMem16(DSP_EmptyBuffer)+90);
1019   1      
1020   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
1021   1              {
1022   2                      return DSP_PLAY_COMMAND_ERROR;
1023   2              }
1024   1      
1025   1              return  0;
1026   1      }
1027          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3153    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      24
   IDATA SIZE       =   ----      42
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
