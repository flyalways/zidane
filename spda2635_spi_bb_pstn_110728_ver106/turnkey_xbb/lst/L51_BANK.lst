A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     1


MACRO ASSEMBLER A51 V8.01
OBJECT MODULE PLACED IN .\obj\L51_BANK.obj
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE ASM\L51_BANK.A51 SET(LARGE) DEBUG PRINT(.\lst\L51_BANK.lst) OBJECT(.\obj\L
                      51_BANK.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     
                       2     $nomod51  NOLINES
                       3     $nocond 
                       4     
  00B0                 5     P3      EQU     0B0H
  0084                 6     DPL1    EQU     084H
  0085                 7     DPH1    EQU     085H
  0086                 8     DPS     EQU     086H
  00A8                 9     IE      EQU     0A8H
  00AF                10     EA      EQU     0A8H.7
  00E0                11     ACC     EQU     0E0H
  008D                12     TH1     EQU     08DH
                      13     ;************************ Configuration Section *******************************
  0020                14     ?B_NBANKS       EQU  32   ; Define max. Number of Banks                       *
                      15     ;                         ; The following values are allowed: 2, 4, 8, 16, 32 *
                      16     ;                         ; the max. value for ?B_BANKS is 32                 *
                      17     ;                                                                             *
  0000                18     ?B_MODE         EQU  0    ; 0 for Bank-Switching via 8051 Port                *
                      19     ;                         ; 1 for Bank-Switching via XDATA Port               *
                      20     ;                         ; 4 for user-provided bank switch code              *
                      21     ;                                                                             *
  0000                22     ?B_RTX          EQU  0    ; 0 for applications without RTX-51 FULL            *
                      23     ;                         ; 1 for applications using RTX-51 FULL              *
                      24     ;                                                                             *
  0000                25     ?B_VAR_BANKING  EQU  0    ; Enable Variable Banking in XDATA and CODE memory  *
                      26     ;                         ; 0 Variable Banking is disabled                    *
                      27     ;                         ; 1 XDATA and CODE banking with same address lines  *
                      28     ;                         ; 2 XDATA uses a different banking port             *
                      29     ;                                                                             *
  009A                30     ROMPAGE         DATA    9AH      ; I/O Port Address                           *
                      31     
                             ENDIF;                                                                        *
                      46     ;                                                                             *
                      47     ;-----------------------------------------------------------------------------*
                      48     ; if ?BANK?MODE is 0 define the following values                              *
                      49     ; For Bank-Switching via 8051 Port define Port Address / Bits                 *
                      50     ;                                                                             *            
                                                                                         
  009A                51     ?B_PORT         EQU     ROMPAGE  ; default is P1                              *
  0000                52     ?B_FIRSTBIT     EQU     0        ; default is Bit 0                           *
                      53     ;-----------------------------------------------------------------------------*
                      54     
                      55     ;                                                                             *
                      56     ;******************************************************************************
                      57     ;                                                                             *
                      58     ; THEORY OF OPERATION                                                         *
                      59     ; -------------------                                                         *
                      60     ; The section below describes the code generated by BL51 or L251 and the      *
                      61     ; operation of the L51_BANK.A51 module.  BL51/L251 generates for each         *
                      62     ; function that is located in a code memory bank and called from the common   *
                      63     ; area or a different code bank and entry into the INTRABANK CALL TABLE.  The *
                      64     ; INTRABANK CALL TABLE is located in the SEGMENT ?BANK?SELECT and listed in   *
                      65     ; the Linker MAP file. The entries in that TABLE have the following format:   *
                      66     ;                                                                             *
                      67     ;   ?FCT?1:  MOV  DPTR,#FCT     ; Load Address of target FCT                  *
                      68     ;            JMP  ?B_BANKn      ; Switch to Bank and Jump to Target Code      *
                      69     ;                                                                             *
A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     2

                      70     ; Instead of directly calling the function FCT, the Linker changes the entry  *
                      71     ; to ?FCT?1.  This entry selects the bank where the function FCT is located   *
                      72     ; and calls that function via the routines defined in this L51_BANK.A51 file. *
                      73     ; The L51_BANK.A51 file contains two sets of functions for each bank:         *
                      74     ;                                                                             *
                      75     ; ?B_BANKn    is a routine which saves the entry of the ?B_SWITCHn function   *
                      76     ;             for the current active bank on the STACK and switches to the    *
                      77     ;             bank 'n'.  Then it jumps to the address specified by the DPTR   *
                      78     ;             register.  It is allowed to modify the following registers in   *
                      79     ;             the ?B_BANKn routine:  A, B, R0, DPTR, PSW                      *
                      80     ;                                                                             *
                      81     ; ?B_SWITCHn  is a function which selects the bank 'n'.  This function is     *
                      82     ;             used at the end of a user function to return to the calling     *
                      83     ;             code bank.  Only the following registers may be altered in the  *
                      84     ;             ?B_SWITCHn function:  R0, DPTR                                  *
                      85     ;                                                                             *
                      86     ; The current active bank is stored in ?B_CURRENTBANK.  RTX-51 uses this      *
                      87     ; variable to restore the code bank after a task switch.  To get correct      *
                      88     ; results, ?B_CURRENTBANK must be set to the code bank before the hardware    *
                      89     ; switch is done, or the code banking sequences must be interrupt protected.  *
                      90     ;******************************************************************************
                      91     
                      92                     NAME    ?BANK?SWITCHING
                      93     
                      94                     PUBLIC  ?B_NBANKS
                      95     
                      96     ; Standard SFR Symbols required in L51_BANK.A51
                      97     
                      98     ;EXTRN DATA (gc_bank_status, gc_bank_number)
                      99     EXTRN CODE (perform_nand_bank_call)
                     100     ;;==============MACRO===================
                     101     SELECT          MACRO   N
                     102                     PUBLIC  ?B_BANK&N
                     103     ?B_BANK&N:   
                     104                             mov     A,#0N
                     105                     jmp     ?B_SWITCH&N
                     106                     ENDM
                     107     
                     108     ;;==============BANK SELECT=============
                     109     ?BANK?SELECT    SEGMENT  CODE ;INBLOCK
                     110     
----                 111                     RSEG    ?BANK?SELECT
  0000               112     CNT             SET     0
                     113     
                     114                     REPT    ?B_NBANKS
                     115                     SELECT  %CNT
                     116     CNT             SET     CNT+1
                     117                     ENDM
                     118+1                   SELECT  %CNT
                     124+1                   SELECT  %CNT
                     130+1                   SELECT  %CNT
                     136+1                   SELECT  %CNT
                     142+1                   SELECT  %CNT
                     148+1                   SELECT  %CNT
                     154+1                   SELECT  %CNT
                     160+1                   SELECT  %CNT
                     166+1                   SELECT  %CNT
                     172+1                   SELECT  %CNT
                     178+1                   SELECT  %CNT
                     184+1                   SELECT  %CNT
                     190+1                   SELECT  %CNT
                     196+1                   SELECT  %CNT
                     202+1                   SELECT  %CNT
                     208+1                   SELECT  %CNT
                     214+1                   SELECT  %CNT
                     220+1                   SELECT  %CNT
A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     3

                     226+1                   SELECT  %CNT
                     232+1                   SELECT  %CNT
                     238+1                   SELECT  %CNT
                     244+1                   SELECT  %CNT
                     250+1                   SELECT  %CNT
                     256+1                   SELECT  %CNT
                     262+1                   SELECT  %CNT
                     268+1                   SELECT  %CNT
                     274+1                   SELECT  %CNT
                     280+1                   SELECT  %CNT
                     286+1                   SELECT  %CNT
                     292+1                   SELECT  %CNT
                     298+1                   SELECT  %CNT
                     304+1                   SELECT  %CNT
                     310     ;;======================================
                     311     ;;==============MACRO===================
                     312     SWITCH          MACRO   N
                     313                     ORG     1;N * 8
                     314                     PUBLIC  ?B_SWITCH&N
                     315     ?B_SWITCH&N:  
                     316                     jmp     perform_nand_bank_call
                     317                     ENDM
                     318     
                     319     ;;==============BANK SWITCH=============                        
                     320     ?BANK?SWITCH    SEGMENT  CODE  
                     321     
----                 322                     RSEG    ?BANK?SWITCH
  0000               323     CNT             SET     0
                     324     
                     325                     REPT    ?B_NBANKS
                     326                     SWITCH  %CNT
                     327     CNT             SET     CNT+1
                     328                     ENDM
                     329+1                   SWITCH  %CNT
                     335+1                   SWITCH  %CNT
                     341+1                   SWITCH  %CNT
                     347+1                   SWITCH  %CNT
                     353+1                   SWITCH  %CNT
                     359+1                   SWITCH  %CNT
                     365+1                   SWITCH  %CNT
                     371+1                   SWITCH  %CNT
                     377+1                   SWITCH  %CNT
                     383+1                   SWITCH  %CNT
                     389+1                   SWITCH  %CNT
                     395+1                   SWITCH  %CNT
                     401+1                   SWITCH  %CNT
                     407+1                   SWITCH  %CNT
                     413+1                   SWITCH  %CNT
                     419+1                   SWITCH  %CNT
                     425+1                   SWITCH  %CNT
                     431+1                   SWITCH  %CNT
                     437+1                   SWITCH  %CNT
                     443+1                   SWITCH  %CNT
                     449+1                   SWITCH  %CNT
                     455+1                   SWITCH  %CNT
                     461+1                   SWITCH  %CNT
                     467+1                   SWITCH  %CNT
                     473+1                   SWITCH  %CNT
                     479+1                   SWITCH  %CNT
                     485+1                   SWITCH  %CNT
                     491+1                   SWITCH  %CNT
                     497+1                   SWITCH  %CNT
                     503+1                   SWITCH  %CNT
                     509+1                   SWITCH  %CNT
                     515+1                   SWITCH  %CNT
                     521     ;;======================================
A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     4

                     522     
A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E                 T Y P E  V A L U E   ATTRIBUTES

?BANK?SELECT . . . . .  C SEG    00A0H       REL=UNIT
?BANK?SWITCH . . . . .  C SEG    0004H       REL=UNIT
?BANK?SWITCHING. . . .  N NUMB   -----       
?B_BANK0 . . . . . . .  C ADDR   0000H   R   SEG=?BANK?SELECT
?B_BANK1 . . . . . . .  C ADDR   0005H   R   SEG=?BANK?SELECT
?B_BANK10. . . . . . .  C ADDR   0032H   R   SEG=?BANK?SELECT
?B_BANK11. . . . . . .  C ADDR   0037H   R   SEG=?BANK?SELECT
?B_BANK12. . . . . . .  C ADDR   003CH   R   SEG=?BANK?SELECT
?B_BANK13. . . . . . .  C ADDR   0041H   R   SEG=?BANK?SELECT
?B_BANK14. . . . . . .  C ADDR   0046H   R   SEG=?BANK?SELECT
?B_BANK15. . . . . . .  C ADDR   004BH   R   SEG=?BANK?SELECT
?B_BANK16. . . . . . .  C ADDR   0050H   R   SEG=?BANK?SELECT
?B_BANK17. . . . . . .  C ADDR   0055H   R   SEG=?BANK?SELECT
?B_BANK18. . . . . . .  C ADDR   005AH   R   SEG=?BANK?SELECT
?B_BANK19. . . . . . .  C ADDR   005FH   R   SEG=?BANK?SELECT
?B_BANK2 . . . . . . .  C ADDR   000AH   R   SEG=?BANK?SELECT
?B_BANK20. . . . . . .  C ADDR   0064H   R   SEG=?BANK?SELECT
?B_BANK21. . . . . . .  C ADDR   0069H   R   SEG=?BANK?SELECT
?B_BANK22. . . . . . .  C ADDR   006EH   R   SEG=?BANK?SELECT
?B_BANK23. . . . . . .  C ADDR   0073H   R   SEG=?BANK?SELECT
?B_BANK24. . . . . . .  C ADDR   0078H   R   SEG=?BANK?SELECT
?B_BANK25. . . . . . .  C ADDR   007DH   R   SEG=?BANK?SELECT
?B_BANK26. . . . . . .  C ADDR   0082H   R   SEG=?BANK?SELECT
?B_BANK27. . . . . . .  C ADDR   0087H   R   SEG=?BANK?SELECT
?B_BANK28. . . . . . .  C ADDR   008CH   R   SEG=?BANK?SELECT
?B_BANK29. . . . . . .  C ADDR   0091H   R   SEG=?BANK?SELECT
?B_BANK3 . . . . . . .  C ADDR   000FH   R   SEG=?BANK?SELECT
?B_BANK30. . . . . . .  C ADDR   0096H   R   SEG=?BANK?SELECT
?B_BANK31. . . . . . .  C ADDR   009BH   R   SEG=?BANK?SELECT
?B_BANK4 . . . . . . .  C ADDR   0014H   R   SEG=?BANK?SELECT
?B_BANK5 . . . . . . .  C ADDR   0019H   R   SEG=?BANK?SELECT
?B_BANK6 . . . . . . .  C ADDR   001EH   R   SEG=?BANK?SELECT
?B_BANK7 . . . . . . .  C ADDR   0023H   R   SEG=?BANK?SELECT
?B_BANK8 . . . . . . .  C ADDR   0028H   R   SEG=?BANK?SELECT
?B_BANK9 . . . . . . .  C ADDR   002DH   R   SEG=?BANK?SELECT
?B_FIRSTBIT. . . . . .  N NUMB   0000H   A   
?B_MODE. . . . . . . .  N NUMB   0000H   A   
?B_NBANKS. . . . . . .  N NUMB   0020H   A   
?B_PORT. . . . . . . .  D ADDR   009AH   A   
?B_RTX . . . . . . . .  N NUMB   0000H   A   
?B_SWITCH0 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH1 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH10. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH11. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH12. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH13. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH14. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH15. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH16. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH17. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH18. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH19. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH2 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH20. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH21. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH22. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH23. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH24. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH25. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH26. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
A51 MACRO ASSEMBLER  L51_BANK                                                             07/09/2012 21:16:43 PAGE     6

?B_SWITCH27. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH28. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH29. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH3 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH30. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH31. . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH4 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH5 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH6 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH7 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH8 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_SWITCH9 . . . . . .  C ADDR   0001H   R   SEG=?BANK?SWITCH
?B_VAR_BANKING . . . .  N NUMB   0000H   A   
ACC. . . . . . . . . .  N NUMB   00E0H   A   
CNT. . . . . . . . . .  N NUMB   0020H   A   
DPH1 . . . . . . . . .  N NUMB   0085H   A   
DPL1 . . . . . . . . .  N NUMB   0084H   A   
DPS. . . . . . . . . .  N NUMB   0086H   A   
EA . . . . . . . . . .  B ADDR   00A8H.7 A   
IE . . . . . . . . . .  N NUMB   00A8H   A   
P3 . . . . . . . . . .  N NUMB   00B0H   A   
PERFORM_NAND_BANK_CALL  C ADDR   -----       EXT
ROMPAGE. . . . . . . .  D ADDR   009AH   A   
TH1. . . . . . . . . .  N NUMB   008DH   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
