C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE PLAY_PROCESS
OBJECT MODULE PLACED IN .\obj\Play_process.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Play\Play_process.C LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsour
                    -ce\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\Play_process.lst) OBJECT(.\obj\Play_process.obj)

line level    source

   1          #include "..\header\SPDA2K.h"
   2          #include "..\DSP\DSPPHYSIC.H"
   3          #include "..\DSP\dspuser.h"
   4          #include "..\IR\remote.h"
   5          #include "..\header\host_init.h"
   6          #include "..\header\variables.h"
   7          #include "..\header\UI_config.h"
   8          #include "..\LCM\LCM_BMP.h"
   9          
  10          
  11          void Music_EQ_Cmd(void)
  12          {
  13   1          DSP_EQ_Cmd(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
  14   1          DSP_SpectrumOn();
  15   1      }
  16          
  17          
  18          U8 MP3_DataIn(void)
  19          {   
  20   1              data    U8      tc_status;
  21   1              xdata   U16     tw_SmpRateIdx;
  22   1      
  23   1              while(L2_DSP_Read_DMem16(DSP_EmptyBuffer)>=512)
  24   1          {
  25   2              tc_status=DOS_Read_File(C_MusicFHandle);
  26   2              if(tc_status == DOS_END_OF_FILE)
  27   2              {
  28   3                              L2_DSP_Write_DMem16(DSP_MP3_file_end_flag,1);
  29   3                  return DSP_DATAIN_COMMAND_ERROR;
  30   3              }
  31   2              else if(tc_status)
  32   2              {
  33   3                  return tc_status;   
  34   3              }
  35   2      
  36   2                      L2_DSP_MCU_DM_DMA_24bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
  37   2              L2_DSP_SendCommandSet(DCMD_DatIn);
  38   2              if (gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
  39   2              {
  40   3                  gs_DSP_GLOBAL_RAM.sc_DM_Index=0;  // DM Range: 0x2000 ~  0x2FFF
  41   3              }
  42   2          }
  43   1      
  44   1          tw_SmpRateIdx = L2_DSP_Read_DMem16(0x3F8E); //0x3F8E is an index of mp3 sampling rate within DSP
  45   1              if((tw_SmpRateIdx==0)||(tw_SmpRateIdx==3)||(tw_SmpRateIdx==6))
  46   1              {
  47   2                      XBYTE[0xB046]|=0x04;
  48   2              }
  49   1          else
  50   1              {
  51   2                      XBYTE[0xB046]&=~0x04; 
  52   2              }
  53   1          return  DSP_SUCCESS;
  54   1      }
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 2   

  55          
  56          
  57          U16 MP3_ReadTime(void) 
  58          {
  59   1              code    U16     SampleRate[4][3]={{11025,12000,8000},{0,0,0},{22050,24000,16000},{44100,48000,32000}};
  60   1              data    U8      tc_SampleRate;
  61   1              data    U8      tc_MPEG_Type;
  62   1              data    U8      tc_Layer;
  63   1              data    U16 tw_DurTime;
  64   1              data    U16 tw_SamplePerFrame;
  65   1              xdata   U32 tdw_Mpeg_Status;
  66   1              xdata   U32 tdw_FrameCnt;
  67   1      
  68   1              tdw_Mpeg_Status=L2_DSP_Read_DMem24(DSP_MPEGSt);
  69   1              tdw_FrameCnt=L2_DSP_Read_DMem24(DSP_DecodeFrameCounter);
  70   1              tc_SampleRate=((U8)(tdw_Mpeg_Status>>5)&0x03);
  71   1              tc_MPEG_Type=((U8)(tdw_Mpeg_Status>>(14+8))&0x03);
  72   1              tc_Layer=((U8)(tdw_Mpeg_Status>>(12+8))&0x03);
  73   1      
  74   1              if(tdw_FrameCnt>0x20)
  75   1              {
  76   2                      if(tc_Layer==0x03) //layer-I, reference ISO/IEC 11172-3 header description
  77   2                      {
  78   3                              tw_SamplePerFrame=384;
  79   3                      }
  80   2                      else if((tc_MPEG_Type!=0x03)&&(tc_Layer==0x01))  
  81   2                      {
  82   3                              tw_SamplePerFrame=576; 
  83   3                      }
  84   2                      else
  85   2                      {
  86   3                              tw_SamplePerFrame=1152;
  87   3                      }
  88   2          
  89   2                      if(tc_MPEG_Type!=0x01)
  90   2                      {
  91   3                              tw_DurTime=gw_CurrentSec+tdw_FrameCnt*tw_SamplePerFrame/SampleRate[tc_MPEG_Type][tc_SampleRate];
  92   3                      }
  93   2                      else
  94   2                      {
  95   3                              tw_DurTime=0;
  96   3                      }
  97   2              }
  98   1              else//(JC)min ~32 frames -> 1sec
  99   1              {
 100   2                      tw_DurTime=gw_CurrentSec;
 101   2              }
 102   1      
 103   1              return tw_DurTime;
 104   1      }
 105          
 106          U8 MP3_EOF_Proc(void)
 107          {                       
 108   1              data    U16 tw_BufRem;
 109   1              data    U16 tw_RampDownBufSz;
 110   1              data    U16 tw_dec_bsbuf_rem;
 111   1              
 112   1              L2_DSP_Write_DMem16(0x3F44,8000);       //Jimi 100517, enlarge DSP MP3 decoder ramp down step
 113   1              L2_DSP_Write_DMem16(0x3F45,8000);
 114   1              
 115   1              tw_BufRem = L2_DSP_Read_DMem16(DSP_RemainBuffer);
 116   1              tw_RampDownBufSz =(U16)(((U32)gs_System_State.w_SampleRate * 1000 )/8/20);  // 0.05 sec for ramp down
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 3   

 117   1              tw_dec_bsbuf_rem = L2_DSP_Read_DMem16(DSP_MP3_dec_bsbuf_rem);   //Jimi 091126
 118   1      
 119   1              if(tw_RampDownBufSz<512)     //for 8k bitrate condition(M2L3 & M2.5L3)
 120   1              {
 121   2                      tw_RampDownBufSz=512;
 122   2              }
 123   1          
 124   1              if(tw_BufRem<tw_RampDownBufSz)
 125   1              {
 126   2                      if(L2_DSP_Read_DMem16(DSP_RampDownComplete) == 0)       //(Jimi 091126)RampDownOK == 0
 127   2                      {
 128   3                              if(tw_dec_bsbuf_rem < tw_RampDownBufSz) //Jimi 100629, 0x3FB5: RampDownFlag
 129   3                              {
 130   4                                      return 1;
 131   4                              }
 132   3                      }
 133   2                      else
 134   2                      {       
 135   3                              return 1;
 136   3                      }
 137   2              }
 138   1          
 139   1              return 0;
 140   1      }
 141          
 142          
 143          U8 WMA_err_bs_proc(void)
 144          {
 145   1              data    U8      tc_iloop;
 146   1              data    U8      tc_tmp;
 147   1              xdata   U32     tdw_testcluster;
 148   1              
 149   1              tc_tmp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 150   1              if(tc_tmp&0x20) //wma format error or drm
 151   1              {
 152   2                      DSP_ResetCmd();
 153   2                      return DSP_USER_FILE_TYPE_ERROR;
 154   2              }
 155   1          
 156   1              if(tc_tmp&0xC0)
 157   1              {
 158   2                      tdw_testcluster = (gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint >> 9)+5;
 159   2                      if( tdw_testcluster >= (gs_File_FCB[gs_System_State.c_FileHandle].dw_File_TotalSize >> 9) )
 160   2                      {
 161   3                              return DSP_RUNNING_STATUS1_ERROR;
 162   3                      }
 163   2      
 164   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster =gs_File_FCB[gs_System_State.c_FileHand
             -le].dw_File_StartCluster;
 165   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint = tdw_testcluster << 9;
 166   2                      gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster = DOS_Seek_File(gs_System_State.c_FileH
             -andle,gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint>>9);
 167   2                      L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3C00);
 168   2                      L2_DSP_Write_DMem16(DSP_RemainBuffer,0x0000);   
 169   2                      gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;      
 170   2                      L2_DSP_Write_DMem24(DSP_WMASectorOffset,(gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint>>9)
             -);      
 171   2                      L2_DSP_Write_DMem16(DSP_DecodeStatus,0x0000);
 172   2                      L2_DSP_Write_DMem16(DSP_WMARandomFlag,0x0001);   //set random flag
 173   2                      tc_iloop = 0;
 174   2      
 175   2                      do
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 4   

 176   2                      {
 177   3                              if (DOS_Read_File(C_MusicFHandle) == DOS_END_OF_FILE)
 178   3                              {
 179   4                                      return DSP_DATAIN_COMMAND_ERROR;
 180   4                              }
 181   3      
 182   3                              L2_DSP_MCU_DM_DMA_24bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
 183   3                              L2_DSP_SendCommandSet(DCMD_DatIn); 
 184   3                              
 185   3                              tc_iloop ++;
 186   3                      }while(tc_iloop!=5);
 187   2              }
 188   1              return DSP_SUCCESS; 
 189   1      }
 190          
 191          
 192          U8 WMA_DataIn(void)
 193          {
 194   1              xdata   U8  tc_errbs;
 195   1              
 196   1              /* Error Bitstream Process */
 197   1              tc_errbs = WMA_err_bs_proc();
 198   1              
 199   1              if(tc_errbs == DSP_USER_FILE_TYPE_ERROR || tc_errbs == DSP_RUNNING_STATUS1_ERROR)
 200   1              {
 201   2                      return DSP_DATAIN_COMMAND_ERROR;
 202   2              }   
 203   1              
 204   1              while(L2_DSP_Read_DMem16(DSP_EmptyBuffer)>512)
 205   1              {
 206   2                      if(DOS_Read_File(0x00)==DOS_END_OF_FILE)
 207   2                      {
 208   3                              return DSP_DATAIN_COMMAND_ERROR;
 209   3                      }
 210   2                      
 211   2                      L2_DSP_MCU_DM_DMA_24bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
 212   2                      L2_DSP_SendCommandSet(DCMD_DatIn);
 213   2                      
 214   2                      if (gs_DSP_GLOBAL_RAM.sc_DM_Index >= 30)  //20090420 chiayen modify 36->30
 215   2                      {
 216   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;  // DM Range: 0x2000 ~  0x37FF
 217   3                      }
 218   2              }
 219   1              return  DSP_SUCCESS;
 220   1      }
 221          
 222          
 223          U16 WMA_ReadTime(void)
 224          {
 225   1              xdata   U32 tw_cur_time_h;
 226   1              xdata   U32 tw_cur_time;
 227   1              
 228   1              tw_cur_time_h=L2_DSP_Read_DMem24(DSP_WMACurrenTimeHigh);
 229   1              tw_cur_time=L2_DSP_Read_DMem24(DSP_WMACurrenTimeLow)+(tw_cur_time_h<<24);
 230   1              
 231   1              return(tw_cur_time/1000);    
 232   1      }
 233          
 234          
 235          U8 WMA_EOF_Proc(void)
 236          {    
 237   1              data    U8  tc_wma_eof_cnt=0;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 5   

 238   1              data    U16     tw_DSP_RemainBufPrev=0;
 239   1              xdata   U16     tw_bs_buf_remain;
 240   1              xdata   U16     tw_DSP_dec_status;
 241   1              xdata   U16     tw_RampDownBufSz;
 242   1              
 243   1              tw_bs_buf_remain=L2_DSP_Read_DMem16(DSP_RemainBuffer);
 244   1              tw_RampDownBufSz=(U16)(((U32)gs_System_State.w_SampleRate*1000)/8/2);  // 0.5 sec for ramp down
 245   1      
 246   1              if(tw_bs_buf_remain<=tw_RampDownBufSz)
 247   1              {
 248   2                      return 1;
 249   2              }
 250   1              
 251   1              if(tw_bs_buf_remain==tw_DSP_RemainBufPrev)
 252   1              {
 253   2                      tc_wma_eof_cnt++;
 254   2              }   
 255   1              else
 256   1              {
 257   2                      tw_DSP_RemainBufPrev=tw_bs_buf_remain;
 258   2                      tc_wma_eof_cnt=0;
 259   2              }    
 260   1              tw_DSP_dec_status = L2_DSP_Read_DMem16(DSP_DecodeStatus) & 0xC0;
 261   1              
 262   1              if( tw_DSP_dec_status || (tc_wma_eof_cnt >=10) )
 263   1              {
 264   2                      L2_DSP_Write_DMem16(DSP_DecodeStatus, tw_DSP_dec_status|0xC0 );//為了避免之後的play_stop hang住
 265   2                      return 1;
 266   2              }
 267   1          
 268   1              return 0;   
 269   1      }
 270          
 271          
 272          U8 Music_PlayCmd(void)
 273          {
 274   1              // sent "PLAY" command to DSP
 275   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
 276   1              {
 277   2                      return DSP_PLAY_COMMAND_ERROR;
 278   2              }
 279   1              
 280   1              if(gc_Play_FileType==0) //(Jimi 091028)wma do not need to reset bitstream address cuz the asf parser is c
             -ontiguous to wma decoder 
 281   1              {
 282   2                      gs_DSP_GLOBAL_RAM.sc_DM_Index=0;  // reset bitstream address of DM//(Jimi 091104 mdf)
 283   2                      // MP3 file open        
 284   2                      if(DOS_Open_File_r(C_MusicFHandle,C_Open_FoundFile,C_NullFileName))
 285   2                      {
 286   3                              return DSP_PLAY_COMMAND_ERROR;
 287   3                      }
 288   2              }
 289   1              return 0;
 290   1      }
 291          
 292          
 293          U8 Music_PauseCmd(void)
 294          {   
 295   1              data    U8  tc_Ret;
 296   1              data    U16     TimeOUT;
 297   1              
 298   1              DSP_WakeUp();
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 6   

 299   1              tc_Ret=DSP_PauseCmd();
 300   1              TimeOUT=0xFFFF;
 301   1      
 302   1              if(gc_Play_FileType==0)
 303   1              {
 304   2                      do
 305   2                      {
 306   3                              TimeOUT--;
 307   3                              if(TimeOUT==0)
 308   3                              {
 309   4                                      return DSP_RUNNING_STATUS1_ERROR;
 310   4                              }
 311   3                      } while(!(L2_DSP_Read_DMem16(DSP_RunningStatus)&0x0002));
 312   2              }
 313   1              else
 314   1              {
 315   2                      do
 316   2                      {
 317   3                              TimeOUT--;
 318   3                              if(TimeOUT==0)
 319   3                              {
 320   4                                      return DSP_RUNNING_STATUS1_ERROR;
 321   4                              }
 322   3                      } while (!L2_DSP_Read_DMem16(DSP_RampDownComplete)); //H1226 DSP_RampDownComplete = 0x3FB8, indicates Ra
             -mpDown OK or NOT
 323   2              }
 324   1      
 325   1              return tc_Ret;
 326   1      }
 327          
 328          
 329          U8 Music_ResumeCmd(void)
 330          {
 331   1              DSP_WakeUp();
 332   1              
 333   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
 334   1              {
 335   2                      return DSP_PLAY_COMMAND_ERROR;
 336   2              }
 337   1              return DSP_SUCCESS;
 338   1      }
 339          
 340          
 341          U8 Music_StopCmd(U8 tc_FileHandle)
 342          {
 343   1              data    U8  tc_Ret;
 344   1              data    U8      tc_value;
 345   1              data    U16 tw_temp;
 346   1              data    U16 dbgTmp;
 347   1      
 348   1              DSP_WakeUp();
 349   1              tc_Ret=DSP_StopCmd();
 350   1              
 351   1              // Reset decode status
 352   1              tw_temp=0xFFFF;
 353   1              do
 354   1              {
 355   2                      tw_temp--;
 356   2                      if(tw_temp==0)
 357   2                      {
 358   3                              tc_Ret=DSP_DECODE_STATUS_TIMEOUT_ERROR;
 359   3                              break;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 7   

 360   3                      }
 361   2              }while(!((L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)==0x00C0));  //wait file end
 362   1      
 363   1              tw_temp=L2_DSP_Read_DMem16(DSP_DecodeStatus);
 364   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,tw_temp&0xFF3F);
 365   1              
 366   1              // Close current file
 367   1              gs_File_FCB[tc_FileHandle].dw_File_StartCluster=0xFFFFFFFF;
 368   1               
 369   1              // wait for ramp down ok and Turn off DSP clock, ycc 081113
 370   1              tw_temp=0xFFFF;
 371   1              while(1)
 372   1              {
 373   2                      dbgTmp=L2_DSP_Read_DMem16(DSP_RestartFlag);  //read DSP 0x3F0B.0 ready status
 374   2                      tw_temp--;     
 375   2                      if((tw_temp==0)||(dbgTmp==0))
 376   2                      {           
 377   3                              break; 
 378   3                      } 
 379   2              }
 380   1              tc_value=XBYTE[0xB010]&0xFE;
 381   1              XBYTE[0xB010]=tc_value;   
 382   1          return tc_Ret;
 383   1      }
 384          
 385          
 386          void play_stop()
 387          {
 388   1              if(gs_System_State.c_Phase!=TASK_PHASE_STOP)
 389   1              {
 390   2                      Music_StopCmd(gs_System_State.c_FileHandle);
 391   2                      gs_System_State.c_Phase=TASK_PHASE_STOP;
 392   2              }
 393   1      }
 394          
 395          
 396          void RandomGetFileIndex(void)
 397          {
 398   1              data    U16     tw_Num;
 399   1              
 400   1              tw_Num=(gw_Random_Timer%gw_FileTotalNumber[gs_System_State.c_FileHandle])+1;
 401   1              
 402   1              if(gw_FileIndex[gs_System_State.c_FileHandle]==tw_Num)
 403   1              {
 404   2                      gw_FileSkipNumber=0;
 405   2              }
 406   1              else
 407   1              {
 408   2                      if (gw_FileIndex[gs_System_State.c_FileHandle] > tw_Num)
 409   2                      {
 410   3                              gw_FileSkipNumber=gw_FileTotalNumber[gs_System_State.c_FileHandle] - (gw_FileIndex[gs_System_State.c_Fi
             -leHandle] - tw_Num);
 411   3                      }
 412   2                      else
 413   2                      {
 414   3                              gw_FileSkipNumber=(tw_Num - gw_FileIndex[gs_System_State.c_FileHandle]);
 415   3                      }
 416   2              }
 417   1      }
 418          
 419          
 420          void play_next()
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 8   

 421          {
 422   1              gc_LCMScrollTimer=0;
 423   1              switch(gs_System_State.c_Phase)
 424   1              {
 425   2                      case TASK_PHASE_STOP:
 426   2                              if(gw_FileIndex[gs_System_State.c_FileHandle]==0)
 427   2                              {
 428   3                                      return;
 429   3                              }
 430   2                      break;
 431   2      
 432   2                      case TASK_PHASE_PAUSE:
 433   2                      case TASK_PHASE_PLAYACT:
 434   2                              Music_StopCmd(gs_System_State.c_FileHandle);
 435   2                              gs_System_State.c_Phase=TASK_PHASE_STOP;
 436   2                              gb_Mp3FileEnd=1;
 437   2                      break;
 438   2              }
 439   1      
 440   1              switch(gc_RepPlayMode)
 441   1              {
 442   2                      case C_RepeatAll:
 443   2                      case C_PlayAllOnce:
 444   2                      case C_RepeatOne:
 445   2                              gb_FDBLastFlag=0;
 446   2                              DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 447   2                              if(gb_FDBLastFlag)
 448   2                              {
 449   3                                      PlayNextFolder();
 450   3                              }
 451   2                      break;
 452   2      
 453   2                      case C_InDirRepeat:
 454   2                      case C_InDirOnce:
 455   2                              DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 456   2                      break;
 457   2      
 458   2                      case C_RandomPlay:
 459   2                              RandomGetFileIndex();
 460   2                              if(gb_DirPlay_Flag==1)
 461   2                              {
 462   3                                      gb_TriggerFileSkip=1;
 463   3                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 464   3                                      gb_TriggerFileSkip=0;
 465   3                              }
 466   2                              else
 467   2                              {
 468   3                                      DOS_Search_File(C_File_All|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 469   3                              }
 470   2                      break;
 471   2              }
 472   1              LCM_Clear_L2_L5();
 473   1              gc_ShowTimer=67;
 474   1              LCM_ShowSongNumber();
 475   1      }
 476          
 477          
 478          void play_prev()
 479          {
 480   1              gc_LCMScrollTimer=0;
 481   1              switch(gs_System_State.c_Phase)
 482   1              {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 9   

 483   2                      case TASK_PHASE_STOP:
 484   2                              if(gw_FileIndex[0]==0)
 485   2                              {
 486   3                                      return;
 487   3                              }
 488   2                      break;
 489   2      
 490   2                      case TASK_PHASE_PAUSE:
 491   2                      case TASK_PHASE_PLAYACT:
 492   2                              Music_StopCmd(0);
 493   2                              gs_System_State.c_Phase=TASK_PHASE_STOP;
 494   2                              gb_Mp3FileEnd=1;
 495   2                      break;
 496   2              }
 497   1      
 498   1              switch(gc_RepPlayMode)
 499   1              {
 500   2                      case C_RepeatAll:
 501   2                      case C_PlayAllOnce:
 502   2                      case C_RepeatOne:
 503   2                              if(gw_FileIndex[0]==1)
 504   2                              {
 505   3                                      PlayPrevFolder();
 506   3                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Prev);
 507   3                              }
 508   2                              else
 509   2                              {
 510   3                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Prev);
 511   3                              }
 512   2                      break;
 513   2      
 514   2                      case C_InDirRepeat:
 515   2                      case C_InDirOnce:
 516   2                              DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Prev);
 517   2                      break;
 518   2      
 519   2                      case C_RandomPlay:
 520   2                              RandomGetFileIndex();
 521   2                              gb_TriggerFileSkip=1;
 522   2                              DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 523   2                              gb_TriggerFileSkip=0;
 524   2                      break;
 525   2              }
 526   1              LCM_Clear_L2_L5();
 527   1              gc_ShowTimer=67;
 528   1              LCM_ShowSongNumber();
 529   1              gc_PrevFlag=1;
 530   1      }
 531          
 532          
 533          void VOL_Adj(void)
 534          {
 535   1              gc_LogData_Timer=67;
 536   1              if(gb_ADJ==0)
 537   1              {
 538   2                      if(gs_DSP_GLOBAL_RAM.sc_Volume<42)
 539   2                      {
 540   3                              gs_DSP_GLOBAL_RAM.sc_Volume+=2;
 541   3                              L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);     // Vloume Range:0~63
 542   3                              LCM_ShowVOL();
 543   3                      }
 544   2              }
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 10  

 545   1              else
 546   1              {
 547   2                      if(gs_DSP_GLOBAL_RAM.sc_Volume>1)
 548   2                      {
 549   3                              gs_DSP_GLOBAL_RAM.sc_Volume-=2;
 550   3                              L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);     // Vloume Range:0~63
 551   3                              LCM_ShowVOL();
 552   3                      }
 553   2              }
 554   1      }
 555          
 556          void ReadBackupDataCompare(void)
 557          {
 558   1              data    U8      tc_clock_mode_backup;
 559   1      
 560   1              tc_clock_mode_backup=gc_clock_mode;
 561   1              set_clock_mode(CLOCK_MODE_DOS);
 562   1              DOS_Count_All_Dir();
 563   1              gs_File_FCB[0].dw_FDB_StartCluster=gdw_DOS_RootDirClus;
 564   1              DOS_Search_File(C_File_All|C_Cnt_FileNo,C_MusicFileType,C_CmpExtName|C_Next);
 565   1              set_clock_mode(tc_clock_mode_backup);
 566   1              if(gw_FileTotalNumber[0]==0)
 567   1              {
 568   2                      // No Music file
 569   2                      gw_FileIndex[0]=0;
 570   2                      LCM_Show_NoFile();
 571   2                      if(StorgeNoMp3FileChangeNext())
 572   2                      {
 573   3                              gb_Mp3FileEnd=0;
 574   3                              gb_Dosinitfail=1;
 575   3                              return;
 576   3                      }
 577   2              }
 578   1      
 579   1              Get_LogData_PageIndex();
 580   1              USER_LogFile_ReadWrite(0);
 581   1              DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_MusicFileType,C_CmpExtName|C_Next);
 582   1              if(gw_FileTotalNumber[0]==0)
 583   1              {
 584   2                      PlayNextFolder();
 585   2              }
 586   1              JumpToTargetFolder();
 587   1      }
 588          
 589          
 590          bit StorgeNoMp3FileChangeNext(void)
 591          {
 592   1              data    U8      x_NoFile;
 593   1              data    U8      x_BackUpClock;
 594   1              data    U8      x_DosInit;
 595   1              
 596   1              x_NoFile=0;
 597   1              x_DosInit=0;
 598   1              gb_Dosinitfail=0;
 599   1              switch(gc_CurrentCard)
 600   1              {
 601   2                      case 0x02:   //SD-> HOST-> FM
 602   2                              if((gb_Host_Exist==1)&&(gb_HostNoFileflag==0))
 603   2                              {
 604   3                                      if(!Host_Initial())
 605   3                                      {
 606   4                                              gc_CurrentCard=5;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 11  

 607   4                                              x_DosInit=1;
 608   4                                      }
 609   3                              }
 610   2                      break;
 611   2                      
 612   2                      case 0x05:   //HOST-> SD-> FM
 613   2                              if((gb_SD_Exist==1)&&(gb_SDNoFileflag==0))
 614   2                              {
 615   3                                      if(SD_Identification_Flow())
 616   3                                      {
 617   4                                              gc_CurrentCard=2;
 618   4                                              x_DosInit=1;
 619   4                                      }
 620   3                              }
 621   2                      break;
 622   2              }
 623   1      
 624   1              if(x_DosInit)
 625   1              {
 626   2                      x_BackUpClock=gc_clock_mode;
 627   2                      x_NoFile=0;
 628   2                      if(!DOS_Initialize())
 629   2                      {
 630   3                              set_clock_mode(CLOCK_MODE_DOS);
 631   3                              gw_FileSkipNumber=0;
 632   3                              gb_FindFlag = 0;
 633   3                              gs_File_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 634   3                              DOS_Search_File(C_File_All|C_Cnt_FileNo,C_MusicFileType,C_CmpExtName|C_Next);// count music file no. in
             - root
 635   3                              set_clock_mode(x_BackUpClock);
 636   3                              gc_KeyEvent=0;
 637   3                              if(gw_FileTotalNumber[0])
 638   3                              {
 639   4                          x_NoFile=1;
 640   4                              }
 641   3                      }
 642   2              }
 643   1      
 644   1              if(x_NoFile==0)
 645   1              {
 646   2                      gb_FindFlag=0;
 647   2                      gc_Task_Current=C_Task_Idle;
 648   2                      gc_CurrentCard=9;
 649   2                      return 1;
 650   2              }
 651   1              return 0;
 652   1      }
 653          
 654          
 655          void DosSearchErrorNextStorageType(void)
 656          {
 657   1              switch(gc_CurrentCard)
 658   1              {
 659   2                      case 0x02: //Current SD Type
 660   2                              if(gb_Host_Exist)
 661   2                              {
 662   3                                      gc_CurrentCard=5;
 663   3                                      if(!Host_Initial())
 664   3                                      {
 665   4                                              if(!DOS_Initialize())
 666   4                                              {
 667   5                                                      gb_Dosinitfail=1;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 12  

 668   5                                              }
 669   4                                      }
 670   3                              }
 671   2                      break;
 672   2      
 673   2                      case 0x05:  //Host
 674   2                              if(gb_SD_Exist)
 675   2                              {
 676   3                                      gc_CurrentCard=2;
 677   3                                      if(SD_Identification_Flow())
 678   3                                      {
 679   4                                              if(!DOS_Initialize())
 680   4                                              {
 681   5                                                      gb_Dosinitfail=1;
 682   5                                              }
 683   4                                      }
 684   3                              }
 685   2                      break;
 686   2              }
 687   1      
 688   1              if(gb_Dosinitfail)
 689   1              {
 690   2                      gb_Dosinitfail=0;
 691   2              }
 692   1              else
 693   1              {
 694   2                      gb_FindFlag=0;
 695   2                      gc_Task_Current=C_Task_Idle;
 696   2                      gc_CurrentCard=9;
 697   2                      gb_Dosinitfail=1;
 698   2              }
 699   1      }
 700          
 701          
 702          void Play_SDFlash_DosInit()
 703          {
 704   1              data    U8  tc_clock_mode_backup; 
 705   1      
 706   1              tc_clock_mode_backup=gc_clock_mode;
 707   1              gb_Dosinitfail=0;                                       // 20100106-maxliao(未加此行,只要Fail一次就再也讀不到)
 708   1              gdw_HOSTStartSectorRead=0xFFFFFFF0;     // 20100106-maxliao
 709   1              set_clock_mode(CLOCK_MODE_DOS);
 710   1              if(DOS_Initialize())
 711   1              {
 712   2                      DosSearchErrorNextStorageType();
 713   2              }
 714   1      
 715   1              gw_FileSkipNumber=0;
 716   1              gb_FindFlag=0;
 717   1          //----------------------------------------------------------------------------------------------------
             ----
 718   1              set_clock_mode(tc_clock_mode_backup);
 719   1              gs_System_State.c_FileHandle=0;
 720   1      
 721   1          gb_Dosinitfail=0;
 722   1              gb_LrcFileName_Exist=0;
 723   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;  // reset bitstream address of DM//(Jimi 091104 mdf)
 724   1              gs_DSP_GLOBAL_RAM.sdw_File_ACluster=0;
 725   1              gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint=0;
 726   1              gs_DSP_GLOBAL_RAM.sdw_File_BCluster=0;
 727   1              gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint=0;
 728   1              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB_NULL;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 13  

 729   1              gw_CurrentSec=0;
 730   1              gw_FileIndex[0]=0;
 731   1              //-------------讀取上一次的資料---------------------------------------
 732   1              ReadBackupDataCompare();
 733   1              //--------------------------------------------------------------------
 734   1              gc_Play_FileType=gs_File_FCB[0].c_FileType;
 735   1              if(gc_Play_FileType==0)
 736   1              {
 737   2                      set_clock_mode(CLOCK_MODE_MP3);
 738   2                      gs_System_State.w_SampleRate=MP3_Bitrate_Parser();
 739   2                      gw_TotalSec=MP3_Total_Time_Parser();//(JC)H0630 LCM test
 740   2              }
 741   1              else
 742   1              {
 743   2                      set_clock_mode(CLOCK_MODE_WMA);
 744   2                      WMA_ASF_Parser();
 745   2              }
 746   1      
 747   1              gc_KeyEvent=0;
 748   1              gc_LCMScrollTimer=0;
 749   1              gb_Mp3FileEnd=1;
 750   1      }
 751          
 752          
 753          void Play_SourceDetect_Process(void)
 754          {
 755   1          data        U8      xc_temp;
 756   1      
 757   1              gb_SD_Exist_pre=gb_SD_Exist;
 758   1              if(gb_SD_pin==0)
 759   1              {
 760   2                      gb_SD_Exist=1;     //SD exist
 761   2              }
 762   1              else
 763   1              {
 764   2                      gb_SD_Exist=0;
 765   2                      gb_SDNoFileflag=0;
 766   2              }
 767   1              gb_Host_Exist_pre=gb_Host_Exist;
 768   1              if(!Host_DetectDevice())
 769   1              {
 770   2                      gb_Host_Exist=1;    //host_exist
 771   2              }
 772   1              else
 773   1              {
 774   2                      gb_Host_Exist=0;
 775   2                      gb_HostNoFileflag=0;
 776   2              }
 777   1      
 778   1              if(gb_HostError==1)
 779   1              {
 780   2                      if(gb_SD_Exist==0)
 781   2                      {
 782   3                              gc_CurrentCard=9;
 783   3                      }
 784   2                      gb_HostError=0;
 785   2              }
 786   1              else
 787   1              {
 788   2                      if(gb_MediaMask)
 789   2                      {       //手動切換 //無檔案時也可以切換
 790   3                              gb_MediaMask=0;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 14  

 791   3                      }
 792   2                      else
 793   2                      {       //自動切換
 794   3                              if((gb_SD_Exist_pre==gb_SD_Exist)&&(gb_Host_Exist_pre==gb_Host_Exist)) 
 795   3                              {
 796   4                                      return;
 797   4                              }
 798   3                      }
 799   2              }
 800   1      
 801   1              switch(gc_CurrentCard)
 802   1              {
 803   2                      case 0x02:   //SD-----------------------------------------
 804   2                  if(gb_Host_Exist)
 805   2                              {
 806   3                                      play_stop();          //切換到HOST MODE
 807   3                                      gc_CurrentCard=5;
 808   3                              }
 809   2                              else
 810   2                              {
 811   3                                      if(gb_SD_Exist)
 812   3                                      {
 813   4                                              gc_CurrentCard=2;
 814   4                                              return;            //SD插著,HOST拔出
 815   4                                      }
 816   3                                      else
 817   3                                      {
 818   4                                              play_stop();       // Idle
 819   4                                              gc_CurrentCard=9;
 820   4                                      }
 821   3                              }
 822   2                      break;
 823   2      
 824   2                      case 0x05:   //HOST---------------------------------------
 825   2                              if(gb_SD_pin==0)
 826   2                              {
 827   3                                      play_stop();          //切換到SD MODE
 828   3                                      gc_CurrentCard=2;
 829   3                              }
 830   2                              else
 831   2                              {
 832   3                                      if(gb_Host_Exist)
 833   3                                      {
 834   4                                              gc_CurrentCard=5;
 835   4                                              return;            //HOST插著,SD拔出
 836   4                                      }
 837   3                                      else
 838   3                                      {
 839   4                                              play_stop();       // FM MODE
 840   4                                              gc_CurrentCard = 9;
 841   4                                      }
 842   3                              }
 843   2                      break;
 844   2              }
 845   1              LCM_Clear_L2_L5();
 846   1              LCM_ShowWait();
 847   1              set_clock_mode(CLOCK_MODE_MP3); 
 848   1          //----------------------------------------------------------
 849   1              xc_temp=0;
 850   1              switch(gc_CurrentCard)
 851   1              {
 852   2                      case 0x02: //SD CARD--------------------------------------
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 15  

 853   2                              if(SD_Identification_Flow()) //return 1 Success
 854   2                              {
 855   3                     xc_temp=1;
 856   3                              }
 857   2                              else
 858   2                              {
 859   3                                      if((gb_Host_Exist==1)&&(gb_HostNoFileflag==0))
 860   3                                      {
 861   4                                              if(!Host_Initial())
 862   4                                              {
 863   5                                                      gc_CurrentCard=5;
 864   5                                                      gb_FindFlag=0;
 865   5                                                      xc_temp=1;
 866   5                                              }
 867   4                                      }
 868   3                              }
 869   2                      break;
 870   2      
 871   2                      case 0x05: //HOST-----------------------------------------
 872   2                              if(!Host_Initial())
 873   2                              {
 874   3                                      xc_temp=1;
 875   3                                      gb_FindFlag=0;
 876   3                              }
 877   2                              else
 878   2                              {
 879   3                                      if((gb_SD_Exist==1)&&(gb_SDNoFileflag==0))
 880   3                                      {
 881   4                                              if(SD_Identification_Flow())
 882   4                                              {
 883   5                                                      gc_CurrentCard=2;
 884   5                                                      xc_temp=1;
 885   5                                              }
 886   4                                      }
 887   3                              }
 888   2                      break;
 889   2              }
 890   1          //------------Check DosInit-----------------------------------------------------------
 891   1              if(xc_temp)
 892   1              {
 893   2                      Play_SDFlash_DosInit();
 894   2                      gc_LastCard=gc_CurrentCard;
 895   2              }
 896   1              else
 897   1              {
 898   2                      gc_CurrentCard=9;
 899   2                      gb_FindFlag=0;
 900   2                      gc_Task_Current=C_Task_Idle;
 901   2              }
 902   1      }
 903          
 904          
 905          void LRC_DisplayFunction(void)
 906          {
 907   1              Lyric_GetTimeStamp();
 908   1              if(gb_LrcGetTimeOrNot)
 909   1              {
 910   2                      gb_LrcGetTimeOrNot=0; 
 911   2                      Lyric_GetLyrics();
 912   2                      if(gc_LrcCurrentLen)
 913   2                      {
 914   3                              if(gc_Play_FileType==0)
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 16  

 915   3                              {
 916   4                                      MP3_DataIn();
 917   4                              }
 918   3                              else
 919   3                              {
 920   4                                      WMA_DataIn();   
 921   4                              }
 922   3                              LCM_DisplayString(&gc_LrcDisplayBuf,gc_LrcCurrentLen-1,32);
 923   3                      }
 924   2              }
 925   1      
 926   1      }
 927          
 928          
 929          void CheckAudioStatus(void)
 930          {
 931   1              data    U8      tc_status;
 932   1      
 933   1              if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
 934   1              {
 935   2                  if((gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_AB)||(gs_File_FCB[0].dw_File_DataPoint<=gs_DSP_
             -GLOBAL_RAM.sdw_File_BDataPoint))
 936   2                      {
 937   3                              if(gc_Play_FileType==0)
 938   3                              {
 939   4                                      gw_Disp_CurrentSec=MP3_ReadTime();
 940   4                                      tc_status=MP3_DataIn();
 941   4                                      if(tc_status)
 942   4                                      {
 943   5                                              tc_status=MP3_EOF_Proc();
 944   5                                      }
 945   4                              }
 946   3                              else
 947   3                              {
 948   4                                      gw_Disp_CurrentSec=WMA_ReadTime();
 949   4                                      tc_status=WMA_DataIn();
 950   4                                      if(tc_status)
 951   4                                      {
 952   5                                              tc_status=WMA_EOF_Proc();
 953   5                                      }
 954   4                              }
 955   3      
 956   3                              if(tc_status)
 957   3                              { //End of File for play
 958   4                                      play_stop();
 959   4                                      if(gc_CurrentCard==2&&gb_SD_pin==1)
 960   4                                      {
 961   5                                              gc_CurrentCard=9;
 962   5                                              return;
 963   5                                      }
 964   4                                      gw_CurrentSec=0;
 965   4                                      gb_Mp3FileEnd=1;
 966   4      
 967   4                                      switch(gc_RepPlayMode)
 968   4                                      {       
 969   5                                              case C_RepeatAll:
 970   5                                              case C_PlayAllOnce:
 971   5                                                      gb_FDBLastFlag=0;
 972   5                                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 973   5                                                      if(gb_FDBLastFlag==1&&gc_RepPlayMode==C_PlayAllOnce)
 974   5                                                      {
 975   6                                                              gb_Mp3FileEnd=0;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 17  

 976   6                                                      }
 977   5                                                      else if(gb_FDBLastFlag)
 978   5                                                      {
 979   6                                                              PlayNextFolder();
 980   6                                                      }
 981   5                                              break;
 982   5      
 983   5                                              case C_RepeatOne:
 984   5                                              break;
 985   5      
 986   5                                              case C_RandomPlay:
 987   5                                                      RandomGetFileIndex();
 988   5                                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 989   5                                              break;
 990   5      
 991   5                                              case C_InDirRepeat:
 992   5                                              case C_InDirOnce:
 993   5                                                      gb_FDBLastFlag=0;
 994   5                                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
 995   5                                                      if(gb_FDBLastFlag==1)
 996   5                                                      {
 997   6                                                              if(gc_RepPlayMode==C_InDirRepeat)
 998   6                                                              {
 999   7                                                                      gw_FileIndex[0]=1;
1000   7                                                              }
1001   6                                                              else
1002   6                                                              {
1003   7                                                                      gw_FileIndex[0]--;
1004   7                                                                      gb_Mp3FileEnd=0;
1005   7                                                              }
1006   6                                                      }
1007   5                                              break;
1008   5                                      }
1009   4                              }
1010   3                              else
1011   3                              {
1012   4                                      gc_PrevFlag=0;
1013   4                              }
1014   3                      }
1015   2                      else
1016   2                      {
1017   3                              if(gc_Play_FileType==0)
1018   3                              {
1019   4                                      MP3_Repeat_DataIn();
1020   4                              }
1021   3                              else
1022   3                              {
1023   4                                      WMA_Repeat_DataIn();
1024   4                              }
1025   3                      }
1026   2              }
1027   1      }
1028          
1029          
1030          void OpenAudioFile(void)
1031          {
1032   1              data    U8 tc_timeout;
1033   1      
1034   1              if(gb_Mp3FileEnd)
1035   1              {
1036   2                      USER_LogFile_ReadWrite(1);
1037   2                      gb_Mp3FileEnd=0;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 18  

1038   2                      gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1039   2                      DOS_GetLongFileName(0,gc_FileLongName);  
1040   2                      //-------------LRC Clear Buffer100-------------------------------
1041   2                      gb_LrcFileName_Exist=Lyric_FileSearch();//(JC)Lyric file exist?
1042   2                      #ifdef SPI_1M             
1043   2                      X_Unicode2ISN(gc_FileLongName);
1044   2                      #endif
1045   2                      if(gb_LrcFileName_Exist)
1046   2                      {
1047   3                              memset(gc_LrcDisplayBuf,0,100); //Clear
1048   3                      }
1049   2                      gc_LrcCurrentLen=0;
1050   2                      
1051   2                      gc_Play_FileType=gs_File_FCB[0].c_FileType;
1052   2      
1053   2                      gs_DSP_GLOBAL_RAM.sdw_File_ACluster=0;
1054   2                      gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint=0;
1055   2                      gs_DSP_GLOBAL_RAM.sdw_File_BCluster=0;
1056   2                      gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint=0;
1057   2                      gw_CurrentSec=0;
1058   2                      gw_Disp_CurrentSec=0;
1059   2                      if(gc_Play_FileType==0)
1060   2                      {
1061   3                              if(gb_LrcFileName_Exist==1)
1062   3                              {
1063   4                                      set_clock_mode(CLOCK_MODE_MP3L);
1064   4                              }
1065   3                              else
1066   3                              {
1067   4                                      set_clock_mode(CLOCK_MODE_MP3);
1068   4                              }
1069   3                              gs_System_State.w_SampleRate=MP3_Bitrate_Parser();
1070   3                              gw_TotalSec=MP3_Total_Time_Parser();
1071   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster=gs_File_FCB[gs_System_State.c_FileHand
             -le].dw_File_StartCluster;
1072   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_CurrentCluster=DOS_Seek_File(gs_System_State.c_FileHa
             -ndle, gdw_ID3_v2_sz >> 9);
1073   3                              gs_File_FCB[gs_System_State.c_FileHandle].dw_File_DataPoint=gdw_ID3_v2_sz & 0xFFFFFE00;
1074   3                              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;  // reset bitstream address of DM//(Jimi 091104 mdf)
1075   3                              if(MP3_Download())
1076   3                              {
1077   4                                      play_next();
1078   4                                      return;
1079   4                              }
1080   3                      }
1081   2                      else
1082   2                      {
1083   3                              set_clock_mode(CLOCK_MODE_WMA);
1084   3                              WMA_ASF_Parser();
1085   3                              if(WMA_Download())
1086   3                              {
1087   4                                      play_next();
1088   4                                      return;
1089   4                              }
1090   3                      }
1091   2      
1092   2                      L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);
1093   2                      L2_DSP_Write_DMem16(DSP_PostProcessSelect,L2_DSP_Read_DMem16(DSP_PostProcessSelect)|0x0020);
1094   2                      tc_timeout=0xFF;
1095   2                      while((L2_DSP_Read_DMem16(DSP_PostProcessSelect)&0x0020))  //Handshake with DSP to make sure that DSP ha
             -s ramp digital volume up.
1096   2                      {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 19  

1097   3                              if(!(tc_timeout--))
1098   3                              {
1099   4                                      break;
1100   4                              }
1101   3                      }
1102   2                      Music_EQ_Cmd();
1103   2                      //-------------------------------------------------------------------------------
1104   2                      gw_DispFileName_ByteOffset=0; 
1105   2                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB_NULL; // 每次新播一首曲目，都要把 RepeatAB 重置
1106   2                      RefreshAllDisplay();
1107   2                      if(Music_PlayCmd()==DSP_PLAY_COMMAND_ERROR)
1108   2                      {
1109   3                              play_next();
1110   3                      }
1111   2              }
1112   1      }
1113          
1114          
1115          void FillAudioDataToDSP(void)
1116          {
1117   1              if(gs_System_State.c_Phase==TASK_PHASE_PLAYACT)
1118   1              {
1119   2                      if(gc_Play_FileType==0)
1120   2                      {
1121   3                    MP3_DataIn();
1122   3                      }
1123   2                      else 
1124   2                      {
1125   3                   WMA_DataIn();
1126   3                      }
1127   2              }
1128   1      }
1129          
1130          
1131          void MP3FunctionProc(void)
1132          {
1133   1              data    U8      tc_Step;
1134   1              data    U16     tw_temp;
1135   1              xdata   U32     tdw_DataPoint;
1136   1      
1137   1              switch(gs_System_State.c_Phase)
1138   1              {
1139   2                      case TASK_PHASE_FASTFWD:        // FF/FR
1140   2                              switch(gc_KeyEvent)
1141   2                              {
1142   3                                      case 0x13:      // FF
1143   3                                              UI_fastFFFR_Play(0);
1144   3                                              LCM_ShowPlayTime(gw_Disp_CurrentSec);
1145   3                                              gc_LongKeyCount=30;
1146   3                                      break;
1147   3      
1148   3                                      case 0x23:      // Stop FF/FR
1149   3                                              play_fffr_end();
1150   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1151   3                                      break;
1152   3                              }
1153   2                      break;
1154   2      
1155   2                      case    TASK_PHASE_FASTREV:     // 20100317 - FF/FR
1156   2                              switch(gc_KeyEvent)
1157   2                              {
1158   3                                      case 0x14:      // FR
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 20  

1159   3                                              UI_fastFFFR_Play(1);
1160   3                                              LCM_ShowPlayTime(gw_Disp_CurrentSec);
1161   3                                              gc_LongKeyCount=30;
1162   3                                      break;
1163   3      
1164   3                                      case 0x24:      // Stop FF/FR
1165   3                                              play_fffr_end();
1166   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1167   3                                      break;
1168   3                              }
1169   2                      break;
1170   2      
1171   2                      case TASK_PHASE_PLAYACT:
1172   2                              if((gc_MenuTimer==0)&&(gc_PlayMenuItem!=0||gb_SetVol))
1173   2                              {
1174   3                                      gb_SetVol=0;
1175   3                                      gc_PlayMenuItem=0;
1176   3                                      RefreshAllDisplay();
1177   3                                      USER_LogFile_ReadWrite(1);
1178   3                              }
1179   2      
1180   2                              if(gc_KeyEvent!=0)
1181   2                              {
1182   3                                      if(gc_PlayMenuItem!=0)
1183   3                                      {
1184   4                                              gc_MenuTimer=6;
1185   4                                      }
1186   3      
1187   3                                      switch(gc_KeyEvent)
1188   3                                      {
1189   4                                              case 0x02:      // Play
1190   4                                                      if(gc_PlayMenuItem==0)
1191   4                                                      {
1192   5                                                              Music_PauseCmd();
1193   5                                                              gs_System_State.c_Phase=TASK_PHASE_PAUSE;
1194   5                                                              LCM_ShowPlayPauseIcon();
1195   5                                                              ClearIRNumberVariable();
1196   5                                                      }
1197   4                                                      else
1198   4                                                      {
1199   5                                                      }
1200   4                                              break;
1201   4      
1202   4                                              case 0x03:      // Next
1203   4                                                      if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_A)
1204   4                                                      {
1205   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_B;
1206   5                                                              if(gc_Play_FileType==0)
1207   5                                                              {
1208   6                                                                      gs_DSP_GLOBAL_RAM.sdw_File_ACluster=0xFFFFFFFF;
1209   6                                                                      tdw_DataPoint=L2_DSP_Read_DMem16(DSP_RemainBuffer);
1210   6                                                                      tdw_DataPoint&=0xFFFFFE00;
1211   6                                                                      gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint=(gs_File_FCB[0].dw_File_DataPoint)-(tdw_DataPoint);
1212   6                                                                      gw_AFrameCnt=L2_DSP_Read_DMem16(DSP_DecodeFrameCounter);// to get A point frame count
1213   6                                                              }
1214   5                                                              else
1215   5                                                              {
1216   6                                                                      gw_APointSec=WMA_ReadTime();                            //Jimi 080529
1217   6                                                                      tdw_DataPoint=L2_DSP_Read_DMem16(DSP_RemainBuffer);
1218   6                                                                      tdw_DataPoint&=0xfffffe00;
1219   6                                                                      gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint=(gs_File_FCB[0].dw_File_DataPoint)-(tdw_DataPoint);
1220   6                                                              }
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 21  

1221   5                                                      }
1222   4                                                      else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_B)
1223   4                                                      {
1224   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB;
1225   5                                                              if(gc_Play_FileType==0) // MP3
1226   5                                                              {
1227   6                                                                      gs_DSP_GLOBAL_RAM.sdw_File_BCluster=gs_File_FCB[0].dw_File_CurrentCluster;
1228   6                                                                      gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint=gs_File_FCB[0].dw_File_DataPoint;
1229   6                                                              }
1230   5                                                              else                                    // WMA
1231   5                                                              {
1232   6                                                                      if(WMA_ReadTime()!=gw_APointSec)
1233   6                                                                      {
1234   7                                                                              gs_DSP_GLOBAL_RAM.sdw_File_BDataPoint=gs_File_FCB[0].dw_File_DataPoint;
1235   7                                                                              gs_DSP_GLOBAL_RAM.sdw_File_BCluster=gs_File_FCB[0].dw_File_CurrentCluster;
1236   7                                                                              WMA_FF_FR_Cmd();
1237   7                                                                              gs_File_FCB[0].dw_File_DataPoint=0;
1238   7                                                                              gs_File_FCB[0].dw_File_CurrentCluster=gs_File_FCB[0].dw_File_StartCluster;
1239   7                                                                              gs_DSP_GLOBAL_RAM.sdw_File_ACluster=DOS_Seek_File(0,gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint>>9);
1240   7                                                                              gs_File_FCB[0].dw_File_CurrentCluster=gs_DSP_GLOBAL_RAM.sdw_File_ACluster;
1241   7                                                                              gs_File_FCB[0].dw_File_DataPoint=gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint;
1242   7                                                                              WMA_seek_trig();
1243   7                                                                      }
1244   6                                                              }
1245   5                                                      }
1246   4                                                      else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_AB)
1247   4                                                      {
1248   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
1249   5                                                      }
1250   4                                                      else if(gc_PlayMenuItem==0)     // 1=Play-Menu  2=Repeat-Mode  3=EQ-Option
1251   4                                                      {
1252   5                                                              gb_ClearBigIcon=1;
1253   5                                                              ClearIRNumberVariable();
1254   5                                                              if(gb_SetVol)
1255   5                                                              {
1256   6                                                                      gb_ADJ=0;
1257   6                                                                      VOL_Adj();
1258   6                                                              }
1259   5                                                              else
1260   5                                                              {                                               
1261   6                                                                      play_next();
1262   6                                                              }
1263   5                                                      }
1264   4                                                      else if(gc_PlayMenuItem==1)     // Play Menu(Repeat/EQ/A-B/Exit)
1265   4                                                      {
1266   5                                                              tc_Step=gc_PlayMenuNum;
1267   5                                                              gc_PlayMenuNum=(gc_PlayMenuNum+1)&0x03;
1268   5                                                              LCM_ShowPlayMenu(tc_Step);
1269   5                                                              LCM_ShowPlayMenu(gc_PlayMenuNum);
1270   5                                                      }
1271   4                                                      else if(gc_PlayMenuItem==2)     // Repeat Menu
1272   4                                                      {
1273   5                                                              tc_Step=gc_RepeatMenuNum;
1274   5                                                              gc_RepeatMenuNum=(gc_RepeatMenuNum+1)%6;
1275   5                                                              if(gc_RepeatMenuNum==4)
1276   5                                                              {
1277   6                                                                      LCM_ShowRepeatMenu(4);
1278   6                                                                      LCM_ShowRepeatMenu(5);
1279   6                                                                      LCM_erase_one_page(4);
1280   6                                                                      LCM_erase_one_page(5);
1281   6                                                                      LCM_erase_one_page(6);
1282   6                                                                      LCM_erase_one_page(7);
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 22  

1283   6                                                              }
1284   5                                                              else if(gc_RepeatMenuNum==0)
1285   5                                                              {
1286   6                                                                      LCM_ShowRepeatMenu(0);
1287   6                                                                      LCM_ShowRepeatMenu(1);
1288   6                                                                      LCM_ShowRepeatMenu(2);
1289   6                                                                      LCM_ShowRepeatMenu(3);
1290   6                                                              }
1291   5                                                              else
1292   5                                                              {
1293   6                                                                      LCM_ShowRepeatMenu(tc_Step);
1294   6                                                                      LCM_ShowRepeatMenu(gc_RepeatMenuNum);
1295   6                                                              }
1296   5                                                      }
1297   4                                                      else if(gc_PlayMenuItem==3)     // EQ Menu
1298   4                                                      {
1299   5                                                              tc_Step=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
1300   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=(gs_DSP_GLOBAL_RAM.sc_EQ_Type+1)%6;
1301   5                                                              if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==4)
1302   5                                                              {
1303   6                                                                      LCM_ShowEQMenu(4);
1304   6                                                                      LCM_ShowEQMenu(5);
1305   6                                                                      LCM_erase_one_page(4);
1306   6                                                                      LCM_erase_one_page(5);
1307   6                                                                      LCM_erase_one_page(6);
1308   6                                                                      LCM_erase_one_page(7);
1309   6                                                              }
1310   5                                                              else if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==0)
1311   5                                                              {
1312   6                                                                      LCM_ShowEQMenu(0);
1313   6                                                                      LCM_ShowEQMenu(1);
1314   6                                                                      LCM_ShowEQMenu(2);
1315   6                                                                      LCM_ShowEQMenu(3);
1316   6                                                              }
1317   5                                                              else
1318   5                                                              {
1319   6                                                                      LCM_ShowEQMenu(tc_Step);
1320   6                                                                      LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
1321   6                                                              }
1322   5                                                              Music_EQ_Cmd();
1323   5                                                      }
1324   4                                              break;
1325   4      
1326   4                                              case 0x04:      // Prev
1327   4                                                      if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_A)
1328   4                                                      {
1329   5                                                      }
1330   4                                                      else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_B)
1331   4                                                      {
1332   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
1333   5                                                      }
1334   4                                                      else if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode==REPEAT_AB)
1335   4                                                      {
1336   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
1337   5                                                      }
1338   4                                                      else if(gc_PlayMenuItem==0)
1339   4                                                      {
1340   5                                                              gb_ClearBigIcon=1;
1341   5                                                              ClearIRNumberVariable();
1342   5                                                              if(gb_SetVol)
1343   5                                                              {
1344   6                                                                      gb_ADJ=1;
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 23  

1345   6                                                                      VOL_Adj();
1346   6                                                              }
1347   5                                                              else
1348   5                                                              {
1349   6                                                                      play_prev();
1350   6                                                              }
1351   5                                                      }
1352   4                                                      else if(gc_PlayMenuItem==1)     // Play Menu(Repeat/EQ/A-B/Exit)
1353   4                                                      {
1354   5                                                              tc_Step=gc_PlayMenuNum;
1355   5                                                              gc_PlayMenuNum=(gc_PlayMenuNum-1)&0x03;
1356   5                                                              LCM_ShowPlayMenu(tc_Step);
1357   5                                                              LCM_ShowPlayMenu(gc_PlayMenuNum);                                                       
1358   5                                                      }
1359   4                                                      else if(gc_PlayMenuItem==2)
1360   4                                                      {
1361   5                                                              tc_Step=gc_RepeatMenuNum;
1362   5                                                              gc_RepeatMenuNum=(gc_RepeatMenuNum+5)%6;
1363   5                                                              if(gc_RepeatMenuNum==5)
1364   5                                                              {
1365   6                                                                      LCM_ShowRepeatMenu(4);
1366   6                                                                      LCM_ShowRepeatMenu(5);
1367   6                                                                      LCM_erase_one_page(4);
1368   6                                                                      LCM_erase_one_page(5);
1369   6                                                                      LCM_erase_one_page(6);
1370   6                                                                      LCM_erase_one_page(7);
1371   6                                                              }
1372   5                                                              else if(gc_RepeatMenuNum==3)
1373   5                                                              {
1374   6                                                                      LCM_ShowRepeatMenu(0);
1375   6                                                                      LCM_ShowRepeatMenu(1);
1376   6                                                                      LCM_ShowRepeatMenu(2);
1377   6                                                                      LCM_ShowRepeatMenu(3);
1378   6                                                              }
1379   5                                                              else
1380   5                                                              {
1381   6                                                                      LCM_ShowRepeatMenu(tc_Step);
1382   6                                                                      LCM_ShowRepeatMenu(gc_RepeatMenuNum);
1383   6                                                              }
1384   5                                                      }
1385   4                                                      else if(gc_PlayMenuItem==3)
1386   4                                                      {
1387   5                                                              tc_Step=gs_DSP_GLOBAL_RAM.sc_EQ_Type;
1388   5                                                              gs_DSP_GLOBAL_RAM.sc_EQ_Type=(gs_DSP_GLOBAL_RAM.sc_EQ_Type+5)%6;
1389   5                                                              if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==5)
1390   5                                                              {
1391   6                                                                      LCM_ShowEQMenu(4);
1392   6                                                                      LCM_ShowEQMenu(5);
1393   6                                                                      LCM_erase_one_page(4);
1394   6                                                                      LCM_erase_one_page(5);
1395   6                                                                      LCM_erase_one_page(6);
1396   6                                                                      LCM_erase_one_page(7);
1397   6                                                              }
1398   5                                                              else if(gs_DSP_GLOBAL_RAM.sc_EQ_Type==3)
1399   5                                                              {
1400   6                                                                      LCM_ShowEQMenu(0);
1401   6                                                                      LCM_ShowEQMenu(1);
1402   6                                                                      LCM_ShowEQMenu(2);
1403   6                                                                      LCM_ShowEQMenu(3);
1404   6                                                              }
1405   5                                                              else
1406   5                                                              {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 24  

1407   6                                                                      LCM_ShowEQMenu(tc_Step);
1408   6                                                                      LCM_ShowEQMenu(gs_DSP_GLOBAL_RAM.sc_EQ_Type);
1409   6                                                              }
1410   5                                                              Music_EQ_Cmd();
1411   5                                                      }
1412   4                                              break;
1413   4      
1414   4                                              case 0x05:      // V
1415   4                                                      if(gc_PlayMenuItem==0&&gb_SetVol==0)
1416   4                                                      {
1417   5                                                              gb_ClearBigIcon=1;
1418   5                                                              gb_SetVol=1;                            
1419   5                                                              LCM_Clear_L2_L5();
1420   5                                                              LCM_ShowVOL();
1421   5                                                              gc_MenuTimer=6;
1422   5                                                              ClearIRNumberVariable();
1423   5                                                      }
1424   4                                                      else
1425   4                                                      {
1426   5                                                              gc_MenuTimer=0;
1427   5                                                      }
1428   4                                              break;
1429   4      
1430   4                                              case 0x06:      // M
1431   4                                                      if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_AB_NULL)
1432   4                                                      {
1433   5                                                              gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_AB_NULL;
1434   5                                                              LCM_ShowRepeatIcon();   // Clear Repeat Icon
1435   5                                                              LCM_ShowSongNum();
1436   5                                                              LCM_ShowSongTotalNum();
1437   5                                                      }
1438   4                                                      else if(gc_PlayMenuItem==0)
1439   4                                                      {
1440   5                                                              // Enter Play Menu
1441   5                                                              gc_PlayMenuItem=1;
1442   5                                                              gc_MenuTimer=6;
1443   5                                                              ClearIRNumberVariable();
1444   5                                                              LCM_ShowPlayMenu(0);
1445   5                                                              LCM_ShowPlayMenu(1);
1446   5                                                              LCM_ShowPlayMenu(2);
1447   5                                                              LCM_ShowPlayMenu(3);
1448   5                                                      }
1449   4                                                      else if(gc_PlayMenuItem==1)     // ** Play Menu **
1450   4                                                      {
1451   5                                                              // Enter Repeat-Mode Menu
1452   5                                                              gc_RepeatMenuNum=gc_RepPlayMode;
1453   5                                                              if(gc_PlayMenuNum==0)   // Repeat Mode
1454   5                                                              {
1455   6                                                                      gc_PlayMenuItem=2;
1456   6                                                                      if(gc_RepeatMenuNum<4)
1457   6                                                                      {
1458   7                                                                              LCM_ShowRepeatMenu(0);
1459   7                                                                              LCM_ShowRepeatMenu(1);
1460   7                                                                              LCM_ShowRepeatMenu(2);
1461   7                                                                              LCM_ShowRepeatMenu(3);
1462   7                                                                      }
1463   6                                                                      else
1464   6                                                                      {
1465   7                                                                              LCM_ShowRepeatMenu(4);
1466   7                                                                              LCM_ShowRepeatMenu(5);
1467   7                                                                              LCM_erase_one_page(4);
1468   7                                                                              LCM_erase_one_page(5);
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 25  

1469   7                                                                              LCM_erase_one_page(6);
1470   7                                                                              LCM_erase_one_page(7);
1471   7                                                                      }
1472   6                                                              }
1473   5                                                              else if(gc_PlayMenuNum==1)      // EQ menu
1474   5                                                              {
1475   6                                                                      gc_PlayMenuItem=3;
1476   6                                                                      if(gs_DSP_GLOBAL_RAM.sc_EQ_Type<4)
1477   6                                                                      {
1478   7                                                                              LCM_ShowEQMenu(0);
1479   7                                                                              LCM_ShowEQMenu(1);
1480   7                                                                              LCM_ShowEQMenu(2);
1481   7                                                                              LCM_ShowEQMenu(3);
1482   7                                                                      }
1483   6                                                                      else
1484   6                                                                      {
1485   7                                                                              LCM_ShowEQMenu(4);
1486   7                                                                              LCM_ShowEQMenu(5);
1487   7                                                                              LCM_erase_one_page(4);
1488   7                                                                              LCM_erase_one_page(5);
1489   7                                                                              LCM_erase_one_page(6);
1490   7                                                                              LCM_erase_one_page(7);
1491   7                                                                      }
1492   6                                                              }
1493   5                                                              else if(gc_PlayMenuNum==2)      // A-B
1494   5                                                              {
1495   6                                                                      gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode=REPEAT_A;
1496   6                                                                      gc_MenuTimer=0;
1497   6                                                              }
1498   5                                                              else    // Exit
1499   5                                                              {
1500   6                                                                      gc_MenuTimer=0;
1501   6                                                              }
1502   5                                                      }
1503   4                                                      else if(gc_PlayMenuItem==2)     // Confirm Repeat mode
1504   4                                                      {
1505   5                                                              gc_RepPlayMode=gc_RepeatMenuNum;
1506   5                                                              gc_MenuTimer=0;
1507   5                                                              LCM_ShowPlayModeIcon();
1508   5                                                      }
1509   4                                                      else if(gc_PlayMenuItem==3)     // Confirm EQ
1510   4                                                      {
1511   5                                                              gc_MenuTimer=0;
1512   5                                                              LCM_ShowEQIcon();
1513   5                                                      }
1514   4                                                      else    // Exit
1515   4                                                      {
1516   5                                                              gc_MenuTimer=0;
1517   5                                                      }
1518   4                                              break;
1519   4      
1520   4                                              case 0x12:      // L-Play
1521   4                                                      gc_Task_Current=C_Task_Suspend;
1522   4                                              break;
1523   4      
1524   4                                              case 0x13:      // L-Next(FF)
1525   4                                                      LCM_ShowSongTime();
1526   4                                                      UI_fastFFFR_Play(0);
1527   4                                              break;
1528   4      
1529   4                                              case 0x14:      // L-Prev(FR)
1530   4                                                      LCM_ShowSongTime();
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 26  

1531   4                                                      UI_fastFFFR_Play(1);
1532   4                                              break;
1533   4      
1534   4                                              case 0x15:      // L-V
1535   4                                                      MediaChange();
1536   4                                              break;
1537   4      
1538   4                                              case 0x16:      // L-M
1539   4                                                      gc_LastCard=gc_CurrentCard;
1540   4                                                      gc_Task_Current=C_Task_Idle;
1541   4                                              break;
1542   4                                      }
1543   3                              }
1544   2                              FillAudioDataToDSP();
1545   2      
1546   2                              if((gs_System_State.c_Phase==TASK_PHASE_PLAYACT)&&(gc_PlayMenuItem==0))
1547   2                              {
1548   3                                      // 頻譜
1549   3                                      if(gc_PinPuTimer==0)
1550   3                                      {
1551   4                                              LCM_ShowPinPu();
1552   4                                      }
1553   3      
1554   3                                      if(gb_RTC_wakeup==1)    // 1-Sec
1555   3                                      {
1556   4                                              gb_RTC_wakeup=0;
1557   4                                              // Bit-Rate
1558   4                                              if(gc_Play_FileType==0)
1559   4                                              {
1560   5                                                      tw_temp=L2_DSP_Read_DMem16(DSP_MP3Bitrate);
1561   5                                              }
1562   4                                              else
1563   4                                              {
1564   5                                                      tw_temp=L2_DSP_Read_DMem16(DSP_WMABitrate);
1565   5                                              }
1566   4                                              if(gs_System_State.w_SampleRate!=tw_temp)
1567   4                                              {
1568   5                                                      gs_System_State.w_SampleRate=tw_temp;
1569   5                                                      LCM_ShowBitRate();
1570   5                                              }
1571   4      
1572   4                                              if(gb_LrcFileName_Exist==1)
1573   4                                              {
1574   5                                                      // LRC
1575   5                                                      LRC_DisplayFunction();                                                          
1576   5                                              }
1577   4      
1578   4                                              if((gc_ShowTimer==0)&&(gc_IR_Timer==0))
1579   4                                              {
1580   5                                                      // Play-Time
1581   5                                                      LCM_ShowPlayTime(gw_Disp_CurrentSec);
1582   5                                              }
1583   4                                      }
1584   3                              }
1585   2      
1586   2                              //---------IR KEY NUMBER PUSH DOWN CHECK--------------------------
1587   2                              if(gb_IRNumberFlag!=0)
1588   2                              {
1589   3                                      CheckIRKeyPushDownTimerOut(2);
1590   3                              }
1591   2      
1592   2                              //---------DisPlay File Name---------------------------------------
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 27  

1593   2                              if((gc_ShowTimer==0)&&(gc_IR_Timer==0)&&(gc_PlayMenuItem==0))
1594   2                              {
1595   3                                      if(gb_ClearBigIcon==1)
1596   3                                      {
1597   4                                              gb_SetVol=0;
1598   4                                              gb_ClearBigIcon=0;
1599   4                                              gc_LCMScrollTimer=0;
1600   4                                              LCM_Clear_L2_L7();
1601   4                                              LCM_ShowSongTime();
1602   4                                              LCM_ShowPlayTime(gw_Disp_CurrentSec);
1603   4                                      }
1604   3                                      //---- Long File Name Diplay---------------------------------------
1605   3                                      if(gb_LrcFileName_Exist==0)
1606   3                                      {
1607   4                                              if(gc_LCMScrollTimer==0)
1608   4                                              {
1609   5                                                      LCM_Disp_FileName(&gc_FileLongName[gw_DispFileName_ByteOffset+5],gc_FileLongName[2],gc_FileLongName[
             -4]-gw_DispFileName_ByteOffset,1);
1610   5                                                      gc_LCMScrollTimer=34;
1611   5                                              }
1612   4                                      }
1613   3                              }
1614   2                      break;
1615   2      
1616   2                      case TASK_PHASE_PAUSE:
1617   2                              switch(gc_KeyEvent)
1618   2                              {
1619   3                                      case 0x02://C_PlayPause:
1620   3                                              Music_ResumeCmd();
1621   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1622   3                                              LCM_ShowPlayPauseIcon();
1623   3                                              gb_ClearBigIcon=1;
1624   3                                              gc_ShowTimer=0;
1625   3                                              gc_LCMScrollTimer=0;
1626   3                                              //-----LRC Display------------------------------------------
1627   3                                              if(gb_LrcFileName_Exist)
1628   3                                              {
1629   4                                                      gb_ClearBigIcon=0;
1630   4                                                      if(gc_Play_FileType==0)
1631   4                                                      {
1632   5                                                              MP3_DataIn();
1633   5                                                      }
1634   4                                                      else
1635   4                                                      {
1636   5                                                              WMA_DataIn();   
1637   5                                                      }
1638   4                                                      LCM_DisplayString(&gc_LrcDisplayBuf,gc_LrcCurrentLen-1,32);
1639   4                                              }
1640   3                                      break;
1641   3      
1642   3                                      case 0x03:      // Next
1643   3                                              if(gc_PlayMenuItem==0)  // 1=Play-Menu  2=Repeat-Mode  3=EQ-Option
1644   3                                              {
1645   4                                                      gb_ClearBigIcon=1;
1646   4                                                      ClearIRNumberVariable();
1647   4                                                      if(gb_SetVol)
1648   4                                                      {
1649   5                                                              gb_ADJ=0;
1650   5                                                              VOL_Adj();
1651   5                                                      }
1652   4                                                      else
1653   4                                                      {                                               
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 28  

1654   5                                                              play_next();
1655   5                                                      }
1656   4                                              }
1657   3                                      break;
1658   3      
1659   3                                      case 0x05:      // V
1660   3                                              if(gc_PlayMenuItem==0&&gb_SetVol==0)
1661   3                                              {
1662   4                                                      gb_ClearBigIcon=1;
1663   4                                                      gb_SetVol=1;                            
1664   4                                                      LCM_Clear_L2_L5();
1665   4                                                      LCM_ShowVOL();
1666   4                                                      ClearIRNumberVariable();
1667   4                                              }
1668   3                                              else
1669   3                                              {
1670   4                                                      gc_MenuTimer=0;
1671   4                                              }
1672   3                                      break;
1673   3      
1674   3                                      case 0x12:      // L-Play
1675   3                                              gc_Task_Current=C_Task_Suspend;
1676   3                                      break;
1677   3      
1678   3                                      case 0x16:      // L-M
1679   3                                              gc_Task_Current=C_Task_Idle;
1680   3                                      break;
1681   3                              }
1682   2                      break;
1683   2      
1684   2                      case TASK_PHASE_STOP:
1685   2                              switch(gc_KeyEvent)
1686   2                              {
1687   3                                      case 0x02://C_PlayPause:
1688   3                                              gb_Mp3FileEnd=1;
1689   3                                              gs_System_State.c_Phase=TASK_PHASE_PLAYACT;
1690   3                                              LCM_ShowPlayPauseIcon();
1691   3                                              gb_ClearBigIcon=1;
1692   3                                              gc_ShowTimer=0;
1693   3                                              gc_LCMScrollTimer=0;
1694   3                                      break;
1695   3      
1696   3                                      case 0x03:      // Next
1697   3                                              if(gc_PlayMenuItem==0)  // 1=Play-Menu  2=Repeat-Mode  3=EQ-Option
1698   3                                              {
1699   4                                                      gb_ClearBigIcon=1;
1700   4                                                      ClearIRNumberVariable();
1701   4                                                      if(gb_SetVol)
1702   4                                                      {
1703   5                                                              gb_ADJ=0;
1704   5                                                              VOL_Adj();
1705   5                                                      }
1706   4                                                      else
1707   4                                                      {                                               
1708   5                                                              play_next();
1709   5                                                      }
1710   4                                              }
1711   3                                      break;
1712   3      
1713   3                                      case 0x05:      // V
1714   3                                              if(gc_PlayMenuItem==0&&gb_SetVol==0)
1715   3                                              {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 29  

1716   4                                                      gb_ClearBigIcon=1;
1717   4                                                      gb_SetVol=1;                            
1718   4                                                      LCM_Clear_L2_L5();
1719   4                                                      LCM_ShowVOL();
1720   4                                                      ClearIRNumberVariable();
1721   4                                              }
1722   3                                              else
1723   3                                              {
1724   4                                                      gc_MenuTimer=0;
1725   4                                              }
1726   3                                      break;
1727   3      
1728   3                                      case 0x12:      // L-Play
1729   3                                              gc_Task_Current=C_Task_Suspend;
1730   3                                      break;
1731   3      
1732   3                                      case 0x16:      // L-M
1733   3                                              gc_Task_Current=C_Task_Idle;
1734   3                                      break;
1735   3                              }
1736   2                      break;
1737   2              }
1738   1              gc_KeyEvent=0;
1739   1      }
1740          
1741          
1742          void Play_Task()
1743          {
1744   1              gb_Mp3FileEnd=1;//sunzhk add 0314wq
1745   1              gc_CurrentCard=gc_LastCard;
1746   1              while(1)
1747   1              {
1748   2                      Key_Detect();
1749   2                      if(gc_IRCmdStatus!=0)
1750   2                      {
1751   3                              IR_Service_Process();
1752   3                      }
1753   2      
1754   2                      if(gc_CurrentCard!=9)
1755   2                      {
1756   3                              MP3FunctionProc();
1757   3                      }
1758   2      
1759   2                      if(gc_CurrentCard!=9)
1760   2                      {
1761   3                              OpenAudioFile();
1762   3                      }
1763   2      
1764   2                      if(gc_CurrentCard!=9)
1765   2                      {
1766   3                              CheckAudioStatus();
1767   3                      }
1768   2                      Play_SourceDetect_Process();
1769   2      
1770   2                      if(gb_LogDataFlag==1)
1771   2                      {
1772   3                              gb_LogDataFlag=0;
1773   3                              USER_LogFile_ReadWrite(1);
1774   3                      }
1775   2      
1776   2                      if(gb_ShowBatt==1&&gc_PlayMenuItem==0)
1777   2                      {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 30  

1778   3                              gb_ShowBatt=0;
1779   3                              LCM_ShowBattIcon();
1780   3                      }
1781   2      
1782   2                      if(gc_CurrentCard==9)
1783   2                      {
1784   3                              gc_Task_Current=C_Task_Idle;
1785   3                      }
1786   2      
1787   2                      if(gb_OrderRecordTrigger==1)
1788   2                      {
1789   3                              gc_Task_Current=C_Task_FM;
1790   3                      }
1791   2      
1792   2                      if(gb_AlarmTrigger==1)
1793   2                      {
1794   3                              if(CheckAlarmSetting()==0)      // Match Alarm Clock Setting
1795   3                              {
1796   4                                      gc_Task_Last=C_Task_MusicPlay;
1797   4                                      gc_Task_Current=C_Task_AlarmON;
1798   4                              }
1799   3                      }
1800   2      /*
1801   2      if(!(XBYTE[0xb409]&0x04))//LineIn insert 
1802   2      {
1803   2              dbprintf("LineIn insert\n");
1804   2              gc_Task_Current=C_Task_LineIn;  
1805   2      }*/
1806   2                      if(gc_Task_Current!=C_Task_MusicPlay)
1807   2                      {
1808   3                              if((gs_System_State.c_Phase==TASK_PHASE_PLAYACT)||(gs_System_State.c_Phase==TASK_PHASE_PAUSE))
1809   3                              {
1810   4                                      play_stop();
1811   4                              }
1812   3                              break;
1813   3                      }
1814   2      
1815   2                      if(gs_DSP_GLOBAL_RAM.s_DSP_RAM.sc_RepeatMode!=REPEAT_AB_NULL)
1816   2                      {
1817   3                              if(gc_ShowRepeatTimer==0)
1818   3                              {
1819   4                                      gc_ShowRepeatTimer=10;
1820   4                                      LCM_ShowRepeatIcon();
1821   4                              }
1822   3                      }
1823   2              }
1824   1      }
1825          
1826          
1827          void L2_DSP_MCU_DM_DMA_24bit(U16 BufferIndex,U8 tc_Dest_Addr_High,U16 tw_Src)
1828          {
1829   1              data    U16 tw_DSP_Word_Align;
1830   1              xdata   U8  tc_DSPAddr_High;
1831   1              code    U16     gw_DSP_Addr_Table[3]={0x0000,0x80aa,0x4155};
1832   1      
1833   1              // ----- DMA Reset -----
1834   1              XBYTE[0xB304] = 0x09;
1835   1              XBYTE[0xB304] = 0x08;
1836   1              XBYTE[0xB3C0] = 0x00;           // clear DMA complete
1837   1              XBYTE[0xB330] = 0x01;           // clear checksum
1838   1      
1839   1              // ----- DMA initial settings for DM transfer -----
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 31  

1840   1              XBYTE[0xB216] = 0x00;   // Remain DSP mode.  When you do MCU -> DM, MCU will stop DSP automaticlly
1841   1              XBYTE[0xB301] = 0x50;   // DMA : SRAM --> DM
1842   1              XBYTE[0xB302] = 0xFF;   // Define data size in DMA (assume 512 bytes)
1843   1              XBYTE[0xB303] = 0x01;
1844   1      
1845   1              // Destination
1846   1              XBYTE[0xB340]=0x00;     // 24-bit DMA
1847   1              tw_DSP_Word_Align=gw_DSP_Addr_Table[BufferIndex%3]+0x200*(BufferIndex/3);
1848   1              tc_DSPAddr_High=*((U8 *)&tw_DSP_Word_Align);
1849   1              XBYTE[0xB21D]=(U8)(tc_DSPAddr_High>>6);
1850   1              tc_DSPAddr_High=*((U8 *)&tw_DSP_Word_Align);
1851   1              tc_DSPAddr_High=tc_DSPAddr_High&0x3F;
1852   1              tc_DSPAddr_High+=tc_Dest_Addr_High;
1853   1              XBYTE[0xB217]=*((U8 *)&tw_DSP_Word_Align+1);
1854   1              XBYTE[0xB218]=tc_DSPAddr_High;
1855   1              // Source
1856   1              XBYTE[0xB112]=(tw_Src<<8)>>8;
1857   1              XBYTE[0xB113]=(tw_Src>>8);
1858   1              Trigger_Data_Transfer_Done();
1859   1      }
1860          
1861          
1862          void JumpToTargetFolder(void)
1863          {
1864   1              xdata   U8      temp;
1865   1      
1866   1              gb_FindFlag=0;
1867   1              gb_LrcFileName_Exist=0;
1868   1              // 計算目錄中之歌曲數
1869   1              DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_MusicFileType,C_CmpExtName|C_Next);
1870   1              if(gw_FileTotalNumber[0]==0)
1871   1          {
1872   2              if(gc_CurrentCard==2) //if SD no file change to Host or flash
1873   2              {
1874   3                  gb_SDNoFileflag=1; 
1875   3                          return;
1876   3              }
1877   2                      if(gc_CurrentCard==5) //if Host no file change to SD or flash
1878   2              {
1879   3                  gb_HostNoFileflag=1;  
1880   3                          return;
1881   3              }
1882   2          }
1883   1      
1884   1              if(gw_FileIndex[0]==0)
1885   1              {
1886   2                      gw_FileIndex[0]=1;
1887   2              }
1888   1              gw_FileSkipNumber=gw_FileIndex[0];
1889   1              gw_FileIndex[0]=0;
1890   1              temp=DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
1891   1              if((temp==1)||(gb_HostError==1))
1892   1              {
1893   2                      gb_HostError=0;
1894   2                      gs_File_FCB[0].dw_FDB_StartCluster=gdw_DOS_RootDirClus;
1895   2                      DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_MusicFileType,C_CmpExtName|C_Next);
1896   2                      gw_FileSkipNumber=0;
1897   2                      gw_FileIndex[0]=0;
1898   2                      if(gw_FileTotalNumber[0]==0)
1899   2                  {
1900   3                      if(gc_CurrentCard==2) //if SD no file change to Host or flash
1901   3                      {
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 32  

1902   4                          gb_SDNoFileflag=1; 
1903   4                                  return;
1904   4                      }
1905   3                              if(gc_CurrentCard==5) //if Host no file change to SD or flash
1906   3                      {
1907   4                          gb_HostNoFileflag=1;  
1908   4                                  return;
1909   4                      }
1910   3                  }
1911   2                      else
1912   2                      {
1913   3                              DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
1914   3                      }
1915   2              }
1916   1      }
1917          
1918          U8 MP3_Repeat_DataIn(void)
1919          {
1920   1              data    U8      tc_Cnt;
1921   1              data    U8      i;
1922   1              data    U16     TimeOUT;
1923   1      
1924   1              // Fill bitstream into buffer
1925   1              for(i=0;i<10;i++)
1926   1              {
1927   2                      if(L2_DSP_Read_DMem16(DSP_EmptyBuffer)>=512)
1928   2                      {
1929   3                              if(DOS_Read_File(0))
1930   3                              {
1931   4                                      break;
1932   4                              }
1933   3                              L2_DSP_MCU_DM_DMA_24bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
1934   3                              L2_DSP_SendCommandSet(DCMD_DatIn);
1935   3      
1936   3                              if(gs_DSP_GLOBAL_RAM.sc_DM_Index>=24)
1937   3                              {
1938   4                                      gs_DSP_GLOBAL_RAM.sc_DM_Index=0;        // DM Range: 0x2000 ~  0x2FFF
1939   4                              }
1940   3                      }
1941   2                      else
1942   2                      {
1943   3                              break;
1944   3                      }
1945   2              }
1946   1              // Send STOP command to DSP
1947   1              if(DSP_StopCmd()!=0)
1948   1              {
1949   2                      return DSP_STOP_COMMAND_ERROR;
1950   2              }
1951   1      
1952   1              TimeOUT=0xFFFF;
1953   1              do{
1954   2                      TimeOUT --;
1955   2                      if(TimeOUT==0)
1956   2                      {
1957   3                              return DSP_DECODE_STATUS_TIMEOUT_ERROR;
1958   3                      }
1959   2              }while(!((L2_DSP_Read_DMem16(DSP_DecodeStatus)&0x00C0)==0x00C0));  //wait file end
1960   1      
1961   1              L2_DSP_Write_DMem16(DSP_DecodeStatus,L2_DSP_Read_DMem16(DSP_DecodeStatus)&0xFF3F);
1962   1              L2_DSP_Write_DMem16(DSP_RemainBuffer,0);
1963   1              L2_DSP_Write_DMem16(DSP_EmptyBuffer,0x3000);
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 33  

1964   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
1965   1      
1966   1              if(gs_DSP_GLOBAL_RAM.sdw_File_ACluster==0xFFFFFFFF)
1967   1              {       // recalculate cluster location
1968   2                      gs_File_FCB[0].dw_File_DataPoint=0;
1969   2                      gs_File_FCB[0].dw_File_CurrentCluster=gs_File_FCB[0].dw_File_StartCluster;
1970   2                      gs_DSP_GLOBAL_RAM.sdw_File_ACluster=DOS_Seek_File(0,gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint>>9);          
1971   2              }
1972   1      
1973   1              // Seek to right point
1974   1              gs_File_FCB[0].dw_File_CurrentCluster=gs_DSP_GLOBAL_RAM.sdw_File_ACluster;
1975   1              gs_File_FCB[0].dw_File_DataPoint=gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint;
1976   1      
1977   1              // restart DSP, Jimi 081125
1978   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
1979   1              {
1980   2                      if(DSP_PlayInit()==0)
1981   2                      {
1982   3                              break;
1983   3                      }
1984   2      
1985   2                      if(tc_Cnt>=5) 
1986   2                      {
1987   3                              XBYTE[0xB002]|=0x01;            // DSP reset
1988   3                      }
1989   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
1990   2              }
1991   1              L2_DSP_Write_DMem16(DSP_VolumeControl,gs_DSP_GLOBAL_RAM.sc_Volume);
1992   1              // Jimi Yu 081208
1993   1              L2_DSP_Write_DMem16(DSP_PostProcessSelect,L2_DSP_Read_DMem16(DSP_PostProcessSelect)|0x0020);
1994   1              TimeOUT=0xFFFF;
1995   1              while((L2_DSP_Read_DMem16(DSP_PostProcessSelect)&0x0020))       //Handshake with DSP to make sure that DSP has 
             -ramp digital volume up.
1996   1              {
1997   2                      TimeOUT--;
1998   2                      if(TimeOUT==0)
1999   2                      {
2000   3                              break;
2001   3                      }
2002   2              }
2003   1              Music_EQ_Cmd();
2004   1              L2_DSP_Write_DMem16(DSP_DecodeFrameCounter,gw_AFrameCnt);       // Jimi 080530, to Get actual time
2005   1      
2006   1              // Send PLAY command to DSP
2007   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
2008   1              {
2009   2                      return DSP_PLAY_COMMAND_ERROR;
2010   2              }
2011   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;        // reset bitstream address of DM
2012   1              return  0;
2013   1      }
2014          
2015          U8 WMA_Repeat_DataIn(void)
2016          {
2017   1              data    U8      i;
2018   1              data    U16     TimeOUT;
2019   1      
2020   1              for(i=0;i<10;i++)
2021   1              {
2022   2                      if(L2_DSP_Read_DMem16(DSP_EmptyBuffer)>=3*512)
2023   2                      {
2024   3                              if(DOS_Read_File(0))
C51 COMPILER V9.00   PLAY_PROCESS                                                          07/09/2012 21:16:52 PAGE 34  

2025   3                              {
2026   4                                      break;
2027   4                              }
2028   3      
2029   3                              L2_DSP_MCU_DM_DMA_24bit(gs_DSP_GLOBAL_RAM.sc_DM_Index++,0x20,(U16)gc_PlayRecordDataBuf);
2030   3                              L2_DSP_SendCommandSet(DCMD_DatIn);
2031   3      
2032   3                              if (gs_DSP_GLOBAL_RAM.sc_DM_Index>=30)
2033   3                              {
2034   4                                      gs_DSP_GLOBAL_RAM.sc_DM_Index=0;        // DM Range: 0x2000 ~  0x37FF
2035   4                              }
2036   3                      }
2037   2              }
2038   1              // Send Pause command to DSP
2039   1              if (DSP_PauseCmd()!=DSP_SUCCESS)
2040   1              {
2041   2                      return DSP_PAUSE_COMMAND_ERROR;
2042   2              }
2043   1              TimeOUT=0xFFFF;
2044   1              do{
2045   2                      TimeOUT --;
2046   2                      if(TimeOUT==0)
2047   2                      {
2048   3                              return DSP_DECODE_STATUS_TIMEOUT_ERROR;
2049   3                      }
2050   2              } while(!L2_DSP_Read_DMem16(DSP_RampDownComplete)); //Jimi 090417, DSP_RampDownComplete = 0x3FB8, indicat
             -es RampDown OK or NOT
2051   1      
2052   1              // Seek to right point
2053   1              gs_File_FCB[0].dw_File_CurrentCluster=gs_DSP_GLOBAL_RAM.sdw_File_ACluster;
2054   1              gs_File_FCB[0].dw_File_DataPoint=gs_DSP_GLOBAL_RAM.sdw_File_ADataPoint;
2055   1              
2056   1              //WMA Seek trigger and reset BS buffer, and send play cmd
2057   1              WMA_seek_trig();
2058   1              return  0;
2059   1      }
2060          
2061          
2062          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   5530    ----
   CONSTANT SIZE    =     30    ----
   XDATA SIZE       =   ----      28
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      50
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
