C51 COMPILER V9.00   MCU_DSPINIT                                                           07/09/2012 21:16:53 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MCU_DSPINIT
OBJECT MODULE PLACED IN .\obj\mcu_dspinit.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Play\mcu_dspinit.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsourc
                    -e\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\mcu_dspinit.lst) OBJECT(.\obj\mcu_dspinit.obj)

line level    source

   1          #include "..\header\SPDA2K.h"
   2          #include "..\DSP\DSPPHYSIC.H"
   3          #include "..\DSP\dspuser.h"
   4          #include "..\header\variables.h"
   5          
   6          
   7          U8 MP3_Download(void)
   8          {
   9   1              data    U8 tc_Cnt;
  10   1      
  11   1              DSP_WakeUp();
  12   1              if(DSP_Download(0x00,0x10)!=DSP_SUCCESS)
  13   1              {
  14   2                      return DSP_PLAY_COMMAND_ERROR;
  15   2              }
  16   1      
  17   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
  18   1              {
  19   2                      if(DSP_PlayInit()==DSP_SUCCESS)
  20   2                      {
  21   3                              return 0;
  22   3                      }
  23   2      
  24   2                      if(tc_Cnt>=5) 
  25   2                      {
  26   3                              XBYTE[0xB002]|=0x01;            // DSP reset
  27   3                      }
  28   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
  29   2              }
  30   1      
  31   1              return DSP_PLAY_COMMAND_ERROR;
  32   1      }
  33          
  34          
  35          U8 WMA_Download(void)
  36          {
  37   1              data    U8 tc_Cnt;
  38   1              data    U8 tc_result;
  39   1      
  40   1              tc_result=0;
  41   1              DSP_WakeUp();
  42   1              if(DSP_Download(0x12,0x25)!=DSP_SUCCESS)
  43   1              {
  44   2                      return 0x90;
  45   2              }
  46   1      
  47   1              L2_DSP_Write_DMem16(DSP_W_asf_parse_ok,0);
  48   1              L2_DSP_Write_DMem16(DSP_W_asf_parse_mode,1);            //Set ASF Parser Mode
  49   1      
  50   1              for (tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
  51   1              {
  52   2                      if (DSP_PlayInit()==DSP_SUCCESS)
  53   2                      {
  54   3                              break;
C51 COMPILER V9.00   MCU_DSPINIT                                                           07/09/2012 21:16:53 PAGE 2   

  55   3                      }
  56   2      
  57   2                      if(tc_Cnt>=5) 
  58   2                      {
  59   3                              XBYTE[0xB002]|=0x01;            // DSP reset
  60   3                      }
  61   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
  62   2              }
  63   1              if (tc_Cnt == 10)
  64   1              {
  65   2                      return 0x91;
  66   2              }
  67   1      
  68   1      /*------------------------------------------------------------------*/
  69   1      /* WMA download IMPM step:                                          */
  70   1      /* 1. ASF parser mode: to check what entropy mode this bitstream is */
  71   1      /* 2. check DRM: option                                             */
  72   1      /* 3. normal wma download: to download the correct IMPM             */
  73   1      /*------------------------------------------------------------------*/
  74   1      
  75   1      //-------------------
  76   1      //1. ASF parser mode
  77   1      //-------------------
  78   1      
  79   1              if(L2_DSP_SendCommandSet(DCMD_Play) != DCMD_Play)
  80   1              {
  81   2                      return 0x92;
  82   2              }
  83   1      
  84   1              gs_DSP_GLOBAL_RAM.sc_DM_Index = 0;      // reset bitstream address of DM 
  85   1      
  86   1              if (DOS_Open_File_r(0x00,0x02,0x00))
  87   1              {
  88   2                      return 0x93;
  89   2              }
  90   1      
  91   1              while(tc_result == 0)
  92   1              {
  93   2                      if(WMA_DataIn() == DSP_DATAIN_COMMAND_ERROR)    
  94   2                      {
  95   3                              return 0x94;
  96   3                      }
  97   2      
  98   2                      tc_result = L2_DSP_Read_DMem16(DSP_W_asf_parse_ok);
  99   2              }
 100   1      
 101   1              if(tc_result != 1)
 102   1              {
 103   2                      return 0x95;
 104   2              }
 105   1      
 106   1      /*-- DSP will jump to pc=0 automatically after asf parse has been done--*/
 107   1      
 108   1      //----------------------
 109   1      //2. Normal wma download
 110   1      //----------------------
 111   1              switch(L2_DSP_Read_DMem16(DSP_w_EntropyMode))
 112   1              {
 113   2                      case 1:
 114   2                              tc_result=DSP_Download(0x01,0x23);
 115   2                      break;
 116   2      
C51 COMPILER V9.00   MCU_DSPINIT                                                           07/09/2012 21:16:53 PAGE 3   

 117   2                      case 2:
 118   2                              tc_result=DSP_Download(0x01,0x24);
 119   2                      break;
 120   2      
 121   2                      case 3:
 122   2                              tc_result=DSP_Download(0x01,0x25);
 123   2                      break;
 124   2              }
 125   1                      
 126   1              if(tc_result != DSP_SUCCESS )   
 127   1              {
 128   2                      return 0x96;
 129   2              }
 130   1      
 131   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
 132   1              {
 133   2                      if(DSP_PlayInit()==DSP_SUCCESS)
 134   2                      {
 135   3                              break;
 136   3                      }
 137   2      
 138   2                      if(tc_Cnt>=5) 
 139   2                      {
 140   3                              XBYTE[0xB002]|=0x01;            // DSP reset
 141   3                      }
 142   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
 143   2              }
 144   1      
 145   1              if (tc_Cnt == 10)
 146   1              {
 147   2                      return 0x97;    
 148   2              }
 149   1              L2_DSP_Write_DMem16(DSP_W_asf_parse_mode,0);            //Clear ASF Parser Mode
 150   1              return DSP_SUCCESS;
 151   1      }
 152          
 153          U8 WAV_Play_Download(void)
 154          {
 155   1              data    U8 tc_Cnt;
 156   1      
 157   1              DSP_WakeUp();
 158   1              if(DSP_Download(0x02,0x12)!=0)
 159   1              {   
 160   2                      return DSP_PLAY_COMMAND_ERROR;
 161   2              }
 162   1      
 163   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
 164   1              {
 165   2                      if(DSP_PlayInit()==DSP_SUCCESS)
 166   2                      {
 167   3                              break;
 168   3                      }
 169   2      
 170   2                      if(tc_Cnt>=5) 
 171   2                      {
 172   3                              XBYTE[0xB002]|=0x01;            // DSP reset
 173   3                      }
 174   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
 175   2              }
 176   1              if(tc_Cnt==10)
 177   1              {
 178   2                      return DSP_PLAY_COMMAND_ERROR;
C51 COMPILER V9.00   MCU_DSPINIT                                                           07/09/2012 21:16:53 PAGE 4   

 179   2              }
 180   1      
 181   1              return 0;
 182   1      }
 183          
 184          U8 IMA_ADPCM_Rec_Download(void)
 185          {
 186   1              data    U8      tc_Cnt;
 187   1      
 188   1              DSP_WakeUp();
 189   1              if(DSP_Download(0x09,0x19)!=0)
 190   1              {
 191   2                      return DSP_PLAY_COMMAND_ERROR;
 192   2              }
 193   1      
 194   1              for(tc_Cnt=0;tc_Cnt<10;++tc_Cnt) 
 195   1              {
 196   2                      if(DSP_PlayInit()==0)
 197   2                      {
 198   3                              break;
 199   3                      }
 200   2                      if(tc_Cnt>=5) 
 201   2                      {
 202   3                              XBYTE[0xB002]|=0x01;            // DSP reset
 203   3                      }
 204   2                      XBYTE[0xB002]&=0xFE;            // Enable DSP Run Normal Mode
 205   2              }
 206   1      //      USER_Delay(15); // delay 10 ms
 207   1              if(tc_Cnt==10)
 208   1              {
 209   2                      return DSP_PLAY_COMMAND_ERROR;
 210   2              }
 211   1              return 0;
 212   1      }
 213          
 214          U8 IMA_ADPCM_Rec_PlayCmd(U8 tc_SampleRate,U8 tc_ChannelNum)
 215          {
 216   1              data    U16 tw_CtrlMode;
 217   1      
 218   1              //setup Channel Number
 219   1              L2_DSP_Write_DMem16(0x3CAB,tc_ChannelNum);
 220   1              tw_CtrlMode=L2_DSP_Read_DMem16(DSP_ADPCMModeControl);
 221   1              // setup Sampling Rate
 222   1              if(tc_SampleRate==16)
 223   1              {
 224   2                      tw_CtrlMode=tw_CtrlMode|0x0010;
 225   2              }
 226   1              else if(tc_SampleRate==32)
 227   1              {
 228   2                      tw_CtrlMode=tw_CtrlMode|0x0020;
 229   2              }
 230   1              else    // always set 8K sampling rate
 231   1              {
 232   2                      tw_CtrlMode=tw_CtrlMode&0xFFEF;
 233   2              }
 234   1              L2_DSP_Write_DMem16(DSP_ADPCMModeControl,tw_CtrlMode);
 235   1      
 236   1              if(L2_DSP_SendCommandSet(DCMD_Play)!=DCMD_Play)
 237   1              {
 238   2                      return DSP_PLAY_COMMAND_ERROR;
 239   2              }
 240   1              gs_DSP_GLOBAL_RAM.sc_DM_Index=0;
C51 COMPILER V9.00   MCU_DSPINIT                                                           07/09/2012 21:16:53 PAGE 5   

 241   1              return 0;
 242   1      }
 243          
 244          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    508    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
