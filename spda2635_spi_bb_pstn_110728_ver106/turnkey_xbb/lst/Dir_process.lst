C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DIR_PROCESS
OBJECT MODULE PLACED IN .\obj\Dir_process.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE DIR\Dir_process.c LARGE OPTIMIZE(9,SIZE) BROWSE NOAREGS INCDIR(..\libsource
                    -\header) DEFINE(K_ICTYPE=0x03) DEBUG OBJECTEXTEND PRINT(.\lst\Dir_process.lst) OBJECT(.\obj\Dir_process.obj)

line level    source

   1          #include "..\Header\SPDA2K.h"
   2          #include "..\LCM\LCM_BMP.h"
   3          #include "..\header\variables.h"
   4          
   5          #define K_COUNTER_DIRNUM  11
   6          #define C_DirIdle       0x00
   7          #define C_DirNext       0x01
   8          #define C_DirPrev       0x02
   9          #define C_DirBackUpper  0x03
  10          #define C_DirEnterChild 0x04
  11          
  12          
  13          #define C_BUF_LENGTH    128     
  14          #define C_LCM_ROW_MAX     4     
  15          #define C_BUF_STRING    122     
  16          #define DIR_OFFSET       18     
  17          #define Glass_ColumnNum 128     
  18          
  19          
  20          
  21          U8 Count_Dir_Fdb(SearchFdb *p_mp)
  22          {
  23   1              data    bit     tb_Check1stFDB;
  24   1              data    U8  tc_SectorOffset;
  25   1              xdata   U16 tw_FdbOffset;
  26   1              xdata   U32     tdw_SectorAdd;
  27   1              xdata   U32     tdw_S_ClusterNum;
  28   1              xdata   U32     tdw_Find_ClusterSize;
  29   1              xdata   U32     tdw_TheEndCluster;
  30   1              
  31   1              p_mp->w_DirTotalNum=0;
  32   1              tdw_S_ClusterNum=p_mp->dw_FDB_StartCluster ;
  33   1              
  34   1              if(gc_DOS_FileSystemType==1)
  35   1              {
  36   2                      tdw_TheEndCluster=0xffff;               //FAT16
  37   2              }
  38   1          else
  39   1              {
  40   2                      tdw_TheEndCluster=0x0fffffff;   //FAT32
  41   2              }
  42   1      
  43   1              tb_Check1stFDB=0;
  44   1              if(p_mp->dw_FDB_StartCluster != gdw_DOS_RootDirClus) 
  45   1              {
  46   2                      tb_Check1stFDB=1;
  47   2              }
  48   1          
  49   1          while(tdw_S_ClusterNum<tdw_TheEndCluster)
  50   1          {//find in one dir
  51   2              if(tdw_S_ClusterNum)
  52   2              {
  53   3                  tdw_Find_ClusterSize=gc_DOS_SectorPerCluster;
  54   3                  tdw_SectorAdd=DOS_ClusterLogicAddr(tdw_S_ClusterNum);
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 2   

  55   3              }
  56   2              else //FAT16's rootdir
  57   2              {
  58   3                  tdw_Find_ClusterSize=(gdw_DOS_DataAddr-gdw_DOS_RootDirAddr);
  59   3                  tdw_SectorAdd=gdw_DOS_RootDirAddr;
  60   3              }
  61   2              for(tc_SectorOffset=0;tc_SectorOffset<tdw_Find_ClusterSize;tc_SectorOffset++)
  62   2              {//find in one cluster 
  63   3                  gb_ReadWriteDataArea=1;
  64   3                  if(DOS_Read_LogicSector(tdw_SectorAdd+tc_SectorOffset)) //read fail
  65   3                              {
  66   4                                      return 0xff ;
  67   4                              }
  68   3      
  69   3                              //Ching 090420
  70   3                              if(tb_Check1stFDB) //check . and ..
  71   3                              {
  72   4                                      tb_Check1stFDB=0;
  73   4                                      if((gc_UserDataBuf[0x00]!=0x2E) || (gc_UserDataBuf[0x0B]!=0x10) || (gc_UserDataBuf[0x20]!=0x2E) || (gc
             -_UserDataBuf[0x21]!=0x2E) || (gc_UserDataBuf[0x2B]!=0x10))
  74   4                                      {
  75   5                                              return 2;
  76   5                                      }
  77   4                              }
  78   3      
  79   3                  for(tw_FdbOffset=0;tw_FdbOffset<512;tw_FdbOffset+=32)
  80   3                  {//find in one sector                               
  81   4                      if(gc_UserDataBuf[tw_FdbOffset]==0xE5)//deleted FDB
  82   4                      {
  83   5                                      }
  84   4                      else if(gc_UserDataBuf[tw_FdbOffset+0x0B]==0x0F)//long FDB
  85   4                      {
  86   5                                      }
  87   4                      else if(gc_UserDataBuf[tw_FdbOffset+0x0B]&0x10)//short FDB and is DIR
  88   4                      {
  89   5                              if(gc_UserDataBuf[tw_FdbOffset]!=0x2E) //it's real folder
  90   5                                              {
  91   6                                                      p_mp->w_DirTotalNum++;
  92   6                                              }
  93   5                      }
  94   4                      else if(gc_UserDataBuf[tw_FdbOffset]==0x00)//end flag
  95   4                                      {
  96   5                          return 0;
  97   5                                      }
  98   4                  }
  99   3              }
 100   2              tdw_S_ClusterNum=DOS_GetNextCluster(tdw_S_ClusterNum,1);
 101   2          }//while(tdw_S_ClusterNum<tdw_TheEndCluster)--------------------------------------------->find in one 
             -dir
 102   1      
 103   1              return 0;
 104   1      }
 105          
 106          //======================================================================================================
 107          /*
 108          DOS_Search_File()/DOS_Search_DIR():
 109          tc_Mode, 
 110                    High 4 bits present searching overall or just in one dir,
 111                                                          0:Search File overall
 112                                                          1:Search File in one dir
 113                                                                  2:Search Dir overall
 114                                                                  3:Search Dir in one dir                 //DOS_Search_DIR()
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 3   

 115                Low 4 bits present Search Mode,
 116                                                          0: Count File Total number
 117                                      1: Find by Time
 118                                      2: Find by Name
 119                                      3: Find by FDB
 120                                                                  4: Find by Long File Name
 121                                                                  5: Find by Short File Name
 122                                      B: Count Dir Number          //DOS_Search_DIR()
 123                                                  
 124          tc_PrevOrNext, presents the searching direction,
 125                                                                  0: Search Next
 126                                          1: Search Pre
 127                   (CountFileTotalNum and FindByFDB defaults searching next)
 128          */
 129          //======================================================================================================
 130          U8      DOS_Search_DIR_Next_test(U8 tc_Mode)
 131          {
 132   1              data    bit     tb_FindDir;
 133   1              data    U8      tc_sts;
 134   1              data    U8      tc_SearchTime;
 135   1              xdata   U32 tdw_SectorAdd;
 136   1              xdata   U32     tdw_CurrentDirCluster;
 137   1              xdata   U32     tdw_PrevDirCluster;
 138   1              xdata   U32     tdw_NextDirCluster;
 139   1              SearchFdb ptr;
 140   1              
 141   1              tc_sts=1;       
 142   1              ptr.w_DirTotalNum=0;
 143   1              gb_ReadWriteDataArea=1;
 144   1      
 145   1              if((tc_Mode&0x0f)==1)
 146   1              {//if search file by time, please search by order
 147   2                      tc_Mode|=0x03;  
 148   2              }       
 149   1              ptr.pc_LongFileName = gc_FileLongName;
 150   1              ptr.c_Search_Mode=(tc_Mode&0x0f);
 151   1              ptr.c_EXTSelect = 0; //the directory doesn't need to compare ExtName, default value
 152   1      
 153   1              if((tc_Mode&0x0f)==0x0b)
 154   1              {
 155   2                      gw_DirTotalNumber=0;
 156   2              }
 157   1      
 158   1              ptr.c_Search_Direction=0; //Next
 159   1              ptr.Compare.dw_BubbleFlag = gdw_CurrFlag;
 160   1              ptr.dw_File_StartCluster = gdw_StartCluster2;
 161   1              ptr.c_type=0;
 162   1              tc_SearchTime=2; 
 163   1              while(tc_SearchTime)
 164   1              {
 165   2                      if((tc_Mode&0x0f0)==0x20 || (tc_Mode&0x0f0)==0x30)
 166   2                      {//find dir 
 167   3                              tb_FindDir=1;
 168   3                              ptr.dw_FDB_StartCluster=gs_DIR_FCB[0].dw_FDB_StartCluster;
 169   3                      }
 170   2                      else
 171   2                      {//find file
 172   3                              return(1); //this function isn't used to find file
 173   3                      }
 174   2                      
 175   2                      if(!(gb_FindFlag))
 176   2                      {//have not searched                   
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 4   

 177   3                              ptr.dw_File_StartCluster = gdw_DOS_RootDirClus;
 178   3                              gs_DIR_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 179   3                              gs_DIR_FCB[0].dw_File_StartCluster = gdw_DOS_RootDirClus;
 180   3                              if(ptr.c_Search_Direction) //find pre
 181   3                              {
 182   4                                      if(((tc_Mode&0x0f)==K_NAME_FINDFDB)||((tc_Mode&0x0f)==K_TIME_FINDFDB)) //modify by Ching
 183   4                                      {
 184   5                                              ptr.Compare.dw_BubbleFlag=0xffffffff;
 185   5                                      }
 186   4                                      tb_FindDir=1;
 187   4                                      gw_DirIndex[0]=0xffff;     //gw_DirIndex1 used to save the index of the fdb which find just now     li
             -zhn 040927 add
 188   4                                      gw_DirIndex[1]=0xffff;     //gw_DirIndex0 used to save the index of the last fdb                                        
 189   4                              }
 190   3                              else //find next
 191   3                              {
 192   4                                      if(((tc_Mode&0x0f)==K_NAME_FINDFDB)||((tc_Mode&0x0f)==K_TIME_FINDFDB)) //modify by Ching
 193   4                                      {
 194   5                                              ptr.Compare.dw_BubbleFlag=0x00;
 195   5                                      }
 196   4                                      gw_DirIndex[0] = 0;    
 197   4                                      gw_DirIndex[1] = 0;
 198   4                              }       
 199   3                      }
 200   2      
 201   2                      if((tc_Mode&0x0f0)==0x30)
 202   2                      {//find dir in one dir
 203   3                              ptr.c_Search_Attribute=1; //find dir
 204   3                              if((tc_Mode&0x0f)==0x0b)
 205   3                              {
 206   4                                      tc_sts=Count_Dir_Fdb(&ptr);
 207   4                              }
 208   3                              else
 209   3                              {
 210   4                                      tc_sts=Find_Fdb(&ptr);
 211   4                              }                       
 212   3      
 213   3                              gb_ReadWriteDataArea=1;
 214   3                              if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd))
 215   3                                      return 0xff;
 216   3      
 217   3                              ((U8 *)(&ptr.dw_File_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
 218   3                              ((U8 *)(&ptr.dw_File_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 219   3                              ((U8 *)(&ptr.dw_File_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 220   3                              ((U8 *)(&ptr.dw_File_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];
 221   3                      }
 222   2                      else //(tc_Mode&0x0f0)==0x20
 223   2                      {//find in all dir
 224   3                              {//find next
 225   4                                      while(1)
 226   4                                      { 
 227   5                                              ptr.c_Search_Mode = (tc_Mode&0x0f);
 228   5                                              if(tb_FindDir==1 && ptr.c_Search_Mode==0x0b)
 229   5                                              {//count dir number in all directories
 230   6                                                      //ptr.c_Search_Attribute=1;//find dir
 231   6                                                      tc_sts=Count_Dir_Fdb(&ptr);
 232   6                                                      gw_DirTotalNumber += ptr.w_DirTotalNum; //Ching 090204
 233   6                                                      tc_sts=1; //Ching 090204
 234   6                                              }
 235   5                                              if(tc_sts) //Here, tc_sts=1
 236   5                                              {//have not found the specific file in one dir or count dir number in one dir
 237   6                                                      ptr.c_Search_Mode=0x03;  //if count filenum now,please search dir by order
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 5   

 238   6      
 239   6                                                      if((tc_Mode&0xf0)==0x20 && (tc_Mode&0x0f)!=0x0b) //for tc_Mode=0x28, 
 240   6                                                              ptr.c_Search_Mode=(tc_Mode&0x0f);                     //it has counted in this dir. Then it must be
             - searching new dir to count overall directories
 241   6      
 242   6                                                      ptr.c_Search_Attribute=1;
 243   6                                                      tc_sts=Find_Fdb(&ptr);   //look for dir in the dir
 244   6                                                      if(tc_sts)
 245   6                                                      {//not find dir
 246   7                                                              if(ptr.dw_FDB_StartCluster!=gdw_DOS_RootDirClus)                 //not rootdir
 247   7                                                              {
 248   8                                                                      tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 249   8                                                                      gb_ReadWriteDataArea=1;
 250   8                                                                      if(DOS_Read_LogicSector(tdw_SectorAdd))
 251   8                                                                              return 0xff;
 252   8      
 253   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 254   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 255   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 256   8                                                                      ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];
 257   8                                                                  if(!(tdw_PrevDirCluster))
 258   8                                                                      {//predir is rootdir
 259   9                                                                              tdw_PrevDirCluster=gdw_DOS_RootDirClus;
 260   9                                                                      }
 261   8                                                                      ptr.dw_File_StartCluster=ptr.dw_FDB_StartCluster;
 262   8                                                                      ptr.dw_FDB_StartCluster=tdw_PrevDirCluster;                   //return to predir
 263   8      
 264   8                                                                      if((tc_Mode&0x0f)==0x0b) //add by Ching 051220
 265   8                                                                              tb_FindDir=0;
 266   8                                                                      
 267   8                                                                      if(ptr.c_Search_Mode==0x03)
 268   8                                                                      {//find by order
 269   9                                                                              gw_DirIndex[1] = 0;
 270   9                                                                              ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;
 271   9                                                                              ptr.Compare.dw_StartCluster =ptr.dw_File_StartCluster;
 272   9                                                                              ptr.c_Search_Attribute=1;
 273   9                                                                              if(Find_Fdb(&ptr))
 274   9                                                                                      break;
 275   9                                                                      }
 276   8                                                              }
 277   7                                                              else
 278   7                                                              {//not find dir in rootdir
 279   8                                                                      gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 280   8                                                                      break; 
 281   8                                                              }
 282   7                                                      }
 283   6                                                      else
 284   6                                                      {//have found dir
 285   7                                                              gb_ReadWriteDataArea=1;
 286   7                                                              if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd))
 287   7                                                                      return 0xff;
 288   7      
 289   7                                                              tdw_CurrentDirCluster=ptr.dw_FDB_StartCluster; //save current dir
 290   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
 291   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 292   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 293   7                                                              ((U8 *)(&ptr.dw_FDB_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];    //next dir cluster
 294   7      
 295   7                                                              tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
 296   7                                                              if(DOS_Read_LogicSector((tdw_SectorAdd)))
 297   7                                                                      return 0xff; 
 298   7      
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 6   

 299   7                                                              ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
 300   7                                                              ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
 301   7                                                              ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
 302   7                                                              ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];       //current dir
 303   7              
 304   7                                                              ((U8 *)(&tdw_NextDirCluster))[3]=gc_UserDataBuf[0x1a];
 305   7                                                              ((U8 *)(&tdw_NextDirCluster))[2]=gc_UserDataBuf[0x1b];
 306   7                                                              ((U8 *)(&tdw_NextDirCluster))[1]=gc_UserDataBuf[0x14];
 307   7                                                              ((U8 *)(&tdw_NextDirCluster))[0]=gc_UserDataBuf[0x15];  //next dir
 308   7      
 309   7                                                              if((tdw_PrevDirCluster!=tdw_CurrentDirCluster)&&(tdw_CurrentDirCluster!=gdw_DOS_RootDirClus)||(tdw_
             -NextDirCluster!=ptr.dw_FDB_StartCluster))
 310   7                                                              {//dos error 
 311   8                                                                      ptr.dw_FDB_StartCluster=tdw_CurrentDirCluster; 
 312   8                                                              }
 313   7                                                              else
 314   7                                                              {
 315   8                                                                      gw_DirIndex[0] = 0;
 316   8                                                                      if((tc_Mode&0x0f0)==0x20)
 317   8                                                                      {//put the line in here is to make dw_FDB_StartCluster equal dw_File_StartCluster 
 318   9                                                                              tb_FindDir=1; //for tc_Mode=0x28,it has been changed. Here it's to re-changed
 319   9                                                                          gw_DirIndex[1] = 0; 
 320   9                                                                              ptr.dw_File_StartCluster = ptr.dw_FDB_StartCluster;
 321   9                                                                              tc_sts=0;
 322   9                                                                              if((tc_Mode&0x0f)!=0x0b)  //for tc_Mode=0x2b, it must continus counting
 323   9                                                                                      break;                                                                  
 324   9                                                                      } 
 325   8                                                                      ptr.Compare.dw_BubbleFlag=0x0000;
 326   8                                                              }
 327   7                                                              tc_sts=1; 
 328   7                                                      }//have find dir 
 329   6                                              }
 330   5                                              else
 331   5                                              {//have find the file --> this line does not occur Here!
 332   6                                                      break;
 333   6                                              }
 334   5                                      }//whileB 
 335   4                              }//find next 
 336   3                      }//find in all dir
 337   2                      if(!tc_sts)
 338   2                      {//find the file/dir
 339   3                              gb_FindFlag=1;
 340   3                              if((tc_Mode&0x0f0)==0x20 || (tc_Mode&0x0f0)==0x30)
 341   3                              {//dir
 342   4                                      gs_DIR_FCB[0].dw_File_StartCluster=ptr.dw_File_StartCluster; 
 343   4                                  gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 344   4                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd1=ptr.dw_LongFDB_LogAdd1;
 345   4                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0=ptr.dw_LongFDB_LogAdd0;
 346   4                                      gs_DIR_FCB[0].dw_FDB_Cluster=ptr.dw_FDB_Cluster;
 347   4                                      gs_DIR_FCB[0].dw_FDB_LogAdd=ptr.dw_FDB_LogAdd;
 348   4                                      gs_DIR_FCB[0].w_FDB_Offset=ptr.w_FDB_Offset;
 349   4                              }
 350   3                              return(tc_sts); 
 351   3                      }
 352   2                      else if((tc_Mode&0x0f)==0x0b)
 353   2                      {//Count dir total number
 354   3                              gw_DirTotalNumber += ptr.w_DirTotalNum; //Ching 090204
 355   3                              //dbprintf("Search----gw_DirTotalNumber=%x\n",gw_DirTotalNumber);
 356   3                              return(1);
 357   3                      }
 358   2                      else
 359   2                      { 
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 7   

 360   3                              gs_File_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 361   3                              gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
 362   3                              tc_SearchTime--;
 363   3                              if(((tc_Mode&0x0f)==1)||((tc_Mode&0x0f)==2)||((tc_Mode&0x0f)==3))
 364   3                              {
 365   4                                      gb_FindFlag=0; 
 366   4                              }
 367   3                      } 
 368   2              }//while
 369   1              //Libprintf("no file to find\n"); 
 370   1              return(1); 
 371   1      }
 372          
 373          
 374          U8      DOS_Search_DIR_Prev_test(U8 tc_Mode)
 375          {
 376   1              data    bit     tb_checkAddr;
 377   1              data    U8      tc_sts;
 378   1              SearchFdb ptr;
 379   1              
 380   1              tc_sts=1;       
 381   1              tb_checkAddr=0;
 382   1              ptr.w_DirTotalNum=0;
 383   1              gb_ReadWriteDataArea=1;
 384   1              if((tc_Mode&0x0f)==1)
 385   1              {//if search file by time, please search by order
 386   2                      tc_Mode|=0x03;  
 387   2              }       
 388   1              ptr.pc_LongFileName = gc_FileLongName;
 389   1              ptr.c_Search_Mode=(tc_Mode&0x0f);
 390   1              //ptr.c_EXTSelect = (tc_PrevOrNext >> 4);//need to compare ExtName;
 391   1              ptr.c_EXTSelect = 0; //the directory doesn't need to compare ExtName, default value
 392   1              if((tc_Mode&0x0f)==0||(tc_Mode&0x0f)==4||(tc_Mode&0x0f)==5 ||(tc_Mode&0x0f)==0x0b)
 393   1              {//count filenum/dirnum , find next
 394   2                      tc_sts = DOS_Search_DIR_Next_test(tc_Mode);
 395   2                      return tc_sts;
 396   2              }                                               
 397   1              ptr.c_Search_Direction=1;
 398   1              ptr.Compare.dw_BubbleFlag = gdw_CurrFlag;
 399   1              ptr.dw_File_StartCluster = gdw_StartCluster2;
 400   1              ptr.c_type=0;
 401   1              //tc_SearchTime=1; 
 402   1              //while(tc_SearchTime)
 403   1              {
 404   2                      if((tc_Mode&0x020)==0x20)
 405   2                      {//find dir 
 406   3                              ptr.dw_FDB_StartCluster=gs_DIR_FCB[0].dw_FDB_StartCluster;
 407   3                      }
 408   2                      else
 409   2                      {//find file
 410   3                              return(1); //this function isn't used to find file
 411   3                      }
 412   2      
 413   2                      //if(tc_PrevOrNext && ((tc_Mode&0x0f)==0x03)) //find prev dir
 414   2                      {
 415   3                              U32 tdw_StartCluster, tdw_TagetCluster, tdw_CurrentCluster, tdw_TempCluster=0xffffffff, tdw_TempCluster
             -1=0xffffffff, tdw_MomFDB_StartClus;
 416   3                              U32 tdw_1stSectorOfCluster, tdw_LogAddr;
 417   3                              U16 tw_FdbOffset;
 418   3      
 419   3                              if(gs_DIR_FCB[0].w_FDB_Offset == 0)
 420   3                              {
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 8   

 421   4                                      if(gs_DIR_FCB[0].dw_FDB_LogAdd != gdw_DOS_RootDirAddr)
 422   4                                      {
 423   5                                              tw_FdbOffset = 0x1E0;
 424   5                                              tb_checkAddr = 1;
 425   5                                      }
 426   4                                      else
 427   4                                      {
 428   5                                              if((gs_DIR_FCB[0].dw_FDB_Cluster == gdw_DOS_RootDirClus) && (gs_DIR_FCB[0].dw_File_StartCluster != gd
             -w_DOS_RootDirClus)) //1st dir
 429   5                                              {//1st dir of root dir
 430   6                                                      if((tc_Mode&0x0f0)==0x30) //find dir in one dir
 431   6                                                      {
 432   7                                                              ptr.c_Search_Mode = K_COUNTER_DIRNUM;
 433   7                                                              ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 434   7                                                              ptr.c_Search_Attribute = 1; //find dir
 435   7                                                              ptr.c_Search_Direction = 0; //search next
 436   7                                                              Count_Dir_Fdb(&ptr);
 437   7                                                                                      
 438   7                                                              gw_FileSkipNumber = ptr.w_DirTotalNum;
 439   7                      
 440   7                                                              if(gw_FileSkipNumber>1)
 441   7                                                              {
 442   8                                                                      ptr.c_Search_Mode = K_ORDER_FINDFDB;
 443   8                                                                      ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 444   8                                                                      ptr.c_Search_Attribute = 1; //find dir
 445   8                                                                      ptr.c_Search_Direction = 0; //search next
 446   8                                                                      gw_DirIndex[1] = 0;
 447   8                      
 448   8                                                                      gb_TriggerFileSkip = 1;
 449   8                                                                      tc_sts = Find_Fdb(&ptr);
 450   8                                                                      gb_TriggerFileSkip = 0;
 451   8                                                                      if(!tc_sts)
 452   8                                                                      {
 453   9                                                                              //gs_DIR_FCB[0].dw_FDB_StartCluster = ptr.dw_FDB_StartCluster;
 454   9                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd1 = ptr.dw_LongFDB_LogAdd1;
 455   9                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = ptr.dw_LongFDB_LogAdd0;
 456   9                                                                              gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 457   9                                                                              gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 458   9                                                                              gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 459   9                      
 460   9                                                                              if(DOS_Read_LogicSector(gs_DIR_FCB[0].dw_FDB_LogAdd))   return 0xff;
 461   9                                                                              ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x15];
 462   9                                                                              ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x14];
 463   9                                                                              ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1b];
 464   9                                                                              ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1a];
 465   9                      
 466   9                                                                              gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster;
 467   9                                                                              gs_DIR_FCB[0].dw_FDB_StartCluster  = tdw_StartCluster;
 468   9      
 469   9                                                                              return 0;
 470   9                                                                      }
 471   8                                                                      else    return 1;
 472   8                                                              }
 473   7                                                              else if(gw_FileSkipNumber==1)   return 0; //the dir itself is what we want to get
 474   7                                                              else    return 1;
 475   7                                                      }
 476   6                                                      else //find in all dir
 477   6                                                      {
 478   7                                                              gs_DIR_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 479   7                                                              gs_DIR_FCB[0].dw_File_StartCluster = gdw_DOS_RootDirClus;
 480   7                                                              gs_DIR_FCB[0].dw_FDB_Cluster = gdw_DOS_RootDirClus;
 481   7                                                              gs_DIR_FCB[0].dw_FDB_LogAdd = gdw_DOS_RootDirAddr;
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 9   

 482   7                                                              gs_DIR_FCB[0].w_FDB_Offset = 0;
 483   7                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = 0;
 484   7                                                              return 0;
 485   7                                                      }
 486   6                                              }
 487   5                                              tw_FdbOffset = 0x1E0;
 488   5                                              tb_checkAddr = 1;
 489   5                                      }
 490   4                              }
 491   3                              else
 492   3                                      tw_FdbOffset = gs_DIR_FCB[0].w_FDB_Offset-32;
 493   3      
 494   3                              if((gs_DIR_FCB[0].dw_FDB_Cluster <= 2) && (gs_DIR_FCB[0].dw_File_StartCluster <= 2))
 495   3                              {//root dir
 496   4                                      if((tc_Mode&0x0f0)==0x30) //find dir in one dir -- no dir to get
 497   4                                              return 1;
 498   4                                      else //find in all dir -- the last dir is what we want to get
 499   4                                      {
 500   5                                              U16 tw_count;
 501   5      
 502   5                                              ptr.c_Search_Mode = K_ORDER_FINDFDB;
 503   5                                              ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_File_StartCluster;
 504   5                                              ptr.c_Search_Attribute = 1; //find dir
 505   5                                              ptr.c_Search_Direction = 0; //search next
 506   5                                              gw_DirIndex[1] = 0;
 507   5                                              gb_FindFlag = 0;
 508   5                              
 509   5                                              for(tw_count=0; tw_count<gw_DirTotalNumber; tw_count++)
 510   5                                              {
 511   6                                                      tc_sts = DOS_Search_DIR_Next_test(0x23);
 512   6                                                      if(tc_sts) return 1;
 513   6                                              }
 514   5                                              return 0;
 515   5                                      }
 516   4                              }
 517   3                              //tdw_MomFDB_StartClus
 518   3                              tdw_TempCluster = gs_DIR_FCB[0].dw_File_StartCluster;
 519   3                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 520   3                              if(DOS_Read_LogicSector(tdw_1stSectorOfCluster))        return 0xff;
 521   3                              ((U8 *)(&tdw_MomFDB_StartClus))[0] = gc_UserDataBuf[0x35];
 522   3                              ((U8 *)(&tdw_MomFDB_StartClus))[1] = gc_UserDataBuf[0x34];
 523   3                              ((U8 *)(&tdw_MomFDB_StartClus))[2] = gc_UserDataBuf[0x3b];
 524   3                              ((U8 *)(&tdw_MomFDB_StartClus))[3] = gc_UserDataBuf[0x3a];
 525   3                              if(tdw_MomFDB_StartClus == 0) tdw_MomFDB_StartClus = gdw_DOS_RootDirClus;
 526   3      
 527   3                              tdw_TempCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 528   3                              tdw_LogAddr = gs_DIR_FCB[0].dw_FDB_LogAdd;
 529   3                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 530   3      
 531   3                              if(tb_checkAddr) //Ching 090213
 532   3                              {
 533   4                                      if(tdw_LogAddr != tdw_1stSectorOfCluster)
 534   4                                              tdw_LogAddr --;
 535   4                                      else
 536   4                                      {
 537   5                                              tdw_CurrentCluster = tdw_TempCluster;
 538   5                                              tdw_TempCluster1 = tdw_MomFDB_StartClus;
 539   5                                              tdw_TempCluster = tdw_TempCluster1;
 540   5                                              while(tdw_TempCluster1!=tdw_CurrentCluster)
 541   5                                              {
 542   6                                                      tdw_TempCluster1 = DOS_GetNextCluster(tdw_TempCluster1,1);
 543   6                                                      if(tdw_TempCluster1!=tdw_CurrentCluster)
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 10  

 544   6                                                              tdw_TempCluster = tdw_TempCluster1;
 545   6                                              }
 546   5                                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 547   5                                              tdw_LogAddr = tdw_1stSectorOfCluster + gc_DOS_SectorPerCluster - 1;
 548   5                                      }
 549   4                              }
 550   3      
 551   3                              if((tc_Mode&0x0f0)==0x30) //find dir in one dir
 552   3                              {
 553   4                                      do //search in one directory
 554   4                                      {
 555   5                                              tdw_CurrentCluster = tdw_TempCluster;
 556   5                                              for(tdw_LogAddr; tdw_LogAddr >= tdw_1stSectorOfCluster; tdw_LogAddr--) //search in one cluster
 557   5                                              {
 558   6                                                      gb_ReadWriteDataArea=1;
 559   6                                                      if(DOS_Read_LogicSector(tdw_LogAddr))   return 0xff;
 560   6              
 561   6                                                      while(1) //search in one sector
 562   6                                                      {
 563   7                                                              if(gc_UserDataBuf[tw_FdbOffset+0x0b] & 0x10) //is dir (short FDB)
 564   7                                                              {
 565   8                                                                      if(gc_UserDataBuf[tw_FdbOffset]!=0xE5)
 566   8                                                                      {
 567   9                                                                              if(gc_UserDataBuf[tw_FdbOffset]==0x2E) //jump to the last dir in this dir
 568   9                                                                              {       // .
 569  10                                                                                      ptr.c_Search_Mode = K_COUNTER_DIRNUM;
 570  10                                                                                      ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 571  10                                                                                      ptr.c_Search_Attribute = 1; //find dir
 572  10                                                                                      ptr.c_Search_Direction = 0; //search next
 573  10                                                                                      Count_Dir_Fdb(&ptr);
 574  10                                                                                                                      
 575  10                                                                                      gw_FileSkipNumber = ptr.w_DirTotalNum;
 576  10                                                      
 577  10                                                                                      if(gw_FileSkipNumber>1)
 578  10                                                                                      {
 579  11                                                                                              ptr.c_Search_Mode = K_ORDER_FINDFDB;
 580  11                                                                                              ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 581  11                                                                                              ptr.c_Search_Attribute = 1; //find dir
 582  11                                                                                              ptr.c_Search_Direction = 0; //search next
 583  11                                                                                              gw_DirIndex[1] = 0;
 584  11      
 585  11                                                                                              gb_TriggerFileSkip = 1;
 586  11                                                                                              tc_sts = Find_Fdb(&ptr);
 587  11                                                                                              gb_TriggerFileSkip = 0;
 588  11                                                                                              if(!tc_sts)
 589  11                                                                                              {
 590  12                                                                                                  gs_DIR_FCB[0].dw_FDB_StartCluster = ptr.dw_FDB_StartCluster;
 591  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd1 = ptr.dw_LongFDB_LogAdd1;
 592  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = ptr.dw_LongFDB_LogAdd0;
 593  12                                                                                                      gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 594  12                                                                                                      gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 595  12                                                                                                      gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 596  12                                                      
 597  12                                                                                                      if(DOS_Read_LogicSector(gs_DIR_FCB[0].dw_FDB_LogAdd))   return 0xff;
 598  12                                                                                                      ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x15];
 599  12                                                                                                      ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x14];
 600  12                                                                                                      ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1b];
 601  12                                                                                                      ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1a];
 602  12                                                      
 603  12                                                                                                      gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster; 
 604  12      
 605  12                                                                                                      return 0;
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 11  

 606  12                                                                                              }
 607  11                                                                                              else if(gw_FileSkipNumber==1)   return 0; //the dir itself is what we want to get
 608  11                                                                                              else    return 1;
 609  11                                                                                      }
 610  10                                                                              }
 611   9                                                                              else //found dir
 612   9                                                                              {
 613  10                                                                                      ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[tw_FdbOffset+0x15];
 614  10                                                                                      ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[tw_FdbOffset+0x14];
 615  10                                                                                      ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[tw_FdbOffset+0x1b];
 616  10                                                                                      ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[tw_FdbOffset+0x1a];
 617  10                      
 618  10                                                                                      gs_DIR_FCB[0].dw_FDB_Cluster = tdw_CurrentCluster;//gs_DIR_FCB[0].dw_FDB_Cluster;
 619  10                                                                                      gs_DIR_FCB[0].dw_FDB_LogAdd = tdw_LogAddr;//gs_DIR_FCB[0].dw_FDB_LogAdd;
 620  10                                                                                      gs_DIR_FCB[0].w_FDB_Offset = tw_FdbOffset;
 621  10                                                                                      gs_DIR_FCB[0].dw_FDB_StartCluster = tdw_StartCluster;
 622  10                                                                                      gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster;
 623  10                                                                                      //Ching 090212
 624  10                                                                                      if(tdw_LogAddr > tdw_1stSectorOfCluster) 
 625  10                                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = tdw_LogAddr - 1;
 626  10                                                                                      else //Prev Cluster's last sector
 627  10                                                                                      {
 628  11                                                                                              if(tdw_CurrentCluster == tdw_MomFDB_StartClus) //no prev cluster
 629  11                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = 0;
 630  11                                                                                              else
 631  11                                                                                              {//search prev cluster
 632  12                                                                                                      tdw_TempCluster1 = tdw_MomFDB_StartClus;
 633  12                                                                                                      tdw_TempCluster = tdw_TempCluster1;
 634  12              
 635  12                                                                                                      while(tdw_TempCluster1!=tdw_CurrentCluster)
 636  12                                                                                                      {
 637  13                                                                                                              tdw_TempCluster1 = DOS_GetNextCluster(tdw_TempCluster1,1);
 638  13                                                                                                              if(tdw_TempCluster1!=tdw_CurrentCluster)
 639  13                                                                                                                      tdw_TempCluster = tdw_TempCluster1;
 640  13                                                                                                      }
 641  12                                                                                                      tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 642  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = tdw_1stSectorOfCluster + gc_DOS_SectorPerCluster - 1;
 643  12                                                                                              }
 644  11                                                                                      }
 645  10                                                                                      return 0;
 646  10                                                                              }
 647   9                                                                      }
 648   8                                                              }
 649   7                      
 650   7                                                              if(tw_FdbOffset==0) break; //break while(1);
 651   7                                                              tw_FdbOffset -= 32;
 652   7                                                      }//while(1) //search in one sector
 653   6                                                      tw_FdbOffset = 0x1E0;
 654   6                                              }//for(tdw_LogAddr) //search in one cluster
 655   5      
 656   5                                              tdw_TempCluster1 = tdw_MomFDB_StartClus;
 657   5                                              tdw_TempCluster = tdw_TempCluster1;
 658   5                                              while(tdw_TempCluster1!=tdw_CurrentCluster)
 659   5                                              {
 660   6                                                      tdw_TempCluster1 = DOS_GetNextCluster(tdw_TempCluster1,1);
 661   6                                                      if(tdw_TempCluster1!=tdw_CurrentCluster)
 662   6                                                              tdw_TempCluster = tdw_TempCluster1;
 663   6                                              }
 664   5                                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 665   5                                              tdw_LogAddr = tdw_1stSectorOfCluster + gc_DOS_SectorPerCluster - 1;
 666   5                                      }while(tdw_CurrentCluster != tdw_MomFDB_StartClus); //search in one directory
 667   4      
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 12  

 668   4                                      if(gs_DIR_FCB[0].dw_FDB_Cluster == gdw_DOS_RootDirClus) //no prev dir in root dir, then last dir in ro
             -ot diris what we want to get
 669   4                                      {
 670   5                                              ptr.c_Search_Mode = K_COUNTER_DIRNUM;
 671   5                                              ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 672   5                                              ptr.c_Search_Attribute=1; //find dir
 673   5                                              ptr.c_Search_Direction = 0; //search next
 674   5                                              Count_Dir_Fdb(&ptr);
 675   5                                                                                      
 676   5                                              gw_FileSkipNumber=ptr.w_DirTotalNum;
 677   5                                              if(gw_FileSkipNumber>1)
 678   5                                              {
 679   6                                                      ptr.c_Search_Mode = K_ORDER_FINDFDB;
 680   6                                                      ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_FDB_Cluster;
 681   6                                                      ptr.c_Search_Attribute = 1; //find dir
 682   6                                                      ptr.c_Search_Direction = 0; //search next
 683   6                                                      gw_DirIndex[1] = 0;
 684   6                      
 685   6                                                      gb_TriggerFileSkip = 1;
 686   6                                                      tc_sts = Find_Fdb(&ptr);
 687   6                                                      gb_TriggerFileSkip = 0;
 688   6                                                      if(!tc_sts)
 689   6                                                      {
 690   7                                                          gs_DIR_FCB[0].dw_FDB_StartCluster = ptr.dw_FDB_StartCluster;
 691   7                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd1 = ptr.dw_LongFDB_LogAdd1;
 692   7                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = ptr.dw_LongFDB_LogAdd0;
 693   7                                                              gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 694   7                                                              gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 695   7                                                              gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 696   7                      
 697   7                                                              if(DOS_Read_LogicSector(gs_DIR_FCB[0].dw_FDB_LogAdd))   return 0xff;
 698   7                                                              ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x15];
 699   7                                                              ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x14];
 700   7                                                              ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1b];
 701   7                                                              ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1a];
 702   7                      
 703   7                                                              gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster; 
 704   7      
 705   7                                                              return 0;
 706   7                                                      }
 707   6                                                      else    return 1;
 708   6                                              }
 709   5                                              else if(gw_FileSkipNumber==1)   return 0; //the dir itself is what we want to get
 710   5                                              else    return 1;
 711   5                                      }
 712   4                              }
 713   3                              else //(tc_Mode&0x0f0)==0x20 //find in all dir
 714   3                              {
 715   4                                      do //search in one directory
 716   4                                      {
 717   5                                              tdw_CurrentCluster = tdw_TempCluster;
 718   5                                              for(tdw_LogAddr; tdw_LogAddr >= tdw_1stSectorOfCluster; tdw_LogAddr--) //search in one cluster
 719   5                                              {
 720   6                                                      gb_ReadWriteDataArea=1;
 721   6                                                      if(DOS_Read_LogicSector(tdw_LogAddr))   return 0xff;
 722   6              
 723   6                                                      while(1) //search in one sector
 724   6                                                      {
 725   7                                                              if(gc_UserDataBuf[tw_FdbOffset+0x0b] & 0x10) //is dir (short FDB)
 726   7                                                              {
 727   8                                                                      if(gc_UserDataBuf[tw_FdbOffset]!=0xE5)
 728   8                                                                      {
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 13  

 729   9                                                                              if(gc_UserDataBuf[tw_FdbOffset]==0x2E) //back to upper dir (upper dir is what we want to get)
 730   9                                                                              {       // .
 731  10                                                                                      ((U8 *)(&tdw_TagetCluster))[0]=gc_UserDataBuf[tw_FdbOffset-11]; //-32+0x15
 732  10                                                                                      ((U8 *)(&tdw_TagetCluster))[1]=gc_UserDataBuf[tw_FdbOffset-12]; //-32+0x14
 733  10                                                                                      ((U8 *)(&tdw_TagetCluster))[2]=gc_UserDataBuf[tw_FdbOffset-5]; //-32+0x1b
 734  10                                                                                      ((U8 *)(&tdw_TagetCluster))[3]=gc_UserDataBuf[tw_FdbOffset-6]; //-32+0x1a
 735  10                                                                                      // ..
 736  10                                                                                      ((U8 *)(&tdw_StartCluster))[0]=gc_UserDataBuf[tw_FdbOffset+0x15];
 737  10                                                                                      ((U8 *)(&tdw_StartCluster))[1]=gc_UserDataBuf[tw_FdbOffset+0x14];
 738  10                                                                                      ((U8 *)(&tdw_StartCluster))[2]=gc_UserDataBuf[tw_FdbOffset+0x1b];
 739  10                                                                                      ((U8 *)(&tdw_StartCluster))[3]=gc_UserDataBuf[tw_FdbOffset+0x1a];
 740  10                                                                                      gw_DirIndex[0]=0;
 741  10                                                                                      ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;
 742  10                                                                                      ptr.Compare.dw_StartCluster = tdw_TagetCluster;
 743  10                                                                                      ptr.dw_FDB_StartCluster = tdw_StartCluster;
 744  10                                                                                      ptr.c_Search_Attribute = 1;  
 745  10                                                                                      ptr.c_Search_Direction = 0; //search next
 746  10                                                                                      if(!Find_Fdb(&ptr))
 747  10                                                                                      {
 748  11                                                                                              gw_DirIndex[1] = 0;
 749  11                                                                                              gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 750  11                                                                                              gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 751  11                                                                                              gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 752  11                                                                                              gs_DIR_FCB[0].dw_FDB_StartCluster = tdw_TagetCluster;
 753  11                                                                                              gs_DIR_FCB[0].dw_File_StartCluster = tdw_TagetCluster;
 754  11                                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd1 = ptr.dw_LongFDB_LogAdd1;
 755  11                                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = ptr.dw_LongFDB_LogAdd0;
 756  11      
 757  11                                                                                              return 0;
 758  11                                                                                      }
 759  10                                                                                      else
 760  10                                                                                              return 1;
 761  10                                                                              }
 762   9                                                                              else //found dir -- check if it has dir
 763   9                                                                              {
 764  10                                                                                      ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[tw_FdbOffset+0x15];
 765  10                                                                                      ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[tw_FdbOffset+0x14];
 766  10                                                                                      ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[tw_FdbOffset+0x1b];
 767  10                                                                                      ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[tw_FdbOffset+0x1a];
 768  10                      
 769  10                                                                                      gs_DIR_FCB[0].dw_FDB_Cluster = tdw_CurrentCluster;//gs_DIR_FCB[0].dw_FDB_Cluster;
 770  10                                                                                      gs_DIR_FCB[0].dw_FDB_LogAdd = tdw_LogAddr;//gs_DIR_FCB[0].dw_FDB_LogAdd;
 771  10                                                                                      gs_DIR_FCB[0].w_FDB_Offset = tw_FdbOffset;
 772  10                                                                                      gs_DIR_FCB[0].dw_FDB_StartCluster = tdw_StartCluster;
 773  10                                                                                      gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster;
 774  10      
 775  10                                                                                      //check if it has dir
 776  10                                                                                      ptr.c_Search_Mode=K_COUNTER_DIRNUM;
 777  10                                                                                      ptr.dw_FDB_StartCluster=gs_DIR_FCB[0].dw_File_StartCluster;
 778  10                                                                                      ptr.c_Search_Attribute=1; //find dir
 779  10                                                                                      ptr.c_Search_Direction=0; //search next
 780  10                                                                                      Count_Dir_Fdb(&ptr);
 781  10                                                                                      
 782  10                                                                                      gw_FileSkipNumber=ptr.w_DirTotalNum;
 783  10      
 784  10                                                                                      if(!gw_FileSkipNumber) //Ching 090212
 785  10                                                                                      {
 786  11                                                                                              if(tdw_LogAddr>tdw_1stSectorOfCluster) 
 787  11                                                                                              {
 788  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0=tdw_LogAddr-1;
 789  12                                                                                              }
 790  11                                                                                              else //Prev Cluster's last sector
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 14  

 791  11                                                                                              {
 792  12                                                                                                      if(tdw_CurrentCluster==tdw_MomFDB_StartClus) //no prev cluster
 793  12                                                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0=0;
 794  12                                                                                                      else
 795  12                                                                                                      {//search prev cluster
 796  13                                                                                                              tdw_TempCluster1=tdw_MomFDB_StartClus;
 797  13                                                                                                              tdw_TempCluster=tdw_TempCluster1;
 798  13                      
 799  13                                                                                                              while(tdw_TempCluster1!=tdw_CurrentCluster)
 800  13                                                                                                              {
 801  14                                                                                                                      tdw_TempCluster1=DOS_GetNextCluster(tdw_TempCluster1,1);
 802  14                                                                                                                      if(tdw_TempCluster1!=tdw_CurrentCluster)
 803  14                                                                                                                      {
 804  15                                                                                                                              tdw_TempCluster=tdw_TempCluster1;
 805  15                                                                                                                      }
 806  14                                                                                                              }
 807  13                                                                                                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 808  13                                                                                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = tdw_1stSectorOfCluster + gc_DOS_SectorPerCluster - 1;
 809  13                                                                                                      }
 810  12                                                                                              }
 811  11                                                                                              return 0;
 812  11                                                                                      }
 813  10      
 814  10                                                                                      while(gw_FileSkipNumber)//if(gw_FileSkipNumber)
 815  10                                                                                      {
 816  11                                                                                              ptr.c_Search_Mode = K_ORDER_FINDFDB;
 817  11                                                                                              ptr.dw_FDB_StartCluster = gs_DIR_FCB[0].dw_File_StartCluster;
 818  11                                                                                              ptr.c_Search_Attribute=1; //find dir
 819  11                                                                                              ptr.c_Search_Direction = 0; //search next
 820  11                                                                                              gw_DirIndex[1] = 0;
 821  11                      
 822  11                                                                                              gb_TriggerFileSkip = 1;
 823  11                                                                                              tc_sts = Find_Fdb(&ptr);
 824  11                                                                                              gb_TriggerFileSkip = 0;
 825  11                                                                                              if(!tc_sts)
 826  11                                                                                              {
 827  12                                                                                                  gs_DIR_FCB[0].dw_FDB_StartCluster = ptr.dw_FDB_StartCluster;
 828  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd1 = ptr.dw_LongFDB_LogAdd1;
 829  12                                                                                                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = ptr.dw_LongFDB_LogAdd0;
 830  12                                                                                                      gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 831  12                                                                                                      gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 832  12                                                                                                      gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 833  12                      
 834  12                                                                                                      if(DOS_Read_LogicSector(gs_DIR_FCB[0].dw_FDB_LogAdd))   return 0xff;
 835  12                                                                                                      ((U8 *)(&tdw_StartCluster))[0] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x15];
 836  12                                                                                                      ((U8 *)(&tdw_StartCluster))[1] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x14];
 837  12                                                                                                      ((U8 *)(&tdw_StartCluster))[2] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1b];
 838  12                                                                                                      ((U8 *)(&tdw_StartCluster))[3] = gc_UserDataBuf[gs_DIR_FCB[0].w_FDB_Offset+0x1a];
 839  12                      
 840  12                                                                                                      gs_DIR_FCB[0].dw_File_StartCluster = tdw_StartCluster; 
 841  12                                                                                                      ptr.c_Search_Mode=K_COUNTER_DIRNUM;
 842  12                                                                                                      ptr.dw_FDB_StartCluster=gs_DIR_FCB[0].dw_File_StartCluster;
 843  12                                                                                                      ptr.c_Search_Attribute=1; //find dir
 844  12                                                                                                      ptr.c_Search_Direction=0; //search next
 845  12                                                                                                      Count_Dir_Fdb(&ptr);
 846  12                                                                                                      gw_FileSkipNumber=ptr.w_DirTotalNum;
 847  12                                                                                              }
 848  11                                                                                              else    return 1;
 849  11                                                                                      }               
 850  10                                                                                      return 0;
 851  10                                                                              }
 852   9                                                                      }
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 15  

 853   8                                                              }               
 854   7                                                              if(tw_FdbOffset==0) break; //break while(1);
 855   7                                                              tw_FdbOffset -= 32;
 856   7                                                      }//while(1) //search in one sector
 857   6                                                      tw_FdbOffset = 0x1E0;
 858   6                                              }//for(tdw_LogAddr) //search in one cluster
 859   5      
 860   5                                              tdw_TempCluster1 = tdw_MomFDB_StartClus;
 861   5                                              tdw_TempCluster = tdw_TempCluster1;
 862   5                                              while(tdw_TempCluster1 != tdw_CurrentCluster)
 863   5                                              {
 864   6                                                      tdw_TempCluster1 = DOS_GetNextCluster(tdw_TempCluster1,1);
 865   6                                                      if(tdw_TempCluster1 != tdw_CurrentCluster)
 866   6                                                              tdw_TempCluster = tdw_TempCluster1;
 867   6                                              }
 868   5                                              tdw_1stSectorOfCluster = DOS_ClusterLogicAddr(tdw_TempCluster);
 869   5                                              tdw_LogAddr = tdw_1stSectorOfCluster + gc_DOS_SectorPerCluster - 1;
 870   5                                      }while(tdw_CurrentCluster != tdw_MomFDB_StartClus); //search in one directory
 871   4      
 872   4                                      if(gs_DIR_FCB[0].dw_FDB_Cluster == gdw_DOS_RootDirClus) //no prev dir in root dir, then root dir is wh
             -at we want to get
 873   4                                      {
 874   5                                              gs_DIR_FCB[0].dw_FDB_Cluster = gdw_DOS_RootDirClus;
 875   5                                              gs_DIR_FCB[0].dw_FDB_LogAdd = gdw_DOS_RootDirAddr;
 876   5                                              gs_DIR_FCB[0].w_FDB_Offset = 0;
 877   5                                              gs_DIR_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 878   5                                              gs_DIR_FCB[0].dw_File_StartCluster = gdw_DOS_RootDirClus;
 879   5                                              gs_DIR_FCB[0].dw_LongFDB_LogAdd0 = 0;
 880   5                                              return 0;
 881   5                                      }
 882   4                              }
 883   3                      }
 884   2              }//while
 885   1              return(1); 
 886   1      }
 887          
 888          
 889          U8 GetCurrentDirInfo()
 890          {
 891   1              U32 tdw_Addr, tdw_TagetCluster, tdw_StartCluster;
 892   1              SearchFdb ptr;
 893   1      
 894   1              if(gs_File_FCB[0].dw_FDB_StartCluster == gdw_DOS_RootDirClus) //root dir
 895   1              {
 896   2                      gs_DIR_FCB[0].dw_FDB_Cluster = gdw_DOS_RootDirClus;
 897   2                      gs_DIR_FCB[0].dw_FDB_StartCluster = gdw_DOS_RootDirClus;
 898   2                      gs_DIR_FCB[0].dw_File_StartCluster = gdw_DOS_RootDirClus;
 899   2                      gs_DIR_FCB[0].dw_FDB_LogAdd = gdw_DOS_RootDirAddr;
 900   2                      gs_DIR_FCB[0].w_FDB_Offset = 0;
 901   2                      return 0;
 902   2              }
 903   1      
 904   1              tdw_Addr = DOS_ClusterLogicAddr(gs_File_FCB[0].dw_FDB_StartCluster); //DIR Current Cluster
 905   1              gb_ReadWriteDataArea=1;
 906   1              if(DOS_Read_LogicSector(tdw_Addr))      return 0xff;
 907   1              // .
 908   1              ((U8 *)(&tdw_TagetCluster))[0]=gc_UserDataBuf[0x15];
 909   1              ((U8 *)(&tdw_TagetCluster))[1]=gc_UserDataBuf[0x14];
 910   1              ((U8 *)(&tdw_TagetCluster))[2]=gc_UserDataBuf[0x1b];
 911   1              ((U8 *)(&tdw_TagetCluster))[3]=gc_UserDataBuf[0x1a];
 912   1              // ..
 913   1              ((U8 *)(&tdw_StartCluster))[0]=gc_UserDataBuf[0x35];
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 16  

 914   1              ((U8 *)(&tdw_StartCluster))[1]=gc_UserDataBuf[0x34];
 915   1              ((U8 *)(&tdw_StartCluster))[2]=gc_UserDataBuf[0x3b];
 916   1              ((U8 *)(&tdw_StartCluster))[3]=gc_UserDataBuf[0x3a];
 917   1              gw_DirIndex[0]=0;
 918   1              ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;
 919   1              ptr.Compare.dw_StartCluster = tdw_TagetCluster;
 920   1              ptr.dw_FDB_StartCluster = tdw_StartCluster;
 921   1              ptr.c_type=0;
 922   1              ptr.c_Search_Attribute = 1;  
 923   1              ptr.c_Search_Direction = 0; //search next
 924   1              if(!Find_Fdb(&ptr))
 925   1              {
 926   2                      gw_DirIndex[1] = 0;
 927   2                      gs_DIR_FCB[0].dw_FDB_Cluster = ptr.dw_FDB_Cluster;
 928   2                      gs_DIR_FCB[0].dw_FDB_LogAdd = ptr.dw_FDB_LogAdd;
 929   2                      gs_DIR_FCB[0].w_FDB_Offset = ptr.w_FDB_Offset;
 930   2                      gs_DIR_FCB[0].dw_FDB_StartCluster = tdw_TagetCluster;
 931   2                      gs_DIR_FCB[0].dw_File_StartCluster = tdw_TagetCluster;
 932   2                      return 0;
 933   2              }
 934   1              else
 935   1              {
 936   2                      return 1;
 937   2              }
 938   1      }
 939          
 940          
 941          U8 DOS_Search_DIR(U8 tc_Mode)
 942          {
 943   1              data    bit     tb_FindDir;
 944   1              data    U8      tc_sts;
 945   1              data    U8      tc_SearchTime;
 946   1              xdata   U32 tdw_SectorAdd,tdw_CurrentDirCluster,tdw_PrevDirCluster,tdw_NextDirCluster;
 947   1              SearchFdb ptr;
 948   1      
 949   1              gs_File_FCB[0].dw_File_StartCluster=0xffffffff ;
 950   1          gs_File_FCB[0].dw_FDB_LogAdd=0 ;
 951   1          tc_sts=1 ;
 952   1      
 953   1          ptr.w_DirTotalNum=0 ;
 954   1          gb_ReadWriteDataArea=1 ;
 955   1      
 956   1          ptr.pc_LongFileName=gc_FileLongName ;
 957   1          ptr.c_Search_Mode=tc_Mode&0x0f ; //0x03 or 0x0B
 958   1          ptr.c_EXTSelect=0 ;                 //the directory doesn't need to compare ExtName, default value
 959   1          ptr.c_Search_Direction=0 ;  //defalut: search next
 960   1              ptr.c_Search_Attribute=1 ;      //default: find dir
 961   1          ptr.c_type=0 ;                              //default
 962   1              ptr.Compare.dw_BubbleFlag=gdw_CurrFlag ;
 963   1              ptr.dw_File_StartCluster=gdw_StartCluster2 ;
 964   1          tc_SearchTime=2 ;
 965   1          while(tc_SearchTime)
 966   1          {
 967   2              {//find dir in one dir
 968   3                  tb_FindDir=1 ;
 969   3                  ptr.dw_FDB_StartCluster=gs_DIR_FCB[0].dw_FDB_StartCluster ;
 970   3              }
 971   2      
 972   2              if(!(gb_FindFlag))
 973   2              {//have not searched                                   
 974   3                              gb_FindFlag=1 ;
 975   3                  //first search next: default
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 17  

 976   3                  gw_DirIndex[0]=0 ;
 977   3                  gw_DirIndex[1]=0 ;
 978   3              }
 979   2              if((tc_Mode&0x0f0)==0x30)//find dir in one dir
 980   2              {            
 981   3                  if((tc_Mode&0x0f)==0x0b)//count dir total number
 982   3                              {
 983   4                                      tc_sts=Count_Dir_Fdb(&ptr);
 984   4                              }
 985   3                  else
 986   3                              {
 987   4                      tc_sts=Find_Fdb(&ptr);
 988   4                          if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd)) //read fail
 989   4                              return 0xff ;
 990   4                          
 991   4                          ((U8*)(&ptr.dw_File_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
 992   4                          ((U8*)(&ptr.dw_File_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
 993   4                          ((U8*)(&ptr.dw_File_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
 994   4                          ((U8*)(&ptr.dw_File_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];
 995   4                              }
 996   3              }
 997   2                      else //(tc_Mode&0x0f0)==0x20
 998   2                      {//find in all dir
 999   3                              while(1)
1000   3                              { 
1001   4                                      ptr.c_Search_Mode = (tc_Mode&0x0f);
1002   4                                                                                                      
1003   4                                      if(tb_FindDir==1 && ptr.c_Search_Mode==0x0b)
1004   4                                      {//count dir number in all directories
1005   5                                              tc_sts=Count_Dir_Fdb(&ptr);
1006   5                                              gw_DirTotalNumber = ptr.w_DirTotalNum;
1007   5                                      }
1008   4      
1009   4                                      if(tc_sts) //Here, tc_sts=1
1010   4                                      {//have not found the specific file in one dir or count dir number in one dir
1011   5                                              ptr.c_Search_Mode=0x03;  //if count filenum now,please search dir by order
1012   5      
1013   5                                              if((tc_Mode&0xf0)==0x20 && (tc_Mode&0x0f)!=0x0b) //for tc_Mode=0x28, 
1014   5                                                      ptr.c_Search_Mode=(tc_Mode&0x0f);                     //it has counted in this dir. Then it must be 
             -searching new dir to count overall directories
1015   5      
1016   5                                              ptr.c_Search_Attribute=1;
1017   5                                              tc_sts=Find_Fdb(&ptr);   //look for dir in the dir
1018   5      
1019   5                                              if(tc_sts)
1020   5                                              {//not find dir
1021   6                                                      if(ptr.dw_FDB_StartCluster!=gdw_DOS_RootDirClus)                 //not rootdir
1022   6                                                      {
1023   7                                                              tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
1024   7                                                              gb_ReadWriteDataArea=1;
1025   7                                                              if(DOS_Read_LogicSector(tdw_SectorAdd))
1026   7                                                                      return 0xff;
1027   7      
1028   7                                                              ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
1029   7                                                              ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
1030   7                                                              ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
1031   7                                                              ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];
1032   7                                                              if(!(tdw_PrevDirCluster))
1033   7                                                              {//predir is rootdir
1034   8                                                                      tdw_PrevDirCluster=gdw_DOS_RootDirClus;
1035   8                                                              }
1036   7                                                              ptr.dw_File_StartCluster=ptr.dw_FDB_StartCluster;
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 18  

1037   7                                                              ptr.dw_FDB_StartCluster=tdw_PrevDirCluster;                   //return to predir
1038   7      
1039   7                                                              if((tc_Mode&0x0f)==0x0b) //add by Ching 051220
1040   7                                                                      tb_FindDir=0;
1041   7                                                              
1042   7                                                              if(ptr.c_Search_Mode==0x03)
1043   7                                                              {//find by order
1044   8                                                                      gw_DirIndex[1] = 0;
1045   8                                                                      ptr.c_Search_Mode = K_SPECIFIC_STARTCLUSTER;
1046   8                                                                      ptr.Compare.dw_StartCluster =ptr.dw_File_StartCluster;
1047   8                                                                      ptr.c_Search_Attribute=1;
1048   8                                                                      if(Find_Fdb(&ptr))
1049   8                                                                              break;
1050   8                                                              }
1051   7                                                      }
1052   6                                                      else
1053   6                                                      {//not find dir in rootdir
1054   7                                                              gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
1055   7                                                              break; 
1056   7                                                      }
1057   6                                              }
1058   5                                              else
1059   5                                              {//have found dir
1060   6                                                      gb_ReadWriteDataArea=1;
1061   6                                                      if(DOS_Read_LogicSector(ptr.dw_FDB_LogAdd))
1062   6                                                              return 0xff;
1063   6      
1064   6                                                      tdw_CurrentDirCluster=ptr.dw_FDB_StartCluster; //save current dir
1065   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[3]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1a];
1066   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[2]=gc_UserDataBuf[ptr.w_FDB_Offset+0x1b];
1067   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[1]=gc_UserDataBuf[ptr.w_FDB_Offset+0x14];
1068   6                                                      ((U8 *)(&ptr.dw_FDB_StartCluster))[0]=gc_UserDataBuf[ptr.w_FDB_Offset+0x15];    //next dir cluster
1069   6      
1070   6                                                      tdw_SectorAdd = DOS_ClusterLogicAddr(ptr.dw_FDB_StartCluster);
1071   6                                                      if(DOS_Read_LogicSector(tdw_SectorAdd))
1072   6                                                              return 0xff; 
1073   6      
1074   6                                                      ((U8 *)(&tdw_PrevDirCluster))[3]=gc_UserDataBuf[32+0x1a];
1075   6                                                      ((U8 *)(&tdw_PrevDirCluster))[2]=gc_UserDataBuf[32+0x1b];
1076   6                                                      ((U8 *)(&tdw_PrevDirCluster))[1]=gc_UserDataBuf[32+0x14];
1077   6                                                      ((U8 *)(&tdw_PrevDirCluster))[0]=gc_UserDataBuf[32+0x15];       //current dir
1078   6      
1079   6                                                      ((U8 *)(&tdw_NextDirCluster))[3]=gc_UserDataBuf[0x1a];
1080   6                                                      ((U8 *)(&tdw_NextDirCluster))[2]=gc_UserDataBuf[0x1b];
1081   6                                                      ((U8 *)(&tdw_NextDirCluster))[1]=gc_UserDataBuf[0x14];
1082   6                                                      ((U8 *)(&tdw_NextDirCluster))[0]=gc_UserDataBuf[0x15];  //next dir
1083   6      
1084   6                                                      if((tdw_PrevDirCluster!=tdw_CurrentDirCluster)&&(tdw_CurrentDirCluster!=gdw_DOS_RootDirClus)||(tdw_N
             -extDirCluster!=ptr.dw_FDB_StartCluster))
1085   6                                                      {//dos error 
1086   7                                                              ptr.dw_FDB_StartCluster=tdw_CurrentDirCluster; 
1087   7                                                      }
1088   6                                                      else
1089   6                                                      {
1090   7                                                              gw_DirIndex[0] = 0;
1091   7                                                              if((tc_Mode&0x0f0)==0x20)
1092   7                                                              {//put the line in here is to make dw_FDB_StartCluster equal dw_File_StartCluster 
1093   8                                                                      tb_FindDir=1; //for tc_Mode=0x28,it has been changed. Here it's to re-changed
1094   8                                                                  gw_DirIndex[1] = 0; 
1095   8                                                                      ptr.dw_File_StartCluster = ptr.dw_FDB_StartCluster;
1096   8                                                                      tc_sts=0;
1097   8                                                                      if((tc_Mode&0x0f)!=0x0b)  //for tc_Mode=0x2b, it must continus counting
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 19  

1098   8                                                                              break;                                                                  
1099   8                                                              } 
1100   7                                                              ptr.Compare.dw_BubbleFlag=0x0000;
1101   7                                                      }
1102   6                                                      tc_sts=1; 
1103   6                                              }//have find dir 
1104   5                                      }
1105   4                                      else
1106   4                                      {//have find the file --> this line does not occur Here!
1107   5                                              break;
1108   5                                      }
1109   4                              }//whileB 
1110   3                      }//find in all dir
1111   2      
1112   2              if(!tc_sts)
1113   2              {//found the file/dir or counted dir total number successfully
1114   3                              if((tc_Mode&0x0f)==0x0b)//count dir total number
1115   3                          gw_DirTotalNumber=ptr.w_DirTotalNum ;
1116   3                  else //if((tc_Mode&0x0f)==0x03)
1117   3                  {
1118   4                          gb_FindFlag=1 ;
1119   4                      //dir
1120   4                      gs_DIR_FCB[0].dw_File_StartCluster=ptr.dw_File_StartCluster ;
1121   4                      gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster ;
1122   4                      gs_DIR_FCB[0].dw_LongFDB_LogAdd1=ptr.dw_LongFDB_LogAdd1 ;
1123   4                      gs_DIR_FCB[0].dw_LongFDB_LogAdd0=ptr.dw_LongFDB_LogAdd0 ;
1124   4                      gs_DIR_FCB[0].dw_FDB_Cluster=ptr.dw_FDB_Cluster ;
1125   4                      gs_DIR_FCB[0].dw_FDB_LogAdd=ptr.dw_FDB_LogAdd ;
1126   4                      gs_DIR_FCB[0].w_FDB_Offset=ptr.w_FDB_Offset ;   
1127   4                  }
1128   3                  return tc_sts;
1129   3              }
1130   2              else 
1131   2              {
1132   3                              if((tc_Mode&0x0f)==0x0b)
1133   3                                      return tc_sts;
1134   3                              else //if((tc_Mode&0x0f)==3)
1135   3                                      gb_FindFlag=0 ;
1136   3      
1137   3                              gb_LastFolder=1;
1138   3                  gs_File_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
1139   3                  gs_DIR_FCB[0].dw_FDB_StartCluster=ptr.dw_FDB_StartCluster;
1140   3      
1141   3                  tc_SearchTime--;
1142   3              }
1143   2          }  
1144   1          return(1);
1145   1      }
1146          
1147          void PlayPrevFolder(void)
1148          {
1149   1              data    U8      tc_SearchDirTimeout;
1150   1              data    U8      tc_clock_mode_backup;
1151   1              xdata   U32     dw_File_StartCluster_Backup;
1152   1              xdata   U32     dw_FDB_StartCluster_Backup;
1153   1      
1154   1              if(gw_FileTotalNumber[0]!=0)
1155   1              {                                                                               
1156   2                      gb_DirPlay_Flag=1;
1157   2      
1158   2                      play_stop();
1159   2                      gb_LrcFileName_Exist=0;
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 20  

1160   2                      tc_clock_mode_backup=gc_clock_mode;
1161   2                      set_clock_mode(CLOCK_MODE_DOS);
1162   2                      GetCurrentDirInfo();
1163   2      
1164   2                      for(tc_SearchDirTimeout=0;tc_SearchDirTimeout<255;tc_SearchDirTimeout++)
1165   2                      {
1166   3                              DOS_Search_DIR_Prev_test(0x23);
1167   3      
1168   3                              gb_FindFlag=0;
1169   3      
1170   3                              if(gw_CurrentFolderNum==0)
1171   3                              {
1172   4                                      gw_CurrentFolderNum=gw_DirTotalNumber;
1173   4                              }
1174   3                              else
1175   3                              {
1176   4                                      gw_CurrentFolderNum--;
1177   4                              }
1178   3                              
1179   3                      //      dbprintf("gw_CurrentFolderNum=%x\n",gw_CurrentFolderNum);
1180   3      
1181   3                              gs_File_FCB[0].dw_FDB_StartCluster = gs_DIR_FCB[0].dw_File_StartCluster;
1182   3      
1183   3                              if(gc_CurrentCard==9)
1184   3                              {
1185   4                                      return; 
1186   4                              }
1187   3                              else if(gc_CurrentCard==2&&gb_SD_pin==1)        // SD remove
1188   3                              {
1189   4                                      return;
1190   4                              }
1191   3                              else if(gc_CurrentCard==5&&Host_DetectDevice()==1)      // Host remove
1192   3                              {
1193   4                                      return;
1194   4                              }
1195   3      
1196   3                              dw_File_StartCluster_Backup=gs_DIR_FCB[0].dw_File_StartCluster;
1197   3                              dw_FDB_StartCluster_Backup=gs_DIR_FCB[0].dw_FDB_StartCluster;
1198   3                              gb_LastFolder=0;
1199   3                              DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_MusicFHandle,C_CmpExtName|C_Next);
1200   3                              if(gw_FileTotalNumber[0])
1201   3                              {
1202   4                                      DOS_Search_File(C_File_OneDir|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
1203   4                                      gw_FileIndex[0]=1;
1204   4                                      break;
1205   4                              }
1206   3                              gs_DIR_FCB[0].dw_File_StartCluster=dw_File_StartCluster_Backup;
1207   3                              gs_DIR_FCB[0].dw_FDB_StartCluster=dw_FDB_StartCluster_Backup;
1208   3                      }
1209   2                      set_clock_mode(tc_clock_mode_backup);
1210   2                      LCM_ShowSongNumber();
1211   2                      gb_FindFlag=1;
1212   2                      gb_Mp3FileEnd=1;
1213   2                      gb_LogDataFlag=1;
1214   2                      gb_DirPlay_Flag=1;
1215   2              }
1216   1      }
1217          
1218          
1219          void PlayNextFolder(void)
1220          {
1221   1              data    U8      tc_SearchDirTimeout;
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 21  

1222   1              data    U8      tc_clock_mode_backup;
1223   1      
1224   1      //      if(gw_FileTotalNumber[0]!=0)
1225   1              {
1226   2                      play_stop();
1227   2                      gb_LrcFileName_Exist=0;
1228   2                      tc_clock_mode_backup=gc_clock_mode;
1229   2                      set_clock_mode(CLOCK_MODE_DOS);
1230   2      
1231   2                      for(tc_SearchDirTimeout=0;tc_SearchDirTimeout<255;tc_SearchDirTimeout++)
1232   2                      {
1233   3                              gs_DIR_FCB[0].dw_FDB_StartCluster=gs_File_FCB[0].dw_FDB_StartCluster;                                                   
1234   3                              DOS_Search_DIR(0x23);
1235   3      
1236   3                              if(gw_CurrentFolderNum==gw_DirTotalNumber)
1237   3                              {
1238   4                                      gw_CurrentFolderNum=0;
1239   4                              }
1240   3                              else
1241   3                              {
1242   4                                      gw_CurrentFolderNum++;
1243   4                              }
1244   3      
1245   3                              gb_FindFlag=0;
1246   3                              if(gb_LastFolder==0)
1247   3                              {
1248   4                                      gs_File_FCB[0].dw_FDB_StartCluster=gs_DIR_FCB[0].dw_File_StartCluster;
1249   4                              }
1250   3                              else
1251   3                              {
1252   4                                      gs_File_FCB[0].dw_FDB_StartCluster=gdw_DOS_RootDirClus;
1253   4                                      gb_LastFolder=0;
1254   4                              }
1255   3      
1256   3                              if(gc_CurrentCard==9)
1257   3                              {
1258   4                                      return; 
1259   4                              }
1260   3                              else if(gc_CurrentCard==2&&gb_SD_pin==1)        // SD remove
1261   3                              {
1262   4                                      return;
1263   4                              }
1264   3                              else if(gc_CurrentCard==5&&Host_DetectDevice()==1)      // Host remove
1265   3                              {
1266   4                                      return;
1267   4                              }
1268   3      
1269   3                              DOS_Search_File(C_File_OneDir|C_Cnt_FileNo,C_MusicFHandle,C_CmpExtName|C_Next);
1270   3                              if(gw_FileTotalNumber[0])
1271   3                              {
1272   4                                      DOS_Search_File(C_File_All|C_By_FDB,C_MusicFileType,C_CmpExtName|C_Next);
1273   4                                      gw_FileIndex[0]=1;
1274   4                                      break;
1275   4                              }                                                                                                               
1276   3                      }
1277   2                      set_clock_mode(tc_clock_mode_backup);
1278   2                      LCM_ShowSongNumber();
1279   2                      gb_FindFlag=1;
1280   2                      gb_Mp3FileEnd=1;
1281   2                      gb_LogDataFlag=1;
1282   2                      gb_DirPlay_Flag=1;
1283   2              }                               
C51 COMPILER V9.00   DIR_PROCESS                                                           07/09/2012 21:16:45 PAGE 22  

1284   1      }
1285          
1286          
1287          
1288          void DOS_Count_All_Dir(void) //Ching 100514
1289          {
1290   1              gs_DIR_FCB[C_OtherFileType].dw_FDB_StartCluster=gdw_DOS_RootDirClus;
1291   1              gs_File_FCB[C_OtherFileType].dw_FDB_StartCluster=gdw_DOS_RootDirClus;
1292   1              gb_FindFlag=0;
1293   1              EXT_NameC[0]=1;
1294   1              EXT_NameC[1]=0xFE;
1295   1              EXT_NameC[2]=0x5A;
1296   1              EXT_NameC[3]=0xA5;
1297   1              gb_CountDirFlag=1;
1298   1              gw_DirTotalNumber=0;
1299   1              DOS_Search_File(C_File_All|C_By_FDB,C_OtherFileType,C_CmpExtName|C_Next);
1300   1              gb_CountDirFlag=0;
1301   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   5171    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----     274
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
